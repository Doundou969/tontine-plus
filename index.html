<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>AgriTontine+ ¬∑ Plateforme Nationale ¬∑ S√©n√©gal</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,600;0,700;0,900;1,700&family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
*,::before,::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#080F08;--s1:#0D160D;--s2:#111C11;--s3:#172017;--s4:#1D261D;
  --green:#2A7D42;--g2:#3A9E56;--g3:#4DBF6A;
  --lime:#7EC845;--lime2:#A2E060;
  --gold:#C49A28;--gold2:#F0C040;--gold3:#FFD060;
  --teal:#1A9E8E;--teal2:#25C4B0;
  --amber:#D4740A;--amber2:#F08C20;
  --blue:#2060C0;--blue2:#4080E0;
  --rust:#C44A2A;--rust2:#E06040;
  --ink:#E8F2E8;--ink2:#9AB89A;--ink3:#5A785A;--ink4:#3A503A;
  --border:#1C2C1C;--border2:#243424;--border3:#2E423E;
  --f-d:'Fraunces',Georgia,serif;
  --f-b:'Sora',system-ui,sans-serif;
  --f-m:'JetBrains Mono',monospace;
  --r:14px;--r2:9px;--r3:6px;
  --sh:0 4px 32px rgba(0,0,0,.5);
  --sh2:0 8px 48px rgba(0,0,0,.6);
}
html,body,#root{height:100%;font-family:var(--f-b);background:var(--bg);color:var(--ink);overflow-x:hidden}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--s1)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}
::-webkit-scrollbar-thumb:hover{background:var(--border3)}

/* ‚îÄ‚îÄ APP LAYOUT ‚îÄ‚îÄ */
.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:248px;background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.main{flex:1;overflow-y:auto;background:var(--bg);position:relative}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sb-brand{padding:1.4rem 1.25rem .9rem;border-bottom:1px solid var(--border)}
.sb-logo{font-family:var(--f-d);font-size:1.5rem;font-weight:900;color:var(--lime);letter-spacing:-.02em;line-height:1}
.sb-logo span{color:var(--gold2)}
.sb-tagline{font-size:.62rem;color:var(--ink3);margin-top:.25rem;letter-spacing:.06em;text-transform:uppercase}
.sb-flag{display:inline-flex;align-items:center;gap:.3rem;background:rgba(126,200,69,.08);border:1px solid rgba(126,200,69,.15);border-radius:99px;padding:.18rem .55rem;font-size:.62rem;font-weight:700;color:var(--lime);margin-top:.45rem;letter-spacing:.04em}

.sb-user{margin:.7rem .9rem;background:var(--s2);border:1px solid var(--border2);border-radius:var(--r2);padding:1rem}
.sb-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;border:2px solid var(--border2)}
.sb-uname{font-weight:700;font-size:.84rem;color:var(--ink);line-height:1.2}
.sb-usub{font-size:.68rem;color:var(--ink3);margin-top:.1rem}
.sb-score-row{margin-top:.65rem;display:flex;align-items:center;gap:.55rem}
.sb-score-track{flex:1;height:3px;background:var(--border);border-radius:99px;overflow:hidden}
.sb-score-fill{height:100%;border-radius:99px;transition:width .6s}
.sb-score-num{font-family:var(--f-m);font-size:.72rem;font-weight:500}

.sb-nav{flex:1;padding:.5rem .7rem;overflow-y:auto}
.sb-sec{font-size:.58rem;font-weight:700;letter-spacing:.18em;text-transform:uppercase;color:var(--ink4);padding:.65rem .6rem .3rem;margin-top:.15rem}
.sb-item{display:flex;align-items:center;gap:.6rem;padding:.58rem .7rem;border-radius:var(--r3);cursor:pointer;font-size:.82rem;color:var(--ink3);transition:.15s;margin-bottom:.1rem;border:1px solid transparent;position:relative}
.sb-item:hover{background:var(--s3);color:var(--ink);border-color:var(--border2)}
.sb-item.on{color:var(--lime);border-color:rgba(126,200,69,.2)}
.sb-item.on::before{content:'';position:absolute;left:0;top:20%;bottom:20%;width:2px;background:var(--lime);border-radius:99px}
.sb-ic{font-size:.95rem;width:18px;text-align:center;flex-shrink:0}
.sb-dot{margin-left:auto;min-width:18px;height:18px;border-radius:99px;display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:700}
.dot-red{background:var(--rust);color:#fff}
.dot-green{background:var(--lime);color:#0D1B0D}
.dot-gold{background:var(--gold);color:#fff}

.sb-foot{padding:.8rem 1.1rem;border-top:1px solid var(--border)}
.sb-logout{display:flex;align-items:center;gap:.45rem;font-size:.78rem;color:var(--ink4);cursor:pointer;padding:.35rem 0;transition:.15s}
.sb-logout:hover{color:var(--rust2)}
.sb-version{font-size:.62rem;color:var(--ink4);margin-top:.35rem;line-height:1.6}

/* ‚îÄ‚îÄ SECTOR BADGE ‚îÄ‚îÄ */
.sector-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.22rem .65rem;border-radius:99px;font-size:.66rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
.sec-agri{background:rgba(126,200,69,.15);color:var(--lime);border:1px solid rgba(126,200,69,.25)}
.sec-elev{background:rgba(212,116,10,.15);color:var(--amber2);border:1px solid rgba(212,116,10,.25)}
.sec-mix{background:rgba(26,158,142,.15);color:var(--teal2);border:1px solid rgba(26,158,142,.25)}
.sec-invest{background:rgba(240,192,64,.15);color:var(--gold3);border:1px solid rgba(240,192,64,.25)}

/* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
.ph{padding:2rem 2.5rem 1.5rem;border-bottom:1px solid var(--border)}
.ph-top{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.ph-tag{font-size:.62rem;font-weight:700;letter-spacing:.18em;text-transform:uppercase;color:var(--lime);margin-bottom:.3rem}
.ph-title{font-family:var(--f-d);font-size:1.8rem;font-weight:700;color:var(--ink);line-height:1.12}
.ph-sub{font-size:.82rem;color:var(--ink3);margin-top:.3rem;line-height:1.55}
.ph-actions{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin-top:.5rem}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{padding:1.75rem 2.5rem}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:1.5rem}
.card:hover{border-color:var(--border2)}
.card-sm{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:1rem}
.card-title{font-weight:700;font-size:.88rem;color:var(--ink);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.card-title span{font-size:.78rem;font-weight:400;color:var(--ink3)}

/* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
.stat{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:1.35rem;position:relative;overflow:hidden;transition:.2s}
.stat:hover{border-color:var(--border2);transform:translateY(-2px)}
.stat::after{content:'';position:absolute;top:-24px;right:-24px;width:90px;height:90px;border-radius:50%;background:var(--glow,rgba(126,200,69,.05))}
.stat-ic{font-size:1.5rem;margin-bottom:.6rem}
.stat-val{font-family:var(--f-d);font-size:2rem;font-weight:700;color:var(--ink);line-height:1}
.stat-lbl{font-size:.7rem;color:var(--ink3);margin-top:.2rem;font-weight:500;text-transform:uppercase;letter-spacing:.04em}
.stat-sub{font-size:.72rem;margin-top:.45rem;display:flex;align-items:center;gap:.3rem}
.up{color:var(--lime)}.dn{color:var(--rust2)}.neu{color:var(--ink3)}

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:1.1rem}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1.4rem}
.g2-3{display:grid;grid-template-columns:1fr 1.4fr;gap:1.4rem}
.gauto{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.1rem}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem 1.15rem;border-radius:var(--r2);font-size:.82rem;font-weight:600;cursor:pointer;border:none;font-family:var(--f-b);transition:.15s;white-space:nowrap}
.btn:hover{transform:translateY(-1px);filter:brightness(1.08)}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none}
.btn-lime{background:var(--lime);color:#080F08}
.btn-green{background:var(--green);color:#fff}
.btn-gold{background:var(--gold);color:#fff}
.btn-teal{background:var(--teal);color:#fff}
.btn-amber{background:var(--amber);color:#fff}
.btn-ghost{background:transparent;color:var(--ink2);border:1px solid var(--border2)}
.btn-ghost:hover{background:var(--s2);color:var(--ink)}
.btn-danger{background:rgba(196,74,42,.12);color:var(--rust2);border:1px solid rgba(196,74,42,.2)}
.btn-sm{padding:.38rem .8rem;font-size:.76rem}
.btn-xs{padding:.24rem .55rem;font-size:.68rem;border-radius:var(--r3)}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.fg{margin-bottom:.9rem}
.fg label{display:block;font-size:.7rem;font-weight:700;color:var(--ink3);margin-bottom:.3rem;letter-spacing:.05em;text-transform:uppercase}
.fg input,.fg select,.fg textarea{width:100%;padding:.58rem .85rem;border:1px solid var(--border2);border-radius:var(--r2);font-size:.84rem;font-family:var(--f-b);background:var(--s2);color:var(--ink);outline:none;transition:border .2s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--lime);background:var(--s3)}
.fg input::placeholder{color:var(--ink4)}
.fg select option{background:var(--s1);color:var(--ink)}
.fg textarea{resize:vertical;min-height:80px;line-height:1.6}
.fg-hint{font-size:.68rem;color:var(--ink4);margin-top:.25rem;line-height:1.5}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.65rem}
.frow-btns{display:flex;gap:.65rem;justify-content:flex-end;margin-top:1.35rem;padding-top:1.1rem;border-top:1px solid var(--border)}

/* ‚îÄ‚îÄ CHIP ‚îÄ‚îÄ */
.chip{display:inline-flex;align-items:center;gap:.28rem;padding:.2rem .6rem;border-radius:99px;font-size:.68rem;font-weight:600}
.ch-lime{background:rgba(126,200,69,.15);color:var(--lime);border:1px solid rgba(126,200,69,.22)}
.ch-gold{background:rgba(240,192,64,.15);color:var(--gold3);border:1px solid rgba(240,192,64,.22)}
.ch-amber{background:rgba(212,116,10,.15);color:var(--amber2);border:1px solid rgba(212,116,10,.22)}
.ch-teal{background:rgba(26,158,142,.15);color:var(--teal2);border:1px solid rgba(26,158,142,.22)}
.ch-rust{background:rgba(196,74,42,.15);color:var(--rust2);border:1px solid rgba(196,74,42,.22)}
.ch-blue{background:rgba(32,96,192,.15);color:var(--blue2);border:1px solid rgba(32,96,192,.22)}
.ch-gray{background:var(--s3);color:var(--ink3);border:1px solid var(--border2)}

/* ‚îÄ‚îÄ SCORE RING ‚îÄ‚îÄ */
.ring-wrap{display:flex;flex-direction:column;align-items:center;gap:.35rem}
.ring{position:relative;flex-shrink:0}
.ring svg{transform:rotate(-90deg);display:block}
.ring-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-n{font-family:var(--f-d);font-weight:700;line-height:1}
.ring-s{font-size:.52rem;color:var(--ink4)}
.ring-lbl{font-size:.64rem;color:var(--ink3);letter-spacing:.06em;text-transform:uppercase}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.tbl-wrap{overflow-x:auto;border-radius:var(--r2);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}
th{padding:.65rem 1rem;font-size:.65rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink4);text-align:left;background:var(--s2);border-bottom:1px solid var(--border)}
td{padding:.72rem 1rem;font-size:.82rem;border-bottom:1px solid var(--border);color:var(--ink);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.015)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:1000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);padding:1rem}
.modal{background:var(--s1);border:1px solid var(--border3);border-radius:18px;width:100%;max-width:500px;max-height:92vh;overflow-y:auto;box-shadow:var(--sh2)}
.modal-lg{max-width:640px}
.mh{padding:1.4rem 1.6rem 1.1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.m-title{font-family:var(--f-d);font-size:1.15rem;font-weight:700;color:var(--ink)}
.m-close{background:var(--s2);border:1px solid var(--border);border-radius:6px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--ink3);font-size:.82rem;transition:.15s}
.m-close:hover{background:var(--s3);color:var(--rust2)}
.mb{padding:1.5rem 1.6rem}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast-cont{position:fixed;bottom:1.5rem;right:1.5rem;z-index:2000;display:flex;flex-direction:column;gap:.45rem;pointer-events:none}
.toast{background:var(--s2);border:1px solid var(--border3);border-radius:10px;padding:.72rem 1rem;display:flex;align-items:center;gap:.6rem;font-size:.8rem;box-shadow:var(--sh2);animation:tin .3s cubic-bezier(.175,.885,.32,1.275);max-width:330px}
.toast-s{border-left:3px solid var(--lime)}
.toast-e{border-left:3px solid var(--rust2)}
.toast-i{border-left:3px solid var(--gold)}
@keyframes tin{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}

/* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
.pbar-wrap{background:var(--border);border-radius:99px;overflow:hidden}
.pbar-fill{height:100%;border-radius:99px;transition:width .5s}

/* ‚îÄ‚îÄ ACTIVITY ‚îÄ‚îÄ */
.act-item{display:flex;gap:.7rem;padding:.7rem 0;border-bottom:1px solid var(--border)}
.act-item:last-child{border-bottom:none}
.act-ic{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.82rem;flex-shrink:0}
.act-text{font-size:.8rem;color:var(--ink);line-height:1.5}
.act-date{font-size:.68rem;color:var(--ink4);margin-top:.1rem}

/* ‚îÄ‚îÄ PROJECT CARD ‚îÄ‚îÄ */
.proj-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:1.35rem;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.proj-card:hover{border-color:var(--border3);transform:translateY(-2px);box-shadow:var(--sh)}
.proj-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--proj-color,var(--lime))}
.proj-name{font-family:var(--f-d);font-size:1.05rem;font-weight:700;color:var(--ink);margin-bottom:.4rem;margin-top:.3rem}
.proj-promo{font-size:.78rem;color:var(--ink3);margin-bottom:.75rem;line-height:1.5}
.proj-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin-bottom:.85rem}
.proj-stat{background:var(--s2);border-radius:var(--r3);padding:.55rem .65rem;text-align:center}
.proj-stat-val{font-family:var(--f-d);font-size:1.1rem;font-weight:700;color:var(--ink);line-height:1}
.proj-stat-lbl{font-size:.62rem;color:var(--ink4);margin-top:.1rem;text-transform:uppercase;letter-spacing:.04em}
.proj-progress{margin-bottom:.85rem}
.proj-prog-head{display:flex;justify-content:space-between;font-size:.72rem;margin-bottom:.3rem}

/* ‚îÄ‚îÄ INVEST CARD ‚îÄ‚îÄ */
.invest-option{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:1rem;display:flex;align-items:center;gap:.85rem;cursor:pointer;transition:.2s;margin-bottom:.6rem}
.invest-option:hover{border-color:var(--gold);background:rgba(196,154,40,.05)}
.invest-option.sel{border-color:var(--gold2);background:rgba(240,192,64,.08)}
.invest-opt-ic{width:40px;height:40px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.invest-opt-n{font-weight:700;font-size:.88rem;color:var(--ink)}
.invest-opt-d{font-size:.74rem;color:var(--ink3);margin-top:.1rem}
.invest-opt-r{margin-left:auto;text-align:right}
.invest-opt-rate{font-family:var(--f-d);font-size:1.1rem;font-weight:700;color:var(--gold2)}
.invest-opt-dur{font-size:.68rem;color:var(--ink4);margin-top:.1rem}

/* ‚îÄ‚îÄ REGION TAG ‚îÄ‚îÄ */
.region-chip{display:inline-flex;align-items:center;gap:.3rem;background:var(--s3);border:1px solid var(--border2);border-radius:99px;padding:.2rem .6rem;font-size:.68rem;color:var(--ink3)}

/* ‚îÄ‚îÄ INFO BOX ‚îÄ‚îÄ */
.info-box{border-radius:var(--r2);padding:.85rem 1rem;font-size:.8rem;line-height:1.65}
.info-lime{background:rgba(126,200,69,.07);border:1px solid rgba(126,200,69,.18);color:var(--ink2)}
.info-gold{background:rgba(240,192,64,.07);border:1px solid rgba(240,192,64,.18);color:var(--ink2)}
.info-rust{background:rgba(196,74,42,.07);border:1px solid rgba(196,74,42,.18);color:var(--ink2)}
.info-teal{background:rgba(26,158,142,.07);border:1px solid rgba(26,158,142,.18);color:var(--ink2)}

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
hr{border:none;border-top:1px solid var(--border);margin:1.25rem 0}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;text-align:center}
.empty-ic{font-size:2.5rem;margin-bottom:1rem;opacity:.4}
.empty-t{font-size:.95rem;font-weight:700;color:var(--ink2);margin-bottom:.35rem}
.empty-s{font-size:.8rem;color:var(--ink4);line-height:1.65;max-width:280px}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
.flex{display:flex}.fcc{display:flex;align-items:center}.fsc{display:flex;align-items:flex-start}.fsb{display:flex;justify-content:space-between}.fcsb{display:flex;align-items:center;justify-content:space-between}
.gap1{gap:.5rem}.gap2{gap:1rem}.gap3{gap:1.5rem}
.mt1{margin-top:.5rem}.mt2{margin-top:1rem}.mt3{margin-top:1.5rem}
.mb1{margin-bottom:.5rem}.mb2{margin-bottom:1rem}.mb3{margin-bottom:1.5rem}
.w100{width:100%}.bold{font-weight:700}.mono{font-family:var(--f-m)}
.t-sm{font-size:.8rem}.t-xs{font-size:.7rem}.t-muted{color:var(--ink3)}.t-lime{color:var(--lime)}.t-gold{color:var(--gold2)}.t-rust{color:var(--rust2)}.t-teal{color:var(--teal2)}.t-amber{color:var(--amber2)}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-bg{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);position:relative;overflow:hidden}
.login-bg::before{content:'';position:absolute;width:700px;height:700px;border-radius:50%;background:radial-gradient(circle,rgba(42,125,66,.1) 0%,transparent 65%);top:-250px;left:-250px}
.login-bg::after{content:'';position:absolute;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(196,154,40,.07) 0%,transparent 65%);bottom:-150px;right:-150px}
.login-card{background:var(--s1);border:1px solid var(--border3);border-radius:20px;padding:2.5rem;width:100%;max-width:400px;position:relative;z-index:2;box-shadow:var(--sh2)}
.login-logo{font-family:var(--f-d);font-size:2.2rem;font-weight:900;color:var(--lime);line-height:1}
.login-logo b{color:var(--gold2)}
.login-sub{font-size:.8rem;color:var(--ink3);margin-top:.3rem;margin-bottom:.5rem;line-height:1.55}
.login-flags{display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:1.75rem}
.login-flag{background:var(--s2);border:1px solid var(--border);border-radius:99px;padding:.2rem .65rem;font-size:.68rem;color:var(--ink3)}
.tabs{display:flex;gap:.4rem;background:var(--s2);padding:.3rem;border-radius:var(--r2);margin-bottom:1.5rem}
.tab{flex:1;padding:.45rem;text-align:center;border-radius:var(--r3);font-size:.8rem;font-weight:600;cursor:pointer;color:var(--ink3);transition:.2s}
.tab.on{background:var(--green);color:#fff}
.demo-btns{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:.9rem 1rem;margin-top:.85rem}
.demo-label{font-size:.72rem;font-weight:700;color:var(--ink3);margin-bottom:.6rem;letter-spacing:.04em;text-transform:uppercase}
.demo-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.45rem}

@media(max-width:800px){
  .sidebar{display:none}
  .g4{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr}
  .g2,.g2-3{grid-template-columns:1fr}
  .fr,.fr3{grid-template-columns:1fr}
  .content{padding:1.25rem}
  .ph{padding:1.25rem 1.25rem 1rem}
}
</style>
</head>
</style>
</head>
<body>
<div id="root"></div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script type="text/babel">
const {useState,useEffect,useCallback,useMemo,useRef} = React;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUPABASE CLIENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SB_URL  = 'https://yxpluppgnztdswwmnhfd.supabase.co';
const SB_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4cGx1cHBnbnp0ZHN3d21uaGZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDYxMDEsImV4cCI6MjA4NzYyMjEwMX0.UObjZEihMuH3vOuiufLbaB2jlWJB2_M0a7kPui8bdLc';
const sb = supabase.createClient(SB_URL, SB_KEY);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONVERTISSEURS DB ‚Üí FORMAT APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function dbUser(u, extra={}) {
  return {
    id: u.id,
    nom: u.nom,
    telephone: u.telephone,
    village: u.village || '',
    region: u.region || 'Dakar',
    secteur: u.secteur || 'agriculture',
    role: u.role || 'paysan',
    dateInscription: (u.created_at||'').slice(0,10),
    cotisations: extra.cotisations || [],
    credits:     extra.credits     || [],
    tontines:    extra.tontines    || [],
    investissements: extra.investissements || [],
  };
}
function dbTontine(t) {
  return {
    id: t.id,
    nom: t.nom,
    admin: t.admin_id,
    secteur: t.secteur,
    region: t.region,
    montantCotis: t.montant_cotis,
    frequence: t.frequence,
    nbMax: t.nb_max,
    semaine: t.semaine_courante || 1,
    statut: t.statut,
    description: t.description || '',
    dateCreation: (t.created_at||'').slice(0,10),
    membres: (t.membres||[]).map(m=>({
      uid: m.user_id,
      tour: m.tour_num,
      pot: m.a_recu_pot,
      nom: m.user ? m.user.nom : '',
    })),
  };
}
function dbCotis(c) {
  return { id:c.id, tontineId:c.tontine_id, montant:c.montant, statut:c.statut, date:c.date };
}
function dbCredit(c) {
  return {
    id:c.id, montant:c.montant, intrant:c.intrant, partenaire:c.partenaire||'',
    statut:c.statut, scoreSnapshot:c.score_snapshot||0,
    dateOctroi:c.date_octroi, dateEcheance:c.date_echeance||'',
  };
}
function dbProjet(p) {
  return {
    id:p.id, nom:p.nom, promoteur:p.promoteur||'', region:p.region||'',
    secteur:p.secteur, description:p.description||'',
    objectif:p.objectif, collecte:p.collecte,
    dateFinancement:p.date_financement||'',
    rendementAnnuel:p.rendement_annuel, dureeMois:p.duree_mois,
    risque:p.risque, investisseurs:p.investisseurs,
    statut:p.statut, updates:p.updates||[],
    dateCreation:(p.created_at||'').slice(0,10),
  };
}
function dbInvest(i) {
  return { projetId:i.projet_id, montant:i.montant, retourAttendu:i.retour_attendu||0, date:i.date };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FONCTIONS SUPABASE CRUD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Charger les donn√©es compl√®tes d'un user
async function loadUserData(userId) {
  const [cotisRes, credRes, membresRes, investRes] = await Promise.all([
    sb.from('cotisations').select('*').eq('user_id',userId).order('date',{ascending:false}),
    sb.from('credits').select('*').eq('user_id',userId).order('date_octroi',{ascending:false}),
    sb.from('membres').select('tontine_id').eq('user_id',userId),
    sb.from('investissements').select('*').eq('user_id',userId).order('date',{ascending:false}),
  ]);
  return {
    cotisations: (cotisRes.data||[]).map(dbCotis),
    credits:     (credRes.data||[]).map(dbCredit),
    tontines:    (membresRes.data||[]).map(m=>m.tontine_id),
    investissements: (investRes.data||[]).map(dbInvest),
  };
}

// Charger toutes les tontines
async function sbFetchTontines() {
  const { data } = await sb.from('tontines')
    .select('*, membres(id,user_id,tour_num,a_recu_pot,user:users(id,nom))')
    .order('created_at',{ascending:false});
  return (data||[]).map(dbTontine);
}

// Charger tous les projets
async function sbFetchProjets() {
  const { data } = await sb.from('projets').select('*').order('created_at',{ascending:false});
  return (data||[]).map(dbProjet);
}

// Cr√©er tontine + inscrire admin comme membre
async function sbCreerTontine(user, f) {
  const { data:t, error } = await sb.from('tontines').insert({
    nom:f.nom, admin_id:user.id, secteur:f.secteur, region:f.region,
    montant_cotis:parseInt(f.montant), frequence:f.frequence,
    nb_max:parseInt(f.nbMax), description:f.desc||'', statut:'actif',
  }).select().single();
  if (error) throw new Error(error.message);
  await sb.from('membres').insert({ user_id:user.id, tontine_id:t.id, tour_num:1, a_recu_pot:false });
  return t.id;
}

// Rejoindre une tontine
async function sbRejoindre(userId, tontine) {
  if (tontine.membres.some(m=>m.uid===userId)) throw new Error('D√©j√† membre');
  if (tontine.membres.length >= tontine.nbMax) throw new Error('Tontine compl√®te');
  const { error } = await sb.from('membres').insert({
    user_id:userId, tontine_id:tontine.id,
    tour_num:tontine.membres.length+1, a_recu_pot:false,
  });
  if (error) throw new Error(error.message);
}

// Payer une cotisation
async function sbPayerCotis(userId, tontine) {
  const { data, error } = await sb.from('cotisations').insert({
    user_id:userId, tontine_id:tontine.id,
    montant:tontine.montantCotis, statut:'payee',
    date:new Date().toISOString().slice(0,10),
  }).select().single();
  if (error) throw new Error(error.message);
  return dbCotis(data);
}

// Demander un cr√©dit
async function sbDemanderCredit(userId, f, score) {
  const dateOctroi = new Date().toISOString().slice(0,10);
  const dateEcheance = new Date(Date.now()+180*24*60*60*1000).toISOString().slice(0,10);
  const { data, error } = await sb.from('credits').insert({
    user_id:userId, montant:parseInt(f.montant), intrant:f.intrant,
    partenaire:f.partenaire, statut:'approuve',
    score_snapshot:score, date_octroi:dateOctroi, date_echeance:dateEcheance,
  }).select().single();
  if (error) throw new Error(error.message);
  return dbCredit(data);
}

// Rembourser un cr√©dit
async function sbRembourser(creditId) {
  const { error } = await sb.from('credits').update({statut:'rembourse'}).eq('id',creditId);
  if (error) throw new Error(error.message);
}

// Cr√©er un projet
async function sbCreerProjet(userId, fp) {
  const { data, error } = await sb.from('projets').insert({
    nom:fp.nom, promoteur:fp.promoteur, region:fp.region, secteur:fp.secteur,
    description:fp.desc, objectif:parseInt(fp.objectif), collecte:0,
    rendement_annuel:parseInt(fp.rendement), duree_mois:parseInt(fp.duree),
    risque:fp.risque, investisseurs:0, statut:'ouvert',
    updates:[], date_financement:new Date(Date.now()+120*24*60*60*1000).toISOString().slice(0,10),
  }).select().single();
  if (error) throw new Error(error.message);
  return dbProjet(data);
}

// Investir dans un projet
async function sbInvestir(userId, projet, montant) {
  const retourBrut = Math.round(montant*(1+projet.rendementAnnuel/100*(projet.dureeMois/12)));
  const { data, error } = await sb.from('investissements').insert({
    user_id:userId, projet_id:projet.id, montant,
    retour_attendu:retourBrut-montant,
    date:new Date().toISOString().slice(0,10),
  }).select().single();
  if (error) throw new Error(error.message);
  // Mettre √† jour collecte + investisseurs c√¥t√© client (le trigger SQL le fait aussi)
  return dbInvest(data);
}

// Mettre √† jour profil
async function sbUpdateProfil(userId, f) {
  const { error } = await sb.from('users').update({
    nom:f.nom, village:f.village, region:f.region, secteur:f.secteur,
  }).eq('id',userId);
  if (error) throw new Error(error.message);
}

// Marquer retard (admin)
async function sbMarquerRetard(userId, tontineId) {
  const { error } = await sb.from('cotisations').insert({
    user_id:userId, tontine_id:tontineId,
    montant:0, statut:'retard', date:new Date().toISOString().slice(0,10),
  });
  if (error) throw new Error(error.message);
}

const REGIONS = ['Dakar','Thi√®s','Diourbel','Saint-Louis','Louga','Fatick','Kaolack','Ziguinchor','Tambacounda','K√©dougou','Kolda','S√©dhiou','Kaffrine','Matam','Podor'];
const SECTEURS = [
  {id:'agriculture', label:'Agriculture', ic:'üå±', color:'var(--lime)', cls:'sec-agri'},
  {id:'elevage', label:'√âlevage', ic:'üêÑ', color:'var(--amber2)', cls:'sec-elev'},
  {id:'mixte', label:'Agri + √âlevage', ic:'üåæ', color:'var(--teal2)', cls:'sec-mix'},
];
const INTRANTS_AGRI = ['Semences certifi√©es','Engrais NPK','Engrais DAP','Pesticides homologu√©s','Petit √©quipement','Irrigation goutte-√†-goutte','Mat√©riel de r√©colte'];
const INTRANTS_ELEV = ['Aliments b√©tail','Vaccins & m√©dicaments','√âquipement v√©t√©rinaire','Mat√©riel d\'enclos','G√©niteurs am√©lior√©s','Produits laitiers (√©quipement)'];
const PARTENAIRES = ['DER S√©n√©gal','FADA','PAM CAS','ANCAR','PRACAS','Cr√©dit Mutuel du S√©n√©gal'];
const ESPECES = ['Bovins','Ovins','Caprins','Porcins','Volaille','√âquid√©s','Camelins'];
const CULTURES = ['Arachide','Mil','Ma√Øs','Sorgho','Riz','Ni√©b√©','Coton','Tomate','Oignon','Manioc','Past√®que','Bissap'];

/* ‚îÄ‚îÄ MARCH√â CADRAN ‚Äî Constantes ‚îÄ‚îÄ */
const CATEGORIES_MARCHE = [
  {id:'cereales',   label:'C√©r√©ales',    ic:'üåæ', cls:'sec-agri'},
  {id:'legumes',    label:'L√©gumes',     ic:'ü•¶', cls:'sec-mix'},
  {id:'fruits',     label:'Fruits',      ic:'üçä', cls:'sec-mix'},
  {id:'betail',     label:'B√©tail',      ic:'üêÑ', cls:'sec-elev'},
  {id:'volaille',   label:'Volaille',    ic:'üêì', cls:'sec-elev'},
  {id:'intrants',   label:'Intrants',    ic:'üß™', cls:'ch-gray'},
  {id:'equipement', label:'√âquipement',  ic:'üöú', cls:'ch-gray'},
  {id:'autre',      label:'Autre',       ic:'üì¶', cls:'ch-gray'},
];
const UNITES = ['kg','tonne','sac (50kg)','sac (100kg)','litre','unit√©','t√™te','lot'];

/* ‚îÄ‚îÄ MARCH√â CADRAN ‚Äî Supabase CRUD ‚îÄ‚îÄ */
async function sbFetchAnnonces(filters) {
  filters = filters || {};
  let q = sb.from('annonces')
    .select('*, vendeur:users(id,nom,telephone,village,region)')
    .eq('statut','active')
    .order('created_at',{ascending:false});
  if (filters.categorie && filters.categorie!=='all') q = q.eq('categorie',filters.categorie);
  if (filters.region && filters.region!=='all') q = q.eq('region',filters.region);
  if (filters.type && filters.type!=='all') q = q.eq('type',filters.type);
  const {data} = await q;
  return data || [];
}

async function sbCreerAnnonce(userId, f) {
  const {data, error} = await sb.from('annonces').insert({
    vendeur_id: userId,
    type: f.type,
    categorie: f.categorie,
    produit: f.produit,
    description: f.description || '',
    quantite: parseFloat(f.quantite),
    unite: f.unite,
    prix_unitaire: parseInt(f.prix),
    region: f.region,
    village: f.village || '',
    contact_wave: f.wave || '',
    statut: 'active',
    vues: 0,
  }).select('*, vendeur:users(id,nom,telephone,village,region)').single();
  if (error) throw new Error(error.message);
  return data;
}

async function sbFaireOffre(annonceId, userId, montant, message) {
  const {data, error} = await sb.from('offres').insert({
    annonce_id: annonceId,
    acheteur_id: userId,
    montant: parseInt(montant),
    message: message || '',
    statut: 'en_attente',
  }).select('*, acheteur:users(id,nom,telephone,village,region)').single();
  if (error) throw new Error(error.message);
  return data;
}

async function sbFetchOffres(annonceId) {
  const {data} = await sb.from('offres')
    .select('*, acheteur:users(id,nom,telephone,village,region)')
    .eq('annonce_id',annonceId)
    .order('created_at',{ascending:false});
  return data || [];
}

async function sbAccepterOffre(offreId, annonceId) {
  await sb.from('offres').update({statut:'acceptee'}).eq('id',offreId);
  await sb.from('annonces').update({statut:'vendue'}).eq('id',annonceId);
}

async function sbIncrVues(annonceId) {
  await sb.rpc('increment_vues', {aid: annonceId});
}

/* Projets d'investissement initiaux */
const PROJETS_INIT = [
  {
    id:'p1', nom:'Ferme Avicole Moderne ‚Äî Thi√®s', promoteur:'Abdoulaye Ndiaye',
    region:'Thi√®s', secteur:'elevage', espece:'Volaille',
    description:'Construction d\'un poulailler de 5 000 places avec syst√®me automatis√©. Production d\'≈ìufs et poulets de chair pour la r√©gion de Thi√®s.',
    objectif:4500000, collecte:2850000, dateFinancement:'2026-06-30',
    rendementAnnuel:14, dureeMois:18, risque:'modere',
    investisseurs:12, statut:'ouvert', dateCreation:'2026-01-15',
    updates:['Permis de construire obtenu','Accord SODEFITEX sign√©']
  },
  {
    id:'p2', nom:'P√©rim√®tre Irrigu√© Oignons ‚Äî Saint-Louis', promoteur:'Coop√©rative Walo',
    region:'Saint-Louis', secteur:'agriculture', culture:'Oignon',
    description:'Extension d\'un p√©rim√®tre mara√Æcher de 5 hectares avec pompe solaire. 3 campagnes/an garanties par contrat avec Auchan S√©n√©gal.',
    objectif:7200000, collecte:5400000, dateFinancement:'2026-04-15',
    rendementAnnuel:18, dureeMois:24, risque:'faible',
    investisseurs:27, statut:'ouvert', dateCreation:'2025-12-10',
    updates:['Contrat Auchan sign√©','Pompe solaire command√©e','15 familles b√©n√©ficiaires']
  },
  {
    id:'p3', nom:'Ranch Bovin Am√©lior√© ‚Äî Tambacounda', promoteur:'Mamadou Ba',
    region:'Tambacounda', secteur:'elevage', espece:'Bovins',
    description:'Acquisition de 40 bovins de race am√©lior√©e (Ndama √ó Z√©bu). Exploitation laiti√®re + vente de viande. Partenariat avec NMA Sanders.',
    objectif:12000000, collecte:8400000, dateFinancement:'2026-07-31',
    rendementAnnuel:16, dureeMois:36, risque:'modere',
    investisseurs:18, statut:'ouvert', dateCreation:'2026-01-20',
    updates:['Site cl√¥tur√©','Accord v√©t√©rinaire DIREL']
  },
  {
    id:'p4', nom:'Riziculture Casamance ‚Äî Ziguinchor', promoteur:'Groupement Femmes Kabrousse',
    region:'Ziguinchor', secteur:'agriculture', culture:'Riz',
    description:'R√©habilitation de 8 ha de rizi√®res en Casamance. Vari√©t√©s am√©lior√©es ISRA, deux campagnes/an. Commercialisation locale garantie.',
    objectif:3800000, collecte:3800000, dateFinancement:'2026-03-01',
    rendementAnnuel:12, dureeMois:12, risque:'faible',
    investisseurs:31, statut:'finance', dateCreation:'2025-11-01',
    updates:['Objectif atteint !','Travaux d√©marr√©s','Premi√®re r√©colte pr√©vue juillet 2026']
  },
  {
    id:'p5', nom:'Unit√© Transformation Tomate ‚Äî Kaolack', promoteur:'UTSK SARL',
    region:'Kaolack', secteur:'mixte',
    description:'Unit√© artisanale de transformation de tomate en concentr√© et sauce. Capacit√© 2 tonnes/jour. March√© local + exportation Gambie.',
    objectif:9500000, collecte:1200000, dateFinancement:'2026-09-30',
    rendementAnnuel:20, dureeMois:30, risque:'eleve',
    investisseurs:4, statut:'ouvert', dateCreation:'2026-02-01',
    updates:['√âtude de march√© valid√©e']
  },
];

/* Utilisateurs d√©mo */
const USERS_DEMO = {
  paysan: {
    id:'u1',nom:'Baye S√®ne',telephone:'+221771234567',village:'Touba Toul',
    region:'Diourbel',secteur:'agriculture',cultures:['Arachide','Mil'],
    role:'paysan',dateInscription:'2026-01-15',
    cotisations:[
      {id:'c1',tontineId:'t1',montant:5000,statut:'payee',date:'2026-01-20'},
      {id:'c2',tontineId:'t1',montant:5000,statut:'payee',date:'2026-01-27'},
      {id:'c3',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-03'},
      {id:'c4',tontineId:'t1',montant:5000,statut:'retard',date:'2026-02-10'},
      {id:'c5',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-17'},
      {id:'c6',tontineId:'t2',montant:3000,statut:'payee',date:'2026-02-01'},
      {id:'c7',tontineId:'t2',montant:3000,statut:'payee',date:'2026-02-15'},
    ],
    credits:[{id:'cr1',montant:40000,intrant:'Semences certifi√©es',statut:'rembourse',dateOctroi:'2025-10-01',dateEcheance:'2026-04-01'}],
    investissements:[{projetId:'p2',montant:150000,date:'2026-01-20',retourAttendu:27000}],
    tontines:['t1','t2'],
  },
  eleveur: {
    id:'u3',nom:'Ousmane Diallo',telephone:'+221776543210',village:'Lingu√®re',
    region:'Louga',secteur:'elevage',especes:['Bovins','Ovins'],
    role:'paysan',dateInscription:'2026-01-08',
    cotisations:[
      {id:'c10',tontineId:'t3',montant:10000,statut:'payee',date:'2026-01-15'},
      {id:'c11',tontineId:'t3',montant:10000,statut:'payee',date:'2026-02-15'},
      {id:'c12',tontineId:'t3',montant:10000,statut:'payee',date:'2026-02-20'},
    ],
    credits:[],
    investissements:[{projetId:'p1',montant:250000,date:'2026-01-25',retourAttendu:35000}],
    tontines:['t3'],
  },
  admin: {
    id:'u2',nom:'Mariama Diallo',telephone:'+221775551234',village:'Bambey',
    region:'Diourbel',secteur:'mixte',
    role:'admin',dateInscription:'2025-12-01',
    cotisations:[
      {id:'c8',tontineId:'t1',montant:5000,statut:'payee',date:'2026-01-20'},
      {id:'c9',tontineId:'t1',montant:5000,statut:'payee',date:'2026-01-27'},
      {id:'c10b',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-03'},
      {id:'c11b',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-10'},
      {id:'c12b',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-17'},
    ],
    credits:[],
    investissements:[],
    tontines:['t1'],
  },
};

const TONTINES_INIT = [
  {id:'t1',nom:'Tontine Espoir Bambey',admin:'u2',secteur:'agriculture',region:'Diourbel',
   montantCotis:5000,frequence:'hebdomadaire',nbMax:10,semaine:8,dateCreation:'2025-12-01',statut:'actif',
   description:'Tontine hebdomadaire agriculture. Financement semences et engrais.',
   membres:[{uid:'u1',tour:3,pot:false},{uid:'u2',tour:1,pot:true,nom:'Mariama Diallo'},{uid:'u3b',tour:2,pot:true,nom:'Fatou Ndiaye'},{uid:'u4',tour:4,pot:false,nom:'Ibrahima Sow'}]},
  {id:'t2',nom:'Groupe Agricole National',admin:'u2',secteur:'agriculture',region:'Thi√®s',
   montantCotis:3000,frequence:'mensuel',nbMax:8,semaine:3,dateCreation:'2026-01-10',statut:'actif',
   description:'Groupe mensuel multi-r√©gions pour cultures mara√Æch√®res.',
   membres:[{uid:'u1',tour:2,pot:false},{uid:'u5',tour:1,pot:true,nom:'Aissatou Ba'},{uid:'u6',tour:3,pot:false,nom:'Moussa Diop'}]},
  {id:'t3',nom:'√âleveurs du Nord',admin:'u3',secteur:'elevage',region:'Louga',
   montantCotis:10000,frequence:'mensuel',nbMax:6,semaine:2,dateCreation:'2026-01-05',statut:'actif',
   description:'Tontine mensuelle pour √©leveurs bovins et ovins du Nord S√©n√©gal.',
   membres:[{uid:'u3',tour:1,pot:false},{uid:'u7',tour:2,pot:false,nom:'Aliou Mbaye'},{uid:'u8',tour:3,pot:false,nom:'Samba Gaye'}]},
];

/* ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ */
function calcScore(user) {
  const c = user.cotisations || [];
  if (!c.length) return 0;
  const paid = c.filter(x=>x.statut==='payee').length;
  const retards = c.filter(x=>x.statut==='retard').length;
  const tontines = (user.tontines||[]).length;
  const credRembourses = (user.credits||[]).filter(x=>x.statut==='rembourse').length;
  const investOk = (user.investissements||[]).length;
  return Math.round(Math.max(0,Math.min(100,
    (paid/c.length)*60 +
    Math.min(tontines/5,1)*12 +
    Math.min(c.length/24,1)*10 +
    Math.min(credRembourses/3,1)*10 +
    Math.min(investOk/2,1)*3 -
    retards*5
  )));
}

/* ‚îÄ‚îÄ TOAST HOOK ‚îÄ‚îÄ */
let tid=0;
function useToast(){
  const [toasts,setToasts]=useState([]);
  const add=useCallback((msg,type='s')=>{
    const id=++tid;
    setToasts(p=>[...p,{id,msg,type}]);
    setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3800);
  },[]);
  return {toasts,add};
}

/* ‚îÄ‚îÄ COMPOSANTS UTILITAIRES ‚îÄ‚îÄ */
function ScoreRing({score,sz=100,fsz='1.5rem'}){
  const r=(sz-8)/2,circ=2*Math.PI*r,dash=(score/100)*circ;
  const col=score>=65?'var(--lime)':score>=40?'var(--gold2)':'var(--rust2)';
  return(
    <div className="ring-wrap">
      <div className="ring" style={{width:sz,height:sz}}>
        <svg width={sz} height={sz}>
          <circle cx={sz/2} cy={sz/2} r={r} fill="none" stroke="rgba(255,255,255,.06)" strokeWidth="7"/>
          <circle cx={sz/2} cy={sz/2} r={r} fill="none" stroke={col} strokeWidth="7"
            strokeDasharray={`${dash} ${circ}`} strokeLinecap="round"
            style={{transition:'stroke-dasharray .7s ease'}}/>
        </svg>
        <div className="ring-inner">
          <div className="ring-n" style={{fontSize:fsz,color:col}}>{score}</div>
          <div className="ring-s">/100</div>
        </div>
      </div>
      <div className="ring-lbl">Score cr√©dit</div>
    </div>
  );
}

function Modal({title,onClose,children,lg}){
  return(
    <div className="overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className={`modal${lg?' modal-lg':''}`}>
        <div className="mh">
          <div className="m-title">{title}</div>
          <div className="m-close" onClick={onClose}>‚úï</div>
        </div>
        <div className="mb">{children}</div>
      </div>
    </div>
  );
}

function Toasts({toasts}){
  return(
    <div className="toast-cont">
      {toasts.map(t=>(
        <div key={t.id} className={`toast toast-${t.type}`}>
          <span>{t.type==='s'?'‚úÖ':t.type==='e'?'‚ùå':'‚ÑπÔ∏è'}</span>
          <span style={{color:'var(--ink)'}}>{t.msg}</span>
        </div>
      ))}
    </div>
  );
}

function PBar({pct,color='var(--lime)',h=4}){
  return(
    <div className="pbar-wrap" style={{height:h}}>
      <div className="pbar-fill" style={{width:pct+'%',background:color,height:h}}/>
    </div>
  );
}

function SectorBadge({secteur}){
  const s=SECTEURS.find(x=>x.id===secteur)||{label:secteur,ic:'üåø',cls:'ch-gray'};
  return <span className={`sector-badge ${s.cls}`}>{s.ic} {s.label}</span>;
}
/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
function Dashboard({user,tontines,projets,toast}){
  const score=calcScore(user);
  const mesTontines=tontines.filter(t=>t.membres.some(m=>m.uid===user.id));
  const totalCotis=user.cotisations.filter(c=>c.statut==='payee').reduce((s,c)=>s+c.montant,0);
  const retards=user.cotisations.filter(c=>c.statut==='retard').length;
  const creditDispo=Math.max(0,score*1000);
  const mesInvests=user.investissements||[];
  const totalInvesti=mesInvests.reduce((s,i)=>s+i.montant,0);
  const totalRetour=mesInvests.reduce((s,i)=>s+i.retourAttendu,0);

  const secteurInfo=SECTEURS.find(s=>s.id===user.secteur)||SECTEURS[0];
  const recentActs=[
    ...user.cotisations.slice(-3).reverse().map(c=>({
      ic:c.statut==='payee'?'üí∏':'‚ö†Ô∏è',
      cls:c.statut==='payee'?'act-g':'act-y',
      text:`Cotisation ${c.statut==='payee'?'pay√©e':'en retard'} ‚Äî ${c.montant.toLocaleString('fr-FR')} FCFA`,
      date:c.date
    })),
    ...mesInvests.slice(-2).map(i=>{
      const p=projets.find(x=>x.id===i.projetId);
      return{ic:'üíº',cls:'act-b',text:`Investissement "${p?.nom||'Projet'}" ‚Äî ${i.montant.toLocaleString('fr-FR')} FCFA`,date:i.date};
    }),
  ].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Tableau de bord</div>
            <div className="ph-title">Bonjour, {user.nom.split(' ')[0]} üëã</div>
            <div className="ph-sub fcc gap1">
              <SectorBadge secteur={user.secteur}/>
              <span className="region-chip">üìç {user.village}, {user.region}</span>
              <span className="t-xs t-muted">Inscrit le {user.dateInscription}</span>
            </div>
          </div>
          <ScoreRing score={score} sz={90} fsz="1.35rem"/>
        </div>
      </div>

      <div className="content">
        <div className="g4 mb3">
          <div className="stat" style={{'--glow':'rgba(126,200,69,.07)'}}>
            <div className="stat-ic">üè¶</div>
            <div className="stat-val">{creditDispo.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Cr√©dit disponible (FCFA)</div>
            <div className="stat-sub"><span className={score>=40?'up':'dn'}>{score>=40?'‚úì √âligible':'‚úó Score < 40'}</span></div>
          </div>
          <div className="stat" style={{'--glow':'rgba(240,192,64,.07)'}}>
            <div className="stat-ic">üí∏</div>
            <div className="stat-val">{totalCotis.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Total cotis√© (FCFA)</div>
            <div className="stat-sub"><span className="up">‚Üë {user.cotisations.filter(c=>c.statut==='payee').length} paiements</span></div>
          </div>
          <div className="stat" style={{'--glow':'rgba(26,158,142,.07)'}}>
            <div className="stat-ic">üíº</div>
            <div className="stat-val">{totalInvesti.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Total investi (FCFA)</div>
            <div className="stat-sub"><span className="up">+{totalRetour.toLocaleString('fr-FR')} FCFA attendus</span></div>
          </div>
          <div className="stat" style={{'--glow':'rgba(196,74,42,.07)'}}>
            <div className="stat-ic">‚ö†Ô∏è</div>
            <div className="stat-val">{retards}</div>
            <div className="stat-lbl">Retards de paiement</div>
            <div className="stat-sub"><span className={retards===0?'up':'dn'}>{retards===0?'‚úì Parfait':'‚àí'+(retards*5)+' pts'}</span></div>
          </div>
        </div>

        <div className="g2 mb3">
          {/* Score d√©tail */}
          <div className="card">
            <div className="card-title">üìä Score IA d√©taill√©</div>
            <div className="fcc gap2 mb2">
              <ScoreRing score={score} sz={110} fsz="1.65rem"/>
              <div style={{flex:1}}>
                {[
                  {l:'Taux de paiement',v:Math.round((user.cotisations.filter(c=>c.statut==='payee').length/Math.max(user.cotisations.length,1))*60),m:60},
                  {l:'Multi-tontines',v:Math.round(Math.min((user.tontines||[]).length/5,1)*12),m:12},
                  {l:'Volume transactions',v:Math.round(Math.min(user.cotisations.length/24,1)*10),m:10},
                  {l:'Cr√©dits rembours√©s',v:Math.round(Math.min((user.credits||[]).filter(c=>c.statut==='rembourse').length/3,1)*10),m:10},
                  {l:'Investissements',v:Math.round(Math.min((user.investissements||[]).length/2,1)*3),m:3},
                ].map(item=>(
                  <div key={item.l} style={{marginBottom:'.48rem'}}>
                    <div className="fcsb t-xs t-muted mb1">
                      <span>{item.l}</span>
                      <span className="mono t-lime">{item.v}/{item.m}</span>
                    </div>
                    <PBar pct={item.v/item.m*100}/>
                  </div>
                ))}
                {retards>0&&<div className="t-xs t-rust mt1">‚ö† Malus: ‚àí{retards*5} pts ({retards} retard{retards>1?'s':''})</div>}
              </div>
            </div>
            <div className="info-box info-lime">
              üí° Plafond cr√©dit : <strong className="t-gold">{creditDispo.toLocaleString('fr-FR')} FCFA</strong> ¬∑ score √ó 1 000 FCFA
            </div>
          </div>

          {/* Activit√© r√©cente */}
          <div className="card">
            <div className="card-title">üïê Activit√© r√©cente</div>
            {recentActs.length===0
              ?<div className="empty"><div className="empty-ic">üì≠</div><div className="empty-s">Aucune activit√© pour l'instant</div></div>
              :recentActs.map((a,i)=>(
                <div key={i} className="act-item">
                  <div className={`act-ic ${a.cls}`}>{a.ic}</div>
                  <div><div className="act-text">{a.text}</div><div className="act-date">{a.date}</div></div>
                </div>
              ))
            }
          </div>
        </div>

        {/* Mes tontines r√©sum√© */}
        {mesTontines.length>0&&(
          <div className="card">
            <div className="card-title">ü§ù Mes tontines actives <span>({mesTontines.length})</span></div>
            <div className="gauto">
              {mesTontines.map(t=>{
                const moi=t.membres.find(m=>m.uid===user.id);
                return(
                  <div key={t.id} className="card-sm">
                    <div className="fcsb mb1">
                      <div className="bold t-sm">{t.nom}</div>
                      <SectorBadge secteur={t.secteur}/>
                    </div>
                    <div className="fcc gap1 t-xs t-muted mb2">
                      <span>üìç {t.region}</span>
                      <span>¬∑ {t.frequence}</span>
                    </div>
                    <div className="fcsb t-xs">
                      <span className="t-muted">Mon tour</span>
                      <span className="mono t-gold">N¬∞{moi?.tour} ¬∑ {moi?.pot?'‚úì Re√ßu':'En attente'}</span>
                    </div>
                    <div className="fcsb t-xs mt1">
                      <span className="t-muted">Pot mensuel</span>
                      <span className="mono t-lime">{(t.montantCotis*t.membres.length).toLocaleString('fr-FR')} FCFA</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Investissements actifs */}
        {mesInvests.length>0&&(
          <div className="card mt3">
            <div className="card-title">üíº Mes investissements <span>({mesInvests.length})</span></div>
            <div className="gauto">
              {mesInvests.map((inv,i)=>{
                const p=projets.find(x=>x.id===inv.projetId);
                if(!p)return null;
                return(
                  <div key={i} className="card-sm" style={{borderTop:`2px solid var(--gold)`}}>
                    <div className="bold t-sm mb1">{p.nom}</div>
                    <div className="fcsb t-xs mb2">
                      <span className="t-muted">Investi</span>
                      <span className="mono t-gold">{inv.montant.toLocaleString('fr-FR')} FCFA</span>
                    </div>
                    <div className="fcsb t-xs mb2">
                      <span className="t-muted">Retour attendu</span>
                      <span className="mono t-lime">+{inv.retourAttendu.toLocaleString('fr-FR')} FCFA</span>
                    </div>
                    <div className="fcsb t-xs">
                      <span className="t-muted">Rendement</span>
                      <span className="chip ch-gold">{p.rendementAnnuel}%/an</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ TONTINES ‚îÄ‚îÄ */
function Tontines({user,tontines,setTontines,toast}){
  const [modal,setModal]=useState(null);
  const [filterSec,setFilterSec]=useState('all');
  const [filterReg,setFilterReg]=useState('all');
  const [f,setF]=useState({nom:'',montant:'5000',frequence:'hebdomadaire',nbMax:'10',secteur:user.secteur||'agriculture',region:user.region,desc:''});

  const mesTontines=tontines.filter(t=>t.membres.some(m=>m.uid===user.id));
  const autresTontines=tontines.filter(t=>!t.membres.some(m=>m.uid===user.id));
  const filtered=autresTontines.filter(t=>(filterSec==='all'||t.secteur===filterSec)&&(filterReg==='all'||t.region===filterReg));

  const creer=()=>{
    if(!f.nom||!f.montant)return;
    const nt={
      id:'t_'+Date.now(),nom:f.nom,admin:user.id,secteur:f.secteur,region:f.region,
      montantCotis:+f.montant,frequence:f.frequence,nbMax:+f.nbMax,semaine:1,
      dateCreation:new Date().toISOString().slice(0,10),statut:'actif',description:f.desc,
      membres:[{uid:user.id,tour:1,pot:false}]
    };
    setTontines(p=>[...p,nt]);
    toast('Tontine "'+f.nom+'" cr√©√©e !');
    setModal(null);
  };

  const rejoindre=(tid)=>{
    setTontines(p=>p.map(t=>{
      if(t.id!==tid)return t;
      if(t.membres.some(m=>m.uid===user.id)){toast('D√©j√† membre','e');return t;}
      if(t.membres.length>=t.nbMax){toast('Tontine compl√®te','e');return t;}
      toast('Vous avez rejoint "'+t.nom+'" !');
      return{...t,membres:[...t.membres,{uid:user.id,tour:t.membres.length+1,pot:false}]};
    }));
  };

  const TCard=({t,membre})=>{
    const moi=t.membres.find(m=>m.uid===user.id);
    const isAdm=t.admin===user.id;
    const pct=Math.round(t.membres.length/t.nbMax*100);
    const pot=t.montantCotis*t.membres.length;
    return(
      <div className="card" style={{cursor:'default'}}>
        <div className="fcsb mb1">
          <div style={{fontFamily:'var(--f-d)',fontSize:'1.05rem',fontWeight:700,color:'var(--ink)'}}>{t.nom}</div>
          <div className="fcc gap1">
            {isAdm&&<span className="chip ch-gold">üëë Admin</span>}
            <span className={`chip ${t.statut==='actif'?'ch-lime':'ch-gray'}`}>{t.statut}</span>
          </div>
        </div>
        <div className="fcc gap2 mb2 t-xs t-muted">
          <SectorBadge secteur={t.secteur}/>
          <span className="region-chip">üìç {t.region}</span>
        </div>
        {t.description&&<div className="t-xs t-muted mb2" style={{lineHeight:1.65}}>{t.description}</div>}
        <div className="fcc gap2 mb2 t-xs t-muted flex-wrap">
          <span>üí∞ {t.montantCotis.toLocaleString('fr-FR')} FCFA/{t.frequence==='hebdomadaire'?'sem':'mois'}</span>
          <span>üë• {t.membres.length}/{t.nbMax} membres</span>
          <span>üìÖ Tour {t.semaine}</span>
        </div>
        <div className="mb2">
          <div className="fcsb t-xs mb1"><span className="t-muted">Remplissage</span><span className="mono t-lime">{pct}%</span></div>
          <PBar pct={pct}/>
        </div>
        <div className="fcsb">
          <div className="t-xs t-muted">
            Pot max : <strong className="t-gold">{pot.toLocaleString('fr-FR')} FCFA</strong>
            {moi&&<span className="ml1"> ¬∑ Tour N¬∞{moi.tour}</span>}
          </div>
          {!membre
            ?<button className="btn btn-green btn-sm" onClick={()=>rejoindre(t.id)}>Rejoindre ‚Üí</button>
            :<span className="chip ch-lime">‚úì Membre</span>
          }
        </div>
      </div>
    );
  };

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Tontines</div>
            <div className="ph-title">Tontines nationales</div>
            <div className="ph-sub">Agriculture ¬∑ √âlevage ¬∑ Mixte ¬∑ {tontines.length} tontines actives</div>
          </div>
          <div className="ph-actions">
            <button className="btn btn-lime" onClick={()=>setModal('creer')}>+ Cr√©er une tontine</button>
          </div>
        </div>
      </div>
      <div className="content">
        {mesTontines.length>0&&(
          <div className="mb3">
            <div className="bold t-sm t-muted mb2">Mes tontines ({mesTontines.length})</div>
            <div className="gauto">{mesTontines.map(t=><TCard key={t.id} t={t} membre={true}/>)}</div>
          </div>
        )}
        <div className="fcsb mb2 flex-wrap gap2">
          <div className="bold t-sm t-muted">Tontines disponibles ({filtered.length})</div>
          <div className="fcc gap1">
            <select className="btn btn-ghost btn-sm" value={filterSec} onChange={e=>setFilterSec(e.target.value)} style={{padding:'.35rem .7rem',background:'var(--s2)',border:'1px solid var(--border2)',borderRadius:'var(--r2)',color:'var(--ink2)',fontFamily:'var(--f-b)',fontSize:'.78rem'}}>
              <option value="all">Tous secteurs</option>
              {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
            </select>
            <select className="btn btn-ghost btn-sm" value={filterReg} onChange={e=>setFilterReg(e.target.value)} style={{padding:'.35rem .7rem',background:'var(--s2)',border:'1px solid var(--border2)',borderRadius:'var(--r2)',color:'var(--ink2)',fontFamily:'var(--f-b)',fontSize:'.78rem'}}>
              <option value="all">Toutes r√©gions</option>
              {REGIONS.map(r=><option key={r}>{r}</option>)}
            </select>
          </div>
        </div>
        {filtered.length>0
          ?<div className="gauto">{filtered.map(t=><TCard key={t.id} t={t} membre={false}/>)}</div>
          :<div className="empty"><div className="empty-ic">üîç</div><div className="empty-t">Aucune tontine trouv√©e</div><div className="empty-s">Modifiez les filtres ou cr√©ez la premi√®re tontine de votre r√©gion</div></div>
        }
      </div>

      {modal==='creer'&&(
        <Modal title="Cr√©er une tontine" onClose={()=>setModal(null)}>
          <div className="fg"><label>Nom de la tontine</label><input value={f.nom} onChange={e=>setF({...f,nom:e.target.value})} placeholder="Ex: √âleveurs du Ferlo"/></div>
          <div className="fr">
            <div className="fg"><label>Secteur</label>
              <select value={f.secteur} onChange={e=>setF({...f,secteur:e.target.value})}>
                {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
              </select>
            </div>
            <div className="fg"><label>R√©gion</label>
              <select value={f.region} onChange={e=>setF({...f,region:e.target.value})}>
                {REGIONS.map(r=><option key={r}>{r}</option>)}
              </select>
            </div>
          </div>
          <div className="fr">
            <div className="fg"><label>Cotisation (FCFA)</label><input type="number" value={f.montant} onChange={e=>setF({...f,montant:e.target.value})} placeholder="5000"/></div>
            <div className="fg"><label>Membres max</label><input type="number" value={f.nbMax} onChange={e=>setF({...f,nbMax:e.target.value})} placeholder="10"/></div>
          </div>
          <div className="fg"><label>Fr√©quence</label>
            <select value={f.frequence} onChange={e=>setF({...f,frequence:e.target.value})}>
              <option value="hebdomadaire">Hebdomadaire</option>
              <option value="mensuel">Mensuel</option>
              <option value="bimensuel">Bimensuel</option>
            </select>
          </div>
          <div className="fg"><label>Description</label><textarea value={f.desc} onChange={e=>setF({...f,desc:e.target.value})} placeholder="Objectif du groupe, types d'activit√©s..."/></div>
          <div className="frow-btns">
            <button className="btn btn-ghost" onClick={()=>setModal(null)}>Annuler</button>
            <button className="btn btn-lime" onClick={creer}>Cr√©er ‚Üí</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ COTISATIONS ‚îÄ‚îÄ */
function Cotisations({user,setUser,tontines,toast}){
  const [modal,setModal]=useState(null);
  const [sel,setSel]=useState('');
  const mesTontines=tontines.filter(t=>t.membres.some(m=>m.uid===user.id));

  const payer=()=>{
    if(!sel)return;
    const t=tontines.find(x=>x.id===sel);
    if(!t)return;
    const nc={id:'c_'+Date.now(),tontineId:sel,montant:t.montantCotis,statut:'payee',date:new Date().toISOString().slice(0,10)};
    setUser(u=>({...u,cotisations:[...u.cotisations,nc]}));
    toast('Cotisation de '+t.montantCotis.toLocaleString('fr-FR')+' FCFA enregistr√©e ! Score recalcul√©.');
    setModal(null);setSel('');
  };

  const all=user.cotisations.map(c=>{
    const t=tontines.find(x=>x.id===c.tontineId);
    return{...c,tontineName:t?.nom||'‚Äî',secteur:t?.secteur||'agriculture'};
  }).sort((a,b)=>new Date(b.date)-new Date(a.date));

  const totalP=all.filter(c=>c.statut==='payee').reduce((s,c)=>s+c.montant,0);
  const taux=all.length>0?Math.round(all.filter(c=>c.statut==='payee').length/all.length*100):0;
  const retards=all.filter(c=>c.statut==='retard').length;

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Cotisations</div>
            <div className="ph-title">Historique des paiements</div>
            <div className="ph-sub">{all.length} cotisation{all.length!==1?'s':''} ¬∑ Taux : {taux}%</div>
          </div>
          <button className="btn btn-lime" onClick={()=>setModal('payer')}>+ Enregistrer paiement</button>
        </div>
      </div>
      <div className="content">
        <div className="g3 mb3">
          <div className="stat"><div className="stat-ic">üí∞</div><div className="stat-val">{totalP.toLocaleString('fr-FR')}</div><div className="stat-lbl">Total cotis√© (FCFA)</div></div>
          <div className="stat">
            <div className="stat-ic">üìà</div><div className="stat-val">{taux}%</div><div className="stat-lbl">Taux de paiement</div>
            <div className="stat-sub"><span className={taux>=80?'up':'dn'}>{taux>=80?'‚úì Excellent':'‚ö† √Ä am√©liorer'}</span></div>
          </div>
          <div className="stat"><div className="stat-ic">‚ö†Ô∏è</div><div className="stat-val">{retards}</div><div className="stat-lbl">Retards (‚àí{retards*5} pts)</div></div>
        </div>
        {all.length===0
          ?<div className="empty"><div className="empty-ic">üí∏</div><div className="empty-t">Aucune cotisation</div><div className="empty-s">Enregistrez votre premi√®re cotisation pour commencer √† construire votre score IA</div></div>
          :<div className="card">
            <div className="card-title">Toutes les cotisations</div>
            <div className="tbl-wrap">
              <table>
                <thead><tr><th>Date</th><th>Tontine</th><th>Secteur</th><th>Montant</th><th>Statut</th></tr></thead>
                <tbody>{all.map(c=>(
                  <tr key={c.id}>
                    <td className="mono t-sm">{c.date}</td>
                    <td className="bold">{c.tontineName}</td>
                    <td><SectorBadge secteur={c.secteur}/></td>
                    <td className="mono t-gold">{c.montant.toLocaleString('fr-FR')} FCFA</td>
                    <td><span className={`chip ${c.statut==='payee'?'ch-lime':c.statut==='retard'?'ch-rust':'ch-gray'}`}>{c.statut}</span></td>
                  </tr>
                ))}</tbody>
              </table>
            </div>
          </div>
        }
      </div>

      {modal==='payer'&&(
        <Modal title="Enregistrer une cotisation" onClose={()=>setModal(null)}>
          <div className="info-box info-teal mb2">
            üí° En production : paiement d√©clench√© via <strong>Wave Mobile Money</strong>. Enregistrement instantan√©.
          </div>
          <div className="fg"><label>S√©lectionner la tontine</label>
            <select value={sel} onChange={e=>setSel(e.target.value)}>
              <option value="">‚Äî Choisir ‚Äî</option>
              {mesTontines.map(t=><option key={t.id} value={t.id}>{t.nom} ¬∑ {t.montantCotis.toLocaleString('fr-FR')} FCFA</option>)}
            </select>
          </div>
          {sel&&(
            <div className="card-sm mb2">
              <div className="fcsb t-sm mb1"><span className="t-muted">Montant</span><span className="mono t-gold">{tontines.find(t=>t.id===sel)?.montantCotis.toLocaleString('fr-FR')} FCFA</span></div>
              <div className="fcsb t-sm"><span className="t-muted">Date</span><span className="mono">{new Date().toISOString().slice(0,10)}</span></div>
            </div>
          )}
          <div className="frow-btns">
            <button className="btn btn-ghost" onClick={()=>setModal(null)}>Annuler</button>
            <button className="btn btn-lime" onClick={payer} disabled={!sel}>‚úì Confirmer</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ CR√âDITS INTRANTS ‚îÄ‚îÄ */
function Credits({user,setUser,toast}){
  const [modal,setModal]=useState(null);
  const [f,setF]=useState({intrant:'',montant:'',partenaire:'DER S√©n√©gal'});
  const score=calcScore(user);
  const plafond=score*1000;
  const eligible=score>=40;
  const credits=user.credits||[];

  const intrantsDispos=user.secteur==='elevage'?INTRANTS_ELEV:user.secteur==='agriculture'?INTRANTS_AGRI:[...INTRANTS_AGRI,...INTRANTS_ELEV];

  const demander=()=>{
    if(!eligible){toast('Score insuffisant (< 40)','e');return;}
    const m=+f.montant;
    if(!m||m<=0){toast('Montant invalide','e');return;}
    if(m>plafond){toast('D√©passe votre plafond : '+plafond.toLocaleString('fr-FR')+' FCFA','e');return;}
    if(!f.intrant){toast('Choisissez un intrant','e');return;}
    const nc={
      id:'cr_'+Date.now(),montant:m,intrant:f.intrant,partenaire:f.partenaire,
      statut:'approuve',scoreSnapshot:score,secteur:user.secteur,
      dateOctroi:new Date().toISOString().slice(0,10),
      dateEcheance:new Date(Date.now()+180*24*60*60*1000).toISOString().slice(0,10),
    };
    setUser(u=>({...u,credits:[...(u.credits||[]),nc]}));
    toast('‚úì Cr√©dit '+m.toLocaleString('fr-FR')+' FCFA approuv√© ! R√©cup√©rez vos '+f.intrant+'.');
    setModal(null);setF({intrant:'',montant:'',partenaire:'DER S√©n√©gal'});
  };

  const rembourser=(id)=>{
    setUser(u=>({...u,credits:u.credits.map(c=>c.id===id?{...c,statut:'rembourse'}:c)}));
    toast('‚úì Cr√©dit rembours√© ! +10 pts au prochain score.');
  };

  const actifs=credits.filter(c=>c.statut==='approuve');
  const hist=credits.filter(c=>c.statut!=='approuve');

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Cr√©dits intrants</div>
            <div className="ph-title">Financement {user.secteur==='elevage'?'√©levage':'agricole'}</div>
            <div className="ph-sub">Score {score}/100 ¬∑ Plafond : {plafond.toLocaleString('fr-FR')} FCFA ¬∑ <SectorBadge secteur={user.secteur}/></div>
          </div>
          {eligible&&<button className="btn btn-lime" onClick={()=>setModal('demander')}>+ Demander un cr√©dit</button>}
        </div>
      </div>
      <div className="content">
        <div className="g3 mb3">
          <div className="stat" style={{'--glow':eligible?'rgba(126,200,69,.07)':'rgba(196,74,42,.07)'}}>
            <div className="stat-ic">{eligible?'‚úÖ':'‚ùå'}</div>
            <div className="stat-val" style={{fontSize:'1.2rem',color:eligible?'var(--lime)':'var(--rust2)'}}>{eligible?'√âligible':'Non √©ligible'}</div>
            <div className="stat-lbl">Score {score}/100 ¬∑ Seuil : 40</div>
          </div>
          <div className="stat"><div className="stat-ic">üí≥</div><div className="stat-val">{plafond.toLocaleString('fr-FR')}</div><div className="stat-lbl">Plafond cr√©dit (FCFA)</div></div>
          <div className="stat"><div className="stat-ic">üìã</div><div className="stat-val">{credits.length}</div><div className="stat-lbl">Total cr√©dits</div></div>
        </div>

        {!eligible&&(
          <div className="info-box info-gold mb3">
            <strong>‚ö† Score insuffisant</strong> ‚Äî Score actuel : <strong>{score}/100</strong>. Minimum requis : <strong>40 points</strong>. Continuez √† cotiser ponctuellement pour augmenter votre score.
          </div>
        )}

        {actifs.length>0&&(
          <div className="card mb3">
            <div className="card-title">üü¢ Cr√©dits en cours</div>
            <div className="gauto">
              {actifs.map(cr=>(
                <div key={cr.id} className="card-sm" style={{borderTop:'2px solid var(--lime)'}}>
                  <div className="fcsb mb1">
                    <div className="t-gold bold" style={{fontFamily:'var(--f-d)',fontSize:'1.3rem'}}>{cr.montant.toLocaleString('fr-FR')} FCFA</div>
                    <span className="chip ch-lime">En cours</span>
                  </div>
                  <div className="t-xs t-muted mb1 uppercase" style={{letterSpacing:'.04em'}}>{cr.intrant} ¬∑ {cr.partenaire}</div>
                  <div className="t-xs t-muted mb1">Octroi : {cr.dateOctroi}</div>
                  <div className="t-xs t-muted mb1">√âch√©ance : <strong className="t-rust">{cr.dateEcheance}</strong></div>
                  <div className="t-xs t-muted mb2">Score snapshot : <span className="mono t-lime">{cr.scoreSnapshot}/100</span></div>
                  <button className="btn btn-green btn-sm w100" style={{justifyContent:'center'}} onClick={()=>rembourser(cr.id)}>‚úì Marquer rembours√©</button>
                </div>
              ))}
            </div>
          </div>
        )}

        {hist.length>0&&(
          <div className="card">
            <div className="card-title">Historique cr√©dits</div>
            <div className="tbl-wrap">
              <table>
                <thead><tr><th>Date</th><th>Intrant</th><th>Montant</th><th>Partenaire</th><th>Score</th><th>Statut</th></tr></thead>
                <tbody>{hist.map(cr=>(
                  <tr key={cr.id}>
                    <td className="mono t-sm">{cr.dateOctroi}</td>
                    <td>{cr.intrant}</td>
                    <td className="mono t-gold">{cr.montant.toLocaleString('fr-FR')}</td>
                    <td><span className="chip ch-blue">{cr.partenaire}</span></td>
                    <td className="mono t-lime">{cr.scoreSnapshot}</td>
                    <td><span className={`chip ${cr.statut==='rembourse'?'ch-lime':'ch-rust'}`}>{cr.statut}</span></td>
                  </tr>
                ))}</tbody>
              </table>
            </div>
          </div>
        )}

        {credits.length===0&&<div className="empty"><div className="empty-ic">üå±</div><div className="empty-t">Aucun cr√©dit</div><div className="empty-s">{eligible?'Vous √™tes √©ligible. Demandez votre premier cr√©dit intrants.':'Cotisez r√©guli√®rement pour construire votre score.'}</div></div>}
      </div>

      {modal==='demander'&&(
        <Modal title="Demander un cr√©dit intrants" onClose={()=>setModal(null)}>
          <div className="card-sm mb2">
            <div className="fcsb t-sm mb1"><span className="t-muted">Votre score</span><span className="mono t-lime">{score}/100</span></div>
            <div className="fcsb t-sm"><span className="t-muted">Plafond disponible</span><span className="mono t-gold">{plafond.toLocaleString('fr-FR')} FCFA</span></div>
          </div>
          <div className="fg"><label>Type d'intrant</label>
            <select value={f.intrant} onChange={e=>setF({...f,intrant:e.target.value})}>
              <option value="">‚Äî Choisir ‚Äî</option>
              {intrantsDispos.map(i=><option key={i}>{i}</option>)}
            </select>
          </div>
          <div className="fg"><label>Montant demand√© (FCFA)</label>
            <input type="number" value={f.montant} onChange={e=>setF({...f,montant:e.target.value})} placeholder={'Max : '+plafond.toLocaleString('fr-FR')}/>
          </div>
          <div className="fg"><label>Partenaire financeur</label>
            <select value={f.partenaire} onChange={e=>setF({...f,partenaire:e.target.value})}>
              {PARTENAIRES.map(p=><option key={p}>{p}</option>)}
            </select>
          </div>
          <div className="frow-btns">
            <button className="btn btn-ghost" onClick={()=>setModal(null)}>Annuler</button>
            <button className="btn btn-lime" onClick={demander}>Approuver ‚Üí</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INVESTISSEMENT (MODULE NOUVEAU)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Investissement({user,setUser,projets,setProjets,toast}){
  const [modal,setModal]=useState(null);
  const [selProjet,setSelProjet]=useState(null);
  const [montantInvest,setMontantInvest]=useState('');
  const [filterSec,setFilterSec]=useState('all');
  const [filterStatut,setFilterStatut]=useState('ouvert');
  const [filterRisque,setFilterRisque]=useState('all');
  const [showCreate,setShowCreate]=useState(false);
  const [fp,setFp]=useState({nom:'',region:'Dakar',secteur:'agriculture',objectif:'',desc:'',rendement:'12',duree:'18',risque:'modere',promoteur:user.nom});

  const mesInvests=user.investissements||[];
  const totalInvesti=mesInvests.reduce((s,i)=>s+i.montant,0);
  const totalRetour=mesInvests.reduce((s,i)=>s+i.retourAttendu,0);
  const score=calcScore(user);

  const projFiltres=projets.filter(p=>
    (filterSec==='all'||p.secteur===filterSec)&&
    (filterStatut==='all'||p.statut===filterStatut)&&
    (filterRisque==='all'||p.risque===filterRisque)
  );

  const investir=()=>{
    if(!selProjet)return;
    const m=+montantInvest;
    if(!m||m<10000){toast('Minimum 10 000 FCFA','e');return;}
    if(m>selProjet.objectif-selProjet.collecte){toast('D√©passe le besoin restant','e');return;}
    const retour=Math.round(m*(1+selProjet.rendementAnnuel/100*(selProjet.dureeMois/12)));
    const ni={projetId:selProjet.id,montant:m,date:new Date().toISOString().slice(0,10),retourAttendu:retour-m};
    setUser(u=>({...u,investissements:[...(u.investissements||[]),ni]}));
    setProjets(p=>p.map(x=>x.id===selProjet.id?{...x,collecte:x.collecte+m,investisseurs:x.investisseurs+1}:x));
    toast('‚úì Investissement de '+m.toLocaleString('fr-FR')+' FCFA confirm√© ! Retour attendu : +'+(retour-m).toLocaleString('fr-FR')+' FCFA');
    setModal(null);setMontantInvest('');setSelProjet(null);
  };

  const creerProjet=()=>{
    if(!fp.nom||!fp.objectif||!fp.desc)return;
    const np={
      id:'p_'+Date.now(),nom:fp.nom,promoteur:fp.promoteur,region:fp.region,secteur:fp.secteur,
      description:fp.desc,objectif:+fp.objectif,collecte:0,
      dateFinancement:new Date(Date.now()+120*24*60*60*1000).toISOString().slice(0,10),
      rendementAnnuel:+fp.rendement,dureeMois:+fp.duree,risque:fp.risque,
      investisseurs:0,statut:'ouvert',dateCreation:new Date().toISOString().slice(0,10),updates:[]
    };
    setProjets(p=>[...p,np]);
    toast('Projet "'+fp.nom+'" publi√© !');
    setShowCreate(false);
    setFp({nom:'',region:'Dakar',secteur:'agriculture',objectif:'',desc:'',rendement:'12',duree:'18',risque:'modere',promoteur:user.nom});
  };

  const risqueColor={faible:'var(--lime)',modere:'var(--gold2)',eleve:'var(--rust2)'};
  const risqueLabel={faible:'Faible',modere:'Mod√©r√©',eleve:'√âlev√©'};
  const risqueChip={faible:'ch-lime',modere:'ch-gold',eleve:'ch-rust'};

  const ProjetCard=({p})=>{
    const pct=Math.round(p.collecte/p.objectif*100);
    const restant=p.objectif-p.collecte;
    const dejaInvesti=mesInvests.some(i=>i.projetId===p.id);
    const colProj=p.secteur==='agriculture'?'var(--lime)':p.secteur==='elevage'?'var(--amber2)':'var(--teal2)';
    return(
      <div className="proj-card" style={{'--proj-color':colProj}}>
        <div className="fcc gap1 mb1 flex-wrap">
          <SectorBadge secteur={p.secteur}/>
          <span className="region-chip">üìç {p.region}</span>
          <span className={`chip ${risqueChip[p.risque]}`}>Risque {risqueLabel[p.risque]}</span>
          {p.statut==='finance'&&<span className="chip ch-teal">‚úì Financ√©</span>}
        </div>
        <div className="proj-name">{p.nom}</div>
        <div className="proj-promo">Par <strong>{p.promoteur}</strong> ¬∑ Cl√¥ture : {p.dateFinancement}</div>
        <div className="t-xs t-muted mb2" style={{lineHeight:1.65}}>{p.description}</div>
        <div className="proj-stats">
          <div className="proj-stat">
            <div className="proj-stat-val t-gold">{p.rendementAnnuel}%</div>
            <div className="proj-stat-lbl">Rendement/an</div>
          </div>
          <div className="proj-stat">
            <div className="proj-stat-val">{p.dureeMois}</div>
            <div className="proj-stat-lbl">Mois</div>
          </div>
          <div className="proj-stat">
            <div className="proj-stat-val">{p.investisseurs}</div>
            <div className="proj-stat-lbl">Investisseurs</div>
          </div>
        </div>
        <div className="proj-progress">
          <div className="proj-prog-head">
            <span className="t-muted">Collect√©</span>
            <span className="mono t-lime">{pct}% ¬∑ {p.collecte.toLocaleString('fr-FR')} FCFA</span>
          </div>
          <PBar pct={Math.min(pct,100)} color={risqueColor[p.risque]} h={6}/>
          <div className="fcsb t-xs t-muted mt1">
            <span>Objectif : {p.objectif.toLocaleString('fr-FR')} FCFA</span>
            <span>Reste : {restant.toLocaleString('fr-FR')} FCFA</span>
          </div>
        </div>
        {p.updates&&p.updates.length>0&&(
          <div className="t-xs t-muted mb2">
            <strong style={{color:'var(--ink2)'}}>Derni√®re update :</strong> {p.updates[p.updates.length-1]}
          </div>
        )}
        <div className="fcsb">
          <div className="t-xs t-muted">Min : 10 000 FCFA</div>
          {dejaInvesti
            ?<span className="chip ch-teal">‚úì Investi</span>
            :p.statut==='ouvert'
              ?<button className="btn btn-gold btn-sm" onClick={()=>{setSelProjet(p);setModal('investir');}}>üíº Investir ‚Üí</button>
              :<span className="chip ch-gray">Cl√¥tur√©</span>
          }
        </div>
      </div>
    );
  };

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Investissement</div>
            <div className="ph-title">Projets agricoles & √©levage</div>
            <div className="ph-sub">Investissez dans des projets v√©rifi√©s ¬∑ Rendement garanti ¬∑ Secteur agri-√©levage</div>
          </div>
          <div className="ph-actions">
            <button className="btn btn-ghost" onClick={()=>setShowCreate(!showCreate)}>{showCreate?'‚úï Annuler':'+ Soumettre un projet'}</button>
          </div>
        </div>
      </div>

      <div className="content">
        {/* Mes stats investissement */}
        <div className="g3 mb3">
          <div className="stat" style={{'--glow':'rgba(240,192,64,.08)'}}>
            <div className="stat-ic">üíº</div>
            <div className="stat-val">{totalInvesti.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Total investi (FCFA)</div>
          </div>
          <div className="stat" style={{'--glow':'rgba(126,200,69,.08)'}}>
            <div className="stat-ic">üìà</div>
            <div className="stat-val">+{totalRetour.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Retours attendus (FCFA)</div>
            <div className="stat-sub"><span className="up">‚Üë {mesInvests.length} projet{mesInvests.length!==1?'s':''}</span></div>
          </div>
          <div className="stat">
            <div className="stat-ic">üèÜ</div>
            <div className="stat-val">{projets.filter(p=>p.statut==='ouvert').length}</div>
            <div className="stat-lbl">Projets ouverts</div>
            <div className="stat-sub"><span className="neu">{projets.length} projets total</span></div>
          </div>
        </div>

        {/* Formulaire soumission projet */}
        {showCreate&&(
          <div className="card mb3" style={{borderColor:'var(--border3)'}}>
            <div className="card-title">üì§ Soumettre un projet √† financer</div>
            <div className="info-box info-teal mb2 t-sm">
              Votre projet sera visible par tous les membres d'AgriTontine+. D√©crivez-le pr√©cis√©ment pour attirer des investisseurs.
            </div>
            <div className="fr">
              <div className="fg"><label>Nom du projet</label><input value={fp.nom} onChange={e=>setFp({...fp,nom:e.target.value})} placeholder="Ex: Ferme avicole moderne"/></div>
              <div className="fg"><label>Promoteur</label><input value={fp.promoteur} onChange={e=>setFp({...fp,promoteur:e.target.value})}/></div>
            </div>
            <div className="fr">
              <div className="fg"><label>Secteur</label>
                <select value={fp.secteur} onChange={e=>setFp({...fp,secteur:e.target.value})}>
                  {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
                </select>
              </div>
              <div className="fg"><label>R√©gion</label>
                <select value={fp.region} onChange={e=>setFp({...fp,region:e.target.value})}>
                  {REGIONS.map(r=><option key={r}>{r}</option>)}
                </select>
              </div>
            </div>
            <div className="fg"><label>Description du projet</label><textarea value={fp.desc} onChange={e=>setFp({...fp,desc:e.target.value})} placeholder="D√©crivez votre projet, les d√©bouch√©s commerciaux, les garanties..."/></div>
            <div className="fr3">
              <div className="fg"><label>Objectif (FCFA)</label><input type="number" value={fp.objectif} onChange={e=>setFp({...fp,objectif:e.target.value})} placeholder="Ex: 5000000"/></div>
              <div className="fg"><label>Rendement/an (%)</label><input type="number" value={fp.rendement} onChange={e=>setFp({...fp,rendement:e.target.value})} min="5" max="30"/></div>
              <div className="fg"><label>Dur√©e (mois)</label><input type="number" value={fp.duree} onChange={e=>setFp({...fp,duree:e.target.value})} min="6" max="60"/></div>
            </div>
            <div className="fg"><label>Niveau de risque</label>
              <select value={fp.risque} onChange={e=>setFp({...fp,risque:e.target.value})}>
                <option value="faible">Faible (activit√© existante, revenus r√©guliers)</option>
                <option value="modere">Mod√©r√© (nouveau projet, march√© test√©)</option>
                <option value="eleve">√âlev√© (innovation, march√© √† cr√©er)</option>
              </select>
            </div>
            <div className="frow-btns">
              <button className="btn btn-ghost" onClick={()=>setShowCreate(false)}>Annuler</button>
              <button className="btn btn-gold" onClick={creerProjet}>Publier le projet ‚Üí</button>
            </div>
          </div>
        )}

        {/* Filtres */}
        <div className="fcsb mb2 flex-wrap gap2">
          <div className="bold t-sm t-muted">Projets disponibles ({projFiltres.length})</div>
          <div className="fcc gap1 flex-wrap">
            {[['all','Tous secteurs'],...SECTEURS.map(s=>[s.id,s.ic+' '+s.label])].map(([v,l])=>(
              <button key={v} className={`btn btn-xs ${filterSec===v?'btn-lime':'btn-ghost'}`} onClick={()=>setFilterSec(v)}>{l}</button>
            ))}
          </div>
        </div>
        <div className="fcc gap1 mb3 flex-wrap">
          {[['all','Tous statuts'],['ouvert','Ouverts'],['finance','Financ√©s']].map(([v,l])=>(
            <button key={v} className={`btn btn-xs ${filterStatut===v?'btn-green':'btn-ghost'}`} onClick={()=>setFilterStatut(v)}>{l}</button>
          ))}
          <span className="t-xs t-muted">¬∑</span>
          {[['all','Tout risque'],['faible','Risque faible'],['modere','Risque mod√©r√©'],['eleve','Risque √©lev√©']].map(([v,l])=>(
            <button key={v} className={`btn btn-xs ${filterRisque===v?'btn-gold':'btn-ghost'}`} onClick={()=>setFilterRisque(v)}>{l}</button>
          ))}
        </div>

        {projFiltres.length>0
          ?<div className="gauto">{projFiltres.map(p=><ProjetCard key={p.id} p={p}/>)}</div>
          :<div className="empty"><div className="empty-ic">üîç</div><div className="empty-t">Aucun projet</div><div className="empty-s">Modifiez les filtres ou soumettez le premier projet.</div></div>
        }

        {/* Mes investissements */}
        {mesInvests.length>0&&(
          <div className="card mt3">
            <div className="card-title">üíº Mes investissements ({mesInvests.length})</div>
            <div className="tbl-wrap">
              <table>
                <thead><tr><th>Projet</th><th>Secteur</th><th>Montant</th><th>Retour attendu</th><th>Date</th><th>Statut</th></tr></thead>
                <tbody>{mesInvests.map((inv,i)=>{
                  const p=projets.find(x=>x.id===inv.projetId);
                  return(
                    <tr key={i}>
                      <td className="bold">{p?.nom||'‚Äî'}</td>
                      <td>{p&&<SectorBadge secteur={p.secteur}/>}</td>
                      <td className="mono t-gold">{inv.montant.toLocaleString('fr-FR')} FCFA</td>
                      <td className="mono t-lime">+{inv.retourAttendu.toLocaleString('fr-FR')} FCFA</td>
                      <td className="mono t-sm">{inv.date}</td>
                      <td><span className={`chip ${p?.statut==='finance'?'ch-teal':'ch-gold'}`}>{p?.statut==='finance'?'Financ√©':'En cours'}</span></td>
                    </tr>
                  );
                })}</tbody>
              </table>
            </div>
          </div>
        )}
      </div>

      {modal==='investir'&&selProjet&&(
        <Modal title={'Investir ¬∑ '+selProjet.nom} onClose={()=>{setModal(null);setSelProjet(null);setMontantInvest('');}} lg>
          <div className="g2 mb2">
            <div>
              <div className="fcc gap1 mb1 flex-wrap">
                <SectorBadge secteur={selProjet.secteur}/>
                <span className={`chip ${risqueChip[selProjet.risque]}`}>Risque {risqueLabel[selProjet.risque]}</span>
              </div>
              <div className="t-sm t-muted mb2" style={{lineHeight:1.65}}>{selProjet.description}</div>
              <div className="card-sm">
                {[
                  ['Rendement annuel',selProjet.rendementAnnuel+'%','t-gold'],
                  ['Dur√©e',selProjet.dureeMois+' mois',''],
                  ['Collect√©',selProjet.collecte.toLocaleString('fr-FR')+' / '+selProjet.objectif.toLocaleString('fr-FR')+' FCFA','t-lime'],
                  ['Investisseurs',selProjet.investisseurs,''],
                  ['Cl√¥ture',selProjet.dateFinancement,''],
                ].map(([l,v,cls])=>(
                  <div key={l} className="fcsb t-sm mb1">
                    <span className="t-muted">{l}</span>
                    <span className={`mono bold ${cls}`}>{v}</span>
                  </div>
                ))}
              </div>
            </div>
            <div>
              <div className="fg"><label>Montant √† investir (FCFA)</label>
                <input type="number" value={montantInvest} onChange={e=>setMontantInvest(e.target.value)} placeholder="Min : 10 000 FCFA"/>
                <div className="fg-hint">Reste √† collecter : {(selProjet.objectif-selProjet.collecte).toLocaleString('fr-FR')} FCFA</div>
              </div>
              {montantInvest&&+montantInvest>=10000&&(
                <div className="card-sm">
                  <div className="t-xs t-muted bold mb1 uppercase" style={{letterSpacing:'.04em'}}>Simulation de retour</div>
                  <div className="fcsb t-sm mb1"><span className="t-muted">Capital investi</span><span className="mono">{(+montantInvest).toLocaleString('fr-FR')} FCFA</span></div>
                  <div className="fcsb t-sm mb1"><span className="t-muted">Retour total ({selProjet.dureeMois} mois)</span><span className="mono t-gold">{Math.round(+montantInvest*(1+selProjet.rendementAnnuel/100*(selProjet.dureeMois/12))).toLocaleString('fr-FR')} FCFA</span></div>
                  <div className="fcsb t-sm"><span className="t-muted">Gain net</span><span className="mono t-lime">+{Math.round(+montantInvest*(selProjet.rendementAnnuel/100*(selProjet.dureeMois/12))).toLocaleString('fr-FR')} FCFA</span></div>
                </div>
              )}
              <div className="info-box info-gold mt2 t-xs">
                ‚ö† Investissement √† risque. Les rendements affich√©s sont estimatifs. Lisez la description compl√®te du projet avant d'investir.
              </div>
            </div>
          </div>
          <div className="frow-btns">
            <button className="btn btn-ghost" onClick={()=>{setModal(null);setSelProjet(null);}}>Annuler</button>
            <button className="btn btn-gold" onClick={investir} disabled={!montantInvest||+montantInvest<10000}>üíº Confirmer l'investissement ‚Üí</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
function Admin({user,tontines,setTontines,toast}){
  const miens=tontines.filter(t=>t.admin===user.id);
  if(!miens.length)return(
    <div>
      <div className="ph"><div className="ph-tag">Administration</div><div className="ph-title">Espace admin</div></div>
      <div className="content"><div className="empty"><div className="empty-ic">üëë</div><div className="empty-t">Aucune tontine √† administrer</div><div className="empty-s">Cr√©ez une tontine dans l'onglet Tontines pour acc√©der √† l'espace admin.</div></div></div>
    </div>
  );
  return(
    <div>
      <div className="ph">
        <div className="ph-tag">Administration</div>
        <div className="ph-title">Tableau de bord admin</div>
        <div className="ph-sub">{miens.length} tontine{miens.length!==1?'s':''} √† g√©rer ¬∑ S√©n√©gal national</div>
      </div>
      <div className="content">
        {miens.map(t=>{
          const pot=t.montantCotis*t.membres.length;
          const pct=Math.round(t.membres.length/t.nbMax*100);
          return(
            <div key={t.id} className="card mb3">
              <div className="fcsb mb3">
                <div>
                  <div style={{fontFamily:'var(--f-d)',fontSize:'1.2rem',fontWeight:700}}>{t.nom}</div>
                  <div className="fcc gap1 mt1"><SectorBadge secteur={t.secteur}/><span className="region-chip">üìç {t.region}</span></div>
                </div>
                <span className={`chip ${t.statut==='actif'?'ch-lime':'ch-gray'}`}>{t.statut}</span>
              </div>
              <div className="g4 mb3">
                <div className="card-sm"><div className="t-xs t-muted mb1">Membres</div><div style={{fontFamily:'var(--f-d)',fontSize:'1.5rem',color:'var(--lime)'}}>{t.membres.length}/{t.nbMax}</div><PBar pct={pct} h={3}/></div>
                <div className="card-sm"><div className="t-xs t-muted mb1">Pot courant</div><div style={{fontFamily:'var(--f-d)',fontSize:'1.1rem',color:'var(--gold2)'}}>{pot.toLocaleString('fr-FR')}</div><div className="t-xs t-muted">FCFA</div></div>
                <div className="card-sm"><div className="t-xs t-muted mb1">Tour courant</div><div style={{fontFamily:'var(--f-d)',fontSize:'1.5rem'}}>{t.semaine}</div></div>
                <div className="card-sm"><div className="t-xs t-muted mb1">Ont re√ßu le pot</div><div style={{fontFamily:'var(--f-d)',fontSize:'1.5rem',color:'var(--lime)'}}>{t.membres.filter(m=>m.pot).length}/{t.membres.length}</div></div>
              </div>
              <div className="tbl-wrap">
                <table>
                  <thead><tr><th>Membre</th><th>Tour</th><th>Pot re√ßu</th><th>Statut</th><th>Action</th></tr></thead>
                  <tbody>{t.membres.map((m,i)=>(
                    <tr key={m.uid}>
                      <td className="bold">{m.nom||(m.uid===user.id?user.nom:'Membre '+(i+1))}</td>
                      <td><span className="chip ch-gray">N¬∞{m.tour}</span></td>
                      <td>{m.pot?<span className="chip ch-lime">‚úì Re√ßu</span>:<span className="chip ch-gray">En attente</span>}</td>
                      <td><span className="chip ch-lime">Actif</span></td>
                      <td>
                        <button className="btn btn-danger btn-xs" onClick={()=>toast('Retard marqu√© ‚Äî membre p√©nalis√©','i')}>Retard</button>
                      </td>
                    </tr>
                  ))}</tbody>
                </table>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ PROFIL ‚îÄ‚îÄ */
function Profil({user,setUser,toast}){
  const [edit,setEdit]=useState(false);
  const [f,setF]=useState({nom:user.nom,village:user.village,region:user.region,secteur:user.secteur});
  const score=calcScore(user);
  const next=score<40?40:score<65?65:100;

  const save=()=>{setUser(u=>({...u,...f}));setEdit(false);toast('Profil mis √† jour !');};

  return(
    <div>
      <div className="ph">
        <div className="ph-tag">Mon profil</div>
        <div className="ph-title">{user.nom}</div>
        <div className="ph-sub fcc gap1"><SectorBadge secteur={user.secteur}/><span className="region-chip">üìç {user.village}, {user.region}</span></div>
      </div>
      <div className="content">
        <div className="g2">
          <div className="card">
            <div className="card-title">Informations personnelles</div>
            {!edit?(
              <>
                {[['Nom',user.nom],['T√©l√©phone',user.telephone],['Village',user.village],['R√©gion',user.region],['Secteur',user.secteur],['R√¥le',user.role],['Inscription',user.dateInscription]].map(([l,v])=>(
                  <div key={l} className="fcsb" style={{padding:'.52rem 0',borderBottom:'1px solid var(--border)'}}>
                    <span className="t-xs t-muted">{l}</span><span className="t-sm bold">{v}</span>
                  </div>
                ))}
                <div className="mt2"><button className="btn btn-ghost btn-sm" onClick={()=>setEdit(true)}>‚úè Modifier</button></div>
              </>
            ):(
              <>
                <div className="fg"><label>Nom</label><input value={f.nom} onChange={e=>setF({...f,nom:e.target.value})}/></div>
                <div className="fg"><label>Village</label><input value={f.village} onChange={e=>setF({...f,village:e.target.value})}/></div>
                <div className="fg"><label>R√©gion</label><select value={f.region} onChange={e=>setF({...f,region:e.target.value})}>{REGIONS.map(r=><option key={r}>{r}</option>)}</select></div>
                <div className="fg"><label>Secteur</label><select value={f.secteur} onChange={e=>setF({...f,secteur:e.target.value})}>{SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}</select></div>
                <div className="frow-btns"><button className="btn btn-ghost" onClick={()=>setEdit(false)}>Annuler</button><button className="btn btn-lime" onClick={save}>Sauvegarder</button></div>
              </>
            )}
          </div>
          <div>
            <div className="card mb2">
              <div className="card-title">Score IA</div>
              <div className="fcc gap2 mb2">
                <ScoreRing score={score} sz={110} fsz="1.65rem"/>
                <div>
                  <span className={`chip ${score>=65?'ch-lime':score>=40?'ch-gold':'ch-rust'} mb1`} style={{display:'inline-flex'}}>{score>=65?'üåü Excellent':score>=40?'‚úÖ √âligible':'‚ö† Insuffisant'}</span>
                  <div className="t-xs t-muted mt1">Plafond : <strong className="t-gold">{(score*1000).toLocaleString('fr-FR')} FCFA</strong></div>
                  {score<100&&<div className="t-xs t-lime mt1">+{next-score} pts ‚Üí palier {next}</div>}
                </div>
              </div>
            </div>
            <div className="card">
              <div className="card-title">Statistiques</div>
              {[
                ['Cotisations totales',user.cotisations.length],
                ['Pay√©es',user.cotisations.filter(c=>c.statut==='payee').length],
                ['Retards',user.cotisations.filter(c=>c.statut==='retard').length],
                ['Tontines',(user.tontines||[]).length],
                ['Cr√©dits',(user.credits||[]).length],
                ['Rembours√©s',(user.credits||[]).filter(c=>c.statut==='rembourse').length],
                ['Investissements',(user.investissements||[]).length],
              ].map(([l,v])=>(
                <div key={l} className="fcsb" style={{padding:'.44rem 0',borderBottom:'1px solid var(--border)'}}>
                  <span className="t-xs t-muted">{l}</span><span className="mono t-sm t-lime">{v}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGIN ‚Äî avec Supabase
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MARCH√â CADRAN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Marche({user, toast}) {
  const [annonces, setAnnonces] = React.useState([]);
  const [offres, setOffres] = React.useState({});
  const [loading, setLoading] = React.useState(true);
  const [modal, setModal] = React.useState(null); // 'creer' | 'detail' | 'offre' | 'prix'
  const [selAnnonce, setSelAnnonce] = React.useState(null);
  const [filterCat, setFilterCat] = React.useState('all');
  const [filterReg, setFilterReg] = React.useState('all');
  const [filterType, setFilterType] = React.useState('all');
  const [searchQ, setSearchQ] = React.useState('');
  const [onglet, setOnglet] = React.useState('marche'); // marche | mesannonces | prix

  // Formulaire nouvelle annonce
  const [f, setF] = React.useState({
    type:'vente', categorie:'cereales', produit:'', description:'',
    quantite:'', unite:'kg', prix:'', region: user.region || 'Dakar',
    village: user.village || '', wave: user.telephone || '',
  });

  // Formulaire offre
  const [fOffre, setFOffre] = React.useState({montant:'', message:''});

  // Chargement annonces
  React.useEffect(()=>{
    load();
    // Realtime nouveaux produits
    const ch = sb.channel('rt_annonces')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'annonces'},
        async ()=>{ const a = await sbFetchAnnonces(); setAnnonces(a); toast('üõí Nouveau produit sur le march√© !','i'); })
      .subscribe();
    return ()=>sb.removeChannel(ch);
  },[]);

  const load = async () => {
    setLoading(true);
    const a = await sbFetchAnnonces();
    setAnnonces(a);
    setLoading(false);
  };

  const reload = async (filters) => {
    setLoading(true);
    const a = await sbFetchAnnonces(filters||{categorie:filterCat,region:filterReg,type:filterType});
    setAnnonces(a);
    setLoading(false);
  };

  // Publier une annonce
  const publier = async (e) => {
    e.preventDefault();
    if (!f.produit||!f.quantite||!f.prix) { toast('Remplissez tous les champs obligatoires','e'); return; }
    try {
      const a = await sbCreerAnnonce(user.id, f);
      setAnnonces(prev=>[a,...prev]);
      setModal(null);
      setF({type:'vente',categorie:'cereales',produit:'',description:'',quantite:'',unite:'kg',prix:'',region:user.region,village:user.village,wave:user.telephone});
      toast('‚úÖ Annonce publi√©e !');
    } catch(e) { toast('Erreur : '+e.message,'e'); }
  };

  // Voir d√©tail + charger offres
  const voirDetail = async (annonce) => {
    setSelAnnonce(annonce);
    setModal('detail');
    const o = await sbFetchOffres(annonce.id);
    setOffres(prev=>({...prev,[annonce.id]:o}));
  };

  // Faire une offre
  const soumettreOffre = async (e) => {
    e.preventDefault();
    if (!fOffre.montant) { toast('Indiquez votre prix','e'); return; }
    try {
      const o = await sbFaireOffre(selAnnonce.id, user.id, fOffre.montant, fOffre.message);
      setOffres(prev=>({...prev,[selAnnonce.id]:[o,...(prev[selAnnonce.id]||[])]}));
      setFOffre({montant:'',message:''});
      setModal('detail');
      toast('‚úÖ Offre envoy√©e ! Le vendeur sera notifi√©.');
    } catch(e) { toast('Erreur : '+e.message,'e'); }
  };

  // Accepter une offre
  const accepterOffre = async (offre) => {
    try {
      await sbAccepterOffre(offre.id, selAnnonce.id);
      setAnnonces(prev=>prev.map(a=>a.id===selAnnonce.id?{...a,statut:'vendue'}:a));
      setModal(null);
      toast('‚úÖ Offre accept√©e ! Contactez l\'acheteur via Wave.');
    } catch(e) { toast('Erreur : '+e.message,'e'); }
  };

  // G√©n√©rer lien Wave
  const waveLink = (tel, montant, produit) => {
    const num = tel.replace(/\D/g,'');
    return `https://pay.wave.com/m/${num}?amount=${montant}&note=${encodeURIComponent('AgriTontine+ : '+produit)}`;
  };

  // Prix du march√© ‚Äî agr√©gation locale
  const prixParProduit = React.useMemo(()=>{
    const map = {};
    annonces.filter(a=>a.type==='vente').forEach(a=>{
      if (!map[a.produit]) map[a.produit] = {produit:a.produit,categorie:a.categorie,prix:[],regions:new Set()};
      map[a.produit].prix.push(a.prix_unitaire);
      map[a.produit].regions.add(a.region);
    });
    return Object.values(map).map(p=>({
      ...p,
      prixMin: Math.min(...p.prix),
      prixMax: Math.max(...p.prix),
      prixMoy: Math.round(p.prix.reduce((a,b)=>a+b,0)/p.prix.length),
      nbOffres: p.prix.length,
      regions: [...p.regions],
    })).sort((a,b)=>b.nbOffres-a.nbOffres);
  },[annonces]);

  // Filtrage local
  const annoncesFiltrees = React.useMemo(()=>{
    let r = annonces;
    if (filterCat!=='all') r=r.filter(a=>a.categorie===filterCat);
    if (filterReg!=='all') r=r.filter(a=>a.region===filterReg);
    if (filterType!=='all') r=r.filter(a=>a.type===filterType);
    if (searchQ) r=r.filter(a=>a.produit.toLowerCase().includes(searchQ.toLowerCase())||a.description.toLowerCase().includes(searchQ.toLowerCase()));
    return r;
  },[annonces,filterCat,filterReg,filterType,searchQ]);

  const mesAnnonces = annonces.filter(a=>a.vendeur_id===user.id);

  const catInfo = (id) => CATEGORIES_MARCHE.find(c=>c.id===id)||{ic:'üì¶',label:id,cls:'ch-gray'};
  const prix = (n) => n ? n.toLocaleString('fr-FR')+' FCFA' : '‚Äî';

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">March√© Cadran</div>
        <div className="ph-title">üõí AgriTontine+ Market</div>
        <div className="ph-sub">Achetez et vendez vos produits agricoles ¬∑ Paiement Wave s√©curis√©</div>
      </div>

      {/* ONGLETS */}
      <div style={{padding:'0 1.25rem',display:'flex',gap:'.5rem',marginBottom:'1rem',borderBottom:'1px solid var(--border)'}}>
        {[['marche','üõí March√©'],['mesannonces','üìã Mes annonces'],['prix','üìä Prix du march√©']].map(([id,lbl])=>(
          <div key={id} onClick={()=>setOnglet(id)} style={{
            padding:'.5rem 1rem',cursor:'pointer',fontWeight:onglet===id?700:400,
            color:onglet===id?'var(--lime)':'var(--ink3)',
            borderBottom:onglet===id?'2px solid var(--lime)':'2px solid transparent',
            fontSize:'.85rem',whiteSpace:'nowrap',
          }}>{lbl}</div>
        ))}
      </div>

      <div className="content">

        {/* ‚ïê‚ïê‚ïê ONGLET MARCH√â ‚ïê‚ïê‚ïê */}
        {onglet==='marche' && <>
          {/* Filtres + Recherche */}
          <div style={{display:'flex',gap:'.5rem',flexWrap:'wrap',marginBottom:'1rem',alignItems:'center'}}>
            <input
              placeholder="üîç Rechercher un produit..."
              value={searchQ} onChange={e=>setSearchQ(e.target.value)}
              style={{flex:'1',minWidth:'160px',padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem'}}
            />
            <select value={filterType} onChange={e=>setFilterType(e.target.value)} style={{padding:'.5rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem'}}>
              <option value="all">Vente + Achat</option>
              <option value="vente">üü¢ Ventes</option>
              <option value="achat">üîµ Demandes achat</option>
            </select>
            <select value={filterCat} onChange={e=>setFilterCat(e.target.value)} style={{padding:'.5rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem'}}>
              <option value="all">Toutes cat√©gories</option>
              {CATEGORIES_MARCHE.map(c=><option key={c.id} value={c.id}>{c.ic} {c.label}</option>)}
            </select>
            <select value={filterReg} onChange={e=>setFilterReg(e.target.value)} style={{padding:'.5rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem'}}>
              <option value="all">Toutes r√©gions</option>
              {REGIONS.map(r=><option key={r}>{r}</option>)}
            </select>
            <button className="btn btn-lime btn-sm" onClick={()=>setModal('creer')}>+ Publier annonce</button>
          </div>

          {/* Stats rapides */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'.75rem',marginBottom:'1.25rem'}}>
            {[
              ['üõí',annoncesFiltrees.filter(a=>a.type==='vente').length,'Ventes actives'],
              ['üîµ',annoncesFiltrees.filter(a=>a.type==='achat').length,'Demandes achat'],
              ['üìç',new Set(annoncesFiltrees.map(a=>a.region)).size,'R√©gions actives'],
            ].map(([ic,val,lbl])=>(
              <div key={lbl} className="card" style={{padding:'.75rem',textAlign:'center'}}>
                <div style={{fontSize:'1.4rem'}}>{ic}</div>
                <div style={{fontWeight:700,fontSize:'1.3rem',color:'var(--lime)'}}>{val}</div>
                <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{lbl}</div>
              </div>
            ))}
          </div>

          {/* Liste annonces */}
          {loading ? <div className="t-muted t-sm" style={{textAlign:'center',padding:'2rem'}}>‚è≥ Chargement...</div>
          : annoncesFiltrees.length===0 ? (
            <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üõí</div>
              <div style={{fontWeight:600,marginBottom:'.25rem'}}>Aucune annonce</div>
              <div style={{fontSize:'.82rem'}}>Soyez le premier √† publier !</div>
              <button className="btn btn-lime btn-sm" style={{marginTop:'1rem'}} onClick={()=>setModal('creer')}>+ Publier une annonce</button>
            </div>
          ) : (
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:'1rem'}}>
              {annoncesFiltrees.map(a=>{
                const cat = catInfo(a.categorie);
                const isVente = a.type==='vente';
                const isMine = a.vendeur_id===user.id;
                return (
                  <div key={a.id} className="card" style={{cursor:'pointer',transition:'.15s',border:`1px solid ${isVente?'rgba(90,158,32,.25)':'rgba(21,101,192,.25)'}`}}
                    onClick={()=>voirDetail(a)}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'.5rem'}}>
                      <span className={`chip ${cat.cls}`} style={{fontSize:'.68rem'}}>{cat.ic} {cat.label}</span>
                      <span style={{fontSize:'.72rem',fontWeight:700,padding:'.2rem .5rem',borderRadius:'99px',
                        background:isVente?'rgba(90,158,32,.12)':'rgba(21,101,192,.12)',
                        color:isVente?'var(--lime)':'var(--blue2,#42a5f5)'}}>
                        {isVente?'üü¢ VENTE':'üîµ ACHAT'}
                      </span>
                    </div>
                    <div style={{fontWeight:700,fontSize:'1rem',color:'var(--ink)',marginBottom:'.25rem'}}>{a.produit}</div>
                    <div style={{fontSize:'1.3rem',fontWeight:900,color:'var(--lime)',marginBottom:'.25rem'}}>
                      {prix(a.prix_unitaire)} <span style={{fontSize:'.75rem',fontWeight:400,color:'var(--ink3)'}}>/ {a.unite}</span>
                    </div>
                    <div style={{fontSize:'.8rem',color:'var(--ink3)',marginBottom:'.5rem'}}>
                      üì¶ {a.quantite} {a.unite} ¬∑ üìç {a.village||''} {a.region}
                    </div>
                    {a.description&&<div style={{fontSize:'.78rem',color:'var(--ink4)',marginBottom:'.5rem',fontStyle:'italic'}}>{a.description}</div>}
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:'.5rem',paddingTop:'.5rem',borderTop:'1px solid var(--border)'}}>
                      <span style={{fontSize:'.75rem',color:'var(--ink3)'}}>üë§ {a.vendeur?.nom||'‚Äî'}</span>
                      {isMine
                        ? <span style={{fontSize:'.72rem',color:'var(--gold2)',fontWeight:600}}>üìã Mon annonce</span>
                        : <span style={{fontSize:'.75rem',color:'var(--teal2)',fontWeight:600}}>Faire une offre ‚Üí</span>
                      }
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </>}

        {/* ‚ïê‚ïê‚ïê ONGLET MES ANNONCES ‚ïê‚ïê‚ïê */}
        {onglet==='mesannonces' && <>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
            <div style={{fontWeight:700,color:'var(--ink)'}}>Mes annonces ({mesAnnonces.length})</div>
            <button className="btn btn-lime btn-sm" onClick={()=>setModal('creer')}>+ Nouvelle annonce</button>
          </div>
          {mesAnnonces.length===0 ? (
            <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üìã</div>
              <div>Vous n'avez pas encore d'annonce</div>
              <button className="btn btn-lime btn-sm" style={{marginTop:'1rem'}} onClick={()=>setModal('creer')}>Publier ma premi√®re annonce</button>
            </div>
          ) : mesAnnonces.map(a=>{
            const cat = catInfo(a.categorie);
            const offresAnnonce = offres[a.id]||[];
            return (
              <div key={a.id} className="card mb2" onClick={()=>voirDetail(a)} style={{cursor:'pointer'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.5rem'}}>
                  <div style={{fontWeight:700}}>{cat.ic} {a.produit}</div>
                  <span style={{fontSize:'.72rem',padding:'.2rem .6rem',borderRadius:'99px',fontWeight:700,
                    background:a.statut==='active'?'rgba(90,158,32,.15)':a.statut==='vendue'?'rgba(196,154,40,.15)':'rgba(196,74,42,.15)',
                    color:a.statut==='active'?'var(--lime)':a.statut==='vendue'?'var(--gold2)':'var(--rust2)'}}>
                    {a.statut==='active'?'‚úÖ Active':a.statut==='vendue'?'ü§ù Vendue':'‚ùå Cl√¥tur√©e'}
                  </span>
                </div>
                <div style={{display:'flex',gap:'1.5rem',fontSize:'.82rem',color:'var(--ink3)'}}>
                  <span>üí∞ {prix(a.prix_unitaire)}/{a.unite}</span>
                  <span>üì¶ {a.quantite} {a.unite}</span>
                  <span>üìç {a.region}</span>
                  <span>üëÅ {a.vues||0} vues</span>
                </div>
                {offresAnnonce.length>0&&(
                  <div style={{marginTop:'.5rem',padding:'.4rem .75rem',background:'rgba(196,154,40,.1)',borderRadius:'8px',fontSize:'.8rem',color:'var(--gold2)',fontWeight:600}}>
                    üí¨ {offresAnnonce.length} offre(s) re√ßue(s) ‚Äî Cliquez pour voir
                  </div>
                )}
              </div>
            );
          })}
        </>}

        {/* ‚ïê‚ïê‚ïê ONGLET PRIX DU MARCH√â ‚ïê‚ïê‚ïê */}
        {onglet==='prix' && <>
          <div style={{fontWeight:700,color:'var(--ink)',marginBottom:'1rem'}}>
            üìä Prix du march√© en temps r√©el ‚Äî {prixParProduit.length} produits
          </div>
          {prixParProduit.length===0 ? (
            <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              Aucune donn√©e de prix disponible ‚Äî publiez des annonces de vente
            </div>
          ) : (
            <div style={{overflowX:'auto'}}>
              <table style={{width:'100%',borderCollapse:'collapse',fontSize:'.83rem'}}>
                <thead>
                  <tr style={{background:'var(--card2,#f8f9f8)',borderBottom:'2px solid var(--border)'}}>
                    {['Produit','Cat√©gorie','Prix min','Prix moyen','Prix max','Offres','R√©gions'].map(h=>(
                      <th key={h} style={{padding:'.6rem .75rem',textAlign:'left',color:'var(--ink3)',fontWeight:600,fontSize:'.78rem'}}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {prixParProduit.map((p,i)=>{
                    const cat = catInfo(p.categorie);
                    return (
                      <tr key={p.produit} style={{borderBottom:'1px solid var(--border)',background:i%2===0?'transparent':'rgba(0,0,0,.02)'}}>
                        <td style={{padding:'.6rem .75rem',fontWeight:600,color:'var(--ink)'}}>{p.produit}</td>
                        <td style={{padding:'.6rem .75rem'}}><span className={`chip ${cat.cls}`} style={{fontSize:'.65rem'}}>{cat.ic} {cat.label}</span></td>
                        <td style={{padding:'.6rem .75rem',color:'var(--lime)',fontWeight:700}}>{prix(p.prixMin)}</td>
                        <td style={{padding:'.6rem .75rem',color:'var(--gold2)',fontWeight:700}}>{prix(p.prixMoy)}</td>
                        <td style={{padding:'.6rem .75rem',color:'var(--rust2)',fontWeight:700}}>{prix(p.prixMax)}</td>
                        <td style={{padding:'.6rem .75rem',textAlign:'center'}}><span className="chip ch-gray" style={{fontSize:'.7rem'}}>{p.nbOffres}</span></td>
                        <td style={{padding:'.6rem .75rem',fontSize:'.75rem',color:'var(--ink3)'}}>{p.regions.slice(0,3).join(', ')}{p.regions.length>3?'...':''}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </>}

      </div>{/* end content */}

      {/* ‚ïê‚ïê‚ïê MODAL CR√âER ANNONCE ‚ïê‚ïê‚ïê */}
      {modal==='creer' && (
        <div className="modal-overlay" onClick={()=>setModal(null)}>
          <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'520px'}}>
            <div className="modal-title">üì¢ Publier une annonce</div>
            <form onSubmit={publier}>
              {/* Type */}
              <div style={{display:'flex',gap:'.5rem',marginBottom:'1rem'}}>
                {[['vente','üü¢ Je vends'],['achat','üîµ Je cherche √† acheter']].map(([val,lbl])=>(
                  <div key={val} onClick={()=>setF(p=>({...p,type:val}))}
                    style={{flex:1,padding:'.6rem',borderRadius:'8px',cursor:'pointer',textAlign:'center',
                      fontWeight:f.type===val?700:400,fontSize:'.83rem',
                      background:f.type===val?(val==='vente'?'rgba(90,158,32,.15)':'rgba(21,101,192,.15)'):'var(--card2,#f5f5f5)',
                      border:`1px solid ${f.type===val?(val==='vente'?'var(--lime)':'#42a5f5'):'var(--border)'}`,
                      color:f.type===val?(val==='vente'?'var(--lime)':'#42a5f5'):'var(--ink3)'}}>
                    {lbl}
                  </div>
                ))}
              </div>
              {/* Cat√©gorie */}
              <div style={{display:'flex',gap:'.4rem',flexWrap:'wrap',marginBottom:'1rem'}}>
                {CATEGORIES_MARCHE.map(c=>(
                  <div key={c.id} onClick={()=>setF(p=>({...p,categorie:c.id}))}
                    className={`chip ${f.categorie===c.id?c.cls:'ch-gray'}`}
                    style={{cursor:'pointer',fontSize:'.75rem',opacity:f.categorie===c.id?1:.6}}>
                    {c.ic} {c.label}
                  </div>
                ))}
              </div>
              <div className="fg"><label>Produit *</label><input required value={f.produit} onChange={e=>setF(p=>({...p,produit:e.target.value}))} placeholder="Ex: Arachide coque, Mil souna, Bovin Z√©bu..."/></div>
              <div className="fg"><label>Description</label><input value={f.description} onChange={e=>setF(p=>({...p,description:e.target.value}))} placeholder="Qualit√©, r√©colte, √¢ge (b√©tail)..."/></div>
              <div className="fr">
                <div className="fg"><label>Quantit√© *</label><input required type="number" min="0.1" step="0.1" value={f.quantite} onChange={e=>setF(p=>({...p,quantite:e.target.value}))} placeholder="Ex: 500"/></div>
                <div className="fg"><label>Unit√©</label>
                  <select value={f.unite} onChange={e=>setF(p=>({...p,unite:e.target.value}))}>
                    {UNITES.map(u=><option key={u}>{u}</option>)}
                  </select>
                </div>
              </div>
              <div className="fg"><label>Prix unitaire (FCFA) *</label><input required type="number" min="1" value={f.prix} onChange={e=>setF(p=>({...p,prix:e.target.value}))} placeholder="Ex: 350 FCFA/kg"/></div>
              <div className="fr">
                <div className="fg"><label>R√©gion</label>
                  <select value={f.region} onChange={e=>setF(p=>({...p,region:e.target.value}))}>
                    {REGIONS.map(r=><option key={r}>{r}</option>)}
                  </select>
                </div>
                <div className="fg"><label>Village</label><input value={f.village} onChange={e=>setF(p=>({...p,village:e.target.value}))} placeholder="Ex: Touba Toul"/></div>
              </div>
              <div className="fg">
                <label>Num√©ro Wave pour paiement *</label>
                <input required value={f.wave} onChange={e=>setF(p=>({...p,wave:e.target.value}))} placeholder="+221 7X XXX XX XX"/>
                <div style={{fontSize:'.72rem',color:'var(--ink3)',marginTop:'.2rem'}}>Les acheteurs vous paieront directement via Wave sur ce num√©ro</div>
              </div>
              <div className="frow-btns">
                <button type="button" className="btn btn-ghost" onClick={()=>setModal(null)}>Annuler</button>
                <button type="submit" className="btn btn-lime">Publier l'annonce</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* ‚ïê‚ïê‚ïê MODAL D√âTAIL ANNONCE ‚ïê‚ïê‚ïê */}
      {modal==='detail' && selAnnonce && (()=>{
        const cat = catInfo(selAnnonce.categorie);
        const isMine = selAnnonce.vendeur_id === user.id;
        const offresAnnonce = offres[selAnnonce.id]||[];
        const total = selAnnonce.quantite * selAnnonce.prix_unitaire;
        const wLink = waveLink(selAnnonce.contact_wave||selAnnonce.vendeur?.telephone||'', total, selAnnonce.produit);
        return (
          <div className="modal-overlay" onClick={()=>setModal(null)}>
            <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'560px'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'1rem'}}>
                <div>
                  <span className={`chip ${cat.cls}`} style={{fontSize:'.72rem',marginBottom:'.4rem',display:'inline-flex'}}>{cat.ic} {cat.label}</span>
                  <div style={{fontWeight:800,fontSize:'1.2rem',color:'var(--ink)'}}>{selAnnonce.produit}</div>
                </div>
                <span style={{fontSize:'.75rem',fontWeight:700,padding:'.3rem .7rem',borderRadius:'99px',
                  background:selAnnonce.type==='vente'?'rgba(90,158,32,.12)':'rgba(21,101,192,.12)',
                  color:selAnnonce.type==='vente'?'var(--lime)':'#42a5f5'}}>
                  {selAnnonce.type==='vente'?'üü¢ VENTE':'üîµ ACHAT'}
                </span>
              </div>

              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.75rem',marginBottom:'1rem'}}>
                <div style={{background:'rgba(90,158,32,.08)',padding:'.75rem',borderRadius:'10px'}}>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>Prix unitaire</div>
                  <div style={{fontWeight:800,fontSize:'1.3rem',color:'var(--lime)'}}>{prix(selAnnonce.prix_unitaire)}</div>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>par {selAnnonce.unite}</div>
                </div>
                <div style={{background:'rgba(196,154,40,.08)',padding:'.75rem',borderRadius:'10px'}}>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>Quantit√© disponible</div>
                  <div style={{fontWeight:800,fontSize:'1.3rem',color:'var(--gold2)'}}>{selAnnonce.quantite}</div>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{selAnnonce.unite}</div>
                </div>
              </div>

              {selAnnonce.description&&<div style={{marginBottom:'1rem',padding:'.75rem',background:'var(--card2,#f5f5f5)',borderRadius:'8px',fontSize:'.83rem',color:'var(--ink3)'}}>{selAnnonce.description}</div>}

              <div style={{display:'flex',gap:'1rem',fontSize:'.82rem',color:'var(--ink3)',marginBottom:'1rem',flexWrap:'wrap'}}>
                <span>üë§ {selAnnonce.vendeur?.nom||'‚Äî'}</span>
                <span>üìç {selAnnonce.village||''} {selAnnonce.region}</span>
                <span>üìû {selAnnonce.vendeur?.telephone||'‚Äî'}</span>
              </div>

              {/* Actions */}
              {!isMine && selAnnonce.statut==='active' && (
                <div style={{display:'flex',gap:'.75rem',marginBottom:'1rem',flexWrap:'wrap'}}>
                  {/* Payer via Wave */}
                  <a href={wLink} target="_blank" rel="noopener noreferrer"
                    style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:'.4rem',
                      padding:'.7rem 1rem',borderRadius:'10px',background:'rgba(21,101,192,.1)',
                      color:'#42a5f5',fontWeight:700,fontSize:'.85rem',textDecoration:'none',
                      border:'1px solid rgba(21,101,192,.2)'}}>
                    üíô Payer via Wave<br/><span style={{fontSize:'.72rem',fontWeight:400}}>{prix(total)} total</span>
                  </a>
                  {/* Faire une offre */}
                  <button className="btn btn-lime" style={{flex:1}} onClick={()=>setModal('offre')}>
                    üí¨ Faire une offre
                  </button>
                </div>
              )}

              {/* Offres re√ßues (si vendeur) */}
              {isMine && offresAnnonce.length>0 && (
                <div style={{marginBottom:'1rem'}}>
                  <div style={{fontWeight:600,marginBottom:'.5rem',color:'var(--ink)'}}>üí¨ Offres re√ßues ({offresAnnonce.length})</div>
                  {offresAnnonce.map(o=>(
                    <div key={o.id} style={{padding:'.75rem',borderRadius:'8px',background:'var(--card2,#f5f5f5)',marginBottom:'.5rem',border:'1px solid var(--border)'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.25rem'}}>
                        <span style={{fontWeight:600,fontSize:'.85rem'}}>üë§ {o.acheteur?.nom||'‚Äî'}</span>
                        <span style={{fontWeight:700,color:'var(--lime)',fontSize:'.9rem'}}>{prix(o.montant)}</span>
                      </div>
                      {o.message&&<div style={{fontSize:'.78rem',color:'var(--ink3)',marginBottom:'.4rem'}}>{o.message}</div>}
                      <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                        <span style={{fontSize:'.72rem',color:'var(--ink3)'}}>{o.acheteur?.telephone}</span>
                        {o.statut==='en_attente' && (
                          <button className="btn btn-lime btn-sm" onClick={()=>accepterOffre(o)}>
                            ‚úÖ Accepter
                          </button>
                        )}
                        {o.statut==='acceptee' && <span style={{fontSize:'.75rem',color:'var(--lime)',fontWeight:700}}>‚úÖ Accept√©e</span>}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <button className="btn btn-ghost w100" onClick={()=>setModal(null)}>Fermer</button>
            </div>
          </div>
        );
      })()}

      {/* ‚ïê‚ïê‚ïê MODAL FAIRE UNE OFFRE ‚ïê‚ïê‚ïê */}
      {modal==='offre' && selAnnonce && (
        <div className="modal-overlay" onClick={()=>setModal('detail')}>
          <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'420px'}}>
            <div className="modal-title">üí¨ Faire une offre ‚Äî {selAnnonce.produit}</div>
            <div style={{padding:'.6rem .75rem',background:'rgba(90,158,32,.08)',borderRadius:'8px',marginBottom:'1rem',fontSize:'.82rem',color:'var(--ink3)'}}>
              Prix demand√© : <strong style={{color:'var(--lime)'}}>{prix(selAnnonce.prix_unitaire)}/{selAnnonce.unite}</strong>
            </div>
            <form onSubmit={soumettreOffre}>
              <div className="fg">
                <label>Votre prix offert (FCFA/{selAnnonce.unite}) *</label>
                <input required type="number" min="1" value={fOffre.montant} onChange={e=>setFOffre(p=>({...p,montant:e.target.value}))} placeholder={selAnnonce.prix_unitaire}/>
              </div>
              <div className="fg">
                <label>Message au vendeur</label>
                <input value={fOffre.message} onChange={e=>setFOffre(p=>({...p,message:e.target.value}))} placeholder="Ex: Prise en charge du transport, quantit√© souhait√©e..."/>
              </div>
              <div style={{fontSize:'.75rem',color:'var(--ink3)',marginBottom:'.75rem',padding:'.5rem',background:'rgba(196,154,40,.08)',borderRadius:'8px'}}>
                üíô Si le vendeur accepte, vous le payez directement via Wave sur son num√©ro <strong>{selAnnonce.contact_wave||selAnnonce.vendeur?.telephone}</strong>
              </div>
              <div className="frow-btns">
                <button type="button" className="btn btn-ghost" onClick={()=>setModal('detail')}>Retour</button>
                <button type="submit" className="btn btn-lime">Envoyer l'offre</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   OUTILS AGRICOLES ‚Äî Calculateur + M√©t√©o + Calendrier
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Donn√©es : Calendrier cultural S√©n√©gal ‚îÄ‚îÄ */
const CALENDRIER = {
  agriculture: [
    {culture:'Arachide',    semis:'Juin‚ÄìJuillet',     recolte:'Octobre‚ÄìNovembre', regions:['Diourbel','Kaolack','Kaffrine','Fatick','Thi√®s'],         conseil:'Semis d√®s les premi√®res pluies (50mm). Vari√©t√© 55-437 ou Fleur 11.'},
    {culture:'Mil',         semis:'Juillet',           recolte:'Octobre‚ÄìNovembre', regions:['Saint-Louis','Louga','Matam','Diourbel','Kaffrine'],       conseil:'D√©marier √† 1 plant/poquet √† 10 jours. Sarclage √† J+20 et J+40.'},
    {culture:'Ma√Øs',        semis:'Juillet‚ÄìAo√ªt',      recolte:'Octobre‚ÄìNovembre', regions:['Kolda','S√©dhiou','Ziguinchor','Tambacounda'],              conseil:'Apport NPK au semis + ur√©e √† la floraison. Irrigation possible.'},
    {culture:'Riz',         semis:'Juillet‚ÄìAo√ªt',      recolte:'Novembre‚ÄìD√©cembre',regions:['Saint-Louis','Ziguinchor','Kolda','S√©dhiou'],              conseil:'Repiquage √† 21 jours. Lame d'eau 5cm. Vari√©t√© ISRA Sahel 108.'},
    {culture:'Ni√©b√©',       semis:'Juillet‚ÄìAo√ªt',      recolte:'Octobre',          regions:['Thi√®s','Diourbel','Fatick','Kaolack'],                     conseil:'R√©sistant √† la s√©cheresse. Association mil-ni√©b√© recommand√©e.'},
    {culture:'Sorgho',      semis:'Juillet‚ÄìAo√ªt',      recolte:'Novembre',         regions:['Tambacounda','K√©dougou','Kolda','Matam'],                  conseil:'Tol√©rant au d√©ficit hydrique. Vari√©t√© locale CE180.'},
    {culture:'Tomate',      semis:'Novembre‚ÄìD√©cembre', recolte:'F√©vrier‚ÄìMars',     regions:['Saint-Louis','Thi√®s','Dakar'],                             conseil:'Saison froide optimale. Irrigation goutte-√†-goutte. Vari√©t√© Roma VF.'},
    {culture:'Oignon',      semis:'Octobre‚ÄìNovembre',  recolte:'Janvier‚ÄìMars',     regions:['Saint-Louis','Thi√®s','Louga'],                             conseil:'P√©pini√®re 6 semaines avant repiquage. Fumure organique essentielle.'},
    {culture:'Arachide de contre-saison', semis:'F√©vrier‚ÄìMars', recolte:'Juin',    regions:['Dakar','Thi√®s','Fatick'],                                  conseil:'N√©cessite irrigation. Vari√©t√© Fleur 11. Rentable si irrigation disponible.'},
  ],
  elevage: [
    {culture:'Bovins (v√™lage)',    semis:'Saison s√®che (Nov‚ÄìF√©v)',  recolte:'Toute l'ann√©e', regions:['Louga','Saint-Louis','Tambacounda','Matam'], conseil:'Suivi v√©t√©rinaire mensuel. Vaccination FVR en octobre.'},
    {culture:'Ovins (agnelage)',   semis:'Toute l'ann√©e',           recolte:'Avant Tabaski', regions:['Toutes r√©gions'],                            conseil:'Engraissement 3 mois avant Tabaski. Aliment compos√© + paille.'},
    {culture:'Volaille (poulet)',  semis:'Toute l'ann√©e',           recolte:'J+45 (chair)',  regions:['Toutes r√©gions'],                            conseil:'Bios√©curit√© stricte. Vaccination Newcastle √† J8 et J21.'},
    {culture:'Caprins (chevreau)', semis:'Octobre‚ÄìNovembre',         recolte:'Toute l'ann√©e',regions:['Kaolack','Diourbel','Fatick'],               conseil:'R√©sistants √† la chaleur. Vermifugation bi-annuelle.'},
  ],
};

/* ‚îÄ‚îÄ Donn√©es : Ravageurs et alertes ‚îÄ‚îÄ */
const ALERTES_RAVAGEURS = [
  {nom:'Criquet p√®lerin',    ic:'ü¶ó', niveau:'√©lev√©',  mois:['Ao√ªt','Septembre','Octobre'], cultures:['Mil','Sorgho','Ma√Øs','Riz'],   action:'Signaler imm√©diatement √† la DAGPN (+221 33 849 70 00). Ne pas traiter seul.'},
  {nom:'Chenille l√©gionnaire', ic:'üêõ', niveau:'√©lev√©', mois:['Juillet','Ao√ªt','Septembre'],cultures:['Ma√Øs','Mil','Sorgho'],         action:'Traitement Coragen ou Ampligo. Surveillance nocturne recommand√©e.'},
  {nom:'Pucerons arachide',  ic:'ü™≤', niveau:'moyen',  mois:['Ao√ªt','Septembre'],            cultures:['Arachide'],                   action:'Pulv√©risation Imidaclopride 200g/ha. √âviter les heures chaudes.'},
  {nom:'Mildiou oignon',     ic:'üçÑ', niveau:'moyen',  mois:['D√©cembre','Janvier','F√©vrier'],cultures:['Oignon','Tomate'],            action:'Fongicide Mancoz√®be. √âviter exc√®s d'humidit√©. Rotation culturale.'},
  {nom:'FMDV (Fi√®vre aphteuse)', ic:'üêÑ', niveau:'√©lev√©', mois:['Novembre','D√©cembre'],     cultures:['Bovins','Ovins'],              action:'Vaccination annuelle obligatoire. Quarantaine 21 jours. Signaler √† DIREL.'},
  {nom:'Newcastle volaille', ic:'üêì', niveau:'√©lev√©',  mois:['Toute l'ann√©e'],              cultures:['Volaille'],                   action:'Vaccination √† J8, rappel J21. Bios√©curit√© stricte. Mortalit√© 80% sans vaccin.'},
];

/* ‚îÄ‚îÄ Donn√©es : Rendements de r√©f√©rence S√©n√©gal ‚îÄ‚îÄ */
const RENDEMENTS_REF = {
  'Arachide':   {min:800,  moy:1200, max:2000, unite:'kg/ha', px_moy:350},
  'Mil':        {min:500,  moy:900,  max:1500, unite:'kg/ha', px_moy:200},
  'Ma√Øs':       {min:1500, moy:2500, max:4000, unite:'kg/ha', px_moy:180},
  'Riz':        {min:2000, moy:3500, max:6000, unite:'kg/ha', px_moy:250},
  'Ni√©b√©':      {min:400,  moy:700,  max:1200, unite:'kg/ha', px_moy:400},
  'Sorgho':     {min:500,  moy:900,  max:1500, unite:'kg/ha', px_moy:160},
  'Tomate':     {min:15000,moy:25000,max:40000,unite:'kg/ha', px_moy:100},
  'Oignon':     {min:10000,moy:18000,max:30000,unite:'kg/ha', px_moy:150},
  'Bovins':     {min:1,    moy:3,    max:6,    unite:'t√™tes/ha',px_moy:380000},
  'Ovins':      {min:3,    moy:6,    max:12,   unite:'t√™tes/ha',px_moy:80000},
  'Volaille':   {min:500,  moy:1000, max:2000, unite:'t√™tes/an',px_moy:4500},
};

/* ‚îÄ‚îÄ M√©t√©o : donn√©es statiques par r√©gion (√† remplacer par API OpenWeather) ‚îÄ‚îÄ */
const METEO_REGIONS = {
  'Dakar':       {temp:27, hum:75, pluie:'Jan‚ÄìMar : saison s√®che', vent:'Harmattan mod√©r√©',  conseil:'Irrigation indispensable nov‚Äìmai'},
  'Thi√®s':       {temp:28, hum:68, pluie:'Juil‚ÄìOct : 400‚Äì600mm',   vent:'Alize c√¥tier',      conseil:'Id√©al mara√Æchage oct‚Äìf√©v'},
  'Diourbel':    {temp:30, hum:55, pluie:'Juil‚ÄìSep : 500‚Äì700mm',   vent:'Harmattan fort',    conseil:'Zone arachidi√®re par excellence'},
  'Saint-Louis': {temp:26, hum:65, pluie:'Ao√ªt‚ÄìSep : 200‚Äì400mm',   vent:'Alize marin',       conseil:'Riz irrigu√© toute l'ann√©e possible'},
  'Louga':       {temp:31, hum:45, pluie:'Ao√ªt‚ÄìSep : 300‚Äì500mm',   vent:'Harmattan fort',    conseil:'√âlevage extensif bovin-ovin'},
  'Fatick':      {temp:29, hum:70, pluie:'Juil‚ÄìOct : 600‚Äì900mm',   vent:'Mod√©r√©',            conseil:'Ni√©b√© + arachide + mara√Æchage'},
  'Kaolack':     {temp:31, hum:60, pluie:'Juil‚ÄìOct : 600‚Äì900mm',   vent:'Mod√©r√©',            conseil:'Capital arachidier du S√©n√©gal'},
  'Ziguinchor':  {temp:28, hum:85, pluie:'Jun‚ÄìOct : 1200‚Äì1600mm',  vent:'Faible',            conseil:'Riziculture + fruits tropicaux'},
  'Tambacounda': {temp:33, hum:50, pluie:'Juil‚ÄìOct : 700‚Äì1000mm',  vent:'Harmattan',         conseil:'Ma√Øs + sorgho + √©levage bovin'},
  'K√©dougou':    {temp:30, hum:75, pluie:'Mai‚ÄìNov : 1200‚Äì1600mm',  vent:'Faible',            conseil:'Zone la plus arros√©e du S√©n√©gal'},
  'Kolda':       {temp:29, hum:80, pluie:'Jun‚ÄìOct : 1000‚Äì1400mm',  vent:'Faible',            conseil:'Ma√Øs + riz + √©levage'},
  'S√©dhiou':     {temp:28, hum:82, pluie:'Jun‚ÄìOct : 1100‚Äì1500mm',  vent:'Faible',            conseil:'Riziculture + mangues'},
  'Kaffrine':    {temp:32, hum:52, pluie:'Juil‚ÄìSep : 600‚Äì800mm',   vent:'Harmattan',         conseil:'Arachide + mil + sorgho'},
  'Matam':       {temp:34, hum:40, pluie:'Ao√ªt‚ÄìSep : 300‚Äì500mm',   vent:'Harmattan fort',    conseil:'√âlevage + cultures irrigu√©es bord fleuve'},
  'Podor':       {temp:35, hum:35, pluie:'Ao√ªt‚ÄìSep : 200‚Äì350mm',   vent:'Harmattan tr√®s fort',conseil:'Cultures de d√©crues + √©levage camelin'},
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMPOSANT OUTILS AGRICOLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function OutilsAgricoles({user, toast}) {
  const [onglet, setOnglet] = React.useState('calculateur');
  const regionUser = user.region || 'Dakar';
  const secteurUser = user.secteur || 'agriculture';
  const moisCourant = new Date().toLocaleString('fr-FR',{month:'long'}).charAt(0).toUpperCase()+new Date().toLocaleString('fr-FR',{month:'long'}).slice(1);

  // ‚îÄ‚îÄ CALCULATEUR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [calc, setCalc] = React.useState({
    culture: 'Arachide',
    superficie: '',
    rendement: '',
    prixVente: '',
    coutSemences: '',
    coutIntrants: '',
    coutMain: '',
    coutAutres: '',
  });
  const [resultat, setResultat] = React.useState(null);

  const refCulture = RENDEMENTS_REF[calc.culture] || RENDEMENTS_REF['Arachide'];

  const calculer = (e) => {
    e.preventDefault();
    const S = parseFloat(calc.superficie) || 0;
    const R = parseFloat(calc.rendement) || refCulture.moy;
    const Px = parseFloat(calc.prixVente) || refCulture.px_moy;
    const cS = parseFloat(calc.coutSemences) || 0;
    const cI = parseFloat(calc.coutIntrants) || 0;
    const cM = parseFloat(calc.coutMain) || 0;
    const cA = parseFloat(calc.coutAutres) || 0;
    if (!S) { toast('Entrez la superficie','e'); return; }
    const production = S * R;
    const revenus = production * Px;
    const charges = (cS + cI + cM + cA) * S;
    const benefice = revenus - charges;
    const rentabilite = charges > 0 ? Math.round((benefice / charges) * 100) : 0;
    const roi = charges > 0 ? Math.round((revenus / charges - 1) * 100) : 0;
    setResultat({ production, revenus, charges, benefice, rentabilite, roi, S, R, Px });
  };

  // ‚îÄ‚îÄ M√âT√âO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [regionMeteo, setRegionMeteo] = React.useState(regionUser);
  const meteo = METEO_REGIONS[regionMeteo] || METEO_REGIONS['Dakar'];

  // ‚îÄ‚îÄ CALENDRIER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [filterRegion, setFilterRegion] = React.useState('all');
  const [filterSecteur, setFilterSecteur] = React.useState(secteurUser);
  const calData = CALENDRIER[filterSecteur] || CALENDRIER.agriculture;
  const calFiltre = filterRegion==='all' ? calData : calData.filter(c=>c.regions.some(r=>r.includes(filterRegion)||filterRegion.includes(r)));
  const moisEnCours = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][new Date().getMonth()];

  // ‚îÄ‚îÄ ALERTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const alertesMois = ALERTES_RAVAGEURS.filter(a=>
    a.mois.includes(moisEnCours) || a.mois.includes('Toute l'ann√©e')
  );

  const prix = (n) => n ? Math.round(n).toLocaleString('fr-FR')+' FCFA' : '‚Äî';

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Outils Agricoles</div>
        <div className="ph-title">üåæ AgriTools ‚Äî Optimisez vos cultures</div>
        <div className="ph-sub">Calculateur ¬∑ M√©t√©o ¬∑ Calendrier ¬∑ Alertes ravageurs</div>
      </div>

      {/* ONGLETS */}
      <div style={{padding:'0 1.25rem',display:'flex',gap:'.4rem',flexWrap:'wrap',marginBottom:'1rem',borderBottom:'1px solid var(--border)'}}>
        {[
          ['calculateur','üßÆ Calculateur'],
          ['meteo','üå§ M√©t√©o'],
          ['calendrier','üìÖ Calendrier'],
          ['alertes','‚ö† Alertes'],
        ].map(([id,lbl])=>(
          <div key={id} onClick={()=>setOnglet(id)} style={{
            padding:'.5rem .9rem',cursor:'pointer',fontWeight:onglet===id?700:400,
            color:onglet===id?'var(--lime)':'var(--ink3)',
            borderBottom:onglet===id?'2px solid var(--lime)':'2px solid transparent',
            fontSize:'.83rem',whiteSpace:'nowrap',
          }}>{lbl}</div>
        ))}
      </div>

      <div className="content">

        {/* ‚ïê‚ïê‚ïê CALCULATEUR RENDEMENT & RENTABILIT√â ‚ïê‚ïê‚ïê */}
        {onglet==='calculateur' && (
          <div className="g2">
            <div className="card">
              <div className="card-title">üßÆ Calculateur de rentabilit√©</div>
              <form onSubmit={calculer}>
                {/* Culture */}
                <div className="fg">
                  <label>Culture / √âlevage</label>
                  <select value={calc.culture} onChange={e=>setCalc(p=>({...p,culture:e.target.value,rendement:'',prixVente:''}))}>
                    {Object.keys(RENDEMENTS_REF).map(c=><option key={c}>{c}</option>)}
                  </select>
                </div>

                {/* R√©f√©rence */}
                <div style={{padding:'.6rem .75rem',background:'rgba(90,158,32,.08)',borderRadius:'8px',marginBottom:'1rem',fontSize:'.8rem'}}>
                  <div style={{fontWeight:600,color:'var(--lime)',marginBottom:'.3rem'}}>üìä R√©f√©rence {calc.culture} ‚Äî S√©n√©gal</div>
                  <div style={{display:'flex',gap:'1rem',flexWrap:'wrap',color:'var(--ink3)'}}>
                    <span>Min : <strong>{refCulture.min.toLocaleString('fr-FR')} {refCulture.unite}</strong></span>
                    <span>Moyen : <strong style={{color:'var(--lime)'}}>{refCulture.moy.toLocaleString('fr-FR')} {refCulture.unite}</strong></span>
                    <span>Max : <strong>{refCulture.max.toLocaleString('fr-FR')} {refCulture.unite}</strong></span>
                    <span>Prix moy : <strong style={{color:'var(--gold2)'}}>{refCulture.px_moy.toLocaleString('fr-FR')} FCFA/{refCulture.unite.split('/')[1]||'unit√©'}</strong></span>
                  </div>
                </div>

                <div className="fr">
                  <div className="fg">
                    <label>Superficie (ha) *</label>
                    <input required type="number" min="0.1" step="0.1" placeholder="Ex: 2.5" value={calc.superficie} onChange={e=>setCalc(p=>({...p,superficie:e.target.value}))}/>
                  </div>
                  <div className="fg">
                    <label>Rendement estim√© ({refCulture.unite})</label>
                    <input type="number" min="1" placeholder={`D√©faut: ${refCulture.moy.toLocaleString('fr-FR')}`} value={calc.rendement} onChange={e=>setCalc(p=>({...p,rendement:e.target.value}))}/>
                  </div>
                </div>
                <div className="fg">
                  <label>Prix de vente (FCFA/{refCulture.unite.split('/')[1]||'unit√©'})</label>
                  <input type="number" min="1" placeholder={`D√©faut: ${refCulture.px_moy.toLocaleString('fr-FR')}`} value={calc.prixVente} onChange={e=>setCalc(p=>({...p,prixVente:e.target.value}))}/>
                </div>

                <div style={{fontWeight:600,fontSize:'.82rem',color:'var(--ink3)',margin:'.75rem 0 .4rem'}}>Charges par hectare (FCFA/ha)</div>
                <div className="fr">
                  <div className="fg"><label>Semences/G√©niteurs</label><input type="number" min="0" placeholder="0" value={calc.coutSemences} onChange={e=>setCalc(p=>({...p,coutSemences:e.target.value}))}/></div>
                  <div className="fg"><label>Intrants/Aliments</label><input type="number" min="0" placeholder="0" value={calc.coutIntrants} onChange={e=>setCalc(p=>({...p,coutIntrants:e.target.value}))}/></div>
                </div>
                <div className="fr">
                  <div className="fg"><label>Main d'≈ìuvre</label><input type="number" min="0" placeholder="0" value={calc.coutMain} onChange={e=>setCalc(p=>({...p,coutMain:e.target.value}))}/></div>
                  <div className="fg"><label>Autres charges</label><input type="number" min="0" placeholder="0" value={calc.coutAutres} onChange={e=>setCalc(p=>({...p,coutAutres:e.target.value}))}/></div>
                </div>
                <button type="submit" className="btn btn-lime w100" style={{justifyContent:'center',marginTop:'.5rem'}}>Calculer la rentabilit√© ‚Üí</button>
              </form>
            </div>

            {/* R√©sultats */}
            <div>
              {resultat ? (<>
                <div className="card mb2" style={{border:`2px solid ${resultat.benefice>=0?'var(--lime)':'var(--rust2)'}`}}>
                  <div className="card-title">{resultat.benefice>=0?'‚úÖ':'‚ö†'} R√©sultat ‚Äî {calc.culture}</div>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.75rem',marginBottom:'1rem'}}>
                    {[
                      ['Production totale', (resultat.production).toLocaleString('fr-FR')+' '+refCulture.unite.split('/')[0], 'var(--ink)'],
                      ['Revenus bruts', prix(resultat.revenus), 'var(--lime)'],
                      ['Total charges', prix(resultat.charges), 'var(--rust2)'],
                      ['B√©n√©fice net', prix(resultat.benefice), resultat.benefice>=0?'var(--lime)':'var(--rust2)'],
                    ].map(([lbl,val,col])=>(
                      <div key={lbl} style={{padding:'.75rem',background:'var(--card2,#f5f5f5)',borderRadius:'10px'}}>
                        <div style={{fontSize:'.72rem',color:'var(--ink3)',marginBottom:'.2rem'}}>{lbl}</div>
                        <div style={{fontWeight:800,fontSize:'1.05rem',color:col}}>{val}</div>
                      </div>
                    ))}
                  </div>
                  <div style={{display:'flex',gap:'1rem',justifyContent:'center',flexWrap:'wrap'}}>
                    <div style={{textAlign:'center',padding:'.75rem 1.25rem',background:resultat.roi>=0?'rgba(90,158,32,.1)':'rgba(196,74,42,.1)',borderRadius:'10px'}}>
                      <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>Retour sur investissement</div>
                      <div style={{fontWeight:800,fontSize:'1.5rem',color:resultat.roi>=0?'var(--lime)':'var(--rust2)'}}>{resultat.roi}%</div>
                    </div>
                    <div style={{textAlign:'center',padding:'.75rem 1.25rem',background:'rgba(196,154,40,.1)',borderRadius:'10px'}}>
                      <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>B√©n√©fice / ha</div>
                      <div style={{fontWeight:800,fontSize:'1.5rem',color:'var(--gold2)'}}>{prix(resultat.benefice/resultat.S)}</div>
                    </div>
                  </div>
                </div>

                {/* Conseil selon rentabilit√© */}
                <div className="card" style={{background:resultat.roi>=50?'rgba(90,158,32,.06)':resultat.roi>=0?'rgba(196,154,40,.06)':'rgba(196,74,42,.06)'}}>
                  <div style={{fontWeight:700,marginBottom:'.4rem'}}>
                    {resultat.roi>=50?'üåü Excellente rentabilit√©':resultat.roi>=20?'‚úÖ Bonne rentabilit√©':resultat.roi>=0?'‚ö† Rentabilit√© faible':'‚ùå D√©ficitaire'}
                  </div>
                  <div style={{fontSize:'.83rem',color:'var(--ink3)',lineHeight:1.6}}>
                    {resultat.roi>=50 && 'Votre exploitation est tr√®s rentable. Envisagez d'agrandir la superficie ou d'investir dans du mat√©riel.'}
                    {resultat.roi>=20 && resultat.roi<50 && 'Rentabilit√© correcte. Optimisez vos charges (groupement d'achats d'intrants) pour am√©liorer la marge.'}
                    {resultat.roi>=0 && resultat.roi<20 && 'Marge faible. Cherchez √† augmenter le prix de vente via le March√© Cadran ou r√©duire les intrants.'}
                    {resultat.roi<0 && 'Attention, cette campagne est d√©ficitaire selon vos estimations. V√©rifiez vos charges ou le prix de vente cible.'}
                  </div>
                  {resultat.charges===0&&<div style={{marginTop:'.5rem',fontSize:'.8rem',color:'var(--ink4)'}}>üí° Entrez vos charges pour un calcul plus pr√©cis</div>}
                </div>
              </>) : (
                <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
                  <div style={{fontSize:'2.5rem',marginBottom:'.75rem'}}>üßÆ</div>
                  <div style={{fontWeight:600,marginBottom:'.4rem'}}>Estimez votre rentabilit√©</div>
                  <div style={{fontSize:'.83rem'}}>Entrez votre superficie et vos charges pour voir votre b√©n√©fice estim√©</div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê M√âT√âO PAR R√âGION ‚ïê‚ïê‚ïê */}
        {onglet==='meteo' && (<>
          <div style={{marginBottom:'1rem'}}>
            <select value={regionMeteo} onChange={e=>setRegionMeteo(e.target.value)}
              style={{padding:'.6rem 1rem',borderRadius:'10px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.9rem',width:'100%',maxWidth:'300px'}}>
              {REGIONS.map(r=><option key={r}>{r}</option>)}
            </select>
          </div>

          {/* Carte m√©t√©o r√©gion */}
          <div className="card mb2" style={{background:'linear-gradient(135deg,rgba(26,122,110,.12),rgba(90,158,32,.08))'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'1rem'}}>
              <div>
                <div style={{fontWeight:800,fontSize:'1.3rem',color:'var(--ink)'}}>üìç {regionMeteo}</div>
                <div style={{fontSize:'.82rem',color:'var(--ink3)',marginTop:'.2rem'}}>Donn√©es climatiques de r√©f√©rence</div>
              </div>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:'2.5rem',fontWeight:900,color:'var(--amber2,#f59f00)'}}>{meteo.temp}¬∞C</div>
                <div style={{fontSize:'.75rem',color:'var(--ink3)'}}>Temp. moyenne</div>
              </div>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1rem'}}>
              {[
                ['üíß Humidit√©', meteo.hum+'%'],
                ['üåß Pluies', meteo.pluie],
                ['üí® Vent', meteo.vent],
              ].map(([lbl,val])=>(
                <div key={lbl} style={{padding:'.75rem',background:'rgba(255,255,255,.5)',borderRadius:'8px'}}>
                  <div style={{fontSize:'.75rem',color:'var(--ink3)',marginBottom:'.2rem'}}>{lbl}</div>
                  <div style={{fontWeight:600,fontSize:'.9rem',color:'var(--ink)'}}>{val}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Conseil agricole */}
          <div className="card mb2" style={{background:'rgba(90,158,32,.06)',border:'1px solid rgba(90,158,32,.2)'}}>
            <div style={{fontWeight:700,color:'var(--lime)',marginBottom:'.5rem'}}>üåæ Conseil agricole pour {regionMeteo}</div>
            <div style={{fontSize:'.87rem',color:'var(--ink)',lineHeight:1.7}}>{meteo.conseil}</div>
          </div>

          {/* Cultures recommand√©es pour cette r√©gion */}
          <div className="card">
            <div className="card-title">üå± Cultures recommand√©es pour {regionMeteo}</div>
            {CALENDRIER.agriculture.filter(c=>c.regions.some(r=>r.includes(regionMeteo)||regionMeteo.includes(r))).length===0
              ? <div style={{color:'var(--ink3)',fontSize:'.85rem'}}>Consultez un agronome local pour des recommandations sp√©cifiques.</div>
              : CALENDRIER.agriculture.filter(c=>c.regions.some(r=>r.includes(regionMeteo)||regionMeteo.includes(r))).map(c=>(
                <div key={c.culture} style={{padding:'.6rem 0',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center',gap:'1rem'}}>
                  <div>
                    <div style={{fontWeight:600,fontSize:'.88rem',color:'var(--ink)'}}>{c.culture}</div>
                    <div style={{fontSize:'.76rem',color:'var(--ink3)'}}>Semis : {c.semis} ¬∑ R√©colte : {c.recolte}</div>
                  </div>
                  <span className="chip ch-lime" style={{fontSize:'.7rem',whiteSpace:'nowrap'}}>‚úÖ Adapt√©</span>
                </div>
              ))
            }
          </div>
        </>)}

        {/* ‚ïê‚ïê‚ïê CALENDRIER CULTURAL ‚ïê‚ïê‚ïê */}
        {onglet==='calendrier' && (<>
          <div style={{display:'flex',gap:'.5rem',marginBottom:'1rem',flexWrap:'wrap'}}>
            <select value={filterSecteur} onChange={e=>setFilterSecteur(e.target.value)}
              style={{padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem'}}>
              <option value="agriculture">üåæ Agriculture</option>
              <option value="elevage">üêÑ √âlevage</option>
            </select>
            <select value={filterRegion} onChange={e=>setFilterRegion(e.target.value)}
              style={{padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem'}}>
              <option value="all">Toutes les r√©gions</option>
              {REGIONS.map(r=><option key={r}>{r}</option>)}
            </select>
          </div>

          {/* Mois en cours */}
          <div style={{padding:'.6rem 1rem',background:'rgba(196,154,40,.1)',borderRadius:'8px',marginBottom:'1rem',fontSize:'.83rem',color:'var(--gold2)',fontWeight:600}}>
            üìÖ Nous sommes en {moisEnCours} ‚Äî Les cultures en cours sont surlign√©es
          </div>

          <div style={{display:'flex',flexDirection:'column',gap:'.75rem'}}>
            {calFiltre.map(c=>{
              const ref = RENDEMENTS_REF[c.culture];
              const enCours = c.semis.includes(moisEnCours)||c.recolte.includes(moisEnCours);
              return (
                <div key={c.culture} className="card" style={{border:enCours?'1.5px solid var(--lime)':'1px solid var(--border)'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'.5rem'}}>
                    <div style={{fontWeight:700,fontSize:'1rem',color:'var(--ink)'}}>{c.culture}</div>
                    {enCours&&<span className="chip ch-lime" style={{fontSize:'.7rem'}}>üìÖ P√©riode en cours</span>}
                  </div>
                  <div style={{display:'flex',gap:'1.5rem',flexWrap:'wrap',fontSize:'.82rem',marginBottom:'.6rem'}}>
                    <span style={{color:'var(--lime)'}}>üå± Semis : <strong>{c.semis}</strong></span>
                    <span style={{color:'var(--gold2)'}}>üåæ R√©colte : <strong>{c.recolte}</strong></span>
                  </div>
                  <div style={{fontSize:'.8rem',color:'var(--ink3)',marginBottom:'.5rem'}}>
                    üìç R√©gions : {c.regions.join(' ¬∑ ')}
                  </div>
                  <div style={{padding:'.5rem .75rem',background:'rgba(26,122,110,.06)',borderRadius:'6px',fontSize:'.8rem',color:'var(--teal2)',lineHeight:1.6}}>
                    üí° {c.conseil}
                  </div>
                  {ref&&(
                    <div style={{marginTop:'.6rem',display:'flex',gap:'1rem',fontSize:'.78rem',color:'var(--ink3)',flexWrap:'wrap'}}>
                      <span>üìä Rendement moyen : <strong style={{color:'var(--lime)'}}>{ref.moy.toLocaleString('fr-FR')} {ref.unite}</strong></span>
                      <span>üí∞ Prix moyen : <strong style={{color:'var(--gold2)'}}>{ref.px_moy.toLocaleString('fr-FR')} FCFA</strong></span>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </>)}

        {/* ‚ïê‚ïê‚ïê ALERTES RAVAGEURS ‚ïê‚ïê‚ïê */}
        {onglet==='alertes' && (<>
          <div style={{padding:'.75rem 1rem',background:'rgba(196,74,42,.08)',borderRadius:'10px',marginBottom:'1.25rem',border:'1px solid rgba(196,74,42,.2)'}}>
            <div style={{fontWeight:700,color:'var(--rust2)',marginBottom:'.3rem'}}>‚ö† Alertes actives pour {moisEnCours}</div>
            <div style={{fontSize:'.82rem',color:'var(--ink3)'}}>
              {alertesMois.length} menace(s) √† surveiller ce mois-ci dans votre r√©gion
            </div>
          </div>

          {/* Alertes du mois */}
          {alertesMois.length > 0 && (
            <div style={{marginBottom:'1.5rem'}}>
              <div style={{fontWeight:600,marginBottom:'.75rem',color:'var(--ink)'}}>üî¥ Actives en {moisEnCours}</div>
              {alertesMois.map(a=>(
                <div key={a.nom} className="card mb2" style={{borderLeft:`4px solid ${a.niveau==='√©lev√©'?'var(--rust2)':'var(--gold2)'}`}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.5rem'}}>
                    <div style={{fontWeight:700,fontSize:'1rem'}}>{a.ic} {a.nom}</div>
                    <span style={{fontSize:'.72rem',fontWeight:700,padding:'.2rem .6rem',borderRadius:'99px',
                      background:a.niveau==='√©lev√©'?'rgba(196,74,42,.12)':'rgba(196,154,40,.12)',
                      color:a.niveau==='√©lev√©'?'var(--rust2)':'var(--gold2)'}}>
                      {a.niveau==='√©lev√©'?'üî¥ Risque √©lev√©':'üü° Risque mod√©r√©'}
                    </span>
                  </div>
                  <div style={{fontSize:'.8rem',color:'var(--ink3)',marginBottom:'.5rem'}}>
                    üåæ Cultures touch√©es : {a.cultures.join(', ')}
                  </div>
                  <div style={{padding:'.6rem .75rem',background:'rgba(196,74,42,.06)',borderRadius:'6px',fontSize:'.82rem',color:'var(--ink)',lineHeight:1.6}}>
                    <strong>Action recommand√©e :</strong> {a.action}
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Toutes les alertes */}
          <div>
            <div style={{fontWeight:600,marginBottom:'.75rem',color:'var(--ink3)'}}>üìã Calendrier annuel des menaces</div>
            {ALERTES_RAVAGEURS.filter(a=>!alertesMois.includes(a)).map(a=>(
              <div key={a.nom} className="card mb2" style={{opacity:.7}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.4rem'}}>
                  <div style={{fontWeight:600}}>{a.ic} {a.nom}</div>
                  <span style={{fontSize:'.72rem',color:'var(--ink3)'}}>{a.mois.join(', ')}</span>
                </div>
                <div style={{fontSize:'.78rem',color:'var(--ink3)'}}>Cultures : {a.cultures.join(', ')}</div>
              </div>
            ))}
          </div>
        </>)}

      </div>
    </div>
  );
}

function Login({onLogin}){
  const [tab,setTab]=useState('paysan');
  const [f,setF]=useState({nom:'',tel:'',village:'',region:'Dakar',secteur:'agriculture',role:'paysan'});
  const [err,setErr]=useState('');
  const [loading,setLoading]=useState(false);

  const loginDemo = async (secteur) => {
    setLoading(true); setErr('');
    try {
      // Chercher un user d√©mo existant en DB
      const { data } = await sb.from('users').select('*').eq('secteur',secteur).limit(1);
      let u = data && data.length > 0 ? data[0] : null;
      if (!u) {
        // Cr√©er un user d√©mo si la DB est vide
        const demoNames = {agriculture:'Baye S√®ne',elevage:'Ousmane Diallo',mixte:'Mariama Diallo',admin:'Mariama Diallo'};
        const demoVilles = {agriculture:'Touba Toul',elevage:'Lingu√®re',mixte:'Bambey',admin:'Bambey'};
        const demoRegions = {agriculture:'Diourbel',elevage:'Louga',mixte:'Diourbel',admin:'Diourbel'};
        const { data: nu, error } = await sb.from('users').insert({
          clerk_id: 'demo_'+secteur+'_'+Date.now(),
          nom: demoNames[secteur]||'Demo User',
          telephone: '+22177'+Math.floor(Math.random()*9000000+1000000),
          village: demoVilles[secteur]||'Dakar',
          region: demoRegions[secteur]||'Dakar',
          secteur: secteur==='admin'?'mixte':secteur,
          role: secteur==='admin'?'admin':'paysan',
        }).select().single();
        if (error) { setErr('Erreur: '+error.message); setLoading(false); return; }
        u = nu;
      }
      const extra = await loadUserData(u.id);
      onLogin(dbUser(u, extra));
    } catch(e) { setErr(e.message); }
    setLoading(false);
  };

  const submit = async (e) => {
    e.preventDefault();
    if (!f.nom||!f.tel||!f.village) { setErr('Tous les champs sont requis'); return; }
    if (!f.tel.match(/^\+221(70|75|76|77|78)\d{7}$/)) { setErr('Num√©ro invalide (+221 7X XXXXXXX)'); return; }
    setLoading(true); setErr('');
    try {
      // Chercher si le num√©ro existe d√©j√†
      const { data:existing } = await sb.from('users').select('*').eq('telephone',f.tel).single();
      let u;
      if (existing) {
        u = existing;
      } else {
        const { data:nu, error } = await sb.from('users').insert({
          clerk_id: 'phone_'+f.tel.replace('+',''),
          nom: f.nom, telephone: f.tel,
          village: f.village, region: f.region,
          secteur: f.secteur, role: tab==='admin'?'admin':'paysan',
        }).select().single();
        if (error) { setErr('Erreur inscription: '+error.message); setLoading(false); return; }
        u = nu;
      }
      const extra = await loadUserData(u.id);
      onLogin(dbUser(u, extra));
    } catch(e) { setErr(e.message); }
    setLoading(false);
  };

  return(
    <div className="login-bg">
      <div className="login-card">
        <div className="login-logo">AgriTontine<b>+</b></div>
        <div className="login-sub">Plateforme nationale de tontines agricoles<br/>Agriculture ¬∑ √âlevage ¬∑ Investissement ¬∑ S√©n√©gal üóÑ</div>
        <div className="login-flags">
          {SECTEURS.map(s=><span key={s.id} className={`sector-badge ${s.cls}`} style={{fontSize:'.62rem'}}>{s.ic} {s.label}</span>)}
          <span className="login-flag">üìç 14 r√©gions</span>
          <span className="login-flag" style={{background:'rgba(26,158,142,.15)',color:'var(--teal2)',border:'1px solid rgba(26,158,142,.25)'}}>üóÑ Supabase Live</span>
        </div>
        <div className="tabs">
          <div className={`tab ${tab==='paysan'?'on':''}`} onClick={()=>{setTab('paysan');setF(p=>({...p,role:'paysan'}))}}>üë®‚Äçüåæ Producteur</div>
          <div className={`tab ${tab==='eleveur'?'on':''}`} onClick={()=>{setTab('eleveur');setF(p=>({...p,role:'paysan',secteur:'elevage'}))}}>üêÑ √âleveur</div>
          <div className={`tab ${tab==='admin'?'on':''}`} onClick={()=>{setTab('admin');setF(p=>({...p,role:'admin'}))}}>üëë Admin</div>
        </div>
        <form onSubmit={submit}>
          <div className="fg"><label>Nom complet</label><input value={f.nom} onChange={e=>setF({...f,nom:e.target.value})} placeholder="Ex: Baye S√®ne" disabled={loading}/></div>
          <div className="fg"><label>T√©l√©phone (+221)</label><input value={f.tel} onChange={e=>setF({...f,tel:e.target.value})} placeholder="+221771234567" disabled={loading}/></div>
          <div className="fr">
            <div className="fg"><label>Village / Ville</label><input value={f.village} onChange={e=>setF({...f,village:e.target.value})} placeholder="Ex: Lingu√®re" disabled={loading}/></div>
            <div className="fg"><label>R√©gion</label><select value={f.region} onChange={e=>setF({...f,region:e.target.value})} disabled={loading}>{REGIONS.map(r=><option key={r}>{r}</option>)}</select></div>
          </div>
          <div className="fg"><label>Secteur d'activit√©</label>
            <select value={f.secteur} onChange={e=>setF({...f,secteur:e.target.value})} disabled={loading}>
              {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
            </select>
          </div>
          {err&&<div className="t-sm t-rust mb1">‚ö† {err}</div>}
          <button type="submit" className="btn btn-lime w100" style={{justifyContent:'center',padding:'.72rem',marginTop:'.25rem'}} disabled={loading}>
            {loading?'‚è≥ Connexion en cours...':'Cr√©er mon compte ‚Üí'}
          </button>
        </form>
        <div className="demo-btns">
          <div className="demo-label">üéØ D√©mo rapide ‚Äî donn√©es sauvegard√©es en DB</div>
          <div className="demo-grid">
            <button className="btn btn-ghost btn-sm" onClick={()=>loginDemo('agriculture')} disabled={loading}>üë®‚Äçüåæ Paysan</button>
            <button className="btn btn-ghost btn-sm" onClick={()=>loginDemo('elevage')} disabled={loading}>üêÑ √âleveur</button>
            <button className="btn btn-ghost btn-sm" onClick={()=>loginDemo('admin')} disabled={loading}>üëë Admin</button>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP ROOT ‚Äî avec Supabase + Realtime
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function App(){
  // ‚îÄ‚îÄ TOUS LES HOOKS EN PREMIER ‚Äî jamais apr√®s un return conditionnel ‚îÄ‚îÄ
  const [user,setUser]         = useState(null);
  const [page,setPage]         = useState('dashboard');
  const [tontines,setTontines] = useState([]);
  const [projets,setProjets]   = useState([]);
  const [appLoading,setAppLoading] = useState(false);
  const {toasts,add:toast}     = useToast();

  // Chargement initial apr√®s login
  useEffect(()=>{
    if (!user) { setTontines([]); setProjets([]); return; }
    setAppLoading(true);
    Promise.all([sbFetchTontines(), sbFetchProjets()]).then(([t,p])=>{
      setTontines(t);
      setProjets(p);
      setAppLoading(false);
    });
  },[user && user.id]);

  // Realtime : cotisations
  useEffect(()=>{
    if (!user) return;
    const ch = sb.channel('rt_cotis_'+user.id)
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'cotisations'},
        async (payload)=>{
          if (payload.new.user_id === user.id) {
            const extra = await loadUserData(user.id);
            setUser(u=>({...u,...extra}));
          } else {
            toast('üí∏ Nouvelle cotisation dans votre tontine !','i');
            sbFetchTontines().then(t=>setTontines(t));
          }
        })
      .subscribe();
    return ()=>sb.removeChannel(ch);
  },[user && user.id]);

  // Realtime : projets
  useEffect(()=>{
    if (!user) return;
    const ch = sb.channel('rt_projets_'+user.id)
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'projets'},
        (payload)=>setProjets(prev=>prev.map(p=>p.id===payload.new.id?dbProjet(payload.new):p)))
      .subscribe();
    return ()=>sb.removeChannel(ch);
  },[user && user.id]);

  // Wrapper setTontines ‚Üí Supabase
  const setTontinesWrapper = useCallback(async (updaterOrFn)=>{
    if (typeof updaterOrFn !== 'function') { setTontines(updaterOrFn); return; }
    setTontines(prev=>{
      const next = updaterOrFn(prev);
      const added = next.find(t=>!prev.find(p=>p.id===t.id));
      if (added) {
        // Cr√©er tontine en DB
        sbCreerTontine(user,{
          nom:added.nom, secteur:added.secteur, region:added.region,
          montant:added.montantCotis, frequence:added.frequence,
          nbMax:added.nbMax, desc:added.description,
        }).then(()=>Promise.all([sbFetchTontines(),loadUserData(user.id)])).then(([t,extra])=>{
          setTontines(t);
          setUser(u=>({...u,...extra}));
          toast('Tontine "'+added.nom+'" cr√©√©e !');
        }).catch(e=>toast('Erreur: '+e.message,'e'));
        return prev; // ne pas muter l'√©tat local avant la r√©ponse DB
      }
      // Rejoindre une tontine
      const changed = next.find((t,i)=>t.membres.length > (prev[i]?.membres.length||0));
      if (changed) {
        const origTontine = prev.find(t=>t.id===changed.id);
        if (origTontine) {
          sbRejoindre(user.id, origTontine)
            .then(()=>Promise.all([sbFetchTontines(),loadUserData(user.id)]))
            .then(([t,extra])=>{
              setTontines(t);
              setUser(u=>({...u,...extra}));
              toast('Vous avez rejoint "'+changed.nom+'" !');
            }).catch(e=>toast(e.message,'e'));
        }
        return prev;
      }
      return next;
    });
  },[user, tontines]);

  // Wrapper setUser ‚Üí Supabase
  const setUserWrapper = useCallback(async (updaterOrObj)=>{
    if (typeof updaterOrObj !== 'function') {
      // Mise √† jour profil
      sbUpdateProfil(user.id, updaterOrObj)
        .then(()=>setUser(u=>({...u,...updaterOrObj})))
        .catch(e=>toast('Erreur profil: '+e.message,'e'));
      return;
    }
    const next = updaterOrObj(user);

    // Nouvelle cotisation ?
    if ((next.cotisations||[]).length > (user.cotisations||[]).length) {
      const nc = next.cotisations.find(c=>!(user.cotisations||[]).find(pc=>pc.id===c.id));
      if (nc) {
        const tontine = tontines.find(t=>t.id===nc.tontineId);
        if (!tontine) return;
        sbPayerCotis(user.id, tontine)
          .then(()=>loadUserData(user.id))
          .then(extra=>{ setUser(u=>({...u,...extra})); toast('Cotisation de '+tontine.montantCotis.toLocaleString('fr-FR')+' FCFA enregistr√©e !'); })
          .catch(e=>toast('Erreur cotisation: '+e.message,'e'));
        return;
      }
    }
    // Nouveau cr√©dit ?
    if ((next.credits||[]).length > (user.credits||[]).length) {
      const nc = next.credits.find(c=>!(user.credits||[]).find(pc=>pc.id===c.id));
      if (nc) {
        const score = calcScore(user);
        sbDemanderCredit(user.id,{montant:String(nc.montant),intrant:nc.intrant,partenaire:nc.partenaire},score)
          .then(()=>loadUserData(user.id))
          .then(extra=>{ setUser(u=>({...u,...extra})); toast('‚úì Cr√©dit '+nc.montant.toLocaleString('fr-FR')+' FCFA approuv√© !'); })
          .catch(e=>toast('Erreur cr√©dit: '+e.message,'e'));
        return;
      }
    }
    // Remboursement ?
    const remb = (next.credits||[]).find(c=>c.statut==='rembourse'&&(user.credits||[]).find(pc=>pc.id===c.id&&pc.statut!=='rembourse'));
    if (remb) {
      sbRembourser(remb.id)
        .then(()=>loadUserData(user.id))
        .then(extra=>{ setUser(u=>({...u,...extra})); toast('‚úì Cr√©dit rembours√© !'); })
        .catch(e=>toast('Erreur: '+e.message,'e'));
      return;
    }
    // Nouvel investissement ?
    if ((next.investissements||[]).length > (user.investissements||[]).length) {
      const ni = next.investissements.find(i=>!(user.investissements||[]).find(pi=>pi.projetId===i.projetId&&pi.date===i.date));
      if (ni) {
        const projet = projets.find(p=>p.id===ni.projetId);
        if (!projet) return;
        sbInvestir(user.id,projet,ni.montant)
          .then(()=>Promise.all([loadUserData(user.id),sbFetchProjets()]))
          .then(([extra,p])=>{ setUser(u=>({...u,...extra})); setProjets(p); toast('‚úì Investissement de '+ni.montant.toLocaleString('fr-FR')+' FCFA confirm√© !'); })
          .catch(e=>toast('Erreur investissement: '+e.message,'e'));
        return;
      }
    }
    setUser(next);
  },[user, tontines, projets]);

  // Wrapper setProjets ‚Üí Supabase
  const setProjetsWrapper = useCallback(async (updaterOrFn)=>{
    if (typeof updaterOrFn !== 'function') { setProjets(updaterOrFn); return; }
    const next = updaterOrFn(projets);
    const added = next.find(p=>!projets.find(pp=>pp.id===p.id));
    if (added) {
      sbCreerProjet(user.id,{
        nom:added.nom, promoteur:added.promoteur||user.nom, region:added.region,
        secteur:added.secteur, desc:added.description,
        objectif:String(added.objectif), rendement:String(added.rendementAnnuel),
        duree:String(added.dureeMois), risque:added.risque,
      })
      .then(()=>sbFetchProjets())
      .then(p=>{ setProjets(p); toast('Projet "'+added.nom+'" publi√© !'); })
      .catch(e=>toast('Erreur projet: '+e.message,'e'));
    }
  },[projets, user]);

  // ‚îÄ‚îÄ RETOURS CONDITIONNELS ‚Äî apr√®s tous les hooks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (!user) return (
    <>
      <Login onLogin={u=>{setUser(u);setPage('dashboard');}}/>
      <Toasts toasts={toasts}/>
    </>
  );

  if (appLoading) return (
    <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'var(--bg)',flexDirection:'column',gap:'1rem'}}>
      <div style={{fontFamily:'var(--f-d)',fontSize:'2.5rem',color:'var(--lime)'}}>AgriTontine+</div>
      <div style={{color:'var(--ink3)',fontSize:'.9rem'}}>‚è≥ Chargement depuis Supabase...</div>
    </div>
  );

  const score = calcScore(user);
  const isAdm = tontines.some(t=>t.admin===user.id)||user.role==='admin';
  const openInvests = projets.filter(p=>p.statut==='ouvert').length;
  const getSectorAv = ()=>{ const s=SECTEURS.find(x=>x.id===user.secteur); return s?s.ic:'üåæ'; };

  const nav=[
    {id:'dashboard',ic:'üè†',label:'Tableau de bord'},
    {id:'tontines',ic:'ü§ù',label:'Tontines'},
    {id:'cotisations',ic:'üí∏',label:'Cotisations'},
    {id:'credits',ic:'üå±',label:'Cr√©dits intrants',dot:score<40?'!':null,dotCls:'dot-gold'},
    {id:'investissement',ic:'üíº',label:'Investissement',dot:openInvests>0?openInvests:null,dotCls:'dot-green'},
    ...(isAdm?[{id:'admin',ic:'üëë',label:'Administration'}]:[]),
    {id:'marche',ic:'üõí',label:'March√© Cadran'},
    {id:'outils',ic:'üåæ',label:'Outils Agricoles'},
    {id:'profil',ic:'üë§',label:'Mon profil'},
  ];

  const pages={
    dashboard:<Dashboard user={user} tontines={tontines} projets={projets} toast={toast}/>,
    tontines:<Tontines user={user} tontines={tontines} setTontines={setTontinesWrapper} toast={toast}/>,
    cotisations:<Cotisations user={user} setUser={setUserWrapper} tontines={tontines} toast={toast}/>,
    credits:<Credits user={user} setUser={setUserWrapper} toast={toast}/>,
    investissement:<Investissement user={user} setUser={setUserWrapper} projets={projets} setProjets={setProjetsWrapper} toast={toast}/>,
    admin:<Admin user={user} tontines={tontines} setTontines={setTontinesWrapper} toast={toast}/>,
    marche:<Marche user={user} toast={toast}/>,
    outils:<OutilsAgricoles user={user} toast={toast}/>,
    profil:<Profil user={user} setUser={setUserWrapper} toast={toast}/>,
  };

  const scoreColor=score>=65?'var(--lime)':score>=40?'var(--gold2)':'var(--rust2)';

  return(
    <div className="app">
      <div className="sidebar">
        <div className="sb-brand">
          <div className="sb-logo">AgriTontine<b>+</b></div>
          <div className="sb-tagline">Agri ¬∑ √âlevage ¬∑ Investissement</div>
          <div className="sb-flag">üá∏üá≥ S√©n√©gal ¬∑ 14 r√©gions</div>
          <div className="sb-flag" style={{marginTop:'.25rem',background:'rgba(26,158,142,.12)',color:'var(--teal2)',borderColor:'rgba(26,158,142,.25)'}}>üóÑ Supabase Live</div>
        </div>
        <div className="sb-user">
          <div className="fcc gap2 mb1">
            <div className="sb-av" style={{background:'linear-gradient(135deg,var(--s3),var(--s4))'}}>{getSectorAv()}</div>
            <div>
              <div className="sb-uname">{user.nom}</div>
              <div className="sb-usub">üìç {user.village} ¬∑ {user.region}</div>
            </div>
          </div>
          <div className="sb-score-row">
            <div className="sb-score-track"><div className="sb-score-fill" style={{width:score+'%',background:scoreColor}}/></div>
            <div className="sb-score-num" style={{color:scoreColor}}>{score}/100</div>
          </div>
          <div className="fcc gap1 mt1"><SectorBadge secteur={user.secteur}/></div>
        </div>
        <div className="sb-nav">
          <div className="sb-sec">Navigation</div>
          {nav.map(item=>(
            <div key={item.id} className={`sb-item ${page===item.id?'on':''}`} onClick={()=>setPage(item.id)}>
              <span className="sb-ic">{item.ic}</span>{item.label}
              {item.dot&&<span className={`sb-dot ${item.dotCls||'dot-red'}`}>{item.dot}</span>}
            </div>
          ))}
        </div>
        <div className="sb-foot">
          <div className="sb-logout" onClick={()=>{setUser(null);setPage('dashboard');}}>
            <span>üö™</span> D√©connexion
          </div>
          <div className="sb-version">
            üóÑ Supabase ¬∑ ‚òÅÔ∏è Vercel<br/>
            <span style={{color:'var(--lime)'}}>v2.1 ¬∑ Donn√©es persistantes</span>
          </div>
        </div>
      </div>
      <div className="main">{pages[page]||pages.dashboard}</div>
      <Toasts toasts={toasts}/>
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
