<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>AgriTontine+ ¬∑ Plateforme Nationale ¬∑ S√©n√©gal</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,600;0,700;0,900;1,700&family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
*,::before,::after{box-sizing:border-box;margin:0;padding:0}
:root{
  /* ‚îÄ‚îÄ Fintech Dark Palette ‚îÄ‚îÄ */
  --bg:#050A0E;--s1:#080F15;--s2:#0C1520;--s3:#111D2A;--s4:#162434;
  --c1:#0A2540;--c2:#0E3060;

  /* ‚îÄ‚îÄ Brand ‚îÄ‚îÄ */
  --lime:#00D084;--lime2:#00F09A;--lime3:#A8FFE0;
  --gold:#F5A623;--gold2:#FFB940;--gold3:#FFD080;
  --teal:#0EAFF0;--teal2:#38C5FF;
  --amber:#FF7A00;--amber2:#FF9A30;
  --blue:#2563EB;--blue2:#60A5FA;
  --rust:#EF4444;--rust2:#F87171;
  --purple:#7C3AED;--purple2:#A78BFA;

  /* ‚îÄ‚îÄ Ink ‚îÄ‚îÄ */
  --ink:#F0F6FF;--ink2:#A0B4C8;--ink3:#5A7490;--ink4:#304560;

  /* ‚îÄ‚îÄ Borders ‚îÄ‚îÄ */
  --border:#0F2236;--border2:#162E48;--border3:#1E3F60;

  /* ‚îÄ‚îÄ Typography ‚Äî Fintech grade ‚îÄ‚îÄ */
  --f-d:'Bricolage Grotesque',system-ui,sans-serif;
  --f-b:'Plus Jakarta Sans',system-ui,sans-serif;
  --f-m:'JetBrains Mono',monospace;

  /* ‚îÄ‚îÄ Radii ‚îÄ‚îÄ */
  --r:16px;--r2:10px;--r3:7px;

  /* ‚îÄ‚îÄ Shadows ‚îÄ‚îÄ */
  --sh:0 4px 24px rgba(0,0,0,.4),0 1px 0 rgba(255,255,255,.04);
  --sh2:0 16px 64px rgba(0,0,0,.6),0 1px 0 rgba(255,255,255,.06);
  --sh-lime:0 0 24px rgba(0,208,132,.2);
  --sh-gold:0 0 24px rgba(245,166,35,.2);
}
html,body,#root{height:100%;font-family:var(--f-b);background:var(--bg);color:var(--ink);overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--s1)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}
::-webkit-scrollbar-thumb:hover{background:var(--border3)}

/* ‚îÄ‚îÄ APP LAYOUT ‚îÄ‚îÄ */
.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:256px;background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;backdrop-filter:blur(20px)}
.main{flex:1;overflow-y:auto;background:var(--bg);position:relative}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sb-brand{padding:1.25rem 1.1rem .85rem;border-bottom:1px solid var(--border);position:relative}
.sb-brand::after{content:'';position:absolute;bottom:0;left:1.1rem;right:1.1rem;height:1px;background:linear-gradient(90deg,var(--lime),transparent)}
.sb-logo{display:flex;align-items:center;gap:.65rem;text-decoration:none}
.sb-logo-icon{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--lime),#00A865);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;box-shadow:0 3px 10px rgba(0,208,132,.25)}
.sb-logo-text{font-family:var(--f-d);font-size:1.25rem;font-weight:800;color:var(--ink);letter-spacing:-.03em;line-height:1}
.sb-logo-text span{color:var(--lime)}
.sb-tagline{font-size:.62rem;color:var(--ink3);margin-top:.25rem;letter-spacing:.06em;text-transform:uppercase}
.sb-flag{display:inline-flex;align-items:center;gap:.3rem;background:rgba(126,200,69,.08);border:1px solid rgba(126,200,69,.15);border-radius:99px;padding:.18rem .55rem;font-size:.62rem;font-weight:700;color:var(--lime);margin-top:.45rem;letter-spacing:.04em}

.sb-user{margin:.7rem .9rem;background:var(--s2);border:1px solid var(--border2);border-radius:var(--r2);padding:1rem}
.sb-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;border:2px solid var(--border2)}
.sb-uname{font-weight:700;font-size:.84rem;color:var(--ink);line-height:1.2}
.sb-usub{font-size:.68rem;color:var(--ink3);margin-top:.1rem}
.sb-score-row{margin-top:.65rem;display:flex;align-items:center;gap:.55rem}
.sb-score-track{flex:1;height:3px;background:var(--border);border-radius:99px;overflow:hidden}
.sb-score-fill{height:100%;border-radius:99px;transition:width .6s}
.sb-score-num{font-family:var(--f-m);font-size:.72rem;font-weight:500}

.sb-nav{flex:1;padding:.5rem .7rem;overflow-y:auto}
.sb-sec{font-size:.58rem;font-weight:700;letter-spacing:.18em;text-transform:uppercase;color:var(--ink4);padding:.65rem .6rem .3rem;margin-top:.15rem}
.sb-item{display:flex;align-items:center;gap:.6rem;padding:.58rem .7rem;border-radius:var(--r3);cursor:pointer;font-size:.82rem;color:var(--ink3);transition:.15s;margin-bottom:.1rem;border:1px solid transparent;position:relative}
.sb-item:hover{background:var(--s3);color:var(--ink);border-color:var(--border2)}
.sb-item.on{color:var(--lime);background:rgba(0,208,132,.08);border-color:rgba(0,208,132,.18)}
.sb-item.on::before{content:'';position:absolute;left:0;top:18%;bottom:18%;width:3px;background:linear-gradient(180deg,var(--lime2),var(--lime));border-radius:99px}
.sb-ic{font-size:.95rem;width:18px;text-align:center;flex-shrink:0}
.sb-dot{margin-left:auto;min-width:18px;height:18px;border-radius:99px;display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:700}
.dot-red{background:var(--rust);color:#fff}
.dot-green{background:var(--lime);color:#0D1B0D}
.dot-gold{background:var(--gold);color:#fff}

.sb-foot{padding:.8rem 1.1rem;border-top:1px solid var(--border)}
.sb-logout{display:flex;align-items:center;gap:.45rem;font-size:.78rem;color:var(--ink4);cursor:pointer;padding:.35rem 0;transition:.15s}
.sb-logout:hover{color:var(--rust2)}
.sb-version{font-size:.62rem;color:var(--ink4);margin-top:.35rem;line-height:1.6}

/* ‚îÄ‚îÄ SECTOR BADGE ‚îÄ‚îÄ */
.sector-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.22rem .65rem;border-radius:99px;font-size:.66rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
.sec-agri{background:rgba(126,200,69,.15);color:var(--lime);border:1px solid rgba(126,200,69,.25)}
.sec-elev{background:rgba(212,116,10,.15);color:var(--amber2);border:1px solid rgba(212,116,10,.25)}
.sec-mix{background:rgba(26,158,142,.15);color:var(--teal2);border:1px solid rgba(26,158,142,.25)}
.sec-invest{background:rgba(240,192,64,.15);color:var(--gold3);border:1px solid rgba(240,192,64,.25)}

/* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
.ph{padding:2rem 2.5rem 1.5rem;border-bottom:1px solid var(--border);position:relative}
.ph::after{content:'';position:absolute;bottom:0;left:2.5rem;width:60px;height:2px;background:linear-gradient(90deg,var(--lime),transparent);border-radius:99px}
.ph-top{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.ph-tag{font-size:.62rem;font-weight:700;letter-spacing:.18em;text-transform:uppercase;color:var(--lime);margin-bottom:.3rem}
.ph-title{font-family:var(--f-d);font-size:1.75rem;font-weight:800;color:var(--ink);line-height:1.1;letter-spacing:-.02em}
.ph-sub{font-size:.82rem;color:var(--ink3);margin-top:.3rem;line-height:1.55}
.ph-actions{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin-top:.5rem}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{padding:1.75rem 2.5rem}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:linear-gradient(145deg,var(--s1),rgba(8,15,21,.8));border:1px solid var(--border);border-radius:var(--r);padding:1.5rem;transition:.2s;position:relative}
.card::before{content:'';position:absolute;inset:0;border-radius:var(--r);background:linear-gradient(135deg,rgba(255,255,255,.025),transparent);pointer-events:none}
.card:hover{border-color:var(--border3)}
.card-sm{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:1rem}
.card-title{font-weight:700;font-size:.88rem;color:var(--ink);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.card-title span{font-size:.78rem;font-weight:400;color:var(--ink3)}

/* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
.stat{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:1.35rem;position:relative;overflow:hidden;transition:.25s;cursor:default}
.stat:hover{border-color:var(--border3);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.3)}
.stat::after{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;border-radius:50%;background:var(--glow,rgba(0,208,132,.06));pointer-events:none}
.stat::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.02),transparent);pointer-events:none;border-radius:var(--r)}
.stat-ic{font-size:1.5rem;margin-bottom:.6rem}
.stat-val{font-family:var(--f-d);font-size:2rem;font-weight:700;color:var(--ink);line-height:1}
.stat-lbl{font-size:.7rem;color:var(--ink3);margin-top:.2rem;font-weight:500;text-transform:uppercase;letter-spacing:.04em}
.stat-sub{font-size:.72rem;margin-top:.45rem;display:flex;align-items:center;gap:.3rem}
.up{color:var(--lime)}.dn{color:var(--rust2)}.neu{color:var(--ink3)}

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:1.1rem}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1.4rem}
.g2-3{display:grid;grid-template-columns:1fr 1.4fr;gap:1.4rem}
.gauto{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.1rem}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem 1.15rem;border-radius:var(--r2);font-size:.82rem;font-weight:600;cursor:pointer;border:none;font-family:var(--f-b);transition:.15s;white-space:nowrap}
.btn:hover{transform:translateY(-1px);filter:brightness(1.08)}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none}
.btn-lime{background:linear-gradient(135deg,var(--lime),var(--lime2));color:#020B06;font-weight:700;box-shadow:var(--sh-lime)}
.btn-green{background:var(--green);color:#fff}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#fff;box-shadow:var(--sh-gold)}
.btn-teal{background:var(--teal);color:#fff}
.btn-amber{background:var(--amber);color:#fff}
.btn-ghost{background:transparent;color:var(--ink2);border:1px solid var(--border2)}
.btn-ghost:hover{background:var(--s2);color:var(--ink)}
.btn-danger{background:rgba(196,74,42,.12);color:var(--rust2);border:1px solid rgba(196,74,42,.2)}
.btn-sm{padding:.38rem .8rem;font-size:.76rem}
.btn-xs{padding:.24rem .55rem;font-size:.68rem;border-radius:var(--r3)}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.fg{margin-bottom:.9rem}
.fg label{display:block;font-size:.7rem;font-weight:700;color:var(--ink3);margin-bottom:.3rem;letter-spacing:.05em;text-transform:uppercase}
.fg input,.fg select,.fg textarea{width:100%;padding:.58rem .85rem;border:1px solid var(--border2);border-radius:var(--r2);font-size:.84rem;font-family:var(--f-b);background:var(--s2);color:var(--ink);outline:none;transition:border .2s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--lime);background:var(--s3)}
.fg input::placeholder{color:var(--ink4)}
.fg select option{background:var(--s1);color:var(--ink)}
.fg textarea{resize:vertical;min-height:80px;line-height:1.6}
.fg-hint{font-size:.68rem;color:var(--ink4);margin-top:.25rem;line-height:1.5}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.65rem}
.frow-btns{display:flex;gap:.65rem;justify-content:flex-end;margin-top:1.35rem;padding-top:1.1rem;border-top:1px solid var(--border)}

/* ‚îÄ‚îÄ CHIP ‚îÄ‚îÄ */
.chip{display:inline-flex;align-items:center;gap:.28rem;padding:.2rem .6rem;border-radius:99px;font-size:.68rem;font-weight:600}
.ch-lime{background:rgba(126,200,69,.15);color:var(--lime);border:1px solid rgba(126,200,69,.22)}
.ch-gold{background:rgba(240,192,64,.15);color:var(--gold3);border:1px solid rgba(240,192,64,.22)}
.ch-amber{background:rgba(212,116,10,.15);color:var(--amber2);border:1px solid rgba(212,116,10,.22)}
.ch-teal{background:rgba(26,158,142,.15);color:var(--teal2);border:1px solid rgba(26,158,142,.22)}
.ch-rust{background:rgba(196,74,42,.15);color:var(--rust2);border:1px solid rgba(196,74,42,.22)}
.ch-blue{background:rgba(32,96,192,.15);color:var(--blue2);border:1px solid rgba(32,96,192,.22)}
.ch-gray{background:var(--s3);color:var(--ink3);border:1px solid var(--border2)}

/* ‚îÄ‚îÄ SCORE RING ‚îÄ‚îÄ */
.ring-wrap{display:flex;flex-direction:column;align-items:center;gap:.35rem}
.ring{position:relative;flex-shrink:0}
.ring svg{transform:rotate(-90deg);display:block}
.ring-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-n{font-family:var(--f-d);font-weight:700;line-height:1}
.ring-s{font-size:.52rem;color:var(--ink4)}
.ring-lbl{font-size:.64rem;color:var(--ink3);letter-spacing:.06em;text-transform:uppercase}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.tbl-wrap{overflow-x:auto;border-radius:var(--r2);border:1px solid var(--border)}
table{width:100%;border-collapse:collapse}
th{padding:.65rem 1rem;font-size:.65rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink4);text-align:left;background:var(--s2);border-bottom:1px solid var(--border)}
td{padding:.72rem 1rem;font-size:.82rem;border-bottom:1px solid var(--border);color:var(--ink);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.015)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:1000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);padding:1rem}
.modal{background:linear-gradient(145deg,var(--s1),var(--s2));border:1px solid var(--border3);border-radius:20px;width:100%;max-width:500px;max-height:92vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.05)}
.modal-lg{max-width:640px}
.mh{padding:1.4rem 1.6rem 1.1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.m-title{font-family:var(--f-d);font-size:1.15rem;font-weight:700;color:var(--ink)}
.m-close{background:var(--s2);border:1px solid var(--border);border-radius:6px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--ink3);font-size:.82rem;transition:.15s}
.m-close:hover{background:var(--s3);color:var(--rust2)}
.mb{padding:1.5rem 1.6rem}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast-cont{position:fixed;bottom:1.5rem;right:1.5rem;z-index:2000;display:flex;flex-direction:column;gap:.45rem;pointer-events:none}
.toast{background:rgba(8,15,21,.95);border:1px solid var(--border3);border-radius:12px;padding:.75rem 1rem;display:flex;align-items:center;gap:.6rem;font-size:.8rem;box-shadow:0 8px 32px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.05);animation:tin .35s cubic-bezier(.175,.885,.32,1.275);max-width:340px;backdrop-filter:blur(20px)}
.toast-s{border-left:3px solid var(--lime)}
.toast-e{border-left:3px solid var(--rust2)}
.toast-i{border-left:3px solid var(--gold)}
@keyframes tin{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}

/* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
.pbar-wrap{background:var(--border);border-radius:99px;overflow:hidden}
.pbar-fill{height:100%;border-radius:99px;transition:width .5s}

/* ‚îÄ‚îÄ ACTIVITY ‚îÄ‚îÄ */
.act-item{display:flex;gap:.7rem;padding:.7rem 0;border-bottom:1px solid var(--border)}
.act-item:last-child{border-bottom:none}
.act-ic{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.82rem;flex-shrink:0}
.act-text{font-size:.8rem;color:var(--ink);line-height:1.5}
.act-date{font-size:.68rem;color:var(--ink4);margin-top:.1rem}

/* ‚îÄ‚îÄ PROJECT CARD ‚îÄ‚îÄ */
.proj-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:1.35rem;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.proj-card:hover{border-color:var(--border3);transform:translateY(-2px);box-shadow:var(--sh)}
.proj-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--proj-color,var(--lime))}
.proj-name{font-family:var(--f-d);font-size:1.05rem;font-weight:700;color:var(--ink);margin-bottom:.4rem;margin-top:.3rem}
.proj-promo{font-size:.78rem;color:var(--ink3);margin-bottom:.75rem;line-height:1.5}
.proj-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin-bottom:.85rem}
.proj-stat{background:var(--s2);border-radius:var(--r3);padding:.55rem .65rem;text-align:center}
.proj-stat-val{font-family:var(--f-d);font-size:1.1rem;font-weight:700;color:var(--ink);line-height:1}
.proj-stat-lbl{font-size:.62rem;color:var(--ink4);margin-top:.1rem;text-transform:uppercase;letter-spacing:.04em}
.proj-progress{margin-bottom:.85rem}
.proj-prog-head{display:flex;justify-content:space-between;font-size:.72rem;margin-bottom:.3rem}

/* ‚îÄ‚îÄ INVEST CARD ‚îÄ‚îÄ */
.invest-option{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:1rem;display:flex;align-items:center;gap:.85rem;cursor:pointer;transition:.2s;margin-bottom:.6rem}
.invest-option:hover{border-color:var(--gold);background:rgba(196,154,40,.05)}
.invest-option.sel{border-color:var(--gold2);background:rgba(240,192,64,.08)}
.invest-opt-ic{width:40px;height:40px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.invest-opt-n{font-weight:700;font-size:.88rem;color:var(--ink)}
.invest-opt-d{font-size:.74rem;color:var(--ink3);margin-top:.1rem}
.invest-opt-r{margin-left:auto;text-align:right}
.invest-opt-rate{font-family:var(--f-d);font-size:1.1rem;font-weight:700;color:var(--gold2)}
.invest-opt-dur{font-size:.68rem;color:var(--ink4);margin-top:.1rem}

/* ‚îÄ‚îÄ REGION TAG ‚îÄ‚îÄ */
.region-chip{display:inline-flex;align-items:center;gap:.3rem;background:var(--s3);border:1px solid var(--border2);border-radius:99px;padding:.2rem .6rem;font-size:.68rem;color:var(--ink3)}

/* ‚îÄ‚îÄ INFO BOX ‚îÄ‚îÄ */
.info-box{border-radius:var(--r2);padding:.85rem 1rem;font-size:.8rem;line-height:1.65}
.info-lime{background:rgba(126,200,69,.07);border:1px solid rgba(126,200,69,.18);color:var(--ink2)}
.info-gold{background:rgba(240,192,64,.07);border:1px solid rgba(240,192,64,.18);color:var(--ink2)}
.info-rust{background:rgba(196,74,42,.07);border:1px solid rgba(196,74,42,.18);color:var(--ink2)}
.info-teal{background:rgba(26,158,142,.07);border:1px solid rgba(26,158,142,.18);color:var(--ink2)}

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
hr{border:none;border-top:1px solid var(--border);margin:1.25rem 0}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;text-align:center}
.empty-ic{font-size:2.5rem;margin-bottom:1rem;opacity:.4}
.empty-t{font-size:.95rem;font-weight:700;color:var(--ink2);margin-bottom:.35rem}
.empty-s{font-size:.8rem;color:var(--ink4);line-height:1.65;max-width:280px}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
.flex{display:flex}.fcc{display:flex;align-items:center}.fsc{display:flex;align-items:flex-start}.fsb{display:flex;justify-content:space-between}.fcsb{display:flex;align-items:center;justify-content:space-between}
.gap1{gap:.5rem}.gap2{gap:1rem}.gap3{gap:1.5rem}
.mt1{margin-top:.5rem}.mt2{margin-top:1rem}.mt3{margin-top:1.5rem}
.mb1{margin-bottom:.5rem}.mb2{margin-bottom:1rem}.mb3{margin-bottom:1.5rem}
.w100{width:100%}.bold{font-weight:700}.mono{font-family:var(--f-m)}
.t-sm{font-size:.8rem}.t-xs{font-size:.7rem}.t-muted{color:var(--ink3)}.t-lime{color:var(--lime)}.t-gold{color:var(--gold2)}.t-rust{color:var(--rust2)}.t-teal{color:var(--teal2)}.t-amber{color:var(--amber2)}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ PREMIUM FINTECH LOGIN ‚îÄ‚îÄ */
.lbg{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);position:relative;overflow:hidden;padding:1rem}
.lbg-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(0,208,132,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,208,132,.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none}
.lbg-glow1{position:absolute;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(0,208,132,.08) 0%,transparent 60%);top:-200px;left:-200px;pointer-events:none}
.lbg-glow2{position:absolute;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(14,175,240,.06) 0%,transparent 60%);bottom:-150px;right:-150px;pointer-events:none}
.lcard{background:rgba(8,15,21,.92);border:1px solid var(--border3);border-radius:24px;padding:2.5rem;width:100%;max-width:420px;position:relative;z-index:2;box-shadow:0 24px 80px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.06);backdrop-filter:blur(20px)}
.llogo{display:flex;align-items:center;gap:.9rem;margin-bottom:1.5rem}
.llogo-icon{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,var(--lime),#00A865);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;box-shadow:0 4px 16px rgba(0,208,132,.3)}
.llogo-name{font-family:var(--f-d);font-size:1.6rem;font-weight:800;color:var(--ink);letter-spacing:-.03em;line-height:1}
.llogo-name span{color:var(--lime)}
.llogo-sub{font-size:.73rem;color:var(--ink3);margin-top:.15rem;font-weight:500}
.lbadges{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:1.75rem}
.lbadge{font-size:.68rem;font-weight:600;padding:.22rem .65rem;border-radius:99px}
.lbadge-green{background:rgba(0,208,132,.1);color:var(--lime);border:1px solid rgba(0,208,132,.2)}
.lbadge-blue{background:rgba(37,99,235,.12);color:var(--blue2);border:1px solid rgba(37,99,235,.2)}
.lbadge-teal{background:rgba(14,175,240,.1);color:var(--teal2);border:1px solid rgba(14,175,240,.2)}
.lstep-title{font-family:var(--f-d);font-size:1.35rem;font-weight:700;color:var(--ink);margin-bottom:.35rem;letter-spacing:-.02em}
.lstep-sub{font-size:.8rem;color:var(--ink3);margin-bottom:1.5rem;line-height:1.65}
.lback{background:none;border:none;color:var(--ink3);font-size:.8rem;cursor:pointer;padding:0;margin-bottom:1rem;font-family:var(--f-b);transition:color .15s;display:block}
.lback:hover{color:var(--lime)}
.lphone-wrap{display:flex;align-items:stretch;border:1px solid var(--border3);border-radius:var(--r2);overflow:hidden;margin-bottom:1rem;background:var(--s2);transition:border-color .2s}
.lphone-wrap:focus-within{border-color:var(--lime)}
.lphone-flag{display:flex;align-items:center;padding:.7rem 1rem;background:var(--s3);font-size:.85rem;font-weight:600;color:var(--ink2);border-right:1px solid var(--border2);white-space:nowrap;flex-shrink:0}
.lphone-input{flex:1;padding:.7rem .9rem;background:transparent;border:none;color:var(--ink);font-size:1rem;font-family:var(--f-b);outline:none;letter-spacing:.05em}
.lphone-input::placeholder{color:var(--ink4)}
.lbtn-primary{width:100%;padding:.82rem;border-radius:var(--r2);background:linear-gradient(135deg,var(--lime),#00B876);color:#020B06;font-size:.9rem;font-weight:700;border:none;cursor:pointer;font-family:var(--f-b);transition:.2s;display:flex;align-items:center;justify-content:center;gap:.5rem;margin-top:.25rem;box-shadow:0 4px 20px rgba(0,208,132,.3)}
.lbtn-primary:hover:not(:disabled){background:linear-gradient(135deg,var(--lime2),var(--lime));transform:translateY(-1px);box-shadow:0 6px 28px rgba(0,208,132,.4)}
.lbtn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.lbtn-ghost{width:100%;padding:.65rem;border-radius:var(--r2);background:transparent;color:var(--ink3);font-size:.83rem;font-weight:600;border:1px solid var(--border2);cursor:pointer;font-family:var(--f-b);transition:.15s;margin-top:.6rem}
.lbtn-ghost:hover{background:var(--s2);color:var(--ink);border-color:var(--border3)}
.lspinner{width:16px;height:16px;border:2px solid rgba(0,0,0,.2);border-top-color:#020B06;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.ldivider{text-align:center;position:relative;margin:1.25rem 0;font-size:.75rem;color:var(--ink4)}
.ldivider::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:var(--border)}
.ldivider span{background:rgba(8,15,21,.92);padding:0 .75rem;position:relative}
.ldemo-title{font-size:.73rem;font-weight:600;color:var(--ink3);text-align:center;margin-bottom:.65rem;text-transform:uppercase;letter-spacing:.08em}
.ldemo-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.5rem}
.ldemo-btn{display:flex;flex-direction:column;align-items:center;gap:.3rem;padding:.65rem .5rem;border-radius:10px;background:var(--s2);border:1px solid var(--border2);cursor:pointer;font-family:var(--f-b);font-size:.75rem;font-weight:600;color:var(--ink2);transition:.15s}
.ldemo-btn:hover{background:var(--s3);border-color:var(--lime);color:var(--lime)}
.ldemo-btn-admin:hover{border-color:var(--gold2);color:var(--gold2)}
.ldemo-ic{font-size:1.2rem}
.lotp-wrap{display:flex;gap:.5rem;justify-content:center;margin:1.5rem 0}
.lotp-box{width:48px;height:56px;border-radius:10px;border:1px solid var(--border3);background:var(--s2);color:var(--ink);font-size:1.4rem;font-weight:700;text-align:center;font-family:var(--f-m);outline:none;transition:.2s;caret-color:var(--lime)}
.lotp-box:focus{border-color:var(--lime);background:var(--s3);box-shadow:0 0 0 3px rgba(0,208,132,.15)}
.lotp-hint{text-align:center;font-size:.75rem;color:var(--ink4);margin-bottom:.75rem;line-height:1.6}
.lotp-countdown{text-align:center;font-size:.78rem;color:var(--ink4);margin-top:.75rem;font-family:var(--f-m)}
.lerr{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:.55rem .8rem;font-size:.8rem;color:var(--rust2);margin-bottom:.75rem}
.lsecteur-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.5rem;margin-top:.3rem}
.lsecteur-btn{display:flex;flex-direction:column;align-items:center;gap:.35rem;padding:.75rem .5rem;border-radius:10px;border:1px solid var(--border2);background:var(--s2);cursor:pointer;transition:.15s;text-align:center;color:var(--ink3)}
.lsecteur-btn:hover,.lsecteur-btn.sel{border-color:var(--lime);background:rgba(0,208,132,.06);color:var(--lime)}
.lfooter{text-align:center;font-size:.68rem;color:var(--ink4);margin-top:1.75rem;line-height:1.7;border-top:1px solid var(--border);padding-top:1rem}
.login-flags{display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:1.75rem}
.login-flag{background:var(--s2);border:1px solid var(--border);border-radius:99px;padding:.2rem .65rem;font-size:.68rem;color:var(--ink3)}
.tabs{display:flex;gap:.4rem;background:var(--s2);padding:.3rem;border-radius:var(--r2);margin-bottom:1.5rem}
.tab{flex:1;padding:.45rem;text-align:center;border-radius:var(--r3);font-size:.8rem;font-weight:600;cursor:pointer;color:var(--ink3);transition:.2s}
.tab.on{background:var(--green);color:#fff}
.demo-btns{background:var(--s2);border:1px solid var(--border);border-radius:var(--r2);padding:.9rem 1rem;margin-top:.85rem}
.demo-label{font-size:.72rem;font-weight:700;color:var(--ink3);margin-bottom:.6rem;letter-spacing:.04em;text-transform:uppercase}
.demo-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.45rem}

@media(max-width:800px){
  .sidebar{display:none}
  .g4{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr}
  .g2,.g2-3{grid-template-columns:1fr}
  .fr,.fr3{grid-template-columns:1fr}
  .content{padding:1.25rem}
  .ph{padding:1.25rem 1.25rem 1rem}
}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:768px){
  .sidebar{position:fixed;left:-256px;top:0;bottom:0;z-index:500;transition:left .3s cubic-bezier(.4,0,.2,1)}
  .sidebar.open{left:0;box-shadow:0 0 0 100vw rgba(0,0,0,.6)}
  .main{width:100%;padding-bottom:60px}
  .g2,.g3,.g4{grid-template-columns:1fr!important}
  .g2-3{grid-template-columns:1fr!important}
  .content{padding:1.25rem 1rem}
  .ph{padding:1.25rem 1rem 1rem}
  .ph-title{font-size:1.4rem}
  .fr{grid-template-columns:1fr!important}
  .lcard{padding:1.75rem 1.25rem}
  .lotp-box{width:42px;height:50px;font-size:1.2rem}
  .mobile-header{display:flex!important}
  .stat-val{font-size:1.6rem}
}
@media(min-width:769px){.mobile-header{display:none!important}}

.mobile-header{display:none;align-items:center;justify-content:space-between;padding:.85rem 1rem;background:var(--s1);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:400}
.mobile-menu-btn{width:38px;height:38px;border-radius:9px;background:var(--s2);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;flex-shrink:0}
.mobile-logo{font-family:var(--f-d);font-size:1.15rem;font-weight:800;color:var(--ink)}
.mobile-logo span{color:var(--lime)}

/* ‚îÄ‚îÄ BOTTOM NAV (mobile) ‚îÄ‚îÄ */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:rgba(8,15,21,.95);border-top:1px solid var(--border);backdrop-filter:blur(20px);z-index:400;padding:.4rem 0 calc(.4rem + env(safe-area-inset-bottom))}
@media(max-width:768px){.bottom-nav{display:flex}}
.bn-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:.15rem;padding:.35rem .25rem;cursor:pointer;font-size:.58rem;color:var(--ink4);font-weight:600;transition:.15s;min-width:0}
.bn-item.on{color:var(--lime)}
.bn-item span:first-child{font-size:1.1rem}

/* ‚îÄ‚îÄ PWA INSTALL BANNER ‚îÄ‚îÄ */
#pwa-install-btn{display:none;position:fixed;bottom:70px;right:1rem;z-index:600;background:linear-gradient(135deg,var(--lime),#00A865);color:#020B06;border:none;border-radius:12px;padding:.65rem 1rem;font-family:var(--f-b);font-weight:700;font-size:.8rem;cursor:pointer;box-shadow:0 4px 20px rgba(0,208,132,.4);align-items:center;gap:.45rem}
@media(min-width:769px){#pwa-install-btn{bottom:1.5rem}}

/* ‚îÄ‚îÄ SCROLLBAR UPGRADE ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border3);border-radius:99px}
::-webkit-scrollbar-thumb:hover{background:var(--ink4)}

/* ‚îÄ‚îÄ FOCUS VISIBLE ‚îÄ‚îÄ */
:focus-visible{outline:2px solid var(--lime);outline-offset:2px;border-radius:4px}

/* ‚îÄ‚îÄ SELECTION ‚îÄ‚îÄ */
::selection{background:rgba(0,208,132,.25);color:var(--ink)}

/* ‚îÄ‚îÄ LOADING SKELETON ‚îÄ‚îÄ */
@keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
.skeleton{background:linear-gradient(90deg,var(--s2) 25%,var(--s3) 50%,var(--s2) 75%);background-size:400px 100%;animation:shimmer 1.4s infinite}
.skel-line{height:12px;border-radius:6px;margin-bottom:.5rem}
.skel-block{border-radius:var(--r2)}

/* ‚îÄ‚îÄ CHIP UPGRADE ‚îÄ‚îÄ */
.chip{display:inline-flex;align-items:center;gap:.28rem;padding:.22rem .65rem;border-radius:99px;font-size:.68rem;font-weight:600;letter-spacing:.01em}
</style>
</head>
</style>
</head>
<body>
<div id="root"></div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<!-- v3.1 20260226155040 -->
<script type="text/babel">
const {useState,useEffect,useCallback,useMemo,useRef} = React;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUPABASE CLIENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SB_URL  = 'https://yxpluppgnztdswwmnhfd.supabase.co';
const SB_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4cGx1cHBnbnp0ZHN3d21uaGZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNDYxMDEsImV4cCI6MjA4NzYyMjEwMX0.UObjZEihMuH3vOuiufLbaB2jlWJB2_M0a7kPui8bdLc';
const sb = supabase.createClient(SB_URL, SB_KEY);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONVERTISSEURS DB ‚Üí FORMAT APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function dbUser(u, extra={}) {
  return {
    id: u.id,
    nom: u.nom,
    telephone: u.telephone,
    village: u.village || '',
    region: u.region || 'Dakar',
    secteur: u.secteur || 'agriculture',
    role: u.role || 'paysan',
    dateInscription: (u.created_at||'').slice(0,10),
    cotisations: extra.cotisations || [],
    credits:     extra.credits     || [],
    tontines:    extra.tontines    || [],
    investissements: extra.investissements || [],
  };
}
function dbTontine(t) {
  return {
    id: t.id,
    nom: t.nom,
    admin: t.admin_id,
    secteur: t.secteur,
    region: t.region,
    montantCotis: t.montant_cotis,
    frequence: t.frequence,
    nbMax: t.nb_max,
    semaine: t.semaine_courante || 1,
    statut: t.statut,
    description: t.description || '',
    dateCreation: (t.created_at||'').slice(0,10),
    membres: (t.membres||[]).map(m=>({
      uid: m.user_id,
      tour: m.tour_num,
      pot: m.a_recu_pot,
      nom: m.user ? m.user.nom : '',
    })),
  };
}
function dbCotis(c) {
  return { id:c.id, tontineId:c.tontine_id, montant:c.montant, statut:c.statut, date:c.date };
}
function dbCredit(c) {
  return {
    id:c.id, montant:c.montant, intrant:c.intrant, partenaire:c.partenaire||'',
    statut:c.statut, scoreSnapshot:c.score_snapshot||0,
    dateOctroi:c.date_octroi, dateEcheance:c.date_echeance||'',
  };
}
function dbProjet(p) {
  return {
    id:p.id, nom:p.nom, promoteur:p.promoteur||'', region:p.region||'',
    secteur:p.secteur, description:p.description||'',
    objectif:p.objectif, collecte:p.collecte,
    dateFinancement:p.date_financement||'',
    rendementAnnuel:p.rendement_annuel, dureeMois:p.duree_mois,
    risque:p.risque, investisseurs:p.investisseurs,
    statut:p.statut, updates:p.updates||[],
    dateCreation:(p.created_at||'').slice(0,10),
  };
}
function dbInvest(i) {
  return { projetId:i.projet_id, montant:i.montant, retourAttendu:i.retour_attendu||0, date:i.date };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FONCTIONS SUPABASE CRUD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Charger les donn√©es compl√®tes d'un user
async function loadUserData(userId) {
  const [cotisRes, credRes, membresRes, investRes] = await Promise.all([
    sb.from('cotisations').select('*').eq('user_id',userId).order('date',{ascending:false}),
    sb.from('credits').select('*').eq('user_id',userId).order('date_octroi',{ascending:false}),
    sb.from('membres').select('tontine_id').eq('user_id',userId),
    sb.from('investissements').select('*').eq('user_id',userId).order('date',{ascending:false}),
  ]);
  return {
    cotisations: (cotisRes.data||[]).map(dbCotis),
    credits:     (credRes.data||[]).map(dbCredit),
    tontines:    (membresRes.data||[]).map(m=>m.tontine_id),
    investissements: (investRes.data||[]).map(dbInvest),
  };
}

// Charger toutes les tontines
async function sbFetchTontines() {
  const { data } = await sb.from('tontines')
    .select('*, membres(id,user_id,tour_num,a_recu_pot,user:users(id,nom))')
    .order('created_at',{ascending:false});
  return (data||[]).map(dbTontine);
}

// Charger tous les projets
async function sbFetchProjets() {
  const { data } = await sb.from('projets').select('*').order('created_at',{ascending:false});
  return (data||[]).map(dbProjet);
}

// Cr√©er tontine + inscrire admin comme membre
async function sbCreerTontine(user, f) {
  const { data:t, error } = await sb.from('tontines').insert({
    nom:f.nom, admin_id:user.id, secteur:f.secteur, region:f.region,
    montant_cotis:parseInt(f.montant), frequence:f.frequence,
    nb_max:parseInt(f.nbMax), description:f.desc||'', statut:'actif',
  }).select().single();
  if (error) throw new Error(error.message);
  await sb.from('membres').insert({ user_id:user.id, tontine_id:t.id, tour_num:1, a_recu_pot:false });
  return t.id;
}

// Rejoindre une tontine
async function sbRejoindre(userId, tontine) {
  if (tontine.membres.some(m=>m.uid===userId)) throw new Error('D√©j√† membre');
  if (tontine.membres.length >= tontine.nbMax) throw new Error('Tontine compl√®te');
  const { error } = await sb.from('membres').insert({
    user_id:userId, tontine_id:tontine.id,
    tour_num:tontine.membres.length+1, a_recu_pot:false,
  });
  if (error) throw new Error(error.message);
}

// Payer une cotisation
async function sbPayerCotis(userId, tontine) {
  const { data, error } = await sb.from('cotisations').insert({
    user_id:userId, tontine_id:tontine.id,
    montant:tontine.montantCotis, statut:'payee',
    date:new Date().toISOString().slice(0,10),
  }).select().single();
  if (error) throw new Error(error.message);
  return dbCotis(data);
}

// Demander un cr√©dit
async function sbDemanderCredit(userId, f, score) {
  const dateOctroi = new Date().toISOString().slice(0,10);
  const dateEcheance = new Date(Date.now()+180*24*60*60*1000).toISOString().slice(0,10);
  const { data, error } = await sb.from('credits').insert({
    user_id:userId, montant:parseInt(f.montant), intrant:f.intrant,
    partenaire:f.partenaire, statut:'approuve',
    score_snapshot:score, date_octroi:dateOctroi, date_echeance:dateEcheance,
  }).select().single();
  if (error) throw new Error(error.message);
  return dbCredit(data);
}

// Rembourser un cr√©dit
async function sbRembourser(creditId) {
  const { error } = await sb.from('credits').update({statut:'rembourse'}).eq('id',creditId);
  if (error) throw new Error(error.message);
}

// Cr√©er un projet
async function sbCreerProjet(userId, fp) {
  const { data, error } = await sb.from('projets').insert({
    nom:fp.nom, promoteur:fp.promoteur, region:fp.region, secteur:fp.secteur,
    description:fp.desc, objectif:parseInt(fp.objectif), collecte:0,
    rendement_annuel:parseInt(fp.rendement), duree_mois:parseInt(fp.duree),
    risque:fp.risque, investisseurs:0, statut:'ouvert',
    updates:[], date_financement:new Date(Date.now()+120*24*60*60*1000).toISOString().slice(0,10),
  }).select().single();
  if (error) throw new Error(error.message);
  return dbProjet(data);
}

// Investir dans un projet
async function sbInvestir(userId, projet, montant) {
  const retourBrut = Math.round(montant*(1+projet.rendementAnnuel/100*(projet.dureeMois/12)));
  const { data, error } = await sb.from('investissements').insert({
    user_id:userId, projet_id:projet.id, montant,
    retour_attendu:retourBrut-montant,
    date:new Date().toISOString().slice(0,10),
  }).select().single();
  if (error) throw new Error(error.message);
  // Mettre √† jour collecte + investisseurs c√¥t√© client (le trigger SQL le fait aussi)
  return dbInvest(data);
}

// Mettre √† jour profil
async function sbUpdateProfil(userId, f) {
  const { error } = await sb.from('users').update({
    nom:f.nom, village:f.village, region:f.region, secteur:f.secteur,
  }).eq('id',userId);
  if (error) throw new Error(error.message);
}

// Marquer retard (admin)
async function sbMarquerRetard(userId, tontineId) {
  const { error } = await sb.from('cotisations').insert({
    user_id:userId, tontine_id:tontineId,
    montant:0, statut:'retard', date:new Date().toISOString().slice(0,10),
  });
  if (error) throw new Error(error.message);
}

const REGIONS = ['Dakar','Thi√®s','Diourbel','Saint-Louis','Louga','Fatick','Kaolack','Ziguinchor','Tambacounda','K√©dougou','Kolda','S√©dhiou','Kaffrine','Matam','Podor'];
const SECTEURS = [
  {id:'agriculture', label:'Agriculture', ic:'üå±', color:'var(--lime)', cls:'sec-agri'},
  {id:'elevage', label:'√âlevage', ic:'üêÑ', color:'var(--amber2)', cls:'sec-elev'},
  {id:'mixte', label:'Agri + √âlevage', ic:'üåæ', color:'var(--teal2)', cls:'sec-mix'},
];
const INTRANTS_AGRI = ['Semences certifi√©es','Engrais NPK','Engrais DAP','Pesticides homologu√©s','Petit √©quipement','Irrigation goutte-√†-goutte','Mat√©riel de r√©colte'];
const INTRANTS_ELEV = ['Aliments b√©tail','Vaccins & m√©dicaments','√âquipement v√©t√©rinaire','Mat√©riel d\'enclos','G√©niteurs am√©lior√©s','Produits laitiers (√©quipement)'];
const PARTENAIRES = ['DER S√©n√©gal','FADA','PAM CAS','ANCAR','PRACAS','Cr√©dit Mutuel du S√©n√©gal'];
const ESPECES = ['Bovins','Ovins','Caprins','Porcins','Volaille','√âquid√©s','Camelins'];
const CULTURES = ['Arachide','Mil','Ma√Øs','Sorgho','Riz','Ni√©b√©','Coton','Tomate','Oignon','Manioc','Past√®que','Bissap'];

/* ‚îÄ‚îÄ MARCH√â CADRAN ‚Äî Constantes ‚îÄ‚îÄ */
const CATEGORIES_MARCHE = [
  {id:'cereales',   label:'C√©r√©ales',    ic:'üåæ', cls:'sec-agri'},
  {id:'legumes',    label:'L√©gumes',     ic:'ü•¶', cls:'sec-mix'},
  {id:'fruits',     label:'Fruits',      ic:'üçä', cls:'sec-mix'},
  {id:'betail',     label:'B√©tail',      ic:'üêÑ', cls:'sec-elev'},
  {id:'volaille',   label:'Volaille',    ic:'üêì', cls:'sec-elev'},
  {id:'intrants',   label:'Intrants',    ic:'üß™', cls:'ch-gray'},
  {id:'equipement', label:'√âquipement',  ic:'üöú', cls:'ch-gray'},
  {id:'autre',      label:'Autre',       ic:'üì¶', cls:'ch-gray'},
];
const UNITES = ['kg','tonne','sac (50kg)','sac (100kg)','litre','unit√©','t√™te','lot'];

/* ‚îÄ‚îÄ MARCH√â CADRAN ‚Äî Supabase CRUD ‚îÄ‚îÄ */
async function sbFetchAnnonces(filters) {
  filters = filters || {};
  let q = sb.from('annonces')
    .select('*, vendeur:users(id,nom,telephone,village,region)')
    .eq('statut','active')
    .order('created_at',{ascending:false});
  if (filters.categorie && filters.categorie!=='all') q = q.eq('categorie',filters.categorie);
  if (filters.region && filters.region!=='all') q = q.eq('region',filters.region);
  if (filters.type && filters.type!=='all') q = q.eq('type',filters.type);
  const {data} = await q;
  return data || [];
}

async function sbCreerAnnonce(userId, f) {
  const {data, error} = await sb.from('annonces').insert({
    vendeur_id: userId,
    type: f.type,
    categorie: f.categorie,
    produit: f.produit,
    description: f.description || '',
    quantite: parseFloat(f.quantite),
    unite: f.unite,
    prix_unitaire: parseInt(f.prix),
    region: f.region,
    village: f.village || '',
    contact_wave: f.wave || '',
    statut: 'active',
    vues: 0,
  }).select('*, vendeur:users(id,nom,telephone,village,region)').single();
  if (error) throw new Error(error.message);
  return data;
}

async function sbFaireOffre(annonceId, userId, montant, message) {
  const {data, error} = await sb.from('offres').insert({
    annonce_id: annonceId,
    acheteur_id: userId,
    montant: parseInt(montant),
    message: message || '',
    statut: 'en_attente',
  }).select('*, acheteur:users(id,nom,telephone,village,region)').single();
  if (error) throw new Error(error.message);
  return data;
}

async function sbFetchOffres(annonceId) {
  const {data} = await sb.from('offres')
    .select('*, acheteur:users(id,nom,telephone,village,region)')
    .eq('annonce_id',annonceId)
    .order('created_at',{ascending:false});
  return data || [];
}

async function sbAccepterOffre(offreId, annonceId) {
  await sb.from('offres').update({statut:'acceptee'}).eq('id',offreId);
  await sb.from('annonces').update({statut:'vendue'}).eq('id',annonceId);
}

async function sbIncrVues(annonceId) {
  await sb.rpc('increment_vues', {aid: annonceId});
}

/* Projets d'investissement initiaux */
const PROJETS_INIT = [
  {
    id:'p1', nom:'Ferme Avicole Moderne ‚Äî Thi√®s', promoteur:'Abdoulaye Ndiaye',
    region:'Thi√®s', secteur:'elevage', espece:'Volaille',
    description:'Construction d\'un poulailler de 5 000 places avec syst√®me automatis√©. Production d\'≈ìufs et poulets de chair pour la r√©gion de Thi√®s.',
    objectif:4500000, collecte:2850000, dateFinancement:'2026-06-30',
    rendementAnnuel:14, dureeMois:18, risque:'modere',
    investisseurs:12, statut:'ouvert', dateCreation:'2026-01-15',
    updates:['Permis de construire obtenu','Accord SODEFITEX sign√©']
  },
  {
    id:'p2', nom:'P√©rim√®tre Irrigu√© Oignons ‚Äî Saint-Louis', promoteur:'Coop√©rative Walo',
    region:'Saint-Louis', secteur:'agriculture', culture:'Oignon',
    description:'Extension d\'un p√©rim√®tre mara√Æcher de 5 hectares avec pompe solaire. 3 campagnes/an garanties par contrat avec Auchan S√©n√©gal.',
    objectif:7200000, collecte:5400000, dateFinancement:'2026-04-15',
    rendementAnnuel:18, dureeMois:24, risque:'faible',
    investisseurs:27, statut:'ouvert', dateCreation:'2025-12-10',
    updates:['Contrat Auchan sign√©','Pompe solaire command√©e','15 familles b√©n√©ficiaires']
  },
  {
    id:'p3', nom:'Ranch Bovin Am√©lior√© ‚Äî Tambacounda', promoteur:'Mamadou Ba',
    region:'Tambacounda', secteur:'elevage', espece:'Bovins',
    description:'Acquisition de 40 bovins de race am√©lior√©e (Ndama √ó Z√©bu). Exploitation laiti√®re + vente de viande. Partenariat avec NMA Sanders.',
    objectif:12000000, collecte:8400000, dateFinancement:'2026-07-31',
    rendementAnnuel:16, dureeMois:36, risque:'modere',
    investisseurs:18, statut:'ouvert', dateCreation:'2026-01-20',
    updates:['Site cl√¥tur√©','Accord v√©t√©rinaire DIREL']
  },
  {
    id:'p4', nom:'Riziculture Casamance ‚Äî Ziguinchor', promoteur:'Groupement Femmes Kabrousse',
    region:'Ziguinchor', secteur:'agriculture', culture:'Riz',
    description:'R√©habilitation de 8 ha de rizi√®res en Casamance. Vari√©t√©s am√©lior√©es ISRA, deux campagnes/an. Commercialisation locale garantie.',
    objectif:3800000, collecte:3800000, dateFinancement:'2026-03-01',
    rendementAnnuel:12, dureeMois:12, risque:'faible',
    investisseurs:31, statut:'finance', dateCreation:'2025-11-01',
    updates:['Objectif atteint !','Travaux d√©marr√©s','Premi√®re r√©colte pr√©vue juillet 2026']
  },
  {
    id:'p5', nom:'Unit√© Transformation Tomate ‚Äî Kaolack', promoteur:'UTSK SARL',
    region:'Kaolack', secteur:'mixte',
    description:'Unit√© artisanale de transformation de tomate en concentr√© et sauce. Capacit√© 2 tonnes/jour. March√© local + exportation Gambie.',
    objectif:9500000, collecte:1200000, dateFinancement:'2026-09-30',
    rendementAnnuel:20, dureeMois:30, risque:'eleve',
    investisseurs:4, statut:'ouvert', dateCreation:'2026-02-01',
    updates:['√âtude de march√© valid√©e']
  },
];

/* Utilisateurs d√©mo */
const USERS_DEMO = {
  paysan: {
    id:'u1',nom:'Baye S√®ne',telephone:'+221771234567',village:'Touba Toul',
    region:'Diourbel',secteur:'agriculture',cultures:['Arachide','Mil'],
    role:'paysan',dateInscription:'2026-01-15',
    cotisations:[
      {id:'c1',tontineId:'t1',montant:5000,statut:'payee',date:'2026-01-20'},
      {id:'c2',tontineId:'t1',montant:5000,statut:'payee',date:'2026-01-27'},
      {id:'c3',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-03'},
      {id:'c4',tontineId:'t1',montant:5000,statut:'retard',date:'2026-02-10'},
      {id:'c5',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-17'},
      {id:'c6',tontineId:'t2',montant:3000,statut:'payee',date:'2026-02-01'},
      {id:'c7',tontineId:'t2',montant:3000,statut:'payee',date:'2026-02-15'},
    ],
    credits:[{id:'cr1',montant:40000,intrant:'Semences certifi√©es',statut:'rembourse',dateOctroi:'2025-10-01',dateEcheance:'2026-04-01'}],
    investissements:[{projetId:'p2',montant:150000,date:'2026-01-20',retourAttendu:27000}],
    tontines:['t1','t2'],
  },
  eleveur: {
    id:'u3',nom:'Ousmane Diallo',telephone:'+221776543210',village:'Lingu√®re',
    region:'Louga',secteur:'elevage',especes:['Bovins','Ovins'],
    role:'paysan',dateInscription:'2026-01-08',
    cotisations:[
      {id:'c10',tontineId:'t3',montant:10000,statut:'payee',date:'2026-01-15'},
      {id:'c11',tontineId:'t3',montant:10000,statut:'payee',date:'2026-02-15'},
      {id:'c12',tontineId:'t3',montant:10000,statut:'payee',date:'2026-02-20'},
    ],
    credits:[],
    investissements:[{projetId:'p1',montant:250000,date:'2026-01-25',retourAttendu:35000}],
    tontines:['t3'],
  },
  admin: {
    id:'u2',nom:'Mariama Diallo',telephone:'+221775551234',village:'Bambey',
    region:'Diourbel',secteur:'mixte',
    role:'admin',dateInscription:'2025-12-01',
    cotisations:[
      {id:'c8',tontineId:'t1',montant:5000,statut:'payee',date:'2026-01-20'},
      {id:'c9',tontineId:'t1',montant:5000,statut:'payee',date:'2026-01-27'},
      {id:'c10b',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-03'},
      {id:'c11b',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-10'},
      {id:'c12b',tontineId:'t1',montant:5000,statut:'payee',date:'2026-02-17'},
    ],
    credits:[],
    investissements:[],
    tontines:['t1'],
  },
};

const TONTINES_INIT = [
  {id:'t1',nom:'Tontine Espoir Bambey',admin:'u2',secteur:'agriculture',region:'Diourbel',
   montantCotis:5000,frequence:'hebdomadaire',nbMax:10,semaine:8,dateCreation:'2025-12-01',statut:'actif',
   description:'Tontine hebdomadaire agriculture. Financement semences et engrais.',
   membres:[{uid:'u1',tour:3,pot:false},{uid:'u2',tour:1,pot:true,nom:'Mariama Diallo'},{uid:'u3b',tour:2,pot:true,nom:'Fatou Ndiaye'},{uid:'u4',tour:4,pot:false,nom:'Ibrahima Sow'}]},
  {id:'t2',nom:'Groupe Agricole National',admin:'u2',secteur:'agriculture',region:'Thi√®s',
   montantCotis:3000,frequence:'mensuel',nbMax:8,semaine:3,dateCreation:'2026-01-10',statut:'actif',
   description:'Groupe mensuel multi-r√©gions pour cultures mara√Æch√®res.',
   membres:[{uid:'u1',tour:2,pot:false},{uid:'u5',tour:1,pot:true,nom:'Aissatou Ba'},{uid:'u6',tour:3,pot:false,nom:'Moussa Diop'}]},
  {id:'t3',nom:'√âleveurs du Nord',admin:'u3',secteur:'elevage',region:'Louga',
   montantCotis:10000,frequence:'mensuel',nbMax:6,semaine:2,dateCreation:'2026-01-05',statut:'actif',
   description:'Tontine mensuelle pour √©leveurs bovins et ovins du Nord S√©n√©gal.',
   membres:[{uid:'u3',tour:1,pot:false},{uid:'u7',tour:2,pot:false,nom:'Aliou Mbaye'},{uid:'u8',tour:3,pot:false,nom:'Samba Gaye'}]},
];

/* ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ */
function calcScore(user) {
  const c = user.cotisations || [];
  if (!c.length) return 0;
  const paid = c.filter(x=>x.statut==='payee').length;
  const retards = c.filter(x=>x.statut==='retard').length;
  const tontines = (user.tontines||[]).length;
  const credRembourses = (user.credits||[]).filter(x=>x.statut==='rembourse').length;
  const investOk = (user.investissements||[]).length;
  return Math.round(Math.max(0,Math.min(100,
    (paid/c.length)*60 +
    Math.min(tontines/5,1)*12 +
    Math.min(c.length/24,1)*10 +
    Math.min(credRembourses/3,1)*10 +
    Math.min(investOk/2,1)*3 -
    retards*5
  )));
}

/* ‚îÄ‚îÄ TOAST HOOK ‚îÄ‚îÄ */
let tid=0;
function useToast(){
  const [toasts,setToasts]=useState([]);
  const add=useCallback((msg,type='s')=>{
    const id=++tid;
    setToasts(p=>[...p,{id,msg,type}]);
    setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3800);
  },[]);
  return {toasts,add};
}

/* ‚îÄ‚îÄ COMPOSANTS UTILITAIRES ‚îÄ‚îÄ */
function ScoreRing({score,sz=100,fsz='1.5rem'}){
  const r=(sz-8)/2,circ=2*Math.PI*r,dash=(score/100)*circ;
  const col=score>=65?'var(--lime)':score>=40?'var(--gold2)':'var(--rust2)';
  return(
    <div className="ring-wrap">
      <div className="ring" style={{width:sz,height:sz}}>
        <svg width={sz} height={sz}>
          <circle cx={sz/2} cy={sz/2} r={r} fill="none" stroke="rgba(255,255,255,.06)" strokeWidth="7"/>
          <circle cx={sz/2} cy={sz/2} r={r} fill="none" stroke={col} strokeWidth="7"
            strokeDasharray={`${dash} ${circ}`} strokeLinecap="round"
            style={{transition:'stroke-dasharray .7s ease'}}/>
        </svg>
        <div className="ring-inner">
          <div className="ring-n" style={{fontSize:fsz,color:col}}>{score}</div>
          <div className="ring-s">/100</div>
        </div>
      </div>
      <div className="ring-lbl">Score cr√©dit</div>
    </div>
  );
}

function Modal({title,onClose,children,lg}){
  return(
    <div className="overlay" onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div className={`modal${lg?' modal-lg':''}`}>
        <div className="mh">
          <div className="m-title">{title}</div>
          <div className="m-close" onClick={onClose}>‚úï</div>
        </div>
        <div className="mb">{children}</div>
      </div>
    </div>
  );
}

function Toasts({toasts}){
  return(
    <div className="toast-cont">
      {toasts.map(t=>(
        <div key={t.id} className={`toast toast-${t.type}`}>
          <span>{t.type==='s'?'‚úÖ':t.type==='e'?'‚ùå':'‚ÑπÔ∏è'}</span>
          <span style={{color:'var(--ink)'}}>{t.msg}</span>
        </div>
      ))}
    </div>
  );
}

function PBar({pct,color='var(--lime)',h=4}){
  return(
    <div className="pbar-wrap" style={{height:h}}>
      <div className="pbar-fill" style={{width:pct+'%',background:color,height:h}}/>
    </div>
  );
}

function SectorBadge({secteur}){
  const s=SECTEURS.find(x=>x.id===secteur)||{label:secteur,ic:'üåø',cls:'ch-gray'};
  return <span className={`sector-badge ${s.cls}`}>{s.ic} {s.label}</span>;
}
/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
function Dashboard({user,tontines,projets,toast}){
  const score=calcScore(user);
  const mesTontines=tontines.filter(t=>t.membres.some(m=>m.uid===user.id));
  const totalCotis=user.cotisations.filter(c=>c.statut==='payee').reduce((s,c)=>s+c.montant,0);
  const retards=user.cotisations.filter(c=>c.statut==='retard').length;
  const creditDispo=Math.max(0,score*1000);
  const mesInvests=user.investissements||[];
  const totalInvesti=mesInvests.reduce((s,i)=>s+i.montant,0);
  const totalRetour=mesInvests.reduce((s,i)=>s+i.retourAttendu,0);

  const secteurInfo=SECTEURS.find(s=>s.id===user.secteur)||SECTEURS[0];
  const recentActs=[
    ...user.cotisations.slice(-3).reverse().map(c=>({
      ic:c.statut==='payee'?'üí∏':'‚ö†Ô∏è',
      cls:c.statut==='payee'?'act-g':'act-y',
      text:`Cotisation ${c.statut==='payee'?'pay√©e':'en retard'} ‚Äî ${c.montant.toLocaleString('fr-FR')} FCFA`,
      date:c.date
    })),
    ...mesInvests.slice(-2).map(i=>{
      const p=projets.find(x=>x.id===i.projetId);
      return{ic:'üíº',cls:'act-b',text:`Investissement "${p?.nom||'Projet'}" ‚Äî ${i.montant.toLocaleString('fr-FR')} FCFA`,date:i.date};
    }),
  ].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Tableau de bord</div>
            <div className="ph-title">Bonjour, {user.nom.split(' ')[0]} üëã</div>
            <div className="ph-sub fcc gap1">
              <SectorBadge secteur={user.secteur}/>
              <span className="region-chip">üìç {user.village}, {user.region}</span>
              <span className="t-xs t-muted">Inscrit le {user.dateInscription}</span>
            </div>
          </div>
          <ScoreRing score={score} sz={90} fsz="1.35rem"/>
        </div>
      </div>

      <div className="content">
        <div className="g4 mb3">
          <div className="stat" style={{'--glow':'rgba(126,200,69,.07)'}}>
            <div className="stat-ic">üè¶</div>
            <div className="stat-val">{creditDispo.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Cr√©dit disponible (FCFA)</div>
            <div className="stat-sub"><span className={score>=40?'up':'dn'}>{score>=40?'‚úì √âligible':'‚úó Score < 40'}</span></div>
          </div>
          <div className="stat" style={{'--glow':'rgba(240,192,64,.07)'}}>
            <div className="stat-ic">üí∏</div>
            <div className="stat-val">{totalCotis.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Total cotis√© (FCFA)</div>
            <div className="stat-sub"><span className="up">‚Üë {user.cotisations.filter(c=>c.statut==='payee').length} paiements</span></div>
          </div>
          <div className="stat" style={{'--glow':'rgba(26,158,142,.07)'}}>
            <div className="stat-ic">üíº</div>
            <div className="stat-val">{totalInvesti.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Total investi (FCFA)</div>
            <div className="stat-sub"><span className="up">+{totalRetour.toLocaleString('fr-FR')} FCFA attendus</span></div>
          </div>
          <div className="stat" style={{'--glow':'rgba(196,74,42,.07)'}}>
            <div className="stat-ic">‚ö†Ô∏è</div>
            <div className="stat-val">{retards}</div>
            <div className="stat-lbl">Retards de paiement</div>
            <div className="stat-sub"><span className={retards===0?'up':'dn'}>{retards===0?'‚úì Parfait':'‚àí'+(retards*5)+' pts'}</span></div>
          </div>
        </div>

        <div className="g2 mb3">
          {/* Score d√©tail */}
          <div className="card">
            <div className="card-title">üìä Score IA d√©taill√©</div>
            <div className="fcc gap2 mb2">
              <ScoreRing score={score} sz={110} fsz="1.65rem"/>
              <div style={{flex:1}}>
                {[
                  {l:'Taux de paiement',v:Math.round((user.cotisations.filter(c=>c.statut==='payee').length/Math.max(user.cotisations.length,1))*60),m:60},
                  {l:'Multi-tontines',v:Math.round(Math.min((user.tontines||[]).length/5,1)*12),m:12},
                  {l:'Volume transactions',v:Math.round(Math.min(user.cotisations.length/24,1)*10),m:10},
                  {l:'Cr√©dits rembours√©s',v:Math.round(Math.min((user.credits||[]).filter(c=>c.statut==='rembourse').length/3,1)*10),m:10},
                  {l:'Investissements',v:Math.round(Math.min((user.investissements||[]).length/2,1)*3),m:3},
                ].map(item=>(
                  <div key={item.l} style={{marginBottom:'.48rem'}}>
                    <div className="fcsb t-xs t-muted mb1">
                      <span>{item.l}</span>
                      <span className="mono t-lime">{item.v}/{item.m}</span>
                    </div>
                    <PBar pct={item.v/item.m*100}/>
                  </div>
                ))}
                {retards>0&&<div className="t-xs t-rust mt1">‚ö† Malus: ‚àí{retards*5} pts ({retards} retard{retards>1?'s':''})</div>}
              </div>
            </div>
            <div className="info-box info-lime">
              üí° Plafond cr√©dit : <strong className="t-gold">{creditDispo.toLocaleString('fr-FR')} FCFA</strong> ¬∑ score √ó 1 000 FCFA
            </div>
          </div>

          {/* Activit√© r√©cente */}
          <div className="card">
            <div className="card-title">üïê Activit√© r√©cente</div>
            {recentActs.length===0
              ?<div className="empty"><div className="empty-ic">üì≠</div><div className="empty-s">Aucune activit√© pour l'instant</div></div>
              :recentActs.map((a,i)=>(
                <div key={i} className="act-item">
                  <div className={`act-ic ${a.cls}`}>{a.ic}</div>
                  <div><div className="act-text">{a.text}</div><div className="act-date">{a.date}</div></div>
                </div>
              ))
            }
          </div>
        </div>

        {/* Mes tontines r√©sum√© */}
        {mesTontines.length>0&&(
          <div className="card">
            <div className="card-title">ü§ù Mes tontines actives <span>({mesTontines.length})</span></div>
            <div className="gauto">
              {mesTontines.map(t=>{
                const moi=t.membres.find(m=>m.uid===user.id);
                return(
                  <div key={t.id} className="card-sm">
                    <div className="fcsb mb1">
                      <div className="bold t-sm">{t.nom}</div>
                      <SectorBadge secteur={t.secteur}/>
                    </div>
                    <div className="fcc gap1 t-xs t-muted mb2">
                      <span>üìç {t.region}</span>
                      <span>¬∑ {t.frequence}</span>
                    </div>
                    <div className="fcsb t-xs">
                      <span className="t-muted">Mon tour</span>
                      <span className="mono t-gold">N¬∞{moi?.tour} ¬∑ {moi?.pot?'‚úì Re√ßu':'En attente'}</span>
                    </div>
                    <div className="fcsb t-xs mt1">
                      <span className="t-muted">Pot mensuel</span>
                      <span className="mono t-lime">{(t.montantCotis*t.membres.length).toLocaleString('fr-FR')} FCFA</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Investissements actifs */}
        {mesInvests.length>0&&(
          <div className="card mt3">
            <div className="card-title">üíº Mes investissements <span>({mesInvests.length})</span></div>
            <div className="gauto">
              {mesInvests.map((inv,i)=>{
                const p=projets.find(x=>x.id===inv.projetId);
                if(!p)return null;
                return(
                  <div key={i} className="card-sm" style={{borderTop:`2px solid var(--gold)`}}>
                    <div className="bold t-sm mb1">{p.nom}</div>
                    <div className="fcsb t-xs mb2">
                      <span className="t-muted">Investi</span>
                      <span className="mono t-gold">{inv.montant.toLocaleString('fr-FR')} FCFA</span>
                    </div>
                    <div className="fcsb t-xs mb2">
                      <span className="t-muted">Retour attendu</span>
                      <span className="mono t-lime">+{inv.retourAttendu.toLocaleString('fr-FR')} FCFA</span>
                    </div>
                    <div className="fcsb t-xs">
                      <span className="t-muted">Rendement</span>
                      <span className="chip ch-gold">{p.rendementAnnuel}%/an</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ TONTINES ‚îÄ‚îÄ */
function Tontines({user,tontines,setTontines,toast}){
  const [modal,setModal]=useState(null);
  const [filterSec,setFilterSec]=useState('all');
  const [filterReg,setFilterReg]=useState('all');
  const [f,setF]=useState({nom:'',montant:'5000',frequence:'hebdomadaire',nbMax:'10',secteur:user.secteur||'agriculture',region:user.region,desc:''});

  const mesTontines=tontines.filter(t=>t.membres.some(m=>m.uid===user.id));
  const autresTontines=tontines.filter(t=>!t.membres.some(m=>m.uid===user.id));
  const filtered=autresTontines.filter(t=>(filterSec==='all'||t.secteur===filterSec)&&(filterReg==='all'||t.region===filterReg));

  const creer=()=>{
    if(!f.nom||!f.montant)return;
    const nt={
      id:'t_'+Date.now(),nom:f.nom,admin:user.id,secteur:f.secteur,region:f.region,
      montantCotis:+f.montant,frequence:f.frequence,nbMax:+f.nbMax,semaine:1,
      dateCreation:new Date().toISOString().slice(0,10),statut:'actif',description:f.desc,
      membres:[{uid:user.id,tour:1,pot:false}]
    };
    setTontines(p=>[...p,nt]);
    toast('Tontine "'+f.nom+'" cr√©√©e !');
    setModal(null);
  };

  const rejoindre=(tid)=>{
    setTontines(p=>p.map(t=>{
      if(t.id!==tid)return t;
      if(t.membres.some(m=>m.uid===user.id)){toast('D√©j√† membre','e');return t;}
      if(t.membres.length>=t.nbMax){toast('Tontine compl√®te','e');return t;}
      toast('Vous avez rejoint "'+t.nom+'" !');
      return{...t,membres:[...t.membres,{uid:user.id,tour:t.membres.length+1,pot:false}]};
    }));
  };

  const TCard=({t,membre})=>{
    const moi=t.membres.find(m=>m.uid===user.id);
    const isAdm=t.admin===user.id;
    const pct=Math.round(t.membres.length/t.nbMax*100);
    const pot=t.montantCotis*t.membres.length;
    return(
      <div className="card" style={{cursor:'default'}}>
        <div className="fcsb mb1">
          <div style={{fontFamily:'var(--f-d)',fontSize:'1.05rem',fontWeight:700,color:'var(--ink)'}}>{t.nom}</div>
          <div className="fcc gap1">
            {isAdm&&<span className="chip ch-gold">üëë Admin</span>}
            <span className={`chip ${t.statut==='actif'?'ch-lime':'ch-gray'}`}>{t.statut}</span>
          </div>
        </div>
        <div className="fcc gap2 mb2 t-xs t-muted">
          <SectorBadge secteur={t.secteur}/>
          <span className="region-chip">üìç {t.region}</span>
        </div>
        {t.description&&<div className="t-xs t-muted mb2" style={{lineHeight:1.65}}>{t.description}</div>}
        <div className="fcc gap2 mb2 t-xs t-muted flex-wrap">
          <span>üí∞ {t.montantCotis.toLocaleString('fr-FR')} FCFA/{t.frequence==='hebdomadaire'?'sem':'mois'}</span>
          <span>üë• {t.membres.length}/{t.nbMax} membres</span>
          <span>üìÖ Tour {t.semaine}</span>
        </div>
        <div className="mb2">
          <div className="fcsb t-xs mb1"><span className="t-muted">Remplissage</span><span className="mono t-lime">{pct}%</span></div>
          <PBar pct={pct}/>
        </div>
        <div className="fcsb">
          <div className="t-xs t-muted">
            Pot max : <strong className="t-gold">{pot.toLocaleString('fr-FR')} FCFA</strong>
            {moi&&<span className="ml1"> ¬∑ Tour N¬∞{moi.tour}</span>}
          </div>
          {!membre
            ?<button className="btn btn-green btn-sm" onClick={()=>rejoindre(t.id)}>Rejoindre ‚Üí</button>
            :<span className="chip ch-lime">‚úì Membre</span>
          }
        </div>
      </div>
    );
  };

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Tontines</div>
            <div className="ph-title">Tontines nationales</div>
            <div className="ph-sub">Agriculture ¬∑ √âlevage ¬∑ Mixte ¬∑ {tontines.length} tontines actives</div>
          </div>
          <div className="ph-actions">
            <button className="btn btn-lime" onClick={()=>setModal('creer')}>+ Cr√©er une tontine</button>
          </div>
        </div>
      </div>
      <div className="content">
        {mesTontines.length>0&&(
          <div className="mb3">
            <div className="bold t-sm t-muted mb2">Mes tontines ({mesTontines.length})</div>
            <div className="gauto">{mesTontines.map(t=><TCard key={t.id} t={t} membre={true}/>)}</div>
          </div>
        )}
        <div className="fcsb mb2 flex-wrap gap2">
          <div className="bold t-sm t-muted">Tontines disponibles ({filtered.length})</div>
          <div className="fcc gap1">
            <select className="btn btn-ghost btn-sm" value={filterSec} onChange={e=>setFilterSec(e.target.value)} style={{padding:'.35rem .7rem',background:'var(--s2)',border:'1px solid var(--border2)',borderRadius:'var(--r2)',color:'var(--ink2)',fontFamily:'var(--f-b)',fontSize:'.78rem'}}>
              <option value="all">Tous secteurs</option>
              {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
            </select>
            <select className="btn btn-ghost btn-sm" value={filterReg} onChange={e=>setFilterReg(e.target.value)} style={{padding:'.35rem .7rem',background:'var(--s2)',border:'1px solid var(--border2)',borderRadius:'var(--r2)',color:'var(--ink2)',fontFamily:'var(--f-b)',fontSize:'.78rem'}}>
              <option value="all">Toutes r√©gions</option>
              {REGIONS.map(r=><option key={r}>{r}</option>)}
            </select>
          </div>
        </div>
        {filtered.length>0
          ?<div className="gauto">{filtered.map(t=><TCard key={t.id} t={t} membre={false}/>)}</div>
          :<div className="empty"><div className="empty-ic">üîç</div><div className="empty-t">Aucune tontine trouv√©e</div><div className="empty-s">Modifiez les filtres ou cr√©ez la premi√®re tontine de votre r√©gion</div></div>
        }
      </div>

      {modal==='creer'&&(
        <Modal title="Cr√©er une tontine" onClose={()=>setModal(null)}>
          <div className="fg"><label>Nom de la tontine</label><input value={f.nom} onChange={e=>setF({...f,nom:e.target.value})} placeholder="Ex: √âleveurs du Ferlo"/></div>
          <div className="fr">
            <div className="fg"><label>Secteur</label>
              <select value={f.secteur} onChange={e=>setF({...f,secteur:e.target.value})}>
                {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
              </select>
            </div>
            <div className="fg"><label>R√©gion</label>
              <select value={f.region} onChange={e=>setF({...f,region:e.target.value})}>
                {REGIONS.map(r=><option key={r}>{r}</option>)}
              </select>
            </div>
          </div>
          <div className="fr">
            <div className="fg"><label>Cotisation (FCFA)</label><input type="number" value={f.montant} onChange={e=>setF({...f,montant:e.target.value})} placeholder="5000"/></div>
            <div className="fg"><label>Membres max</label><input type="number" value={f.nbMax} onChange={e=>setF({...f,nbMax:e.target.value})} placeholder="10"/></div>
          </div>
          <div className="fg"><label>Fr√©quence</label>
            <select value={f.frequence} onChange={e=>setF({...f,frequence:e.target.value})}>
              <option value="hebdomadaire">Hebdomadaire</option>
              <option value="mensuel">Mensuel</option>
              <option value="bimensuel">Bimensuel</option>
            </select>
          </div>
          <div className="fg"><label>Description</label><textarea value={f.desc} onChange={e=>setF({...f,desc:e.target.value})} placeholder="Objectif du groupe, types d'activit√©s..."/></div>
          <div className="frow-btns">
            <button className="btn btn-ghost" onClick={()=>setModal(null)}>Annuler</button>
            <button className="btn btn-lime" onClick={creer}>Cr√©er ‚Üí</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ COTISATIONS ‚îÄ‚îÄ */
function Cotisations({user,setUser,tontines,toast}){
  const [modal,setModal]=useState(null);
  const [sel,setSel]=useState('');
  const mesTontines=tontines.filter(t=>t.membres.some(m=>m.uid===user.id));

  const payer=()=>{
    if(!sel)return;
    const t=tontines.find(x=>x.id===sel);
    if(!t)return;
    const nc={id:'c_'+Date.now(),tontineId:sel,montant:t.montantCotis,statut:'payee',date:new Date().toISOString().slice(0,10)};
    setUser(u=>({...u,cotisations:[...u.cotisations,nc]}));
    toast('Cotisation de '+t.montantCotis.toLocaleString('fr-FR')+' FCFA enregistr√©e ! Score recalcul√©.');
    setModal(null);setSel('');
  };

  const all=user.cotisations.map(c=>{
    const t=tontines.find(x=>x.id===c.tontineId);
    return{...c,tontineName:t?.nom||'‚Äî',secteur:t?.secteur||'agriculture'};
  }).sort((a,b)=>new Date(b.date)-new Date(a.date));

  const totalP=all.filter(c=>c.statut==='payee').reduce((s,c)=>s+c.montant,0);
  const taux=all.length>0?Math.round(all.filter(c=>c.statut==='payee').length/all.length*100):0;
  const retards=all.filter(c=>c.statut==='retard').length;

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Cotisations</div>
            <div className="ph-title">Historique des paiements</div>
            <div className="ph-sub">{all.length} cotisation{all.length!==1?'s':''} ¬∑ Taux : {taux}%</div>
          </div>
          <button className="btn btn-lime" onClick={()=>setModal('payer')}>+ Enregistrer paiement</button>
        </div>
      </div>
      <div className="content">
        <div className="g3 mb3">
          <div className="stat"><div className="stat-ic">üí∞</div><div className="stat-val">{totalP.toLocaleString('fr-FR')}</div><div className="stat-lbl">Total cotis√© (FCFA)</div></div>
          <div className="stat">
            <div className="stat-ic">üìà</div><div className="stat-val">{taux}%</div><div className="stat-lbl">Taux de paiement</div>
            <div className="stat-sub"><span className={taux>=80?'up':'dn'}>{taux>=80?'‚úì Excellent':'‚ö† √Ä am√©liorer'}</span></div>
          </div>
          <div className="stat"><div className="stat-ic">‚ö†Ô∏è</div><div className="stat-val">{retards}</div><div className="stat-lbl">Retards (‚àí{retards*5} pts)</div></div>
        </div>
        {all.length===0
          ?<div className="empty"><div className="empty-ic">üí∏</div><div className="empty-t">Aucune cotisation</div><div className="empty-s">Enregistrez votre premi√®re cotisation pour commencer √† construire votre score IA</div></div>
          :<div className="card">
            <div className="card-title">Toutes les cotisations</div>
            <div className="tbl-wrap">
              <table>
                <thead><tr><th>Date</th><th>Tontine</th><th>Secteur</th><th>Montant</th><th>Statut</th></tr></thead>
                <tbody>{all.map(c=>(
                  <tr key={c.id}>
                    <td className="mono t-sm">{c.date}</td>
                    <td className="bold">{c.tontineName}</td>
                    <td><SectorBadge secteur={c.secteur}/></td>
                    <td className="mono t-gold">{c.montant.toLocaleString('fr-FR')} FCFA</td>
                    <td><span className={`chip ${c.statut==='payee'?'ch-lime':c.statut==='retard'?'ch-rust':'ch-gray'}`}>{c.statut}</span></td>
                  </tr>
                ))}</tbody>
              </table>
            </div>
          </div>
        }
      </div>

      {modal==='payer'&&(
        <Modal title="Enregistrer une cotisation" onClose={()=>setModal(null)}>
          <div className="info-box info-teal mb2">
            üí° En production : paiement d√©clench√© via <strong>Wave Mobile Money</strong>. Enregistrement instantan√©.
          </div>
          <div className="fg"><label>S√©lectionner la tontine</label>
            <select value={sel} onChange={e=>setSel(e.target.value)}>
              <option value="">‚Äî Choisir ‚Äî</option>
              {mesTontines.map(t=><option key={t.id} value={t.id}>{t.nom} ¬∑ {t.montantCotis.toLocaleString('fr-FR')} FCFA</option>)}
            </select>
          </div>
          {sel&&(
            <div className="card-sm mb2">
              <div className="fcsb t-sm mb1"><span className="t-muted">Montant</span><span className="mono t-gold">{tontines.find(t=>t.id===sel)?.montantCotis.toLocaleString('fr-FR')} FCFA</span></div>
              <div className="fcsb t-sm"><span className="t-muted">Date</span><span className="mono">{new Date().toISOString().slice(0,10)}</span></div>
            </div>
          )}
          <div className="frow-btns">
            <button className="btn btn-ghost" onClick={()=>setModal(null)}>Annuler</button>
            <button className="btn btn-lime" onClick={payer} disabled={!sel}>‚úì Confirmer</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ CR√âDITS INTRANTS ‚îÄ‚îÄ */
function Credits({user,setUser,toast}){
  const [modal,setModal]=useState(null);
  const [f,setF]=useState({intrant:'',montant:'',partenaire:'DER S√©n√©gal'});
  const score=calcScore(user);
  const plafond=score*1000;
  const eligible=score>=40;
  const credits=user.credits||[];

  const intrantsDispos=user.secteur==='elevage'?INTRANTS_ELEV:user.secteur==='agriculture'?INTRANTS_AGRI:[...INTRANTS_AGRI,...INTRANTS_ELEV];

  const demander=()=>{
    if(!eligible){toast('Score insuffisant (< 40)','e');return;}
    const m=+f.montant;
    if(!m||m<=0){toast('Montant invalide','e');return;}
    if(m>plafond){toast('D√©passe votre plafond : '+plafond.toLocaleString('fr-FR')+' FCFA','e');return;}
    if(!f.intrant){toast('Choisissez un intrant','e');return;}
    const nc={
      id:'cr_'+Date.now(),montant:m,intrant:f.intrant,partenaire:f.partenaire,
      statut:'approuve',scoreSnapshot:score,secteur:user.secteur,
      dateOctroi:new Date().toISOString().slice(0,10),
      dateEcheance:new Date(Date.now()+180*24*60*60*1000).toISOString().slice(0,10),
    };
    setUser(u=>({...u,credits:[...(u.credits||[]),nc]}));
    toast('‚úì Cr√©dit '+m.toLocaleString('fr-FR')+' FCFA approuv√© ! R√©cup√©rez vos '+f.intrant+'.');
    setModal(null);setF({intrant:'',montant:'',partenaire:'DER S√©n√©gal'});
  };

  const rembourser=(id)=>{
    setUser(u=>({...u,credits:u.credits.map(c=>c.id===id?{...c,statut:'rembourse'}:c)}));
    toast('‚úì Cr√©dit rembours√© ! +10 pts au prochain score.');
  };

  const actifs=credits.filter(c=>c.statut==='approuve');
  const hist=credits.filter(c=>c.statut!=='approuve');

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Cr√©dits intrants</div>
            <div className="ph-title">Financement {user.secteur==='elevage'?'√©levage':'agricole'}</div>
            <div className="ph-sub">Score {score}/100 ¬∑ Plafond : {plafond.toLocaleString('fr-FR')} FCFA ¬∑ <SectorBadge secteur={user.secteur}/></div>
          </div>
          {eligible&&<button className="btn btn-lime" onClick={()=>setModal('demander')}>+ Demander un cr√©dit</button>}
        </div>
      </div>
      <div className="content">
        <div className="g3 mb3">
          <div className="stat" style={{'--glow':eligible?'rgba(126,200,69,.07)':'rgba(196,74,42,.07)'}}>
            <div className="stat-ic">{eligible?'‚úÖ':'‚ùå'}</div>
            <div className="stat-val" style={{fontSize:'1.2rem',color:eligible?'var(--lime)':'var(--rust2)'}}>{eligible?'√âligible':'Non √©ligible'}</div>
            <div className="stat-lbl">Score {score}/100 ¬∑ Seuil : 40</div>
          </div>
          <div className="stat"><div className="stat-ic">üí≥</div><div className="stat-val">{plafond.toLocaleString('fr-FR')}</div><div className="stat-lbl">Plafond cr√©dit (FCFA)</div></div>
          <div className="stat"><div className="stat-ic">üìã</div><div className="stat-val">{credits.length}</div><div className="stat-lbl">Total cr√©dits</div></div>
        </div>

        {!eligible&&(
          <div className="info-box info-gold mb3">
            <strong>‚ö† Score insuffisant</strong> ‚Äî Score actuel : <strong>{score}/100</strong>. Minimum requis : <strong>40 points</strong>. Continuez √† cotiser ponctuellement pour augmenter votre score.
          </div>
        )}

        {actifs.length>0&&(
          <div className="card mb3">
            <div className="card-title">üü¢ Cr√©dits en cours</div>
            <div className="gauto">
              {actifs.map(cr=>(
                <div key={cr.id} className="card-sm" style={{borderTop:'2px solid var(--lime)'}}>
                  <div className="fcsb mb1">
                    <div className="t-gold bold" style={{fontFamily:'var(--f-d)',fontSize:'1.3rem'}}>{cr.montant.toLocaleString('fr-FR')} FCFA</div>
                    <span className="chip ch-lime">En cours</span>
                  </div>
                  <div className="t-xs t-muted mb1 uppercase" style={{letterSpacing:'.04em'}}>{cr.intrant} ¬∑ {cr.partenaire}</div>
                  <div className="t-xs t-muted mb1">Octroi : {cr.dateOctroi}</div>
                  <div className="t-xs t-muted mb1">√âch√©ance : <strong className="t-rust">{cr.dateEcheance}</strong></div>
                  <div className="t-xs t-muted mb2">Score snapshot : <span className="mono t-lime">{cr.scoreSnapshot}/100</span></div>
                  <button className="btn btn-green btn-sm w100" style={{justifyContent:'center'}} onClick={()=>rembourser(cr.id)}>‚úì Marquer rembours√©</button>
                </div>
              ))}
            </div>
          </div>
        )}

        {hist.length>0&&(
          <div className="card">
            <div className="card-title">Historique cr√©dits</div>
            <div className="tbl-wrap">
              <table>
                <thead><tr><th>Date</th><th>Intrant</th><th>Montant</th><th>Partenaire</th><th>Score</th><th>Statut</th></tr></thead>
                <tbody>{hist.map(cr=>(
                  <tr key={cr.id}>
                    <td className="mono t-sm">{cr.dateOctroi}</td>
                    <td>{cr.intrant}</td>
                    <td className="mono t-gold">{cr.montant.toLocaleString('fr-FR')}</td>
                    <td><span className="chip ch-blue">{cr.partenaire}</span></td>
                    <td className="mono t-lime">{cr.scoreSnapshot}</td>
                    <td><span className={`chip ${cr.statut==='rembourse'?'ch-lime':'ch-rust'}`}>{cr.statut}</span></td>
                  </tr>
                ))}</tbody>
              </table>
            </div>
          </div>
        )}

        {credits.length===0&&<div className="empty"><div className="empty-ic">üå±</div><div className="empty-t">Aucun cr√©dit</div><div className="empty-s">{eligible?'Vous √™tes √©ligible. Demandez votre premier cr√©dit intrants.':'Cotisez r√©guli√®rement pour construire votre score.'}</div></div>}
      </div>

      {modal==='demander'&&(
        <Modal title="Demander un cr√©dit intrants" onClose={()=>setModal(null)}>
          <div className="card-sm mb2">
            <div className="fcsb t-sm mb1"><span className="t-muted">Votre score</span><span className="mono t-lime">{score}/100</span></div>
            <div className="fcsb t-sm"><span className="t-muted">Plafond disponible</span><span className="mono t-gold">{plafond.toLocaleString('fr-FR')} FCFA</span></div>
          </div>
          <div className="fg"><label>Type d'intrant</label>
            <select value={f.intrant} onChange={e=>setF({...f,intrant:e.target.value})}>
              <option value="">‚Äî Choisir ‚Äî</option>
              {intrantsDispos.map(i=><option key={i}>{i}</option>)}
            </select>
          </div>
          <div className="fg"><label>Montant demand√© (FCFA)</label>
            <input type="number" value={f.montant} onChange={e=>setF({...f,montant:e.target.value})} placeholder={'Max : '+plafond.toLocaleString('fr-FR')}/>
          </div>
          <div className="fg"><label>Partenaire financeur</label>
            <select value={f.partenaire} onChange={e=>setF({...f,partenaire:e.target.value})}>
              {PARTENAIRES.map(p=><option key={p}>{p}</option>)}
            </select>
          </div>
          <div className="frow-btns">
            <button className="btn btn-ghost" onClick={()=>setModal(null)}>Annuler</button>
            <button className="btn btn-lime" onClick={demander}>Approuver ‚Üí</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INVESTISSEMENT (MODULE NOUVEAU)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Investissement({user,setUser,projets,setProjets,toast}){
  const [modal,setModal]=useState(null);
  const [selProjet,setSelProjet]=useState(null);
  const [montantInvest,setMontantInvest]=useState('');
  const [filterSec,setFilterSec]=useState('all');
  const [filterStatut,setFilterStatut]=useState('ouvert');
  const [filterRisque,setFilterRisque]=useState('all');
  const [showCreate,setShowCreate]=useState(false);
  const [fp,setFp]=useState({nom:'',region:'Dakar',secteur:'agriculture',objectif:'',desc:'',rendement:'12',duree:'18',risque:'modere',promoteur:user.nom});

  const mesInvests=user.investissements||[];
  const totalInvesti=mesInvests.reduce((s,i)=>s+i.montant,0);
  const totalRetour=mesInvests.reduce((s,i)=>s+i.retourAttendu,0);
  const score=calcScore(user);

  const projFiltres=projets.filter(p=>
    (filterSec==='all'||p.secteur===filterSec)&&
    (filterStatut==='all'||p.statut===filterStatut)&&
    (filterRisque==='all'||p.risque===filterRisque)
  );

  const investir=()=>{
    if(!selProjet)return;
    const m=+montantInvest;
    if(!m||m<10000){toast('Minimum 10 000 FCFA','e');return;}
    if(m>selProjet.objectif-selProjet.collecte){toast('D√©passe le besoin restant','e');return;}
    const retour=Math.round(m*(1+selProjet.rendementAnnuel/100*(selProjet.dureeMois/12)));
    const ni={projetId:selProjet.id,montant:m,date:new Date().toISOString().slice(0,10),retourAttendu:retour-m};
    setUser(u=>({...u,investissements:[...(u.investissements||[]),ni]}));
    setProjets(p=>p.map(x=>x.id===selProjet.id?{...x,collecte:x.collecte+m,investisseurs:x.investisseurs+1}:x));
    toast('‚úì Investissement de '+m.toLocaleString('fr-FR')+' FCFA confirm√© ! Retour attendu : +'+(retour-m).toLocaleString('fr-FR')+' FCFA');
    setModal(null);setMontantInvest('');setSelProjet(null);
  };

  const creerProjet=()=>{
    if(!fp.nom||!fp.objectif||!fp.desc)return;
    const np={
      id:'p_'+Date.now(),nom:fp.nom,promoteur:fp.promoteur,region:fp.region,secteur:fp.secteur,
      description:fp.desc,objectif:+fp.objectif,collecte:0,
      dateFinancement:new Date(Date.now()+120*24*60*60*1000).toISOString().slice(0,10),
      rendementAnnuel:+fp.rendement,dureeMois:+fp.duree,risque:fp.risque,
      investisseurs:0,statut:'ouvert',dateCreation:new Date().toISOString().slice(0,10),updates:[]
    };
    setProjets(p=>[...p,np]);
    toast('Projet "'+fp.nom+'" publi√© !');
    setShowCreate(false);
    setFp({nom:'',region:'Dakar',secteur:'agriculture',objectif:'',desc:'',rendement:'12',duree:'18',risque:'modere',promoteur:user.nom});
  };

  const risqueColor={faible:'var(--lime)',modere:'var(--gold2)',eleve:'var(--rust2)'};
  const risqueLabel={faible:'Faible',modere:'Mod√©r√©',eleve:'√âlev√©'};
  const risqueChip={faible:'ch-lime',modere:'ch-gold',eleve:'ch-rust'};

  const ProjetCard=({p})=>{
    const pct=Math.round(p.collecte/p.objectif*100);
    const restant=p.objectif-p.collecte;
    const dejaInvesti=mesInvests.some(i=>i.projetId===p.id);
    const colProj=p.secteur==='agriculture'?'var(--lime)':p.secteur==='elevage'?'var(--amber2)':'var(--teal2)';
    return(
      <div className="proj-card" style={{'--proj-color':colProj}}>
        <div className="fcc gap1 mb1 flex-wrap">
          <SectorBadge secteur={p.secteur}/>
          <span className="region-chip">üìç {p.region}</span>
          <span className={`chip ${risqueChip[p.risque]}`}>Risque {risqueLabel[p.risque]}</span>
          {p.statut==='finance'&&<span className="chip ch-teal">‚úì Financ√©</span>}
        </div>
        <div className="proj-name">{p.nom}</div>
        <div className="proj-promo">Par <strong>{p.promoteur}</strong> ¬∑ Cl√¥ture : {p.dateFinancement}</div>
        <div className="t-xs t-muted mb2" style={{lineHeight:1.65}}>{p.description}</div>
        <div className="proj-stats">
          <div className="proj-stat">
            <div className="proj-stat-val t-gold">{p.rendementAnnuel}%</div>
            <div className="proj-stat-lbl">Rendement/an</div>
          </div>
          <div className="proj-stat">
            <div className="proj-stat-val">{p.dureeMois}</div>
            <div className="proj-stat-lbl">Mois</div>
          </div>
          <div className="proj-stat">
            <div className="proj-stat-val">{p.investisseurs}</div>
            <div className="proj-stat-lbl">Investisseurs</div>
          </div>
        </div>
        <div className="proj-progress">
          <div className="proj-prog-head">
            <span className="t-muted">Collect√©</span>
            <span className="mono t-lime">{pct}% ¬∑ {p.collecte.toLocaleString('fr-FR')} FCFA</span>
          </div>
          <PBar pct={Math.min(pct,100)} color={risqueColor[p.risque]} h={6}/>
          <div className="fcsb t-xs t-muted mt1">
            <span>Objectif : {p.objectif.toLocaleString('fr-FR')} FCFA</span>
            <span>Reste : {restant.toLocaleString('fr-FR')} FCFA</span>
          </div>
        </div>
        {p.updates&&p.updates.length>0&&(
          <div className="t-xs t-muted mb2">
            <strong style={{color:'var(--ink2)'}}>Derni√®re update :</strong> {p.updates[p.updates.length-1]}
          </div>
        )}
        <div className="fcsb">
          <div className="t-xs t-muted">Min : 10 000 FCFA</div>
          {dejaInvesti
            ?<span className="chip ch-teal">‚úì Investi</span>
            :p.statut==='ouvert'
              ?<button className="btn btn-gold btn-sm" onClick={()=>{setSelProjet(p);setModal('investir');}}>üíº Investir ‚Üí</button>
              :<span className="chip ch-gray">Cl√¥tur√©</span>
          }
        </div>
      </div>
    );
  };

  return(
    <div>
      <div className="ph">
        <div className="ph-top">
          <div>
            <div className="ph-tag">Investissement</div>
            <div className="ph-title">Projets agricoles & √©levage</div>
            <div className="ph-sub">Investissez dans des projets v√©rifi√©s ¬∑ Rendement garanti ¬∑ Secteur agri-√©levage</div>
          </div>
          <div className="ph-actions">
            <button className="btn btn-ghost" onClick={()=>setShowCreate(!showCreate)}>{showCreate?'‚úï Annuler':'+ Soumettre un projet'}</button>
          </div>
        </div>
      </div>

      <div className="content">
        {/* Mes stats investissement */}
        <div className="g3 mb3">
          <div className="stat" style={{'--glow':'rgba(240,192,64,.08)'}}>
            <div className="stat-ic">üíº</div>
            <div className="stat-val">{totalInvesti.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Total investi (FCFA)</div>
          </div>
          <div className="stat" style={{'--glow':'rgba(126,200,69,.08)'}}>
            <div className="stat-ic">üìà</div>
            <div className="stat-val">+{totalRetour.toLocaleString('fr-FR')}</div>
            <div className="stat-lbl">Retours attendus (FCFA)</div>
            <div className="stat-sub"><span className="up">‚Üë {mesInvests.length} projet{mesInvests.length!==1?'s':''}</span></div>
          </div>
          <div className="stat">
            <div className="stat-ic">üèÜ</div>
            <div className="stat-val">{projets.filter(p=>p.statut==='ouvert').length}</div>
            <div className="stat-lbl">Projets ouverts</div>
            <div className="stat-sub"><span className="neu">{projets.length} projets total</span></div>
          </div>
        </div>

        {/* Formulaire soumission projet */}
        {showCreate&&(
          <div className="card mb3" style={{borderColor:'var(--border3)'}}>
            <div className="card-title">üì§ Soumettre un projet √† financer</div>
            <div className="info-box info-teal mb2 t-sm">
              Votre projet sera visible par tous les membres d'AgriTontine+. D√©crivez-le pr√©cis√©ment pour attirer des investisseurs.
            </div>
            <div className="fr">
              <div className="fg"><label>Nom du projet</label><input value={fp.nom} onChange={e=>setFp({...fp,nom:e.target.value})} placeholder="Ex: Ferme avicole moderne"/></div>
              <div className="fg"><label>Promoteur</label><input value={fp.promoteur} onChange={e=>setFp({...fp,promoteur:e.target.value})}/></div>
            </div>
            <div className="fr">
              <div className="fg"><label>Secteur</label>
                <select value={fp.secteur} onChange={e=>setFp({...fp,secteur:e.target.value})}>
                  {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
                </select>
              </div>
              <div className="fg"><label>R√©gion</label>
                <select value={fp.region} onChange={e=>setFp({...fp,region:e.target.value})}>
                  {REGIONS.map(r=><option key={r}>{r}</option>)}
                </select>
              </div>
            </div>
            <div className="fg"><label>Description du projet</label><textarea value={fp.desc} onChange={e=>setFp({...fp,desc:e.target.value})} placeholder="D√©crivez votre projet, les d√©bouch√©s commerciaux, les garanties..."/></div>
            <div className="fr3">
              <div className="fg"><label>Objectif (FCFA)</label><input type="number" value={fp.objectif} onChange={e=>setFp({...fp,objectif:e.target.value})} placeholder="Ex: 5000000"/></div>
              <div className="fg"><label>Rendement/an (%)</label><input type="number" value={fp.rendement} onChange={e=>setFp({...fp,rendement:e.target.value})} min="5" max="30"/></div>
              <div className="fg"><label>Dur√©e (mois)</label><input type="number" value={fp.duree} onChange={e=>setFp({...fp,duree:e.target.value})} min="6" max="60"/></div>
            </div>
            <div className="fg"><label>Niveau de risque</label>
              <select value={fp.risque} onChange={e=>setFp({...fp,risque:e.target.value})}>
                <option value="faible">Faible (activit√© existante, revenus r√©guliers)</option>
                <option value="modere">Mod√©r√© (nouveau projet, march√© test√©)</option>
                <option value="eleve">√âlev√© (innovation, march√© √† cr√©er)</option>
              </select>
            </div>
            <div className="frow-btns">
              <button className="btn btn-ghost" onClick={()=>setShowCreate(false)}>Annuler</button>
              <button className="btn btn-gold" onClick={creerProjet}>Publier le projet ‚Üí</button>
            </div>
          </div>
        )}

        {/* Filtres */}
        <div className="fcsb mb2 flex-wrap gap2">
          <div className="bold t-sm t-muted">Projets disponibles ({projFiltres.length})</div>
          <div className="fcc gap1 flex-wrap">
            {[['all','Tous secteurs'],...SECTEURS.map(s=>[s.id,s.ic+' '+s.label])].map(([v,l])=>(
              <button key={v} className={`btn btn-xs ${filterSec===v?'btn-lime':'btn-ghost'}`} onClick={()=>setFilterSec(v)}>{l}</button>
            ))}
          </div>
        </div>
        <div className="fcc gap1 mb3 flex-wrap">
          {[['all','Tous statuts'],['ouvert','Ouverts'],['finance','Financ√©s']].map(([v,l])=>(
            <button key={v} className={`btn btn-xs ${filterStatut===v?'btn-green':'btn-ghost'}`} onClick={()=>setFilterStatut(v)}>{l}</button>
          ))}
          <span className="t-xs t-muted">¬∑</span>
          {[['all','Tout risque'],['faible','Risque faible'],['modere','Risque mod√©r√©'],['eleve','Risque √©lev√©']].map(([v,l])=>(
            <button key={v} className={`btn btn-xs ${filterRisque===v?'btn-gold':'btn-ghost'}`} onClick={()=>setFilterRisque(v)}>{l}</button>
          ))}
        </div>

        {projFiltres.length>0
          ?<div className="gauto">{projFiltres.map(p=><ProjetCard key={p.id} p={p}/>)}</div>
          :<div className="empty"><div className="empty-ic">üîç</div><div className="empty-t">Aucun projet</div><div className="empty-s">Modifiez les filtres ou soumettez le premier projet.</div></div>
        }

        {/* Mes investissements */}
        {mesInvests.length>0&&(
          <div className="card mt3">
            <div className="card-title">üíº Mes investissements ({mesInvests.length})</div>
            <div className="tbl-wrap">
              <table>
                <thead><tr><th>Projet</th><th>Secteur</th><th>Montant</th><th>Retour attendu</th><th>Date</th><th>Statut</th></tr></thead>
                <tbody>{mesInvests.map((inv,i)=>{
                  const p=projets.find(x=>x.id===inv.projetId);
                  return(
                    <tr key={i}>
                      <td className="bold">{p?.nom||'‚Äî'}</td>
                      <td>{p&&<SectorBadge secteur={p.secteur}/>}</td>
                      <td className="mono t-gold">{inv.montant.toLocaleString('fr-FR')} FCFA</td>
                      <td className="mono t-lime">+{inv.retourAttendu.toLocaleString('fr-FR')} FCFA</td>
                      <td className="mono t-sm">{inv.date}</td>
                      <td><span className={`chip ${p?.statut==='finance'?'ch-teal':'ch-gold'}`}>{p?.statut==='finance'?'Financ√©':'En cours'}</span></td>
                    </tr>
                  );
                })}</tbody>
              </table>
            </div>
          </div>
        )}
      </div>

      {modal==='investir'&&selProjet&&(
        <Modal title={'Investir ¬∑ '+selProjet.nom} onClose={()=>{setModal(null);setSelProjet(null);setMontantInvest('');}} lg>
          <div className="g2 mb2">
            <div>
              <div className="fcc gap1 mb1 flex-wrap">
                <SectorBadge secteur={selProjet.secteur}/>
                <span className={`chip ${risqueChip[selProjet.risque]}`}>Risque {risqueLabel[selProjet.risque]}</span>
              </div>
              <div className="t-sm t-muted mb2" style={{lineHeight:1.65}}>{selProjet.description}</div>
              <div className="card-sm">
                {[
                  ['Rendement annuel',selProjet.rendementAnnuel+'%','t-gold'],
                  ['Dur√©e',selProjet.dureeMois+' mois',''],
                  ['Collect√©',selProjet.collecte.toLocaleString('fr-FR')+' / '+selProjet.objectif.toLocaleString('fr-FR')+' FCFA','t-lime'],
                  ['Investisseurs',selProjet.investisseurs,''],
                  ['Cl√¥ture',selProjet.dateFinancement,''],
                ].map(([l,v,cls])=>(
                  <div key={l} className="fcsb t-sm mb1">
                    <span className="t-muted">{l}</span>
                    <span className={`mono bold ${cls}`}>{v}</span>
                  </div>
                ))}
              </div>
            </div>
            <div>
              <div className="fg"><label>Montant √† investir (FCFA)</label>
                <input type="number" value={montantInvest} onChange={e=>setMontantInvest(e.target.value)} placeholder="Min : 10 000 FCFA"/>
                <div className="fg-hint">Reste √† collecter : {(selProjet.objectif-selProjet.collecte).toLocaleString('fr-FR')} FCFA</div>
              </div>
              {montantInvest&&+montantInvest>=10000&&(
                <div className="card-sm">
                  <div className="t-xs t-muted bold mb1 uppercase" style={{letterSpacing:'.04em'}}>Simulation de retour</div>
                  <div className="fcsb t-sm mb1"><span className="t-muted">Capital investi</span><span className="mono">{(+montantInvest).toLocaleString('fr-FR')} FCFA</span></div>
                  <div className="fcsb t-sm mb1"><span className="t-muted">Retour total ({selProjet.dureeMois} mois)</span><span className="mono t-gold">{Math.round(+montantInvest*(1+selProjet.rendementAnnuel/100*(selProjet.dureeMois/12))).toLocaleString('fr-FR')} FCFA</span></div>
                  <div className="fcsb t-sm"><span className="t-muted">Gain net</span><span className="mono t-lime">+{Math.round(+montantInvest*(selProjet.rendementAnnuel/100*(selProjet.dureeMois/12))).toLocaleString('fr-FR')} FCFA</span></div>
                </div>
              )}
              <div className="info-box info-gold mt2 t-xs">
                ‚ö† Investissement √† risque. Les rendements affich√©s sont estimatifs. Lisez la description compl√®te du projet avant d‚Äôinvestir.
              </div>
            </div>
          </div>
          <div className="frow-btns">
            <button className="btn btn-ghost" onClick={()=>{setModal(null);setSelProjet(null);}}>Annuler</button>
            <button className="btn btn-gold" onClick={investir} disabled={!montantInvest||+montantInvest<10000}>üíº Confirmer l'investissement ‚Üí</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
function Admin({user,tontines,setTontines,toast}){
  const miens=tontines.filter(t=>t.admin===user.id);
  if(!miens.length)return(
    <div>
      <div className="ph"><div className="ph-tag">Administration</div><div className="ph-title">Espace admin</div></div>
      <div className="content"><div className="empty"><div className="empty-ic">üëë</div><div className="empty-t">Aucune tontine √† administrer</div><div className="empty-s">Cr√©ez une tontine dans l'onglet Tontines pour acc√©der √† l‚Äôespace admin.</div></div></div>
    </div>
  );
  return(
    <div>
      <div className="ph">
        <div className="ph-tag">Administration</div>
        <div className="ph-title">Tableau de bord admin</div>
        <div className="ph-sub">{miens.length} tontine{miens.length!==1?'s':''} √† g√©rer ¬∑ S√©n√©gal national</div>
      </div>
      <div className="content">
        {miens.map(t=>{
          const pot=t.montantCotis*t.membres.length;
          const pct=Math.round(t.membres.length/t.nbMax*100);
          return(
            <div key={t.id} className="card mb3">
              <div className="fcsb mb3">
                <div>
                  <div style={{fontFamily:'var(--f-d)',fontSize:'1.2rem',fontWeight:700}}>{t.nom}</div>
                  <div className="fcc gap1 mt1"><SectorBadge secteur={t.secteur}/><span className="region-chip">üìç {t.region}</span></div>
                </div>
                <span className={`chip ${t.statut==='actif'?'ch-lime':'ch-gray'}`}>{t.statut}</span>
              </div>
              <div className="g4 mb3">
                <div className="card-sm"><div className="t-xs t-muted mb1">Membres</div><div style={{fontFamily:'var(--f-d)',fontSize:'1.5rem',color:'var(--lime)'}}>{t.membres.length}/{t.nbMax}</div><PBar pct={pct} h={3}/></div>
                <div className="card-sm"><div className="t-xs t-muted mb1">Pot courant</div><div style={{fontFamily:'var(--f-d)',fontSize:'1.1rem',color:'var(--gold2)'}}>{pot.toLocaleString('fr-FR')}</div><div className="t-xs t-muted">FCFA</div></div>
                <div className="card-sm"><div className="t-xs t-muted mb1">Tour courant</div><div style={{fontFamily:'var(--f-d)',fontSize:'1.5rem'}}>{t.semaine}</div></div>
                <div className="card-sm"><div className="t-xs t-muted mb1">Ont re√ßu le pot</div><div style={{fontFamily:'var(--f-d)',fontSize:'1.5rem',color:'var(--lime)'}}>{t.membres.filter(m=>m.pot).length}/{t.membres.length}</div></div>
              </div>
              <div className="tbl-wrap">
                <table>
                  <thead><tr><th>Membre</th><th>Tour</th><th>Pot re√ßu</th><th>Statut</th><th>Action</th></tr></thead>
                  <tbody>{t.membres.map((m,i)=>(
                    <tr key={m.uid}>
                      <td className="bold">{m.nom||(m.uid===user.id?user.nom:'Membre '+(i+1))}</td>
                      <td><span className="chip ch-gray">N¬∞{m.tour}</span></td>
                      <td>{m.pot?<span className="chip ch-lime">‚úì Re√ßu</span>:<span className="chip ch-gray">En attente</span>}</td>
                      <td><span className="chip ch-lime">Actif</span></td>
                      <td>
                        <button className="btn btn-danger btn-xs" onClick={()=>toast('Retard marqu√© ‚Äî membre p√©nalis√©','i')}>Retard</button>
                      </td>
                    </tr>
                  ))}</tbody>
                </table>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ PROFIL ‚îÄ‚îÄ */
function Profil({user,setUser,toast}){
  const [edit,setEdit]=useState(false);
  const [f,setF]=useState({nom:user.nom,village:user.village,region:user.region,secteur:user.secteur});
  const score=calcScore(user);
  const next=score<40?40:score<65?65:100;

  const save=()=>{setUser(u=>({...u,...f}));setEdit(false);toast('Profil mis √† jour !');};

  return(
    <div>
      <div className="ph">
        <div className="ph-tag">Mon profil</div>
        <div className="ph-title">{user.nom}</div>
        <div className="ph-sub fcc gap1"><SectorBadge secteur={user.secteur}/><span className="region-chip">üìç {user.village}, {user.region}</span></div>
      </div>
      <div className="content">
        <div className="g2">
          <div className="card">
            <div className="card-title">Informations personnelles</div>
            {!edit?(
              <>
                {[['Nom',user.nom],['T√©l√©phone',user.telephone],['Village',user.village],['R√©gion',user.region],['Secteur',user.secteur],['R√¥le',user.role],['Inscription',user.dateInscription]].map(([l,v])=>(
                  <div key={l} className="fcsb" style={{padding:'.52rem 0',borderBottom:'1px solid var(--border)'}}>
                    <span className="t-xs t-muted">{l}</span><span className="t-sm bold">{v}</span>
                  </div>
                ))}
                <div className="mt2"><button className="btn btn-ghost btn-sm" onClick={()=>setEdit(true)}>‚úè Modifier</button></div>
              </>
            ):(
              <>
                <div className="fg"><label>Nom</label><input value={f.nom} onChange={e=>setF({...f,nom:e.target.value})}/></div>
                <div className="fg"><label>Village</label><input value={f.village} onChange={e=>setF({...f,village:e.target.value})}/></div>
                <div className="fg"><label>R√©gion</label><select value={f.region} onChange={e=>setF({...f,region:e.target.value})}>{REGIONS.map(r=><option key={r}>{r}</option>)}</select></div>
                <div className="fg"><label>Secteur</label><select value={f.secteur} onChange={e=>setF({...f,secteur:e.target.value})}>{SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}</select></div>
                <div className="frow-btns"><button className="btn btn-ghost" onClick={()=>setEdit(false)}>Annuler</button><button className="btn btn-lime" onClick={save}>Sauvegarder</button></div>
              </>
            )}
          </div>
          <div>
            <div className="card mb2">
              <div className="card-title">Score IA</div>
              <div className="fcc gap2 mb2">
                <ScoreRing score={score} sz={110} fsz="1.65rem"/>
                <div>
                  <span className={`chip ${score>=65?'ch-lime':score>=40?'ch-gold':'ch-rust'} mb1`} style={{display:'inline-flex'}}>{score>=65?'üåü Excellent':score>=40?'‚úÖ √âligible':'‚ö† Insuffisant'}</span>
                  <div className="t-xs t-muted mt1">Plafond : <strong className="t-gold">{(score*1000).toLocaleString('fr-FR')} FCFA</strong></div>
                  {score<100&&<div className="t-xs t-lime mt1">+{next-score} pts ‚Üí palier {next}</div>}
                </div>
              </div>
            </div>
            <div className="card">
              <div className="card-title">Statistiques</div>
              {[
                ['Cotisations totales',user.cotisations.length],
                ['Pay√©es',user.cotisations.filter(c=>c.statut==='payee').length],
                ['Retards',user.cotisations.filter(c=>c.statut==='retard').length],
                ['Tontines',(user.tontines||[]).length],
                ['Cr√©dits',(user.credits||[]).length],
                ['Rembours√©s',(user.credits||[]).filter(c=>c.statut==='rembourse').length],
                ['Investissements',(user.investissements||[]).length],
              ].map(([l,v])=>(
                <div key={l} className="fcsb" style={{padding:'.44rem 0',borderBottom:'1px solid var(--border)'}}>
                  <span className="t-xs t-muted">{l}</span><span className="mono t-sm t-lime">{v}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOGIN ‚Äî avec Supabase
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MARCH√â CADRAN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Marche({user, toast}) {
  const [annonces, setAnnonces] = React.useState([]);
  const [offres, setOffres] = React.useState({});
  const [loading, setLoading] = React.useState(true);
  const [modal, setModal] = React.useState(null); // 'creer' | 'detail' | 'offre' | 'prix'
  const [selAnnonce, setSelAnnonce] = React.useState(null);
  const [filterCat, setFilterCat] = React.useState('all');
  const [filterReg, setFilterReg] = React.useState('all');
  const [filterType, setFilterType] = React.useState('all');
  const [searchQ, setSearchQ] = React.useState('');
  const [onglet, setOnglet] = React.useState('marche'); // marche | mesannonces | prix

  // Formulaire nouvelle annonce
  const [f, setF] = React.useState({
    type:'vente', categorie:'cereales', produit:'', description:'',
    quantite:'', unite:'kg', prix:'', region: user.region || 'Dakar',
    village: user.village || '', wave: user.telephone || '',
  });

  // Formulaire offre
  const [fOffre, setFOffre] = React.useState({montant:'', message:''});

  // Chargement annonces
  React.useEffect(()=>{
    load();
    // Realtime nouveaux produits
    const ch = sb.channel('rt_annonces')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'annonces'},
        async ()=>{ const a = await sbFetchAnnonces(); setAnnonces(a); toast('üõí Nouveau produit sur le march√© !','i'); })
      .subscribe();
    return ()=>sb.removeChannel(ch);
  },[]);

  const load = async () => {
    setLoading(true);
    const a = await sbFetchAnnonces();
    setAnnonces(a);
    setLoading(false);
  };

  const reload = async (filters) => {
    setLoading(true);
    const a = await sbFetchAnnonces(filters||{categorie:filterCat,region:filterReg,type:filterType});
    setAnnonces(a);
    setLoading(false);
  };

  // Publier une annonce
  const publier = async (e) => {
    e.preventDefault();
    if (!f.produit||!f.quantite||!f.prix) { toast('Remplissez tous les champs obligatoires','e'); return; }
    try {
      const a = await sbCreerAnnonce(user.id, f);
      setAnnonces(prev=>[a,...prev]);
      setModal(null);
      setF({type:'vente',categorie:'cereales',produit:'',description:'',quantite:'',unite:'kg',prix:'',region:user.region,village:user.village,wave:user.telephone});
      toast('‚úÖ Annonce publi√©e !');
    } catch(e) { toast('Erreur : '+e.message,'e'); }
  };

  // Voir d√©tail + charger offres
  const voirDetail = async (annonce) => {
    setSelAnnonce(annonce);
    setModal('detail');
    const o = await sbFetchOffres(annonce.id);
    setOffres(prev=>({...prev,[annonce.id]:o}));
  };

  // Faire une offre
  const soumettreOffre = async (e) => {
    e.preventDefault();
    if (!fOffre.montant) { toast('Indiquez votre prix','e'); return; }
    try {
      const o = await sbFaireOffre(selAnnonce.id, user.id, fOffre.montant, fOffre.message);
      setOffres(prev=>({...prev,[selAnnonce.id]:[o,...(prev[selAnnonce.id]||[])]}));
      setFOffre({montant:'',message:''});
      setModal('detail');
      toast('‚úÖ Offre envoy√©e ! Le vendeur sera notifi√©.');
    } catch(e) { toast('Erreur : '+e.message,'e'); }
  };

  // Accepter une offre
  const accepterOffre = async (offre) => {
    try {
      await sbAccepterOffre(offre.id, selAnnonce.id);
      setAnnonces(prev=>prev.map(a=>a.id===selAnnonce.id?{...a,statut:'vendue'}:a));
      setModal(null);
      toast('‚úÖ Offre accept√©e ! Contactez l\'acheteur via Wave.');
    } catch(e) { toast('Erreur : '+e.message,'e'); }
  };

  // G√©n√©rer lien Wave
  const waveLink = (tel, montant, produit) => {
    const num = tel.replace(/\D/g,'');
    return `https://pay.wave.com/m/${num}?amount=${montant}&note=${encodeURIComponent('AgriTontine+ : '+produit)}`;
  };

  // Prix du march√© ‚Äî agr√©gation locale
  const prixParProduit = React.useMemo(()=>{
    const map = {};
    annonces.filter(a=>a.type==='vente').forEach(a=>{
      if (!map[a.produit]) map[a.produit] = {produit:a.produit,categorie:a.categorie,prix:[],regions:new Set()};
      map[a.produit].prix.push(a.prix_unitaire);
      map[a.produit].regions.add(a.region);
    });
    return Object.values(map).map(p=>({
      ...p,
      prixMin: Math.min(...p.prix),
      prixMax: Math.max(...p.prix),
      prixMoy: Math.round(p.prix.reduce((a,b)=>a+b,0)/p.prix.length),
      nbOffres: p.prix.length,
      regions: [...p.regions],
    })).sort((a,b)=>b.nbOffres-a.nbOffres);
  },[annonces]);

  // Filtrage local
  const annoncesFiltrees = React.useMemo(()=>{
    let r = annonces;
    if (filterCat!=='all') r=r.filter(a=>a.categorie===filterCat);
    if (filterReg!=='all') r=r.filter(a=>a.region===filterReg);
    if (filterType!=='all') r=r.filter(a=>a.type===filterType);
    if (searchQ) r=r.filter(a=>a.produit.toLowerCase().includes(searchQ.toLowerCase())||a.description.toLowerCase().includes(searchQ.toLowerCase()));
    return r;
  },[annonces,filterCat,filterReg,filterType,searchQ]);

  const mesAnnonces = annonces.filter(a=>a.vendeur_id===user.id);

  const catInfo = (id) => CATEGORIES_MARCHE.find(c=>c.id===id)||{ic:'üì¶',label:id,cls:'ch-gray'};
  const prix = (n) => n ? n.toLocaleString('fr-FR')+' FCFA' : '‚Äî';

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">March√© Cadran</div>
        <div className="ph-title">üõí AgriTontine+ Market</div>
        <div className="ph-sub">Achetez et vendez vos produits agricoles ¬∑ Paiement Wave s√©curis√©</div>
      </div>

      {/* ONGLETS */}
      <div style={{padding:'0 1.25rem',display:'flex',gap:'.5rem',marginBottom:'1rem',borderBottom:'1px solid var(--border)'}}>
        {[['marche','üõí March√©'],['mesannonces','üìã Mes annonces'],['prix','üìä Prix du march√©']].map(([id,lbl])=>(
          <div key={id} onClick={()=>setOnglet(id)} style={{
            padding:'.5rem 1rem',cursor:'pointer',fontWeight:onglet===id?700:400,
            color:onglet===id?'var(--lime)':'var(--ink3)',
            borderBottom:onglet===id?'2px solid var(--lime)':'2px solid transparent',
            fontSize:'.85rem',whiteSpace:'nowrap',
          }}>{lbl}</div>
        ))}
      </div>

      <div className="content">

        {/* ‚ïê‚ïê‚ïê ONGLET MARCH√â ‚ïê‚ïê‚ïê */}
        {onglet==='marche' && <>
          {/* Filtres + Recherche */}
          <div style={{display:'flex',gap:'.5rem',flexWrap:'wrap',marginBottom:'1rem',alignItems:'center'}}>
            <input
              placeholder="üîç Rechercher un produit..."
              value={searchQ} onChange={e=>setSearchQ(e.target.value)}
              style={{flex:'1',minWidth:'160px',padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem'}}
            />
            <select value={filterType} onChange={e=>setFilterType(e.target.value)} style={{padding:'.5rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem'}}>
              <option value="all">Vente + Achat</option>
              <option value="vente">üü¢ Ventes</option>
              <option value="achat">üîµ Demandes achat</option>
            </select>
            <select value={filterCat} onChange={e=>setFilterCat(e.target.value)} style={{padding:'.5rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem'}}>
              <option value="all">Toutes cat√©gories</option>
              {CATEGORIES_MARCHE.map(c=><option key={c.id} value={c.id}>{c.ic} {c.label}</option>)}
            </select>
            <select value={filterReg} onChange={e=>setFilterReg(e.target.value)} style={{padding:'.5rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem'}}>
              <option value="all">Toutes r√©gions</option>
              {REGIONS.map(r=><option key={r}>{r}</option>)}
            </select>
            <button className="btn btn-lime btn-sm" onClick={()=>setModal('creer')}>+ Publier annonce</button>
          </div>

          {/* Stats rapides */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'.75rem',marginBottom:'1.25rem'}}>
            {[
              ['üõí',annoncesFiltrees.filter(a=>a.type==='vente').length,'Ventes actives'],
              ['üîµ',annoncesFiltrees.filter(a=>a.type==='achat').length,'Demandes achat'],
              ['üìç',new Set(annoncesFiltrees.map(a=>a.region)).size,'R√©gions actives'],
            ].map(([ic,val,lbl])=>(
              <div key={lbl} className="card" style={{padding:'.75rem',textAlign:'center'}}>
                <div style={{fontSize:'1.4rem'}}>{ic}</div>
                <div style={{fontWeight:700,fontSize:'1.3rem',color:'var(--lime)'}}>{val}</div>
                <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{lbl}</div>
              </div>
            ))}
          </div>

          {/* Liste annonces */}
          {loading ? <div className="t-muted t-sm" style={{textAlign:'center',padding:'2rem'}}>‚è≥ Chargement...</div>
          : annoncesFiltrees.length===0 ? (
            <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üõí</div>
              <div style={{fontWeight:600,marginBottom:'.25rem'}}>Aucune annonce</div>
              <div style={{fontSize:'.82rem'}}>Soyez le premier √† publier !</div>
              <button className="btn btn-lime btn-sm" style={{marginTop:'1rem'}} onClick={()=>setModal('creer')}>+ Publier une annonce</button>
            </div>
          ) : (
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:'1rem'}}>
              {annoncesFiltrees.map(a=>{
                const cat = catInfo(a.categorie);
                const isVente = a.type==='vente';
                const isMine = a.vendeur_id===user.id;
                return (
                  <div key={a.id} className="card" style={{cursor:'pointer',transition:'.15s',border:`1px solid ${isVente?'rgba(90,158,32,.25)':'rgba(21,101,192,.25)'}`}}
                    onClick={()=>voirDetail(a)}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'.5rem'}}>
                      <span className={`chip ${cat.cls}`} style={{fontSize:'.68rem'}}>{cat.ic} {cat.label}</span>
                      <span style={{fontSize:'.72rem',fontWeight:700,padding:'.2rem .5rem',borderRadius:'99px',
                        background:isVente?'rgba(90,158,32,.12)':'rgba(21,101,192,.12)',
                        color:isVente?'var(--lime)':'var(--blue2,#42a5f5)'}}>
                        {isVente?'üü¢ VENTE':'üîµ ACHAT'}
                      </span>
                    </div>
                    <div style={{fontWeight:700,fontSize:'1rem',color:'var(--ink)',marginBottom:'.25rem'}}>{a.produit}</div>
                    <div style={{fontSize:'1.3rem',fontWeight:900,color:'var(--lime)',marginBottom:'.25rem'}}>
                      {prix(a.prix_unitaire)} <span style={{fontSize:'.75rem',fontWeight:400,color:'var(--ink3)'}}>/ {a.unite}</span>
                    </div>
                    <div style={{fontSize:'.8rem',color:'var(--ink3)',marginBottom:'.5rem'}}>
                      üì¶ {a.quantite} {a.unite} ¬∑ üìç {a.village||''} {a.region}
                    </div>
                    {a.description&&<div style={{fontSize:'.78rem',color:'var(--ink4)',marginBottom:'.5rem',fontStyle:'italic'}}>{a.description}</div>}
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:'.5rem',paddingTop:'.5rem',borderTop:'1px solid var(--border)'}}>
                      <span style={{fontSize:'.75rem',color:'var(--ink3)'}}>üë§ {a.vendeur?.nom||'‚Äî'}</span>
                      {isMine
                        ? <span style={{fontSize:'.72rem',color:'var(--gold2)',fontWeight:600}}>üìã Mon annonce</span>
                        : <span style={{fontSize:'.75rem',color:'var(--teal2)',fontWeight:600}}>Faire une offre ‚Üí</span>
                      }
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </>}

        {/* ‚ïê‚ïê‚ïê ONGLET MES ANNONCES ‚ïê‚ïê‚ïê */}
        {onglet==='mesannonces' && <>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}>
            <div style={{fontWeight:700,color:'var(--ink)'}}>Mes annonces ({mesAnnonces.length})</div>
            <button className="btn btn-lime btn-sm" onClick={()=>setModal('creer')}>+ Nouvelle annonce</button>
          </div>
          {mesAnnonces.length===0 ? (
            <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üìã</div>
              <div>Vous n‚Äôavez pas encore d‚Äôannonce</div>
              <button className="btn btn-lime btn-sm" style={{marginTop:'1rem'}} onClick={()=>setModal('creer')}>Publier ma premi√®re annonce</button>
            </div>
          ) : mesAnnonces.map(a=>{
            const cat = catInfo(a.categorie);
            const offresAnnonce = offres[a.id]||[];
            return (
              <div key={a.id} className="card mb2" onClick={()=>voirDetail(a)} style={{cursor:'pointer'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.5rem'}}>
                  <div style={{fontWeight:700}}>{cat.ic} {a.produit}</div>
                  <span style={{fontSize:'.72rem',padding:'.2rem .6rem',borderRadius:'99px',fontWeight:700,
                    background:a.statut==='active'?'rgba(90,158,32,.15)':a.statut==='vendue'?'rgba(196,154,40,.15)':'rgba(196,74,42,.15)',
                    color:a.statut==='active'?'var(--lime)':a.statut==='vendue'?'var(--gold2)':'var(--rust2)'}}>
                    {a.statut==='active'?'‚úÖ Active':a.statut==='vendue'?'ü§ù Vendue':'‚ùå Cl√¥tur√©e'}
                  </span>
                </div>
                <div style={{display:'flex',gap:'1.5rem',fontSize:'.82rem',color:'var(--ink3)'}}>
                  <span>üí∞ {prix(a.prix_unitaire)}/{a.unite}</span>
                  <span>üì¶ {a.quantite} {a.unite}</span>
                  <span>üìç {a.region}</span>
                  <span>üëÅ {a.vues||0} vues</span>
                </div>
                {offresAnnonce.length>0&&(
                  <div style={{marginTop:'.5rem',padding:'.4rem .75rem',background:'rgba(196,154,40,.1)',borderRadius:'8px',fontSize:'.8rem',color:'var(--gold2)',fontWeight:600}}>
                    üí¨ {offresAnnonce.length} offre(s) re√ßue(s) ‚Äî Cliquez pour voir
                  </div>
                )}
              </div>
            );
          })}
        </>}

        {/* ‚ïê‚ïê‚ïê ONGLET PRIX DU MARCH√â ‚ïê‚ïê‚ïê */}
        {onglet==='prix' && <>
          <div style={{fontWeight:700,color:'var(--ink)',marginBottom:'1rem'}}>
            üìä Prix du march√© en temps r√©el ‚Äî {prixParProduit.length} produits
          </div>
          {prixParProduit.length===0 ? (
            <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              Aucune donn√©e de prix disponible ‚Äî publiez des annonces de vente
            </div>
          ) : (
            <div style={{overflowX:'auto'}}>
              <table style={{width:'100%',borderCollapse:'collapse',fontSize:'.83rem'}}>
                <thead>
                  <tr style={{background:'var(--card2,#f8f9f8)',borderBottom:'2px solid var(--border)'}}>
                    {['Produit','Cat√©gorie','Prix min','Prix moyen','Prix max','Offres','R√©gions'].map(h=>(
                      <th key={h} style={{padding:'.6rem .75rem',textAlign:'left',color:'var(--ink3)',fontWeight:600,fontSize:'.78rem'}}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {prixParProduit.map((p,i)=>{
                    const cat = catInfo(p.categorie);
                    return (
                      <tr key={p.produit} style={{borderBottom:'1px solid var(--border)',background:i%2===0?'transparent':'rgba(0,0,0,.02)'}}>
                        <td style={{padding:'.6rem .75rem',fontWeight:600,color:'var(--ink)'}}>{p.produit}</td>
                        <td style={{padding:'.6rem .75rem'}}><span className={`chip ${cat.cls}`} style={{fontSize:'.65rem'}}>{cat.ic} {cat.label}</span></td>
                        <td style={{padding:'.6rem .75rem',color:'var(--lime)',fontWeight:700}}>{prix(p.prixMin)}</td>
                        <td style={{padding:'.6rem .75rem',color:'var(--gold2)',fontWeight:700}}>{prix(p.prixMoy)}</td>
                        <td style={{padding:'.6rem .75rem',color:'var(--rust2)',fontWeight:700}}>{prix(p.prixMax)}</td>
                        <td style={{padding:'.6rem .75rem',textAlign:'center'}}><span className="chip ch-gray" style={{fontSize:'.7rem'}}>{p.nbOffres}</span></td>
                        <td style={{padding:'.6rem .75rem',fontSize:'.75rem',color:'var(--ink3)'}}>{p.regions.slice(0,3).join(', ')}{p.regions.length>3?'...':''}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </>}

      </div>{/* end content */}

      {/* ‚ïê‚ïê‚ïê MODAL CR√âER ANNONCE ‚ïê‚ïê‚ïê */}
      {modal==='creer' && (
        <div className="modal-overlay" onClick={()=>setModal(null)}>
          <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'520px'}}>
            <div className="modal-title">üì¢ Publier une annonce</div>
            <form onSubmit={publier}>
              {/* Type */}
              <div style={{display:'flex',gap:'.5rem',marginBottom:'1rem'}}>
                {[['vente','üü¢ Je vends'],['achat','üîµ Je cherche √† acheter']].map(([val,lbl])=>(
                  <div key={val} onClick={()=>setF(p=>({...p,type:val}))}
                    style={{flex:1,padding:'.6rem',borderRadius:'8px',cursor:'pointer',textAlign:'center',
                      fontWeight:f.type===val?700:400,fontSize:'.83rem',
                      background:f.type===val?(val==='vente'?'rgba(90,158,32,.15)':'rgba(21,101,192,.15)'):'var(--card2,#f5f5f5)',
                      border:`1px solid ${f.type===val?(val==='vente'?'var(--lime)':'#42a5f5'):'var(--border)'}`,
                      color:f.type===val?(val==='vente'?'var(--lime)':'#42a5f5'):'var(--ink3)'}}>
                    {lbl}
                  </div>
                ))}
              </div>
              {/* Cat√©gorie */}
              <div style={{display:'flex',gap:'.4rem',flexWrap:'wrap',marginBottom:'1rem'}}>
                {CATEGORIES_MARCHE.map(c=>(
                  <div key={c.id} onClick={()=>setF(p=>({...p,categorie:c.id}))}
                    className={`chip ${f.categorie===c.id?c.cls:'ch-gray'}`}
                    style={{cursor:'pointer',fontSize:'.75rem',opacity:f.categorie===c.id?1:.6}}>
                    {c.ic} {c.label}
                  </div>
                ))}
              </div>
              <div className="fg"><label>Produit *</label><input required value={f.produit} onChange={e=>setF(p=>({...p,produit:e.target.value}))} placeholder="Ex: Arachide coque, Mil souna, Bovin Z√©bu..."/></div>
              <div className="fg"><label>Description</label><input value={f.description} onChange={e=>setF(p=>({...p,description:e.target.value}))} placeholder="Qualit√©, r√©colte, √¢ge (b√©tail)..."/></div>
              <div className="fr">
                <div className="fg"><label>Quantit√© *</label><input required type="number" min="0.1" step="0.1" value={f.quantite} onChange={e=>setF(p=>({...p,quantite:e.target.value}))} placeholder="Ex: 500"/></div>
                <div className="fg"><label>Unit√©</label>
                  <select value={f.unite} onChange={e=>setF(p=>({...p,unite:e.target.value}))}>
                    {UNITES.map(u=><option key={u}>{u}</option>)}
                  </select>
                </div>
              </div>
              <div className="fg"><label>Prix unitaire (FCFA) *</label><input required type="number" min="1" value={f.prix} onChange={e=>setF(p=>({...p,prix:e.target.value}))} placeholder="Ex: 350 FCFA/kg"/></div>
              <div className="fr">
                <div className="fg"><label>R√©gion</label>
                  <select value={f.region} onChange={e=>setF(p=>({...p,region:e.target.value}))}>
                    {REGIONS.map(r=><option key={r}>{r}</option>)}
                  </select>
                </div>
                <div className="fg"><label>Village</label><input value={f.village} onChange={e=>setF(p=>({...p,village:e.target.value}))} placeholder="Ex: Touba Toul"/></div>
              </div>
              <div className="fg">
                <label>Num√©ro Wave pour paiement *</label>
                <input required value={f.wave} onChange={e=>setF(p=>({...p,wave:e.target.value}))} placeholder="+221 7X XXX XX XX"/>
                <div style={{fontSize:'.72rem',color:'var(--ink3)',marginTop:'.2rem'}}>Les acheteurs vous paieront directement via Wave sur ce num√©ro</div>
              </div>
              <div className="frow-btns">
                <button type="button" className="btn btn-ghost" onClick={()=>setModal(null)}>Annuler</button>
                <button type="submit" className="btn btn-lime">Publier l'annonce</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* ‚ïê‚ïê‚ïê MODAL D√âTAIL ANNONCE ‚ïê‚ïê‚ïê */}
      {modal==='detail' && selAnnonce && (()=>{
        const cat = catInfo(selAnnonce.categorie);
        const isMine = selAnnonce.vendeur_id === user.id;
        const offresAnnonce = offres[selAnnonce.id]||[];
        const total = selAnnonce.quantite * selAnnonce.prix_unitaire;
        const wLink = waveLink(selAnnonce.contact_wave||selAnnonce.vendeur?.telephone||'', total, selAnnonce.produit);
        return (
          <div className="modal-overlay" onClick={()=>setModal(null)}>
            <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'560px'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'1rem'}}>
                <div>
                  <span className={`chip ${cat.cls}`} style={{fontSize:'.72rem',marginBottom:'.4rem',display:'inline-flex'}}>{cat.ic} {cat.label}</span>
                  <div style={{fontWeight:800,fontSize:'1.2rem',color:'var(--ink)'}}>{selAnnonce.produit}</div>
                </div>
                <span style={{fontSize:'.75rem',fontWeight:700,padding:'.3rem .7rem',borderRadius:'99px',
                  background:selAnnonce.type==='vente'?'rgba(90,158,32,.12)':'rgba(21,101,192,.12)',
                  color:selAnnonce.type==='vente'?'var(--lime)':'#42a5f5'}}>
                  {selAnnonce.type==='vente'?'üü¢ VENTE':'üîµ ACHAT'}
                </span>
              </div>

              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.75rem',marginBottom:'1rem'}}>
                <div style={{background:'rgba(90,158,32,.08)',padding:'.75rem',borderRadius:'10px'}}>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>Prix unitaire</div>
                  <div style={{fontWeight:800,fontSize:'1.3rem',color:'var(--lime)'}}>{prix(selAnnonce.prix_unitaire)}</div>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>par {selAnnonce.unite}</div>
                </div>
                <div style={{background:'rgba(196,154,40,.08)',padding:'.75rem',borderRadius:'10px'}}>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>Quantit√© disponible</div>
                  <div style={{fontWeight:800,fontSize:'1.3rem',color:'var(--gold2)'}}>{selAnnonce.quantite}</div>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{selAnnonce.unite}</div>
                </div>
              </div>

              {selAnnonce.description&&<div style={{marginBottom:'1rem',padding:'.75rem',background:'var(--card2,#f5f5f5)',borderRadius:'8px',fontSize:'.83rem',color:'var(--ink3)'}}>{selAnnonce.description}</div>}

              <div style={{display:'flex',gap:'1rem',fontSize:'.82rem',color:'var(--ink3)',marginBottom:'1rem',flexWrap:'wrap'}}>
                <span>üë§ {selAnnonce.vendeur?.nom||'‚Äî'}</span>
                <span>üìç {selAnnonce.village||''} {selAnnonce.region}</span>
                <span>üìû {selAnnonce.vendeur?.telephone||'‚Äî'}</span>
              </div>

              {/* Actions */}
              {!isMine && selAnnonce.statut==='active' && (
                <div style={{display:'flex',gap:'.75rem',marginBottom:'1rem',flexWrap:'wrap'}}>
                  {/* Payer via Wave */}
                  <a href={wLink} target="_blank" rel="noopener noreferrer"
                    style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:'.4rem',
                      padding:'.7rem 1rem',borderRadius:'10px',background:'rgba(21,101,192,.1)',
                      color:'#42a5f5',fontWeight:700,fontSize:'.85rem',textDecoration:'none',
                      border:'1px solid rgba(21,101,192,.2)'}}>
                    üíô Payer via Wave<br/><span style={{fontSize:'.72rem',fontWeight:400}}>{prix(total)} total</span>
                  </a>
                  {/* Faire une offre */}
                  <button className="btn btn-lime" style={{flex:1}} onClick={()=>setModal('offre')}>
                    üí¨ Faire une offre
                  </button>
                </div>
              )}

              {/* Offres re√ßues (si vendeur) */}
              {isMine && offresAnnonce.length>0 && (
                <div style={{marginBottom:'1rem'}}>
                  <div style={{fontWeight:600,marginBottom:'.5rem',color:'var(--ink)'}}>üí¨ Offres re√ßues ({offresAnnonce.length})</div>
                  {offresAnnonce.map(o=>(
                    <div key={o.id} style={{padding:'.75rem',borderRadius:'8px',background:'var(--card2,#f5f5f5)',marginBottom:'.5rem',border:'1px solid var(--border)'}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.25rem'}}>
                        <span style={{fontWeight:600,fontSize:'.85rem'}}>üë§ {o.acheteur?.nom||'‚Äî'}</span>
                        <span style={{fontWeight:700,color:'var(--lime)',fontSize:'.9rem'}}>{prix(o.montant)}</span>
                      </div>
                      {o.message&&<div style={{fontSize:'.78rem',color:'var(--ink3)',marginBottom:'.4rem'}}>{o.message}</div>}
                      <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                        <span style={{fontSize:'.72rem',color:'var(--ink3)'}}>{o.acheteur?.telephone}</span>
                        {o.statut==='en_attente' && (
                          <button className="btn btn-lime btn-sm" onClick={()=>accepterOffre(o)}>
                            ‚úÖ Accepter
                          </button>
                        )}
                        {o.statut==='acceptee' && <span style={{fontSize:'.75rem',color:'var(--lime)',fontWeight:700}}>‚úÖ Accept√©e</span>}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <button className="btn btn-ghost w100" onClick={()=>setModal(null)}>Fermer</button>
            </div>
          </div>
        );
      })()}

      {/* ‚ïê‚ïê‚ïê MODAL FAIRE UNE OFFRE ‚ïê‚ïê‚ïê */}
      {modal==='offre' && selAnnonce && (
        <div className="modal-overlay" onClick={()=>setModal('detail')}>
          <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'420px'}}>
            <div className="modal-title">üí¨ Faire une offre ‚Äî {selAnnonce.produit}</div>
            <div style={{padding:'.6rem .75rem',background:'rgba(90,158,32,.08)',borderRadius:'8px',marginBottom:'1rem',fontSize:'.82rem',color:'var(--ink3)'}}>
              Prix demand√© : <strong style={{color:'var(--lime)'}}>{prix(selAnnonce.prix_unitaire)}/{selAnnonce.unite}</strong>
            </div>
            <form onSubmit={soumettreOffre}>
              <div className="fg">
                <label>Votre prix offert (FCFA/{selAnnonce.unite}) *</label>
                <input required type="number" min="1" value={fOffre.montant} onChange={e=>setFOffre(p=>({...p,montant:e.target.value}))} placeholder={selAnnonce.prix_unitaire}/>
              </div>
              <div className="fg">
                <label>Message au vendeur</label>
                <input value={fOffre.message} onChange={e=>setFOffre(p=>({...p,message:e.target.value}))} placeholder="Ex: Prise en charge du transport, quantit√© souhait√©e..."/>
              </div>
              <div style={{fontSize:'.75rem',color:'var(--ink3)',marginBottom:'.75rem',padding:'.5rem',background:'rgba(196,154,40,.08)',borderRadius:'8px'}}>
                üíô Si le vendeur accepte, vous le payez directement via Wave sur son num√©ro <strong>{selAnnonce.contact_wave||selAnnonce.vendeur?.telephone}</strong>
              </div>
              <div className="frow-btns">
                <button type="button" className="btn btn-ghost" onClick={()=>setModal('detail')}>Retour</button>
                <button type="submit" className="btn btn-lime">Envoyer l'offre</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   OUTILS AGRICOLES ‚Äî Calculateur + M√©t√©o + Calendrier
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Donn√©es : Calendrier cultural S√©n√©gal ‚îÄ‚îÄ */
const CALENDRIER = {
  agriculture: [
    {culture:'Arachide',    semis:'Juin‚ÄìJuillet',     recolte:'Octobre‚ÄìNovembre', regions:['Diourbel','Kaolack','Kaffrine','Fatick','Thi√®s'],         conseil:`Semis d√®s les premi√®res pluies (50mm). Vari√©t√© 55-437 ou Fleur 11.`},
    {culture:'Mil',         semis:'Juillet',           recolte:'Octobre‚ÄìNovembre', regions:['Saint-Louis','Louga','Matam','Diourbel','Kaffrine'],       conseil:`D√©marier √† 1 plant/poquet √† 10 jours. Sarclage √† J+20 et J+40.`},
    {culture:'Ma√Øs',        semis:'Juillet‚ÄìAo√ªt',      recolte:'Octobre‚ÄìNovembre', regions:['Kolda','S√©dhiou','Ziguinchor','Tambacounda'],              conseil:`Apport NPK au semis + ur√©e √† la floraison. Irrigation possible.`},
    {culture:'Riz',         semis:'Juillet‚ÄìAo√ªt',      recolte:'Novembre‚ÄìD√©cembre',regions:['Saint-Louis','Ziguinchor','Kolda','S√©dhiou'],              conseil:`Repiquage √† 21 jours. Lame deau 5cm. Vari√©t√© ISRA Sahel 108.`},
    {culture:'Ni√©b√©',       semis:'Juillet‚ÄìAo√ªt',      recolte:'Octobre',          regions:['Thi√®s','Diourbel','Fatick','Kaolack'],                     conseil:`R√©sistant √† la s√©cheresse. Association mil-ni√©b√© recommand√©e.`},
    {culture:'Sorgho',      semis:'Juillet‚ÄìAo√ªt',      recolte:'Novembre',         regions:['Tambacounda','K√©dougou','Kolda','Matam'],                  conseil:`Tol√©rant au d√©ficit hydrique. Vari√©t√© locale CE180.`},
    {culture:'Tomate',      semis:'Novembre‚ÄìD√©cembre', recolte:'F√©vrier‚ÄìMars',     regions:['Saint-Louis','Thi√®s','Dakar'],                             conseil:`Saison froide optimale. Irrigation goutte-√†-goutte. Vari√©t√© Roma VF.`},
    {culture:'Oignon',      semis:'Octobre‚ÄìNovembre',  recolte:'Janvier‚ÄìMars',     regions:['Saint-Louis','Thi√®s','Louga'],                             conseil:`P√©pini√®re 6 semaines avant repiquage. Fumure organique essentielle.`},
    {culture:'Arachide de contre-saison', semis:'F√©vrier‚ÄìMars', recolte:'Juin',    regions:['Dakar','Thi√®s','Fatick'],                                  conseil:`N√©cessite irrigation. Vari√©t√© Fleur 11. Rentable si irrigation disponible.`},
  ],
  elevage: [
    {culture:'Bovins (v√™lage)',    semis:`Saison s√®che (Nov-F√©v)`,  recolte:`Toute l‚Äôann√©e`, regions:['Louga','Saint-Louis','Tambacounda','Matam'], conseil:`Suivi v√©t√©rinaire mensuel. Vaccination FVR en octobre.`},
    {culture:'Ovins (agnelage)',   semis:`Toute l‚Äôann√©e`,           recolte:`Avant Tabaski`, regions:['Toutes r√©gions'],                            conseil:`Engraissement 3 mois avant Tabaski. Aliment compos√© + paille.`},
    {culture:'Volaille (poulet)',  semis:`Toute l‚Äôann√©e`,           recolte:`J+45 (chair)`,  regions:['Toutes r√©gions'],                            conseil:`Bios√©curit√© stricte. Vaccination Newcastle √† J8 et J21.`},
    {culture:'Caprins (chevreau)', semis:'Octobre‚ÄìNovembre',         recolte:`Toute l‚Äôann√©e`,regions:['Kaolack','Diourbel','Fatick'],               conseil:`R√©sistants √† la chaleur. Vermifugation bi-annuelle.`},
  ],
};

/* ‚îÄ‚îÄ Donn√©es : Ravageurs et alertes ‚îÄ‚îÄ */
const ALERTES_RAVAGEURS = [
  {nom:'Criquet p√®lerin',    ic:'ü¶ó', niveau:'√©lev√©',  mois:['Ao√ªt','Septembre','Octobre'], cultures:['Mil','Sorgho','Ma√Øs','Riz'],   action:`Signaler imm√©diatement √† la DAGPN (+221 33 849 70 00). Ne pas traiter seul.`},
  {nom:'Chenille l√©gionnaire', ic:'üêõ', niveau:'√©lev√©', mois:['Juillet','Ao√ªt','Septembre'],cultures:['Ma√Øs','Mil','Sorgho'],         action:`Traitement Coragen ou Ampligo. Surveillance nocturne recommand√©e.`},
  {nom:'Pucerons arachide',  ic:'ü™≤', niveau:'moyen',  mois:['Ao√ªt','Septembre'],            cultures:['Arachide'],                   action:`Pulv√©risation Imidaclopride 200g/ha. √âviter les heures chaudes.`},
  {nom:'Mildiou oignon',     ic:'üçÑ', niveau:'moyen',  mois:['D√©cembre','Janvier','F√©vrier'],cultures:['Oignon','Tomate'],            action:`Fongicide Mancoz√®be. √âviter exces d‚Äôhumidite. Rotation culturale.`},
  {nom:'FMDV (Fi√®vre aphteuse)', ic:'üêÑ', niveau:'√©lev√©', mois:['Novembre','D√©cembre'],     cultures:['Bovins','Ovins'],              action:`Vaccination annuelle obligatoire. Quarantaine 21 jours. Signaler √† DIREL.`},
  {nom:'Newcastle volaille', ic:'üêì', niveau:'√©lev√©',  mois:[`Toute l‚Äôann√©e`],              cultures:['Volaille'],                   action:`Vaccination √† J8, rappel J21. Bios√©curit√© stricte. Mortalit√© 80% sans vaccin.`},
];

/* ‚îÄ‚îÄ Donn√©es : Rendements de r√©f√©rence S√©n√©gal ‚îÄ‚îÄ */
const RENDEMENTS_REF = {
  'Arachide':   {min:800,  moy:1200, max:2000, unite:'kg/ha', px_moy:350},
  'Mil':        {min:500,  moy:900,  max:1500, unite:'kg/ha', px_moy:200},
  'Ma√Øs':       {min:1500, moy:2500, max:4000, unite:'kg/ha', px_moy:180},
  'Riz':        {min:2000, moy:3500, max:6000, unite:'kg/ha', px_moy:250},
  'Ni√©b√©':      {min:400,  moy:700,  max:1200, unite:'kg/ha', px_moy:400},
  'Sorgho':     {min:500,  moy:900,  max:1500, unite:'kg/ha', px_moy:160},
  'Tomate':     {min:15000,moy:25000,max:40000,unite:'kg/ha', px_moy:100},
  'Oignon':     {min:10000,moy:18000,max:30000,unite:'kg/ha', px_moy:150},
  'Bovins':     {min:1,    moy:3,    max:6,    unite:'t√™tes/ha',px_moy:380000},
  'Ovins':      {min:3,    moy:6,    max:12,   unite:'t√™tes/ha',px_moy:80000},
  'Volaille':   {min:500,  moy:1000, max:2000, unite:'t√™tes/an',px_moy:4500},
};

/* ‚îÄ‚îÄ M√©t√©o : donn√©es statiques par r√©gion (√† remplacer par API OpenWeather) ‚îÄ‚îÄ */
const METEO_REGIONS = {
  'Dakar':       {temp:27, hum:75, pluie:'Jan‚ÄìMar : saison s√®che', vent:'Harmattan mod√©r√©',  conseil:`Irrigation indispensable nov‚Äìmai`},
  'Thi√®s':       {temp:28, hum:68, pluie:'Juil‚ÄìOct : 400‚Äì600mm',   vent:'Alize c√¥tier',      conseil:`Id√©al mara√Æchage oct‚Äìf√©v`},
  'Diourbel':    {temp:30, hum:55, pluie:'Juil‚ÄìSep : 500‚Äì700mm',   vent:'Harmattan fort',    conseil:`Zone arachidi√®re par excellence`},
  'Saint-Louis': {temp:26, hum:65, pluie:'Ao√ªt‚ÄìSep : 200‚Äì400mm',   vent:'Alize marin',       conseil:`Riz irrigu√© toute l‚Äôann√©e possible`},
  'Louga':       {temp:31, hum:45, pluie:'Ao√ªt‚ÄìSep : 300‚Äì500mm',   vent:'Harmattan fort',    conseil:`√âlevage extensif bovin-ovin`},
  'Fatick':      {temp:29, hum:70, pluie:'Juil‚ÄìOct : 600‚Äì900mm',   vent:'Mod√©r√©',            conseil:`Ni√©b√© + arachide + mara√Æchage`},
  'Kaolack':     {temp:31, hum:60, pluie:'Juil‚ÄìOct : 600‚Äì900mm',   vent:'Mod√©r√©',            conseil:`Capital arachidier du S√©n√©gal`},
  'Ziguinchor':  {temp:28, hum:85, pluie:'Jun‚ÄìOct : 1200‚Äì1600mm',  vent:'Faible',            conseil:`Riziculture + fruits tropicaux`},
  'Tambacounda': {temp:33, hum:50, pluie:'Juil‚ÄìOct : 700‚Äì1000mm',  vent:'Harmattan',         conseil:`Ma√Øs + sorgho + √©levage bovin`},
  'K√©dougou':    {temp:30, hum:75, pluie:'Mai‚ÄìNov : 1200‚Äì1600mm',  vent:'Faible',            conseil:`Zone la plus arros√©e du S√©n√©gal`},
  'Kolda':       {temp:29, hum:80, pluie:'Jun‚ÄìOct : 1000‚Äì1400mm',  vent:'Faible',            conseil:`Ma√Øs + riz + √©levage`},
  'S√©dhiou':     {temp:28, hum:82, pluie:'Jun‚ÄìOct : 1100‚Äì1500mm',  vent:'Faible',            conseil:`Riziculture + mangues`},
  'Kaffrine':    {temp:32, hum:52, pluie:'Juil‚ÄìSep : 600‚Äì800mm',   vent:'Harmattan',         conseil:`Arachide + mil + sorgho`},
  'Matam':       {temp:34, hum:40, pluie:'Ao√ªt‚ÄìSep : 300‚Äì500mm',   vent:'Harmattan fort',    conseil:`√âlevage + cultures irrigu√©es bord fleuve`},
  'Podor':       {temp:35, hum:35, pluie:'Ao√ªt‚ÄìSep : 200‚Äì350mm',   vent:'Harmattan tr√®s fort',conseil:`Cultures de d√©crues + √©levage camelin`},
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMPOSANT OUTILS AGRICOLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function OutilsAgricoles({user, toast}) {
  const [onglet, setOnglet] = React.useState('calculateur');
  const regionUser = user.region || 'Dakar';
  const secteurUser = user.secteur || 'agriculture';
  const moisCourant = new Date().toLocaleString('fr-FR',{month:'long'}).charAt(0).toUpperCase()+new Date().toLocaleString('fr-FR',{month:'long'}).slice(1);

  // ‚îÄ‚îÄ CALCULATEUR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [calc, setCalc] = React.useState({
    culture: 'Arachide',
    superficie: '',
    rendement: '',
    prixVente: '',
    coutSemences: '',
    coutIntrants: '',
    coutMain: '',
    coutAutres: '',
  });
  const [resultat, setResultat] = React.useState(null);

  const refCulture = RENDEMENTS_REF[calc.culture] || RENDEMENTS_REF['Arachide'];

  const calculer = (e) => {
    e.preventDefault();
    const S = parseFloat(calc.superficie) || 0;
    const R = parseFloat(calc.rendement) || refCulture.moy;
    const Px = parseFloat(calc.prixVente) || refCulture.px_moy;
    const cS = parseFloat(calc.coutSemences) || 0;
    const cI = parseFloat(calc.coutIntrants) || 0;
    const cM = parseFloat(calc.coutMain) || 0;
    const cA = parseFloat(calc.coutAutres) || 0;
    if (!S) { toast('Entrez la superficie','e'); return; }
    const production = S * R;
    const revenus = production * Px;
    const charges = (cS + cI + cM + cA) * S;
    const benefice = revenus - charges;
    const rentabilite = charges > 0 ? Math.round((benefice / charges) * 100) : 0;
    const roi = charges > 0 ? Math.round((revenus / charges - 1) * 100) : 0;
    setResultat({ production, revenus, charges, benefice, rentabilite, roi, S, R, Px });
  };

  // ‚îÄ‚îÄ M√âT√âO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [regionMeteo, setRegionMeteo] = React.useState(regionUser);
  const meteo = METEO_REGIONS[regionMeteo] || METEO_REGIONS['Dakar'];

  // ‚îÄ‚îÄ CALENDRIER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [filterRegion, setFilterRegion] = React.useState('all');
  const [filterSecteur, setFilterSecteur] = React.useState(secteurUser);
  const calData = CALENDRIER[filterSecteur] || CALENDRIER.agriculture;
  const calFiltre = filterRegion==='all' ? calData : calData.filter(c=>c.regions.some(r=>r.includes(filterRegion)||filterRegion.includes(r)));
  const moisEnCours = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][new Date().getMonth()];

  // ‚îÄ‚îÄ ALERTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const alertesMois = ALERTES_RAVAGEURS.filter(a=>
    a.mois.includes(moisEnCours) || a.mois.includes('Toute l‚Äôann√©e')
  );

  const prix = (n) => n ? Math.round(n).toLocaleString('fr-FR')+' FCFA' : '‚Äî';

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Outils Agricoles</div>
        <div className="ph-title">üåæ AgriTools ‚Äî Optimisez vos cultures</div>
        <div className="ph-sub">Calculateur ¬∑ M√©t√©o ¬∑ Calendrier ¬∑ Alertes ravageurs</div>
      </div>

      {/* ONGLETS */}
      <div style={{padding:'0 1.25rem',display:'flex',gap:'.4rem',flexWrap:'wrap',marginBottom:'1rem',borderBottom:'1px solid var(--border)'}}>
        {[
          ['calculateur','üßÆ Calculateur'],
          ['meteo','üå§ M√©t√©o'],
          ['calendrier','üìÖ Calendrier'],
          ['alertes','‚ö† Alertes'],
        ].map(([id,lbl])=>(
          <div key={id} onClick={()=>setOnglet(id)} style={{
            padding:'.5rem .9rem',cursor:'pointer',fontWeight:onglet===id?700:400,
            color:onglet===id?'var(--lime)':'var(--ink3)',
            borderBottom:onglet===id?'2px solid var(--lime)':'2px solid transparent',
            fontSize:'.83rem',whiteSpace:'nowrap',
          }}>{lbl}</div>
        ))}
      </div>

      <div className="content">

        {/* ‚ïê‚ïê‚ïê CALCULATEUR RENDEMENT & RENTABILIT√â ‚ïê‚ïê‚ïê */}
        {onglet==='calculateur' && (
          <div className="g2">
            <div className="card">
              <div className="card-title">üßÆ Calculateur de rentabilit√©</div>
              <form onSubmit={calculer}>
                {/* Culture */}
                <div className="fg">
                  <label>Culture / √âlevage</label>
                  <select value={calc.culture} onChange={e=>setCalc(p=>({...p,culture:e.target.value,rendement:'',prixVente:''}))}>
                    {Object.keys(RENDEMENTS_REF).map(c=><option key={c}>{c}</option>)}
                  </select>
                </div>

                {/* R√©f√©rence */}
                <div style={{padding:'.6rem .75rem',background:'rgba(90,158,32,.08)',borderRadius:'8px',marginBottom:'1rem',fontSize:'.8rem'}}>
                  <div style={{fontWeight:600,color:'var(--lime)',marginBottom:'.3rem'}}>üìä R√©f√©rence {calc.culture} ‚Äî S√©n√©gal</div>
                  <div style={{display:'flex',gap:'1rem',flexWrap:'wrap',color:'var(--ink3)'}}>
                    <span>Min : <strong>{refCulture.min.toLocaleString('fr-FR')} {refCulture.unite}</strong></span>
                    <span>Moyen : <strong style={{color:'var(--lime)'}}>{refCulture.moy.toLocaleString('fr-FR')} {refCulture.unite}</strong></span>
                    <span>Max : <strong>{refCulture.max.toLocaleString('fr-FR')} {refCulture.unite}</strong></span>
                    <span>Prix moy : <strong style={{color:'var(--gold2)'}}>{refCulture.px_moy.toLocaleString('fr-FR')} FCFA/{refCulture.unite.split('/')[1]||'unit√©'}</strong></span>
                  </div>
                </div>

                <div className="fr">
                  <div className="fg">
                    <label>Superficie (ha) *</label>
                    <input required type="number" min="0.1" step="0.1" placeholder="Ex: 2.5" value={calc.superficie} onChange={e=>setCalc(p=>({...p,superficie:e.target.value}))}/>
                  </div>
                  <div className="fg">
                    <label>Rendement estim√© ({refCulture.unite})</label>
                    <input type="number" min="1" placeholder={`D√©faut: ${refCulture.moy.toLocaleString('fr-FR')}`} value={calc.rendement} onChange={e=>setCalc(p=>({...p,rendement:e.target.value}))}/>
                  </div>
                </div>
                <div className="fg">
                  <label>Prix de vente (FCFA/{refCulture.unite.split('/')[1]||'unit√©'})</label>
                  <input type="number" min="1" placeholder={`D√©faut: ${refCulture.px_moy.toLocaleString('fr-FR')}`} value={calc.prixVente} onChange={e=>setCalc(p=>({...p,prixVente:e.target.value}))}/>
                </div>

                <div style={{fontWeight:600,fontSize:'.82rem',color:'var(--ink3)',margin:'.75rem 0 .4rem'}}>Charges par hectare (FCFA/ha)</div>
                <div className="fr">
                  <div className="fg"><label>Semences/G√©niteurs</label><input type="number" min="0" placeholder="0" value={calc.coutSemences} onChange={e=>setCalc(p=>({...p,coutSemences:e.target.value}))}/></div>
                  <div className="fg"><label>Intrants/Aliments</label><input type="number" min="0" placeholder="0" value={calc.coutIntrants} onChange={e=>setCalc(p=>({...p,coutIntrants:e.target.value}))}/></div>
                </div>
                <div className="fr">
                  <div className="fg"><label>Main d'≈ìuvre</label><input type="number" min="0" placeholder="0" value={calc.coutMain} onChange={e=>setCalc(p=>({...p,coutMain:e.target.value}))}/></div>
                  <div className="fg"><label>Autres charges</label><input type="number" min="0" placeholder="0" value={calc.coutAutres} onChange={e=>setCalc(p=>({...p,coutAutres:e.target.value}))}/></div>
                </div>
                <button type="submit" className="btn btn-lime w100" style={{justifyContent:'center',marginTop:'.5rem'}}>Calculer la rentabilit√© ‚Üí</button>
              </form>
            </div>

            {/* R√©sultats */}
            <div>
              {resultat ? (<>
                <div className="card mb2" style={{border:`2px solid ${resultat.benefice>=0?'var(--lime)':'var(--rust2)'}`}}>
                  <div className="card-title">{resultat.benefice>=0?'‚úÖ':'‚ö†'} R√©sultat ‚Äî {calc.culture}</div>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.75rem',marginBottom:'1rem'}}>
                    {[
                      ['Production totale', (resultat.production).toLocaleString('fr-FR')+' '+refCulture.unite.split('/')[0], 'var(--ink)'],
                      ['Revenus bruts', prix(resultat.revenus), 'var(--lime)'],
                      ['Total charges', prix(resultat.charges), 'var(--rust2)'],
                      ['B√©n√©fice net', prix(resultat.benefice), resultat.benefice>=0?'var(--lime)':'var(--rust2)'],
                    ].map(([lbl,val,col])=>(
                      <div key={lbl} style={{padding:'.75rem',background:'var(--card2,#f5f5f5)',borderRadius:'10px'}}>
                        <div style={{fontSize:'.72rem',color:'var(--ink3)',marginBottom:'.2rem'}}>{lbl}</div>
                        <div style={{fontWeight:800,fontSize:'1.05rem',color:col}}>{val}</div>
                      </div>
                    ))}
                  </div>
                  <div style={{display:'flex',gap:'1rem',justifyContent:'center',flexWrap:'wrap'}}>
                    <div style={{textAlign:'center',padding:'.75rem 1.25rem',background:resultat.roi>=0?'rgba(90,158,32,.1)':'rgba(196,74,42,.1)',borderRadius:'10px'}}>
                      <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>Retour sur investissement</div>
                      <div style={{fontWeight:800,fontSize:'1.5rem',color:resultat.roi>=0?'var(--lime)':'var(--rust2)'}}>{resultat.roi}%</div>
                    </div>
                    <div style={{textAlign:'center',padding:'.75rem 1.25rem',background:'rgba(196,154,40,.1)',borderRadius:'10px'}}>
                      <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>B√©n√©fice / ha</div>
                      <div style={{fontWeight:800,fontSize:'1.5rem',color:'var(--gold2)'}}>{prix(resultat.benefice/resultat.S)}</div>
                    </div>
                  </div>
                </div>

                {/* Conseil selon rentabilit√© */}
                <div className="card" style={{background:resultat.roi>=50?'rgba(90,158,32,.06)':resultat.roi>=0?'rgba(196,154,40,.06)':'rgba(196,74,42,.06)'}}>
                  <div style={{fontWeight:700,marginBottom:'.4rem'}}>
                    {resultat.roi>=50?'üåü Excellente rentabilit√©':resultat.roi>=20?'‚úÖ Bonne rentabilit√©':resultat.roi>=0?'‚ö† Rentabilit√© faible':'‚ùå D√©ficitaire'}
                  </div>
                  <div style={{fontSize:'.83rem',color:'var(--ink3)',lineHeight:1.6}}>
                    {resultat.roi>=50 && `Votre exploitation est tr√®s rentable. Envisagez d‚Äôagrandir la superficie ou d‚Äôinvestir dans du mat√©riel.`}
                    {resultat.roi>=20 && resultat.roi<50 && `Rentabilit√© correcte. Optimisez vos charges (groupement d‚Äôachats d‚Äôintrants) pour am√©liorer la marge.`}
                    {resultat.roi>=0 && resultat.roi<20 && `Marge faible. Cherchez √† augmenter le prix de vente via le March√© Cadran ou r√©duire les intrants.`}
                    {resultat.roi<0 && `Attention, cette campagne est d√©ficitaire selon vos estimations. V√©rifiez vos charges ou le prix de vente cible.`}
                  </div>
                  {resultat.charges===0&&<div style={{marginTop:'.5rem',fontSize:'.8rem',color:'var(--ink4)'}}>üí° Entrez vos charges pour un calcul plus pr√©cis</div>}
                </div>
              </>) : (
                <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
                  <div style={{fontSize:'2.5rem',marginBottom:'.75rem'}}>üßÆ</div>
                  <div style={{fontWeight:600,marginBottom:'.4rem'}}>Estimez votre rentabilit√©</div>
                  <div style={{fontSize:'.83rem'}}>Entrez votre superficie et vos charges pour voir votre b√©n√©fice estim√©</div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* ‚ïê‚ïê‚ïê M√âT√âO PAR R√âGION ‚ïê‚ïê‚ïê */}
        {onglet==='meteo' && (<>
          <div style={{marginBottom:'1rem'}}>
            <select value={regionMeteo} onChange={e=>setRegionMeteo(e.target.value)}
              style={{padding:'.6rem 1rem',borderRadius:'10px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.9rem',width:'100%',maxWidth:'300px'}}>
              {REGIONS.map(r=><option key={r}>{r}</option>)}
            </select>
          </div>

          {/* Carte m√©t√©o r√©gion */}
          <div className="card mb2" style={{background:'linear-gradient(135deg,rgba(26,122,110,.12),rgba(90,158,32,.08))'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'1rem'}}>
              <div>
                <div style={{fontWeight:800,fontSize:'1.3rem',color:'var(--ink)'}}>üìç {regionMeteo}</div>
                <div style={{fontSize:'.82rem',color:'var(--ink3)',marginTop:'.2rem'}}>Donn√©es climatiques de r√©f√©rence</div>
              </div>
              <div style={{textAlign:'right'}}>
                <div style={{fontSize:'2.5rem',fontWeight:900,color:'var(--amber2,#f59f00)'}}>{meteo.temp}¬∞C</div>
                <div style={{fontSize:'.75rem',color:'var(--ink3)'}}>Temp. moyenne</div>
              </div>
            </div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'1rem'}}>
              {[
                ['üíß Humidit√©', meteo.hum+'%'],
                ['üåß Pluies', meteo.pluie],
                ['üí® Vent', meteo.vent],
              ].map(([lbl,val])=>(
                <div key={lbl} style={{padding:'.75rem',background:'rgba(255,255,255,.5)',borderRadius:'8px'}}>
                  <div style={{fontSize:'.75rem',color:'var(--ink3)',marginBottom:'.2rem'}}>{lbl}</div>
                  <div style={{fontWeight:600,fontSize:'.9rem',color:'var(--ink)'}}>{val}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Conseil agricole */}
          <div className="card mb2" style={{background:'rgba(90,158,32,.06)',border:'1px solid rgba(90,158,32,.2)'}}>
            <div style={{fontWeight:700,color:'var(--lime)',marginBottom:'.5rem'}}>üåæ Conseil agricole pour {regionMeteo}</div>
            <div style={{fontSize:'.87rem',color:'var(--ink)',lineHeight:1.7}}>{meteo.conseil}</div>
          </div>

          {/* Cultures recommand√©es pour cette r√©gion */}
          <div className="card">
            <div className="card-title">üå± Cultures recommand√©es pour {regionMeteo}</div>
            {CALENDRIER.agriculture.filter(c=>c.regions.some(r=>r.includes(regionMeteo)||regionMeteo.includes(r))).length===0
              ? <div style={{color:'var(--ink3)',fontSize:'.85rem'}}>Consultez un agronome local pour des recommandations sp√©cifiques.</div>
              : CALENDRIER.agriculture.filter(c=>c.regions.some(r=>r.includes(regionMeteo)||regionMeteo.includes(r))).map(c=>(
                <div key={c.culture} style={{padding:'.6rem 0',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center',gap:'1rem'}}>
                  <div>
                    <div style={{fontWeight:600,fontSize:'.88rem',color:'var(--ink)'}}>{c.culture}</div>
                    <div style={{fontSize:'.76rem',color:'var(--ink3)'}}>Semis : {c.semis} ¬∑ R√©colte : {c.recolte}</div>
                  </div>
                  <span className="chip ch-lime" style={{fontSize:'.7rem',whiteSpace:'nowrap'}}>‚úÖ Adapt√©</span>
                </div>
              ))
            }
          </div>
        </>)}

        {/* ‚ïê‚ïê‚ïê CALENDRIER CULTURAL ‚ïê‚ïê‚ïê */}
        {onglet==='calendrier' && (<>
          <div style={{display:'flex',gap:'.5rem',marginBottom:'1rem',flexWrap:'wrap'}}>
            <select value={filterSecteur} onChange={e=>setFilterSecteur(e.target.value)}
              style={{padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem'}}>
              <option value="agriculture">üåæ Agriculture</option>
              <option value="elevage">üêÑ √âlevage</option>
            </select>
            <select value={filterRegion} onChange={e=>setFilterRegion(e.target.value)}
              style={{padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem'}}>
              <option value="all">Toutes les r√©gions</option>
              {REGIONS.map(r=><option key={r}>{r}</option>)}
            </select>
          </div>

          {/* Mois en cours */}
          <div style={{padding:'.6rem 1rem',background:'rgba(196,154,40,.1)',borderRadius:'8px',marginBottom:'1rem',fontSize:'.83rem',color:'var(--gold2)',fontWeight:600}}>
            üìÖ Nous sommes en {moisEnCours} ‚Äî Les cultures en cours sont surlign√©es
          </div>

          <div style={{display:'flex',flexDirection:'column',gap:'.75rem'}}>
            {calFiltre.map(c=>{
              const ref = RENDEMENTS_REF[c.culture];
              const enCours = c.semis.includes(moisEnCours)||c.recolte.includes(moisEnCours);
              return (
                <div key={c.culture} className="card" style={{border:enCours?'1.5px solid var(--lime)':'1px solid var(--border)'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'.5rem'}}>
                    <div style={{fontWeight:700,fontSize:'1rem',color:'var(--ink)'}}>{c.culture}</div>
                    {enCours&&<span className="chip ch-lime" style={{fontSize:'.7rem'}}>üìÖ P√©riode en cours</span>}
                  </div>
                  <div style={{display:'flex',gap:'1.5rem',flexWrap:'wrap',fontSize:'.82rem',marginBottom:'.6rem'}}>
                    <span style={{color:'var(--lime)'}}>üå± Semis : <strong>{c.semis}</strong></span>
                    <span style={{color:'var(--gold2)'}}>üåæ R√©colte : <strong>{c.recolte}</strong></span>
                  </div>
                  <div style={{fontSize:'.8rem',color:'var(--ink3)',marginBottom:'.5rem'}}>
                    üìç R√©gions : {c.regions.join(' ¬∑ ')}
                  </div>
                  <div style={{padding:'.5rem .75rem',background:'rgba(26,122,110,.06)',borderRadius:'6px',fontSize:'.8rem',color:'var(--teal2)',lineHeight:1.6}}>
                    üí° {c.conseil}
                  </div>
                  {ref&&(
                    <div style={{marginTop:'.6rem',display:'flex',gap:'1rem',fontSize:'.78rem',color:'var(--ink3)',flexWrap:'wrap'}}>
                      <span>üìä Rendement moyen : <strong style={{color:'var(--lime)'}}>{ref.moy.toLocaleString('fr-FR')} {ref.unite}</strong></span>
                      <span>üí∞ Prix moyen : <strong style={{color:'var(--gold2)'}}>{ref.px_moy.toLocaleString('fr-FR')} FCFA</strong></span>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </>)}

        {/* ‚ïê‚ïê‚ïê ALERTES RAVAGEURS ‚ïê‚ïê‚ïê */}
        {onglet==='alertes' && (<>
          <div style={{padding:'.75rem 1rem',background:'rgba(196,74,42,.08)',borderRadius:'10px',marginBottom:'1.25rem',border:'1px solid rgba(196,74,42,.2)'}}>
            <div style={{fontWeight:700,color:'var(--rust2)',marginBottom:'.3rem'}}>‚ö† Alertes actives pour {moisEnCours}</div>
            <div style={{fontSize:'.82rem',color:'var(--ink3)'}}>
              {alertesMois.length} menace(s) √† surveiller ce mois-ci dans votre r√©gion
            </div>
          </div>

          {/* Alertes du mois */}
          {alertesMois.length > 0 && (
            <div style={{marginBottom:'1.5rem'}}>
              <div style={{fontWeight:600,marginBottom:'.75rem',color:'var(--ink)'}}>üî¥ Actives en {moisEnCours}</div>
              {alertesMois.map(a=>(
                <div key={a.nom} className="card mb2" style={{borderLeft:`4px solid ${a.niveau==='√©lev√©'?'var(--rust2)':'var(--gold2)'}`}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.5rem'}}>
                    <div style={{fontWeight:700,fontSize:'1rem'}}>{a.ic} {a.nom}</div>
                    <span style={{fontSize:'.72rem',fontWeight:700,padding:'.2rem .6rem',borderRadius:'99px',
                      background:a.niveau==='√©lev√©'?'rgba(196,74,42,.12)':'rgba(196,154,40,.12)',
                      color:a.niveau==='√©lev√©'?'var(--rust2)':'var(--gold2)'}}>
                      {a.niveau==='√©lev√©'?'üî¥ Risque √©lev√©':'üü° Risque mod√©r√©'}
                    </span>
                  </div>
                  <div style={{fontSize:'.8rem',color:'var(--ink3)',marginBottom:'.5rem'}}>
                    üåæ Cultures touch√©es : {a.cultures.join(', ')}
                  </div>
                  <div style={{padding:'.6rem .75rem',background:'rgba(196,74,42,.06)',borderRadius:'6px',fontSize:'.82rem',color:'var(--ink)',lineHeight:1.6}}>
                    <strong>Action recommand√©e :</strong> {a.action}
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Toutes les alertes */}
          <div>
            <div style={{fontWeight:600,marginBottom:'.75rem',color:'var(--ink3)'}}>üìã Calendrier annuel des menaces</div>
            {ALERTES_RAVAGEURS.filter(a=>!alertesMois.includes(a)).map(a=>(
              <div key={a.nom} className="card mb2" style={{opacity:.7}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.4rem'}}>
                  <div style={{fontWeight:600}}>{a.ic} {a.nom}</div>
                  <span style={{fontSize:'.72rem',color:'var(--ink3)'}}>{a.mois.join(', ')}</span>
                </div>
                <div style={{fontSize:'.78rem',color:'var(--ink3)'}}>Cultures : {a.cultures.join(', ')}</div>
              </div>
            ))}
          </div>
        </>)}

      </div>
    </div>
  );
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ANNUAIRE ‚Äî V√©t√©rinaires & Agronomes
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ANNUAIRE_DATA = [
  {id:'a1',nom:'Dr. Mamadou Diallo',type:'veterinaire',specialite:'Bovins & Ovins',region:'Louga',ville:'Lingu√®re',telephone:'+221 77 123 45 67',disponible:true,note:4.8,avis:32},
  {id:'a2',nom:'Dr. Fatou Seck',type:'veterinaire',specialite:'Volaille & Porcins',region:'Thi√®s',ville:'Mbour',telephone:'+221 76 234 56 78',disponible:true,note:4.6,avis:18},
  {id:'a3',nom:'Dr. Ibrahima Ba',type:'veterinaire',specialite:'Caprins & Camelins',region:'Saint-Louis',ville:'Podor',telephone:'+221 70 345 67 89',disponible:false,note:4.5,avis:24},
  {id:'a4',nom:'Ousmane Ndiaye',type:'agronome',specialite:'C√©r√©ales & Arachide',region:'Diourbel',ville:'Touba',telephone:'+221 77 456 78 90',disponible:true,note:4.9,avis:41},
  {id:'a5',nom:'Aissatou Diop',type:'agronome',specialite:'Mara√Æchage & Irrigation',region:'Saint-Louis',ville:'Richard Toll',telephone:'+221 78 567 89 01',disponible:true,note:4.7,avis:29},
  {id:'a6',nom:'Dr. Moussa Ciss√©',type:'veterinaire',specialite:'Bovins & √âquid√©s',region:'Tambacounda',ville:'Tambacounda',telephone:'+221 75 678 90 12',disponible:true,note:4.4,avis:15},
  {id:'a7',nom:'Mariama Sarr',type:'agronome',specialite:'Riziculture & Cultures de d√©crues',region:'Ziguinchor',ville:'Ziguinchor',telephone:'+221 77 789 01 23',disponible:true,note:4.8,avis:37},
  {id:'a8',nom:'Aliou Mbaye',type:'agronome',specialite:'Arachide & Mil',region:'Kaolack',ville:'Kaolack',telephone:'+221 76 890 12 34',disponible:false,note:4.3,avis:22},
  {id:'a9',nom:'Dr. Cheikh Fall',type:'veterinaire',specialite:'Volaille & Petits ruminants',region:'Dakar',ville:'Pikine',telephone:'+221 78 901 23 45',disponible:true,note:4.6,avis:55},
  {id:'a10',nom:'Rokhaya Gaye',type:'agronome',specialite:'Horticulture & Fruits',region:'Thi√®s',ville:'Thi√®s',telephone:'+221 70 012 34 56',disponible:true,note:4.5,avis:19},
  {id:'a11',nom:'Dr. Abdou Kon√©',type:'veterinaire',specialite:'Bovins laitiers',region:'Kolda',ville:'Kolda',telephone:'+221 77 111 22 33',disponible:true,note:4.7,avis:28},
  {id:'a12',nom:'Seydou Niang',type:'agronome',specialite:'Sorgho & Ni√©b√©',region:'Kaffrine',ville:'Kaffrine',telephone:'+221 76 222 33 44',disponible:true,note:4.4,avis:16},
];

function Annuaire({user, toast}) {
  const [filterType, setFilterType] = React.useState('all');
  const [filterReg, setFilterReg] = React.useState('all');
  const [search, setSearch] = React.useState('');
  const [sel, setSel] = React.useState(null);

  const filtered = ANNUAIRE_DATA.filter(a => {
    if (filterType !== 'all' && a.type !== filterType) return false;
    if (filterReg !== 'all' && a.region !== filterReg) return false;
    if (search && !a.nom.toLowerCase().includes(search.toLowerCase()) &&
        !a.specialite.toLowerCase().includes(search.toLowerCase())) return false;
    return true;
  });

  const waveLink = (tel) => 'https://wa.me/' + tel.replace(/\D/g,'');

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Annuaire</div>
        <div className="ph-title">üë®‚Äç‚öïÔ∏è V√©t√©rinaires & Agronomes</div>
        <div className="ph-sub">Trouvez un expert pr√®s de chez vous ¬∑ Contact direct WhatsApp</div>
      </div>
      <div className="content">
        <div style={{display:'flex',gap:'.5rem',flexWrap:'wrap',marginBottom:'1rem'}}>
          <input placeholder="üîç Nom ou sp√©cialit√©..." value={search} onChange={e=>setSearch(e.target.value)}
            style={{flex:'1',minWidth:'160px',padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem'}}/>
          <select value={filterType} onChange={e=>setFilterType(e.target.value)}
            style={{padding:'.5rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem'}}>
            <option value="all">Tous</option>
            <option value="veterinaire">ü©∫ V√©t√©rinaires</option>
            <option value="agronome">üå± Agronomes</option>
          </select>
          <select value={filterReg} onChange={e=>setFilterReg(e.target.value)}
            style={{padding:'.5rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem'}}>
            <option value="all">Toutes r√©gions</option>
            {REGIONS.map(r=><option key={r}>{r}</option>)}
          </select>
        </div>

        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:'1rem'}}>
          {filtered.map(a => (
            <div key={a.id} className="card" style={{cursor:'pointer',border:`1px solid ${a.type==='veterinaire'?'rgba(21,101,192,.2)':'rgba(90,158,32,.2)'}`}}
              onClick={()=>setSel(sel?.id===a.id?null:a)}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'.5rem'}}>
                <div style={{fontSize:'1.8rem'}}>{a.type==='veterinaire'?'ü©∫':'üå±'}</div>
                <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:'.2rem'}}>
                  <span style={{fontSize:'.7rem',fontWeight:700,padding:'.15rem .5rem',borderRadius:'99px',
                    background:a.disponible?'rgba(90,158,32,.12)':'rgba(196,74,42,.12)',
                    color:a.disponible?'var(--lime)':'var(--rust2)'}}>
                    {a.disponible?'‚úÖ Disponible':'‚õî Indisponible'}
                  </span>
                  <span style={{fontSize:'.72rem',color:'var(--gold2)'}}>{'‚òÖ'.repeat(Math.round(a.note))} {a.note}/5</span>
                </div>
              </div>
              <div style={{fontWeight:700,fontSize:'1rem',color:'var(--ink)',marginBottom:'.2rem'}}>{a.nom}</div>
              <div style={{fontSize:'.8rem',color:a.type==='veterinaire'?'#42a5f5':'var(--lime)',fontWeight:600,marginBottom:'.3rem'}}>{a.specialite}</div>
              <div style={{fontSize:'.78rem',color:'var(--ink3)',marginBottom:'.5rem'}}>üìç {a.ville} ¬∑ {a.region}</div>
              <div style={{fontSize:'.75rem',color:'var(--ink4)',marginBottom:'.75rem'}}>{a.avis} avis clients</div>
              {sel?.id===a.id && (
                <div style={{borderTop:'1px solid var(--border)',paddingTop:'.75rem',display:'flex',gap:'.5rem',flexWrap:'wrap'}}>
                  <a href={'tel:'+a.telephone.replace(/\s/g,'')} className="btn btn-ghost btn-sm" style={{flex:1,justifyContent:'center',textDecoration:'none'}}>
                    üìû Appeler
                  </a>
                  <a href={waveLink(a.telephone)} target="_blank" rel="noopener noreferrer"
                    className="btn btn-lime btn-sm" style={{flex:1,justifyContent:'center',textDecoration:'none'}}>
                    üí¨ WhatsApp
                  </a>
                </div>
              )}
            </div>
          ))}
          {filtered.length===0 && (
            <div style={{gridColumn:'1/-1',textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üë®‚Äç‚öïÔ∏è</div>
              <div>Aucun expert trouv√© pour ces crit√®res</div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MESSAGERIE entre membres
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function sbFetchConversations(userId) {
  const {data} = await sb.from('messages')
    .select('*, expediteur:users!messages_expediteur_id_fkey(id,nom,secteur), destinataire:users!messages_destinataire_id_fkey(id,nom,secteur)')
    .or('expediteur_id.eq.'+userId+',destinataire_id.eq.'+userId)
    .order('created_at',{ascending:false});
  if (!data) return [];
  const convMap = {};
  data.forEach(m => {
    const otherId = m.expediteur_id===userId ? m.destinataire_id : m.expediteur_id;
    const other = m.expediteur_id===userId ? m.destinataire : m.expediteur;
    if (!convMap[otherId]) convMap[otherId] = {userId:otherId,user:other,messages:[],unread:0};
    convMap[otherId].messages.push(m);
    if (m.destinataire_id===userId && !m.lu) convMap[otherId].unread++;
  });
  return Object.values(convMap);
}

async function sbFetchMessages(userId, otherId) {
  const {data} = await sb.from('messages')
    .select('*')
    .or('and(expediteur_id.eq.'+userId+',destinataire_id.eq.'+otherId+'),and(expediteur_id.eq.'+otherId+',destinataire_id.eq.'+userId+')')
    .order('created_at',{ascending:true});
  return data || [];
}

async function sbEnvoyerMessage(expediteurId, destinataireId, texte) {
  const {data,error} = await sb.from('messages').insert({
    expediteur_id: expediteurId,
    destinataire_id: destinataireId,
    texte,
    lu: false,
  }).select().single();
  if (error) throw new Error(error.message);
  return data;
}

async function sbMarquerLu(userId, otherId) {
  await sb.from('messages').update({lu:true})
    .eq('destinataire_id',userId).eq('expediteur_id',otherId).eq('lu',false);
}

async function sbFetchUsers() {
  const {data} = await sb.from('users').select('id,nom,secteur,region,village').order('nom');
  return data || [];
}

function Messagerie({user, toast}) {
  const [convs, setConvs] = React.useState([]);
  const [selConv, setSelConv] = React.useState(null);
  const [messages, setMessages] = React.useState([]);
  const [texte, setTexte] = React.useState('');
  const [users, setUsers] = React.useState([]);
  const [showNewConv, setShowNewConv] = React.useState(false);
  const [searchUser, setSearchUser] = React.useState('');
  const [loading, setLoading] = React.useState(true);
  const messagesEndRef = React.useRef(null);

  React.useEffect(()=>{
    load();
    sbFetchUsers().then(u=>setUsers(u.filter(u=>u.id!==user.id)));
    // Realtime nouveaux messages
    const ch = sb.channel('rt_messages_'+user.id)
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',
        filter:'destinataire_id=eq.'+user.id},
        async ()=>{
          await load();
          if (selConv) await loadMessages(selConv.userId);
          toast('üí¨ Nouveau message !','i');
        })
      .subscribe();
    return ()=>sb.removeChannel(ch);
  },[]);

  React.useEffect(()=>{
    if (messagesEndRef.current) messagesEndRef.current.scrollIntoView({behavior:'smooth'});
  },[messages]);

  const load = async () => {
    const c = await sbFetchConversations(user.id);
    setConvs(c);
    setLoading(false);
  };

  const loadMessages = async (otherId) => {
    const m = await sbFetchMessages(user.id, otherId);
    setMessages(m);
    await sbMarquerLu(user.id, otherId);
    await load();
  };

  const ouvrirConv = async (conv) => {
    setSelConv(conv);
    setShowNewConv(false);
    await loadMessages(conv.userId);
  };

  const demarrerConv = async (otherUser) => {
    const fakeConv = {userId:otherUser.id, user:otherUser, messages:[], unread:0};
    setSelConv(fakeConv);
    setShowNewConv(false);
    setMessages([]);
  };

  const envoyer = async (e) => {
    e.preventDefault();
    if (!texte.trim()) return;
    try {
      const m = await sbEnvoyerMessage(user.id, selConv.userId, texte.trim());
      setMessages(prev=>[...prev,m]);
      setTexte('');
      await load();
    } catch(err) { toast('Erreur envoi: '+err.message,'e'); }
  };

  const usersFiltres = users.filter(u=>
    u.nom.toLowerCase().includes(searchUser.toLowerCase()) ||
    (u.village||'').toLowerCase().includes(searchUser.toLowerCase())
  );

  const totalUnread = convs.reduce((s,c)=>s+c.unread,0);
  const secteurIc = (s) => s==='elevage'?'üêÑ':s==='mixte'?'üåæ':'üå±';

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Messagerie</div>
        <div className="ph-title">üí¨ Messages {totalUnread>0&&<span style={{fontSize:'.75rem',background:'var(--rust2)',color:'#fff',borderRadius:'99px',padding:'.1rem .5rem',marginLeft:'.4rem'}}>{totalUnread}</span>}</div>
        <div className="ph-sub">√âchangez directement avec les membres AgriTontine+</div>
      </div>
      <div className="content">
        <div style={{display:'grid',gridTemplateColumns:'300px 1fr',gap:'1rem',height:'70vh',minHeight:'400px'}}>

          {/* Liste conversations */}
          <div style={{border:'1px solid var(--border)',borderRadius:'12px',overflow:'hidden',display:'flex',flexDirection:'column',background:'var(--card)'}}>
            <div style={{padding:'.75rem',borderBottom:'1px solid var(--border)',display:'flex',gap:'.5rem'}}>
              <button className={`btn btn-sm ${!showNewConv?'btn-lime':'btn-ghost'}`} style={{flex:1,justifyContent:'center'}} onClick={()=>setShowNewConv(false)}>
                üí¨ Conversations
              </button>
              <button className={`btn btn-sm ${showNewConv?'btn-lime':'btn-ghost'}`} style={{flex:1,justifyContent:'center'}} onClick={()=>setShowNewConv(true)}>
                + Nouveau
              </button>
            </div>
            <div style={{overflowY:'auto',flex:1}}>
              {showNewConv ? (
                <div style={{padding:'.5rem'}}>
                  <input placeholder="Rechercher un membre..." value={searchUser} onChange={e=>setSearchUser(e.target.value)}
                    style={{width:'100%',padding:'.4rem .6rem',borderRadius:'6px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.82rem',marginBottom:'.5rem'}}/>
                  {usersFiltres.slice(0,20).map(u=>(
                    <div key={u.id} onClick={()=>demarrerConv(u)}
                      style={{padding:'.6rem',borderRadius:'8px',cursor:'pointer',display:'flex',gap:'.6rem',alignItems:'center',marginBottom:'.2rem'}}
                      onMouseOver={e=>e.currentTarget.style.background='var(--hover,rgba(0,0,0,.04))'} onMouseOut={e=>e.currentTarget.style.background='transparent'}>
                      <div style={{width:'32px',height:'32px',borderRadius:'50%',background:'var(--s3)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1rem',flexShrink:0}}>{secteurIc(u.secteur)}</div>
                      <div>
                        <div style={{fontWeight:600,fontSize:'.85rem',color:'var(--ink)'}}>{u.nom}</div>
                        <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>üìç {u.village||''} {u.region}</div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : loading ? (
                <div style={{padding:'1rem',textAlign:'center',color:'var(--ink3)',fontSize:'.82rem'}}>‚è≥ Chargement...</div>
              ) : convs.length===0 ? (
                <div style={{padding:'1rem',textAlign:'center',color:'var(--ink3)',fontSize:'.82rem'}}>
                  Aucune conversation<br/>
                  <span style={{fontSize:'.75rem'}}>Cliquez sur + Nouveau</span>
                </div>
              ) : convs.map(c=>(
                <div key={c.userId} onClick={()=>ouvrirConv(c)}
                  style={{padding:'.75rem',cursor:'pointer',borderBottom:'1px solid var(--border)',
                    background:selConv?.userId===c.userId?'rgba(90,158,32,.08)':'transparent',
                    display:'flex',gap:'.6rem',alignItems:'center'}}>
                  <div style={{width:'36px',height:'36px',borderRadius:'50%',background:'linear-gradient(135deg,var(--s3),var(--s4))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.1rem',flexShrink:0}}>
                    {secteurIc(c.user?.secteur)}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontWeight:c.unread?700:500,fontSize:'.88rem',color:'var(--ink)',display:'flex',justifyContent:'space-between'}}>
                      <span style={{overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{c.user?.nom||'‚Äî'}</span>
                      {c.unread>0&&<span style={{background:'var(--lime)',color:'#fff',borderRadius:'99px',fontSize:'.68rem',padding:'.1rem .4rem',flexShrink:0,marginLeft:'.3rem'}}>{c.unread}</span>}
                    </div>
                    <div style={{fontSize:'.72rem',color:'var(--ink3)',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
                      {c.messages[0]?.texte||'D√©marrer la conversation'}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Zone de chat */}
          <div style={{border:'1px solid var(--border)',borderRadius:'12px',overflow:'hidden',display:'flex',flexDirection:'column',background:'var(--card)'}}>
            {!selConv ? (
              <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column',gap:'.75rem',color:'var(--ink3)'}}>
                <div style={{fontSize:'3rem'}}>üí¨</div>
                <div style={{fontWeight:600}}>S√©lectionnez une conversation</div>
                <div style={{fontSize:'.82rem'}}>ou cliquez sur + Nouveau pour √©crire un membre</div>
              </div>
            ) : (<>
              {/* Header */}
              <div style={{padding:'.75rem 1rem',borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',gap:'.75rem',background:'var(--card)'}}>
                <div style={{width:'36px',height:'36px',borderRadius:'50%',background:'linear-gradient(135deg,var(--s3),var(--s4))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.1rem'}}>
                  {secteurIc(selConv.user?.secteur)}
                </div>
                <div>
                  <div style={{fontWeight:700,color:'var(--ink)'}}>{selConv.user?.nom||'‚Äî'}</div>
                  <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>üìç {selConv.user?.village||''} {selConv.user?.region}</div>
                </div>
              </div>
              {/* Messages */}
              <div style={{flex:1,overflowY:'auto',padding:'1rem',display:'flex',flexDirection:'column',gap:'.5rem'}}>
                {messages.length===0&&<div style={{textAlign:'center',color:'var(--ink3)',fontSize:'.82rem',marginTop:'2rem'}}>Envoyez votre premier message !</div>}
                {messages.map(m=>{
                  const isMine = m.expediteur_id===user.id;
                  return (
                    <div key={m.id} style={{display:'flex',justifyContent:isMine?'flex-end':'flex-start'}}>
                      <div style={{maxWidth:'70%',padding:'.6rem .9rem',borderRadius:isMine?'16px 16px 4px 16px':'16px 16px 16px 4px',
                        background:isMine?'var(--lime)':'var(--card2,#f0f0f0)',color:isMine?'#fff':'var(--ink)',fontSize:'.87rem',lineHeight:1.5}}>
                        {m.texte}
                        <div style={{fontSize:'.65rem',opacity:.7,marginTop:'.2rem',textAlign:'right'}}>
                          {new Date(m.created_at).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}
                          {isMine&&<span style={{marginLeft:'.3rem'}}>{m.lu?'‚úì‚úì':'‚úì'}</span>}
                        </div>
                      </div>
                    </div>
                  );
                })}
                <div ref={messagesEndRef}/>
              </div>
              {/* Input */}
              <form onSubmit={envoyer} style={{padding:'.75rem',borderTop:'1px solid var(--border)',display:'flex',gap:'.5rem'}}>
                <input value={texte} onChange={e=>setTexte(e.target.value)} placeholder="√âcrire un message..."
                  style={{flex:1,padding:'.6rem .9rem',borderRadius:'24px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.87rem'}}/>
                <button type="submit" className="btn btn-lime" style={{borderRadius:'50%',width:'40px',height:'40px',padding:0,justifyContent:'center',flexShrink:0}}>
                  ‚û§
                </button>
              </form>
            </>)}
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CARTE INTERACTIVE ‚Äî Tontines par r√©gion
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function CarteRegions({user, tontines, toast}) {
  const [selRegion, setSelRegion] = React.useState(null);
  const [filterSec, setFilterSec] = React.useState('all');

  // Coordonn√©es SVG approximatives des 15 r√©gions du S√©n√©gal
  const COORDS = {
    'Dakar':       {x:62,  y:158, pop:'3.7M'},
    'Thi√®s':       {x:88,  y:148, pop:'2.1M'},
    'Diourbel':    {x:128, y:148, pop:'1.8M'},
    'Fatick':      {x:118, y:178, pop:'0.9M'},
    'Kaolack':     {x:148, y:178, pop:'1.1M'},
    'Kaffrine':    {x:188, y:168, pop:'0.7M'},
    'Saint-Louis': {x:118, y:62,  pop:'1.1M'},
    'Louga':       {x:138, y:98,  pop:'1.1M'},
    'Matam':       {x:218, y:78,  pop:'0.7M'},
    'Podor':       {x:168, y:62,  pop:'0.4M'},
    'Tambacounda': {x:238, y:158, pop:'0.9M'},
    'K√©dougou':    {x:258, y:198, pop:'0.2M'},
    'Kolda':       {x:208, y:208, pop:'0.7M'},
    'S√©dhiou':     {x:168, y:218, pop:'0.5M'},
    'Ziguinchor':  {x:128, y:228, pop:'0.6M'},
  };

  const tontinesParRegion = React.useMemo(()=>{
    const map = {};
    REGIONS.forEach(r=>{ map[r]={total:0,agriculture:0,elevage:0,mixte:0,membres:0}; });
    tontines.filter(t=>filterSec==='all'||t.secteur===filterSec).forEach(t=>{
      if (map[t.region]) {
        map[t.region].total++;
        map[t.region][t.secteur]=(map[t.region][t.secteur]||0)+1;
        map[t.region].membres+=(t.membres||[]).length;
      }
    });
    return map;
  },[tontines,filterSec]);

  const maxTontines = Math.max(...Object.values(tontinesParRegion).map(r=>r.total),1);
  const getColor = (region) => {
    const n = tontinesParRegion[region]?.total||0;
    if (n===0) return 'rgba(200,200,200,.3)';
    const intensity = n/maxTontines;
    if (intensity>0.7) return 'rgba(90,158,32,.8)';
    if (intensity>0.4) return 'rgba(90,158,32,.5)';
    return 'rgba(90,158,32,.25)';
  };

  const regSel = selRegion ? tontinesParRegion[selRegion] : null;
  const tontinesSel = selRegion ? tontines.filter(t=>t.region===selRegion&&(filterSec==='all'||t.secteur===filterSec)) : [];

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Carte</div>
        <div className="ph-title">üó∫ Carte des Tontines ‚Äî S√©n√©gal</div>
        <div className="ph-sub">Distribution des tontines par r√©gion ¬∑ Cliquez sur une r√©gion</div>
      </div>
      <div className="content">
        <div style={{marginBottom:'1rem',display:'flex',gap:'.5rem',flexWrap:'wrap',alignItems:'center'}}>
          <select value={filterSec} onChange={e=>setFilterSec(e.target.value)}
            style={{padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem'}}>
            <option value="all">Tous secteurs</option>
            {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
          </select>
          <div style={{fontSize:'.8rem',color:'var(--ink3)'}}>
            Total : <strong style={{color:'var(--lime)'}}>{tontines.filter(t=>filterSec==='all'||t.secteur===filterSec).length} tontines</strong> ¬∑
            <strong style={{color:'var(--gold2)'}}> {tontines.reduce((s,t)=>s+(t.membres||[]).length,0)} membres</strong>
          </div>
        </div>

        <div className="g2">
          {/* Carte SVG */}
          <div className="card" style={{padding:'1rem'}}>
            <div style={{fontWeight:600,marginBottom:'.75rem',fontSize:'.85rem',color:'var(--ink3)'}}>
              üó∫ Cliquez sur une r√©gion
            </div>
            <svg viewBox="0 0 320 260" style={{width:'100%',maxWidth:'400px',display:'block',margin:'0 auto'}}>
              {Object.entries(COORDS).map(([region,pos])=>{
                const data = tontinesParRegion[region];
                const isUser = region===user.region;
                const isSel = region===selRegion;
                const r = data.total>0 ? Math.max(14, Math.min(26, 14+data.total*3)) : 12;
                return (
                  <g key={region} onClick={()=>setSelRegion(selRegion===region?null:region)} style={{cursor:'pointer'}}>
                    <circle cx={pos.x} cy={pos.y} r={r}
                      fill={getColor(region)}
                      stroke={isSel?'var(--lime)':isUser?'var(--gold2)':'rgba(90,158,32,.4)'}
                      strokeWidth={isSel?3:isUser?2:1}
                      opacity={isSel?1:.85}/>
                    {data.total>0&&(
                      <text x={pos.x} y={pos.y+1} textAnchor="middle" dominantBaseline="middle"
                        style={{fontSize:'9px',fontWeight:700,fill:'#fff',pointerEvents:'none'}}>
                        {data.total}
                      </text>
                    )}
                    <text x={pos.x} y={pos.y+r+9} textAnchor="middle"
                      style={{fontSize:'7px',fill:'var(--ink3)',pointerEvents:'none'}}>
                      {region.length>8?region.slice(0,8)+'‚Ä¶':region}
                    </text>
                  </g>
                );
              })}
            </svg>
            {/* L√©gende */}
            <div style={{display:'flex',gap:'.75rem',justifyContent:'center',marginTop:'.75rem',flexWrap:'wrap'}}>
              {[['rgba(90,158,32,.8)','Nombreuses'],['rgba(90,158,32,.5)','Quelques'],['rgba(90,158,32,.25)','1‚Äì2'],['rgba(200,200,200,.3)','Aucune']].map(([col,lbl])=>(
                <div key={lbl} style={{display:'flex',alignItems:'center',gap:'.3rem',fontSize:'.72rem',color:'var(--ink3)'}}>
                  <div style={{width:'12px',height:'12px',borderRadius:'50%',background:col}}/>
                  {lbl}
                </div>
              ))}
              <div style={{display:'flex',alignItems:'center',gap:'.3rem',fontSize:'.72rem',color:'var(--gold2)'}}>
                <div style={{width:'12px',height:'12px',borderRadius:'50%',background:'transparent',border:'2px solid var(--gold2)'}}/>
                Votre r√©gion
              </div>
            </div>
          </div>

          {/* Panneau d√©tail r√©gion */}
          <div>
            {selRegion ? (
              <div className="card">
                <div style={{fontWeight:800,fontSize:'1.1rem',color:'var(--ink)',marginBottom:'.75rem'}}>
                  üìç {selRegion}
                  {selRegion===user.region&&<span className="chip ch-gold" style={{fontSize:'.7rem',marginLeft:'.5rem'}}>Votre r√©gion</span>}
                </div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.6rem',marginBottom:'1rem'}}>
                  {[
                    ['Tontines',regSel.total,'var(--lime)'],
                    ['Membres',regSel.membres,'var(--gold2)'],
                    ['Agriculture',regSel.agriculture,'var(--lime)'],
                    ['√âlevage',regSel.elevage,'var(--amber2,#f59f00)'],
                  ].map(([lbl,val,col])=>(
                    <div key={lbl} style={{padding:'.6rem',background:'var(--card2,#f5f5f5)',borderRadius:'8px',textAlign:'center'}}>
                      <div style={{fontWeight:800,fontSize:'1.2rem',color:col}}>{val}</div>
                      <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{lbl}</div>
                    </div>
                  ))}
                </div>
                {tontinesSel.length>0 ? tontinesSel.map(t=>(
                  <div key={t.id} style={{padding:'.6rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',marginBottom:'.5rem',background:'var(--card)'}}>
                    <div style={{fontWeight:600,fontSize:'.88rem',color:'var(--ink)'}}>{t.nom}</div>
                    <div style={{fontSize:'.75rem',color:'var(--ink3)',marginTop:'.2rem',display:'flex',gap:'1rem'}}>
                      <span>üë• {(t.membres||[]).length}/{t.nbMax}</span>
                      <span>üí∞ {(t.montantCotis||0).toLocaleString('fr-FR')} FCFA</span>
                      <span className={`chip ${SECTEURS.find(s=>s.id===t.secteur)?.cls||'ch-gray'}`} style={{fontSize:'.65rem'}}>{t.secteur}</span>
                    </div>
                  </div>
                )) : (
                  <div style={{textAlign:'center',padding:'1rem',color:'var(--ink3)',fontSize:'.83rem'}}>
                    Aucune tontine dans cette r√©gion<br/>
                    <span style={{fontSize:'.75rem'}}>Soyez le premier √† en cr√©er une !</span>
                  </div>
                )}
              </div>
            ) : (
              <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
                <div style={{fontSize:'2.5rem',marginBottom:'.75rem'}}>üó∫</div>
                <div style={{fontWeight:600,marginBottom:'.4rem'}}>Explorez les r√©gions</div>
                <div style={{fontSize:'.82rem'}}>Cliquez sur un cercle pour voir les tontines de la r√©gion</div>
                <div style={{marginTop:'1rem',padding:'.6rem',background:'rgba(90,158,32,.08)',borderRadius:'8px',fontSize:'.8rem',color:'var(--lime)'}}>
                  Votre r√©gion : <strong>{user.region}</strong>
                </div>
              </div>
            )}

            {/* Top r√©gions */}
            <div className="card mt2">
              <div className="card-title">üèÜ Top r√©gions</div>
              {Object.entries(tontinesParRegion)
                .filter(([,d])=>d.total>0)
                .sort(([,a],[,b])=>b.total-a.total)
                .slice(0,5)
                .map(([region,data],i)=>(
                  <div key={region} onClick={()=>setSelRegion(region)}
                    style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'.5rem 0',
                      borderBottom:'1px solid var(--border)',cursor:'pointer',
                      color:selRegion===region?'var(--lime)':'var(--ink)'}}>
                    <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                      <span style={{fontWeight:700,color:'var(--ink3)',fontSize:'.8rem'}}>#{i+1}</span>
                      <span style={{fontWeight:600,fontSize:'.88rem'}}>{region}</span>
                    </div>
                    <div style={{display:'flex',gap:'.75rem',fontSize:'.78rem',color:'var(--ink3)'}}>
                      <span>{data.total} tontines</span>
                      <span style={{color:'var(--lime)',fontWeight:600}}>{data.membres} membres</span>
                    </div>
                  </div>
                ))}
              {Object.values(tontinesParRegion).every(d=>d.total===0)&&(
                <div style={{textAlign:'center',color:'var(--ink3)',fontSize:'.82rem',padding:'1rem'}}>
                  Cr√©ez des tontines pour les voir appara√Ætre sur la carte
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADMIN NATIONAL ‚Äî Tableau de bord
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function AdminNational({user, tontines, projets, toast}) {
  const [stats, setStats] = React.useState(null);
  const [topUsers, setTopUsers] = React.useState([]);
  const [loading, setLoading] = React.useState(true);

  React.useEffect(()=>{
    load();
  },[]);

  const load = async () => {
    setLoading(true);
    const [usersRes, cotisRes, creditRes, investRes, annoncesRes] = await Promise.all([
      sb.from('users').select('id,nom,secteur,region,role,created_at'),
      sb.from('cotisations').select('id,montant,statut,user_id'),
      sb.from('credits').select('id,montant,statut'),
      sb.from('investissements').select('id,montant'),
      sb.from('annonces').select('id,statut,type'),
    ]);
    const users = usersRes.data||[];
    const cotis = cotisRes.data||[];
    const credits = creditRes.data||[];
    const invests = investRes.data||[];
    const annonces = annoncesRes.data||[];

    const totalCotis = cotis.filter(c=>c.statut==='payee').reduce((s,c)=>s+c.montant,0);
    const totalCredits = credits.reduce((s,c)=>s+c.montant,0);
    const totalInvests = invests.reduce((s,i)=>s+i.montant,0);
    const retards = cotis.filter(c=>c.statut==='retard').length;

    setStats({
      nbUsers: users.length,
      nbTontines: tontines.length,
      nbProjets: projets.length,
      totalCotis,
      totalCredits,
      totalInvests,
      retards,
      nbAnnonces: annonces.filter(a=>a.statut==='active').length,
      parRegion: REGIONS.map(r=>({region:r,users:users.filter(u=>u.region===r).length,tontines:tontines.filter(t=>t.region===r).length})).filter(r=>r.users>0||r.tontines>0).sort((a,b)=>b.users-a.users),
      parSecteur: SECTEURS.map(s=>({secteur:s.label,ic:s.ic,users:users.filter(u=>u.secteur===s.id).length})),
      evolution: Array.from({length:6},(_,i)=>{
        const d = new Date(); d.setMonth(d.getMonth()-5+i);
        const mois = d.toLocaleString('fr-FR',{month:'short'});
        const usersM = users.filter(u=>new Date(u.created_at).getMonth()===d.getMonth()&&new Date(u.created_at).getFullYear()===d.getFullYear()).length;
        return {mois,users:usersM};
      }),
    });

    // Top users par cotisations
    const userCotis = {};
    cotis.filter(c=>c.statut==='payee').forEach(c=>{ userCotis[c.user_id]=(userCotis[c.user_id]||0)+c.montant; });
    const top = users.sort((a,b)=>(userCotis[b.id]||0)-(userCotis[a.id]||0)).slice(0,5).map(u=>({...u,totalCotis:userCotis[u.id]||0}));
    setTopUsers(top);
    setLoading(false);
  };

  const prix = (n) => n?Math.round(n).toLocaleString('fr-FR')+' FCFA':'0 FCFA';

  if (!user || user.role!=='admin') return (
    <div className="content">
      <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
        <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üîí</div>
        <div style={{fontWeight:600}}>Acc√®s r√©serv√© aux administrateurs</div>
      </div>
    </div>
  );

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Administration</div>
        <div className="ph-title">üëë Tableau de bord national</div>
        <div className="ph-sub">Vue globale AgriTontine+ ¬∑ S√©n√©gal ¬∑ {new Date().toLocaleDateString('fr-FR')}</div>
      </div>
      <div className="content">
        {loading ? <div style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>‚è≥ Chargement des donn√©es...</div> : stats && (<>
          {/* KPIs principaux */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(150px,1fr))',gap:'.75rem',marginBottom:'1.5rem'}}>
            {[
              ['üë•',stats.nbUsers,'Membres',null],
              ['ü§ù',stats.nbTontines,'Tontines',null],
              ['üí∞',prix(stats.totalCotis),'Cotisations','var(--lime)'],
              ['üå±',credits_text(stats.totalCredits),'Cr√©dits octroy√©s','var(--teal2)'],
              ['üíº',prix(stats.totalInvests),'Investissements','var(--gold2)'],
              ['üõí',stats.nbAnnonces,'Annonces actives',null],
              ['‚ö†',stats.retards,'Retards paiement','var(--rust2)'],
            ].map(([ic,val,lbl,col])=>(
              <div key={lbl} className="card" style={{textAlign:'center',padding:'.75rem'}}>
                <div style={{fontSize:'1.4rem'}}>{ic}</div>
                <div style={{fontWeight:800,fontSize:'1.1rem',color:col||'var(--ink)',margin:'.2rem 0',lineHeight:1.2}}>{val}</div>
                <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{lbl}</div>
              </div>
            ))}
          </div>

          <div className="g2">
            {/* Par r√©gion */}
            <div className="card">
              <div className="card-title">üìç Activit√© par r√©gion</div>
              {stats.parRegion.slice(0,8).map((r,i)=>(
                <div key={r.region} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'.45rem 0',borderBottom:'1px solid var(--border)'}}>
                  <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                    <span style={{fontSize:'.78rem',color:'var(--ink4)',width:'1.2rem'}}>#{i+1}</span>
                    <span style={{fontWeight:600,fontSize:'.88rem'}}>{r.region}</span>
                  </div>
                  <div style={{display:'flex',gap:'1rem',fontSize:'.78rem',color:'var(--ink3)'}}>
                    <span>üë• {r.users}</span>
                    <span style={{color:'var(--lime)',fontWeight:600}}>ü§ù {r.tontines}</span>
                  </div>
                </div>
              ))}
            </div>

            {/* Par secteur */}
            <div>
              <div className="card mb2">
                <div className="card-title">üåæ R√©partition par secteur</div>
                {stats.parSecteur.map(s=>{
                  const pct = stats.nbUsers>0?Math.round(s.users/stats.nbUsers*100):0;
                  return (
                    <div key={s.secteur} style={{marginBottom:'.75rem'}}>
                      <div style={{display:'flex',justifyContent:'space-between',fontSize:'.83rem',marginBottom:'.25rem'}}>
                        <span>{s.ic} {s.secteur}</span>
                        <span style={{fontWeight:600,color:'var(--lime)'}}>{s.users} ({pct}%)</span>
                      </div>
                      <div style={{height:'6px',background:'var(--border)',borderRadius:'99px',overflow:'hidden'}}>
                        <div style={{width:pct+'%',height:'100%',background:'var(--lime)',borderRadius:'99px',transition:'.4s'}}/>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Top membres */}
              <div className="card">
                <div className="card-title">üèÜ Top 5 membres actifs</div>
                {topUsers.map((u,i)=>(
                  <div key={u.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'.45rem 0',borderBottom:'1px solid var(--border)'}}>
                    <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                      <span style={{fontSize:'.78rem',color:'var(--ink4)',width:'1.2rem'}}>#{i+1}</span>
                      <div>
                        <div style={{fontWeight:600,fontSize:'.85rem'}}>{u.nom}</div>
                        <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{u.region}</div>
                      </div>
                    </div>
                    <span style={{fontWeight:700,color:'var(--lime)',fontSize:'.82rem'}}>{prix(u.totalCotis)}</span>
                  </div>
                ))}
                {topUsers.length===0&&<div style={{textAlign:'center',color:'var(--ink3)',fontSize:'.82rem',padding:'.5rem'}}>Aucune cotisation enregistr√©e</div>}
              </div>
            </div>
          </div>
        </>)}
      </div>
    </div>
  );
}

function credits_text(n) {
  if (!n) return '0 FCFA';
  if (n>=1000000) return (n/1000000).toFixed(1)+'M FCFA';
  if (n>=1000) return (n/1000).toFixed(0)+'K FCFA';
  return n.toLocaleString('fr-FR')+' FCFA';
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NOTIFICATIONS ‚Äî Centre de notifications
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function sbFetchNotifs(userId) {
  const {data} = await sb.from('notifications')
    .select('*').eq('user_id', userId)
    .order('created_at',{ascending:false}).limit(50);
  return data || [];
}
async function sbMarquerNotifLue(id) {
  await sb.from('notifications').update({lu:true}).eq('id',id);
}
async function sbMarquerToutesLues(userId) {
  await sb.from('notifications').update({lu:true}).eq('user_id',userId).eq('lu',false);
}
async function sbCreerNotif(userId, type, titre, message, lien) {
  await sb.from('notifications').insert({user_id:userId,type,titre,message,lien:lien||'',lu:false});
}

function Notifications({user, toast}) {
  const [notifs, setNotifs] = React.useState([]);
  const [loading, setLoading] = React.useState(true);
  const [filter, setFilter] = React.useState('all');

  React.useEffect(()=>{ load(); }, []);

  const load = async () => {
    setLoading(true);
    const n = await sbFetchNotifs(user.id);
    setNotifs(n);
    setLoading(false);
  };

  const marquerLue = async (id) => {
    await sbMarquerNotifLue(id);
    setNotifs(prev=>prev.map(n=>n.id===id?{...n,lu:true}:n));
  };

  const toutMarquer = async () => {
    await sbMarquerToutesLues(user.id);
    setNotifs(prev=>prev.map(n=>({...n,lu:true})));
    toast('Toutes les notifications marqu√©es comme lues');
  };

  const NOTIF_TYPES = {
    cotisation: {ic:'üí∏', color:'var(--lime)'},
    credit:     {ic:'üå±', color:'var(--teal2)'},
    tontine:    {ic:'ü§ù', color:'var(--gold2)'},
    message:    {ic:'üí¨', color:'#42a5f5'},
    marche:     {ic:'üõí', color:'var(--amber2,#f59f00)'},
    alerte:     {ic:'‚ö†',  color:'var(--rust2)'},
    invest:     {ic:'üíº', color:'var(--lime)'},
    systeme:    {ic:'üîî', color:'var(--ink3)'},
  };

  const filtered = filter==='all' ? notifs : filter==='non_lues' ? notifs.filter(n=>!n.lu) : notifs.filter(n=>n.type===filter);
  const nonLues = notifs.filter(n=>!n.lu).length;
  const timeAgo = (d) => {
    const diff = (Date.now()-new Date(d))/1000;
    if (diff<60) return '√Ä l\'instant';
    if (diff<3600) return Math.floor(diff/60)+'min';
    if (diff<86400) return Math.floor(diff/3600)+'h';
    return Math.floor(diff/86400)+'j';
  };

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Notifications</div>
        <div className="ph-title">üîî Centre de notifications
          {nonLues>0&&<span style={{fontSize:'.75rem',background:'var(--rust2)',color:'#fff',borderRadius:'99px',padding:'.1rem .5rem',marginLeft:'.5rem'}}>{nonLues}</span>}
        </div>
        <div className="ph-sub">Toutes vos alertes et activit√©s en temps r√©el</div>
      </div>
      <div className="content">
        <div style={{display:'flex',gap:'.5rem',flexWrap:'wrap',marginBottom:'1rem',alignItems:'center',justifyContent:'space-between'}}>
          <div style={{display:'flex',gap:'.4rem',flexWrap:'wrap'}}>
            {[['all','Toutes'],['non_lues','Non lues'],['cotisation','Cotisations'],['tontine','Tontines'],['message','Messages'],['alerte','Alertes']].map(([val,lbl])=>(
              <div key={val} onClick={()=>setFilter(val)} style={{
                padding:'.3rem .75rem',borderRadius:'99px',cursor:'pointer',fontSize:'.78rem',fontWeight:filter===val?700:400,
                background:filter===val?'var(--lime)':'var(--card)',color:filter===val?'#fff':'var(--ink3)',
                border:'1px solid '+(filter===val?'var(--lime)':'var(--border)'),
              }}>{lbl}{val==='non_lues'&&nonLues>0?` (${nonLues})`:''}</div>
            ))}
          </div>
          {nonLues>0&&<button className="btn btn-ghost btn-sm" onClick={toutMarquer}>‚úì Tout marquer lu</button>}
        </div>

        {loading ? <div style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>‚è≥ Chargement...</div>
        : filtered.length===0 ? (
          <div className="card" style={{textAlign:'center',padding:'3rem',color:'var(--ink3)'}}>
            <div style={{fontSize:'2.5rem',marginBottom:'.75rem'}}>üîî</div>
            <div style={{fontWeight:600,marginBottom:'.3rem'}}>Aucune notification</div>
            <div style={{fontSize:'.82rem'}}>Vos alertes appara√Ætront ici</div>
          </div>
        ) : (
          <div style={{display:'flex',flexDirection:'column',gap:'.5rem'}}>
            {filtered.map(n=>{
              const t = NOTIF_TYPES[n.type]||NOTIF_TYPES.systeme;
              return (
                <div key={n.id} onClick={()=>marquerLue(n.id)}
                  style={{padding:'.85rem 1rem',borderRadius:'10px',cursor:'pointer',
                    background:n.lu?'var(--card)':'rgba(90,158,32,.05)',
                    border:`1px solid ${n.lu?'var(--border)':'rgba(90,158,32,.2)'}`,
                    display:'flex',gap:'.75rem',alignItems:'flex-start',transition:'.15s'}}>
                  <div style={{width:'38px',height:'38px',borderRadius:'50%',background:`rgba(${t.color==='var(--lime)'?'90,158,32':'196,154,40'},.12)`,
                    display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.2rem',flexShrink:0}}>
                    {t.ic}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:'.5rem'}}>
                      <div style={{fontWeight:n.lu?500:700,fontSize:'.9rem',color:'var(--ink)'}}>{n.titre}</div>
                      <div style={{display:'flex',alignItems:'center',gap:'.4rem',flexShrink:0}}>
                        <span style={{fontSize:'.72rem',color:'var(--ink4)'}}>{timeAgo(n.created_at)}</span>
                        {!n.lu&&<div style={{width:'8px',height:'8px',borderRadius:'50%',background:'var(--lime)',flexShrink:0}}/>}
                      </div>
                    </div>
                    <div style={{fontSize:'.82rem',color:'var(--ink3)',marginTop:'.2rem',lineHeight:1.5}}>{n.message}</div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIMULATEUR DE CR√âDIT ‚Äî IA scoring avanc√©
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function SimulateurCredit({user, tontines, toast}) {
  const score = calcScore(user);
  const plafond = score * 1000;

  const [sim, setSim] = React.useState({
    montant: '',
    duree: '6',
    intrant: 'Semences certifi√©es',
    objectif: '',
  });
  const [resultat, setResultat] = React.useState(null);

  // Taux d'int√©r√™t selon le score
  const getTaux = (score) => {
    if (score >= 80) return 3;
    if (score >= 65) return 5;
    if (score >= 50) return 8;
    if (score >= 40) return 12;
    return null; // in√©ligible
  };

  const taux = getTaux(score);
  const mesTontines = tontines.filter(t=>t.membres.some(m=>m.uid===user.id));

  const simuler = (e) => {
    e.preventDefault();
    const montant = parseInt(sim.montant);
    const duree = parseInt(sim.duree);
    if (!montant || montant <= 0) { toast('Entrez un montant','e'); return; }
    if (montant > plafond) { toast('Montant sup√©rieur √† votre plafond de '+plafond.toLocaleString('fr-FR')+' FCFA','e'); return; }
    if (!taux) { toast('Score insuffisant (minimum 40 points)','e'); return; }

    const interetTotal = Math.round(montant * taux/100 * duree/12);
    const totalRemboursement = montant + interetTotal;
    const mensualite = Math.round(totalRemboursement / duree);
    const scoreApres = Math.min(100, score + 8); // bonus remboursement
    const nouveauPlafond = scoreApres * 1000;

    setResultat({
      montant, duree, taux, interetTotal, totalRemboursement,
      mensualite, scoreApres, nouveauPlafond,
      eligible: montant <= plafond && score >= 40,
    });
  };

  const INTRANTS_ALL = [
    ...INTRANTS_AGRI.map(i=>({label:i,secteur:'agriculture'})),
    ...INTRANTS_ELEV.map(i=>({label:i,secteur:'elevage'})),
  ];

  const scoreColor = score>=65?'var(--lime)':score>=40?'var(--gold2)':'var(--rust2)';
  const prix = (n) => n.toLocaleString('fr-FR')+' FCFA';

  // Historique cr√©dits
  const creditsOk = (user.credits||[]).filter(c=>c.statut==='rembourse').length;
  const creditsEnCours = (user.credits||[]).filter(c=>c.statut==='approuve').length;

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Simulateur</div>
        <div className="ph-title">üßÆ Simulateur de Cr√©dit IA</div>
        <div className="ph-sub">Estimez votre √©ligibilit√© et vos mensualit√©s avant de demander</div>
      </div>
      <div className="content">
        <div className="g2">
          {/* Profil cr√©dit */}
          <div>
            <div className="card mb2">
              <div className="card-title">üìä Votre profil de cr√©dit</div>
              <div style={{textAlign:'center',marginBottom:'1rem'}}>
                <ScoreRing score={score} sz={120} fsz="1.8rem"/>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.6rem',marginBottom:'1rem'}}>
                {[
                  ['Plafond actuel', prix(plafond), 'var(--lime)'],
                  ['Taux applicable', taux ? taux+'%/an' : 'In√©ligible', taux?'var(--teal2)':'var(--rust2)'],
                  ['Cr√©dits rembours√©s', creditsOk, 'var(--gold2)'],
                  ['Tontines actives', mesTontines.length, 'var(--lime)'],
                ].map(([lbl,val,col])=>(
                  <div key={lbl} style={{padding:'.6rem',background:'var(--card2,#f5f5f5)',borderRadius:'8px',textAlign:'center'}}>
                    <div style={{fontWeight:700,fontSize:'1rem',color:col}}>{val}</div>
                    <div style={{fontSize:'.7rem',color:'var(--ink3)',marginTop:'.1rem'}}>{lbl}</div>
                  </div>
                ))}
              </div>

              {/* Bar√®me des taux */}
              <div style={{padding:'.6rem',background:'rgba(26,122,110,.06)',borderRadius:'8px',fontSize:'.78rem'}}>
                <div style={{fontWeight:600,color:'var(--teal2)',marginBottom:'.4rem'}}>üìã Bar√®me des taux AgriTontine+</div>
                {[[80,100,'3% / an','var(--lime)'],[65,79,'5% / an','var(--lime)'],[50,64,'8% / an','var(--gold2)'],[40,49,'12% / an','var(--amber2,#f59f00)'],[0,39,'In√©ligible','var(--rust2)']].map(([min,max,tx,col])=>(
                  <div key={min} style={{display:'flex',justifyContent:'space-between',padding:'.2rem 0',
                    fontWeight:score>=min&&score<=max?700:400,color:score>=min&&score<=max?col:'var(--ink3)'}}>
                    <span>Score {min}‚Äì{max} pts {score>=min&&score<=max&&'‚Üê vous'}</span>
                    <span style={{color:col,fontWeight:600}}>{tx}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Conseils am√©lioration score */}
            {score < 100 && (
              <div className="card">
                <div className="card-title">üí° Am√©liorez votre score</div>
                {[
                  score < 65 && ['Payez toutes vos cotisations √† temps', '+5 pts par paiement', 'var(--lime)'],
                  mesTontines.length < 3 && ['Rejoignez une tontine suppl√©mentaire', '+2.4 pts', 'var(--gold2)'],
                  creditsOk < 3 && creditsEnCours > 0 && ['Remboursez votre cr√©dit en cours', '+10 pts', 'var(--teal2)'],
                  (user.investissements||[]).length < 2 && ['Investissez dans un projet', '+1.5 pts', 'var(--lime)'],
                ].filter(Boolean).map(([conseil,gain,col])=>(
                  <div key={conseil} style={{display:'flex',justifyContent:'space-between',padding:'.5rem 0',borderBottom:'1px solid var(--border)',fontSize:'.82rem'}}>
                    <span style={{color:'var(--ink)'}}>{conseil}</span>
                    <span style={{fontWeight:700,color:col,flexShrink:0,marginLeft:'.5rem'}}>{gain}</span>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Formulaire simulation */}
          <div>
            <div className="card mb2">
              <div className="card-title">üßÆ Simulez votre cr√©dit</div>
              {score < 40 ? (
                <div style={{padding:'1rem',background:'rgba(196,74,42,.08)',borderRadius:'8px',textAlign:'center'}}>
                  <div style={{fontSize:'1.5rem',marginBottom:'.4rem'}}>‚ö†</div>
                  <div style={{fontWeight:600,color:'var(--rust2)',marginBottom:'.4rem'}}>Score insuffisant ({score}/100)</div>
                  <div style={{fontSize:'.82rem',color:'var(--ink3)'}}>Minimum requis : 40 points. Payez vos cotisations pour augmenter votre score.</div>
                </div>
              ) : (
                <form onSubmit={simuler}>
                  <div className="fg">
                    <label>Montant souhait√© (FCFA)</label>
                    <input type="number" min="5000" max={plafond} step="1000" required
                      value={sim.montant} onChange={e=>setSim(p=>({...p,montant:e.target.value}))}
                      placeholder={`Max: ${prix(plafond)}`}/>
                    {sim.montant && parseInt(sim.montant) > plafond &&
                      <div style={{fontSize:'.75rem',color:'var(--rust2)',marginTop:'.2rem'}}>‚ö† D√©passe votre plafond de {prix(plafond)}</div>}
                  </div>
                  <div className="fg">
                    <label>Dur√©e de remboursement</label>
                    <select value={sim.duree} onChange={e=>setSim(p=>({...p,duree:e.target.value}))}>
                      {[3,6,12,18,24].map(d=><option key={d} value={d}>{d} mois</option>)}
                    </select>
                  </div>
                  <div className="fg">
                    <label>Intrant / Usage</label>
                    <select value={sim.intrant} onChange={e=>setSim(p=>({...p,intrant:e.target.value}))}>
                      <optgroup label="Agriculture">
                        {INTRANTS_AGRI.map(i=><option key={i}>{i}</option>)}
                      </optgroup>
                      <optgroup label="√âlevage">
                        {INTRANTS_ELEV.map(i=><option key={i}>{i}</option>)}
                      </optgroup>
                    </select>
                  </div>
                  <div className="fg">
                    <label>Objectif / Utilisation pr√©vue</label>
                    <input value={sim.objectif} onChange={e=>setSim(p=>({...p,objectif:e.target.value}))}
                      placeholder="Ex: Achat 200kg semences pour 2ha arachide"/>
                  </div>
                  <button type="submit" className="btn btn-lime w100" style={{justifyContent:'center',marginTop:'.5rem'}}>
                    Simuler ‚Üí
                  </button>
                </form>
              )}
            </div>

            {/* R√©sultat simulation */}
            {resultat && (
              <div className="card" style={{border:'2px solid var(--lime)'}}>
                <div className="card-title" style={{color:'var(--lime)'}}>‚úÖ R√©sultat de simulation</div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.6rem',marginBottom:'1rem'}}>
                  {[
                    ['Montant demand√©',prix(resultat.montant),'var(--ink)'],
                    ['Taux appliqu√©',resultat.taux+'% / an','var(--teal2)'],
                    ['Int√©r√™ts totaux',prix(resultat.interetTotal),'var(--rust2)'],
                    ['Total √† rembourser',prix(resultat.totalRemboursement),'var(--gold2)'],
                  ].map(([lbl,val,col])=>(
                    <div key={lbl} style={{padding:'.6rem',background:'var(--card2,#f5f5f5)',borderRadius:'8px'}}>
                      <div style={{fontWeight:700,fontSize:'.95rem',color:col}}>{val}</div>
                      <div style={{fontSize:'.7rem',color:'var(--ink3)',marginTop:'.1rem'}}>{lbl}</div>
                    </div>
                  ))}
                </div>
                <div style={{padding:'.75rem',background:'rgba(90,158,32,.08)',borderRadius:'10px',textAlign:'center',marginBottom:'1rem'}}>
                  <div style={{fontSize:'.75rem',color:'var(--ink3)',marginBottom:'.25rem'}}>Mensualit√© estim√©e</div>
                  <div style={{fontWeight:900,fontSize:'1.6rem',color:'var(--lime)'}}>{prix(resultat.mensualite)}</div>
                  <div style={{fontSize:'.75rem',color:'var(--ink3)'}}>pendant {resultat.duree} mois</div>
                </div>
                <div style={{padding:'.6rem .75rem',background:'rgba(26,122,110,.08)',borderRadius:'8px',fontSize:'.8rem',color:'var(--teal2)'}}>
                  <strong>Bonus remboursement :</strong> Score passe de {score} √† {resultat.scoreApres} pts ‚Üí Nouveau plafond {prix(resultat.nouveauPlafond)}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARAM√àTRES & S√âCURIT√â
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Parametres({user, setUser, toast}) {
  const [section, setSection] = React.useState('compte');
  const [fNotif, setFNotif] = React.useState({
    cotisations: true, credits: true, marche: true,
    messages: true, alertes: true, newsletter: false,
  });
  const [fSecurite, setFSecurite] = React.useState({
    pin: '', pinConfirm: '', pinActuel: '',
  });
  const [fCompte, setFCompte] = React.useState({
    nom: user.nom, village: user.village, region: user.region,
    secteur: user.secteur, telephone: user.telephone,
    cultures: user.cultures||[], especes: user.especes||[],
    superficie: user.superficie||'', experience: user.experience||'',
  });
  const [saved, setSaved] = React.useState(false);

  const saveCompte = async () => {
    try {
      await sbUpdateProfil(user.id, fCompte);
      setUser(u=>({...u,...fCompte}));
      setSaved(true);
      setTimeout(()=>setSaved(false),2000);
      toast('‚úÖ Profil mis √† jour !');
    } catch(e) { toast('Erreur: '+e.message,'e'); }
  };

  const saveNotif = () => {
    toast('‚úÖ Pr√©f√©rences de notifications sauvegard√©es !');
  };

  const EXPERIENCE_OPTIONS = ['Moins de 1 an','1-3 ans','3-5 ans','5-10 ans','Plus de 10 ans'];
  const superficieOptions = ['Moins de 1 ha','1-5 ha','5-10 ha','10-50 ha','Plus de 50 ha'];

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Param√®tres</div>
        <div className="ph-title">‚öôÔ∏è Param√®tres & S√©curit√©</div>
        <div className="ph-sub">G√©rez votre compte, notifications et pr√©f√©rences</div>
      </div>

      <div style={{padding:'0 1.25rem',display:'flex',gap:'.4rem',flexWrap:'wrap',marginBottom:'1rem',borderBottom:'1px solid var(--border)'}}>
        {[['compte','üë§ Mon compte'],['notifications','üîî Notifications'],['securite','üîí S√©curit√©'],['appli','üì± Application']].map(([id,lbl])=>(
          <div key={id} onClick={()=>setSection(id)} style={{
            padding:'.5rem .9rem',cursor:'pointer',fontWeight:section===id?700:400,
            color:section===id?'var(--lime)':'var(--ink3)',
            borderBottom:section===id?'2px solid var(--lime)':'2px solid transparent',
            fontSize:'.83rem',whiteSpace:'nowrap',
          }}>{lbl}</div>
        ))}
      </div>

      <div className="content">

        {section==='compte' && (
          <div style={{maxWidth:'560px'}}>
            <div className="card">
              <div className="card-title">üë§ Informations du compte</div>
              <div className="fg"><label>Nom complet</label><input value={fCompte.nom} onChange={e=>setFCompte(p=>({...p,nom:e.target.value}))}/></div>
              <div className="fr">
                <div className="fg"><label>Village</label><input value={fCompte.village} onChange={e=>setFCompte(p=>({...p,village:e.target.value}))}/></div>
                <div className="fg"><label>R√©gion</label>
                  <select value={fCompte.region} onChange={e=>setFCompte(p=>({...p,region:e.target.value}))}>
                    {REGIONS.map(r=><option key={r}>{r}</option>)}
                  </select>
                </div>
              </div>
              <div className="fg"><label>Secteur</label>
                <select value={fCompte.secteur} onChange={e=>setFCompte(p=>({...p,secteur:e.target.value}))}>
                  {SECTEURS.map(s=><option key={s.id} value={s.id}>{s.ic} {s.label}</option>)}
                </select>
              </div>
              <div className="fr">
                <div className="fg"><label>Superficie exploit√©e</label>
                  <select value={fCompte.superficie} onChange={e=>setFCompte(p=>({...p,superficie:e.target.value}))}>
                    <option value="">Non renseign√©</option>
                    {superficieOptions.map(o=><option key={o}>{o}</option>)}
                  </select>
                </div>
                <div className="fg"><label>Exp√©rience agricole</label>
                  <select value={fCompte.experience} onChange={e=>setFCompte(p=>({...p,experience:e.target.value}))}>
                    <option value="">Non renseign√©</option>
                    {EXPERIENCE_OPTIONS.map(o=><option key={o}>{o}</option>)}
                  </select>
                </div>
              </div>
              <div className="fg">
                <label>T√©l√©phone</label>
                <input value={fCompte.telephone} disabled style={{opacity:.6}}/>
                <div style={{fontSize:'.72rem',color:'var(--ink3)',marginTop:'.2rem'}}>Le num√©ro de t√©l√©phone ne peut pas √™tre modifi√©</div>
              </div>
              <button className="btn btn-lime" onClick={saveCompte} style={{marginTop:'.5rem'}}>
                {saved?'‚úÖ Sauvegard√© !':'Sauvegarder les modifications'}
              </button>
            </div>

            <div className="card mt2">
              <div className="card-title">üóë Zone de danger</div>
              <div style={{padding:'.75rem',background:'rgba(196,74,42,.06)',borderRadius:'8px',fontSize:'.83rem',color:'var(--ink3)',lineHeight:1.6,marginBottom:'.75rem'}}>
                La suppression de votre compte est irr√©versible. Toutes vos donn√©es seront effac√©es.
              </div>
              <button className="btn btn-ghost btn-sm" style={{color:'var(--rust2)',borderColor:'var(--rust2)'}}
                onClick={()=>toast('Pour supprimer votre compte, contactez support@agritontineplus.com','i')}>
                üóë Demander la suppression du compte
              </button>
            </div>
          </div>
        )}

        {section==='notifications' && (
          <div style={{maxWidth:'480px'}}>
            <div className="card">
              <div className="card-title">üîî Pr√©f√©rences de notifications</div>
              {[
                ['cotisations','üí∏ Cotisations tontine','Alertes paiements et rappels'],
                ['credits','üå± Cr√©dits','Statut et √©ch√©ances de vos cr√©dits'],
                ['marche','üõí March√© Cadran','Nouvelles annonces dans votre r√©gion'],
                ['messages','üí¨ Messagerie','Nouveaux messages re√ßus'],
                ['alertes','‚ö† Alertes ravageurs','Menaces en cours dans votre r√©gion'],
                ['newsletter','üì∞ Newsletter mensuelle','Actualit√©s AgriTontine+ et conseils'],
              ].map(([key,titre,desc])=>(
                <div key={key} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'.75rem 0',borderBottom:'1px solid var(--border)'}}>
                  <div>
                    <div style={{fontWeight:600,fontSize:'.88rem',color:'var(--ink)'}}>{titre}</div>
                    <div style={{fontSize:'.75rem',color:'var(--ink3)',marginTop:'.1rem'}}>{desc}</div>
                  </div>
                  <div onClick={()=>setFNotif(p=>({...p,[key]:!p[key]}))}
                    style={{width:'44px',height:'24px',borderRadius:'99px',cursor:'pointer',flexShrink:0,
                      background:fNotif[key]?'var(--lime)':'var(--border)',transition:'.2s',position:'relative'}}>
                    <div style={{position:'absolute',top:'3px',left:fNotif[key]?'23px':'3px',width:'18px',height:'18px',
                      borderRadius:'50%',background:'#fff',transition:'.2s',boxShadow:'0 1px 3px rgba(0,0,0,.2)'}}/>
                  </div>
                </div>
              ))}
              <button className="btn btn-lime btn-sm" style={{marginTop:'1rem'}} onClick={saveNotif}>Sauvegarder</button>
            </div>
          </div>
        )}

        {section==='securite' && (
          <div style={{maxWidth:'480px'}}>
            <div className="card mb2">
              <div className="card-title">üîí S√©curit√© du compte</div>
              <div style={{padding:'.75rem',background:'rgba(90,158,32,.06)',borderRadius:'8px',fontSize:'.83rem',marginBottom:'1rem'}}>
                <div style={{fontWeight:600,color:'var(--lime)',marginBottom:'.3rem'}}>‚úÖ Compte s√©curis√©</div>
                <div style={{color:'var(--ink3)'}}>Votre compte est li√© √† votre num√©ro <strong>{user.telephone}</strong>. Chaque connexion est v√©rifi√©e par SMS.</div>
              </div>
              <div style={{display:'flex',flexDirection:'column',gap:'.6rem',fontSize:'.83rem'}}>
                {[
                  ['üì± Authentification SMS','Activ√©e','var(--lime)'],
                  ['üîë Connexion par OTP','Configur√©e','var(--lime)'],
                  ['üåç Derni√®re connexion','Aujourd\'hui','var(--ink3)'],
                  ['üìç Localisation','S√©n√©gal','var(--ink3)'],
                ].map(([lbl,val,col])=>(
                  <div key={lbl} style={{display:'flex',justifyContent:'space-between',padding:'.5rem 0',borderBottom:'1px solid var(--border)'}}>
                    <span style={{color:'var(--ink)'}}>{lbl}</span>
                    <span style={{fontWeight:600,color:col}}>{val}</span>
                  </div>
                ))}
              </div>
            </div>
            <div className="card">
              <div className="card-title">üìã Journal de connexions</div>
              {[
                ['Aujourd\'hui','14:23','Dakar, S√©n√©gal','Chrome / Windows'],
                ['Hier','09:11','Thi√®s, S√©n√©gal','Safari / iPhone'],
                ['Il y a 3 jours','17:45','Dakar, S√©n√©gal','Chrome / Windows'],
              ].map(([date,heure,lieu,appareil])=>(
                <div key={date+heure} style={{padding:'.5rem 0',borderBottom:'1px solid var(--border)',fontSize:'.8rem'}}>
                  <div style={{display:'flex',justifyContent:'space-between',marginBottom:'.1rem'}}>
                    <span style={{fontWeight:600,color:'var(--ink)'}}>{date} √† {heure}</span>
                    <span style={{color:'var(--lime)',fontSize:'.72rem'}}>‚úÖ Succ√®s</span>
                  </div>
                  <div style={{color:'var(--ink3)'}}>üìç {lieu} ¬∑ {appareil}</div>
                </div>
              ))}
            </div>
          </div>
        )}

        {section==='appli' && (
          <div style={{maxWidth:'480px'}}>
            <div className="card mb2">
              <div className="card-title">üì± √Ä propos de l'application</div>
              {[
                ['Application','AgriTontine+'],
                ['Version','v4.0 ‚Äî Production'],
                ['Base de donn√©es','Supabase PostgreSQL'],
                ['H√©bergement','Vercel Edge Network'],
                ['Derni√®re MAJ','F√©vrier 2026'],
                ['D√©velopp√© pour','S√©n√©gal ¬∑ 14 r√©gions'],
              ].map(([lbl,val])=>(
                <div key={lbl} style={{display:'flex',justifyContent:'space-between',padding:'.5rem 0',borderBottom:'1px solid var(--border)',fontSize:'.85rem'}}>
                  <span style={{color:'var(--ink3)'}}>{lbl}</span>
                  <span style={{fontWeight:600,color:'var(--ink)'}}>{val}</span>
                </div>
              ))}
            </div>
            <div className="card">
              <div className="card-title">üÜò Support & Aide</div>
              <div style={{display:'flex',flexDirection:'column',gap:'.6rem'}}>
                {[
                  ['üìß Email support','support@agritontineplus.com'],
                  ['üìû T√©l√©phone','+(221) 33 XXX XX XX'],
                  ['üí¨ WhatsApp','+(221) 77 XXX XX XX'],
                  ['üåê Site web','agritontineplus.com'],
                ].map(([ic,val])=>(
                  <div key={ic} style={{display:'flex',justifyContent:'space-between',padding:'.5rem 0',borderBottom:'1px solid var(--border)',fontSize:'.83rem'}}>
                    <span style={{color:'var(--ink)'}}>{ic}</span>
                    <span style={{color:'var(--lime)',fontWeight:600}}>{val}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

      </div>
    </div>
  );
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RAPPORT MENSUEL ‚Äî PDF exportable
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function RapportMensuel({user, tontines, projets, toast}) {
  const score = calcScore(user);
  const mesTontines = tontines.filter(t=>t.membres.some(m=>m.uid===user.id));
  const now = new Date();
  const moisCourant = now.toLocaleString('fr-FR',{month:'long',year:'numeric'});
  const [periode, setPeriode] = React.useState('mois');

  // Calculs stats
  const cotisPayees = (user.cotisations||[]).filter(c=>c.statut==='payee');
  const cotisRetard = (user.cotisations||[]).filter(c=>c.statut==='retard');
  const totalCotis = cotisPayees.reduce((s,c)=>s+(c.montant||0),0);
  const creditsActifs = (user.credits||[]).filter(c=>c.statut==='approuve');
  const creditsRembourses = (user.credits||[]).filter(c=>c.statut==='rembourse');
  const totalEmprunte = (user.credits||[]).reduce((s,c)=>s+(c.montant||0),0);
  const totalInvesti = (user.investissements||[]).reduce((s,i)=>s+(i.montant||0),0);
  const retourAttendu = (user.investissements||[]).reduce((s,i)=>s+(i.retourAttendu||0),0);
  const tauxPonctualite = (user.cotisations||[]).length>0 ? Math.round(cotisPayees.length/(user.cotisations||[]).length*100) : 100;

  const imprimer = () => {
    window.print();
    toast('Impression/export PDF lanc√© !');
  };

  const prix = (n) => (n||0).toLocaleString('fr-FR')+' FCFA';

  const StatCard = ({ic,val,lbl,col}) => (
    <div style={{padding:'.75rem',background:col?`rgba(${col},.08)`:'var(--card2,#f5f5f5)',borderRadius:'10px',textAlign:'center',border:col?`1px solid rgba(${col},.2)`:'none'}}>
      <div style={{fontSize:'1.3rem'}}>{ic}</div>
      <div style={{fontWeight:800,fontSize:'1.1rem',color:col?`rgba(${col},1)`:'var(--ink)',margin:'.2rem 0'}}>{val}</div>
      <div style={{fontSize:'.7rem',color:'var(--ink3)'}}>{lbl}</div>
    </div>
  );

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Rapport</div>
        <div className="ph-title">üìÑ Rapport Mensuel</div>
        <div className="ph-sub">Synth√®se de votre activit√© ¬∑ {moisCourant}</div>
      </div>
      <div className="content">
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.25rem',flexWrap:'wrap',gap:'.5rem'}}>
          <div style={{display:'flex',gap:'.4rem'}}>
            {[['mois','Ce mois'],['trimestre','Trimestre'],['annee','Ann√©e']].map(([val,lbl])=>(
              <div key={val} onClick={()=>setPeriode(val)} style={{padding:'.35rem .75rem',borderRadius:'99px',cursor:'pointer',fontSize:'.8rem',fontWeight:periode===val?700:400,
                background:periode===val?'var(--lime)':'var(--card)',color:periode===val?'#fff':'var(--ink3)',border:'1px solid '+(periode===val?'var(--lime)':'var(--border)')}}>
                {lbl}
              </div>
            ))}
          </div>
          <button className="btn btn-lime btn-sm" onClick={imprimer}>üñ® Exporter PDF</button>
        </div>

        {/* En-t√™te rapport */}
        <div className="card mb2" style={{background:'linear-gradient(135deg,rgba(90,158,32,.1),rgba(26,122,110,.06))',border:'1px solid rgba(90,158,32,.2)'}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',flexWrap:'wrap',gap:'1rem'}}>
            <div>
              <div style={{fontWeight:800,fontSize:'1.3rem',color:'var(--ink)'}}>{user.nom}</div>
              <div style={{fontSize:'.83rem',color:'var(--ink3)',marginTop:'.2rem'}}>üìç {user.village}, {user.region} ¬∑ {SECTEURS.find(s=>s.id===user.secteur)?.ic} {SECTEURS.find(s=>s.id===user.secteur)?.label}</div>
              <div style={{fontSize:'.78rem',color:'var(--ink4)',marginTop:'.1rem'}}>Membre depuis {user.dateInscription}</div>
            </div>
            <div style={{textAlign:'center'}}>
              <ScoreRing score={score} sz={80} fsz="1.2rem"/>
              <div style={{fontSize:'.72rem',color:'var(--ink3)',marginTop:'.3rem'}}>Score IA</div>
            </div>
          </div>
        </div>

        {/* KPIs */}
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(130px,1fr))',gap:'.75rem',marginBottom:'1.5rem'}}>
          <StatCard ic="ü§ù" val={mesTontines.length} lbl="Tontines actives" col="90,158,32"/>
          <StatCard ic="üí∏" val={prix(totalCotis)} lbl="Cotisations pay√©es" col="90,158,32"/>
          <StatCard ic="üìä" val={tauxPonctualite+'%'} lbl="Taux ponctualit√©" col={tauxPonctualite>=90?'90,158,32':tauxPonctualite>=70?'196,154,40':'196,74,42'}/>
          <StatCard ic="üå±" val={prix(totalEmprunte)} lbl="Total emprunt√©"/>
          <StatCard ic="üíº" val={prix(totalInvesti)} lbl="Total investi" col="196,154,40"/>
          <StatCard ic="üìà" val={prix(retourAttendu)} lbl="Retours attendus" col="90,158,32"/>
        </div>

        <div className="g2">
          {/* Tontines d√©tail */}
          <div>
            <div className="card mb2">
              <div className="card-title">ü§ù Mes Tontines</div>
              {mesTontines.length===0 ? <div style={{color:'var(--ink3)',fontSize:'.83rem'}}>Aucune tontine</div>
              : mesTontines.map(t=>{
                const monTour = t.membres.find(m=>m.uid===user.id);
                const cotisT = (user.cotisations||[]).filter(c=>c.tontineId===t.id);
                const payeesT = cotisT.filter(c=>c.statut==='payee');
                return (
                  <div key={t.id} style={{padding:'.65rem 0',borderBottom:'1px solid var(--border)'}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'.2rem'}}>
                      <span style={{fontWeight:600,fontSize:'.88rem'}}>{t.nom}</span>
                      <span className={`chip ${t.statut==='actif'?'ch-lime':'ch-gray'}`} style={{fontSize:'.68rem'}}>{t.statut}</span>
                    </div>
                    <div style={{fontSize:'.75rem',color:'var(--ink3)',display:'flex',gap:'1rem',flexWrap:'wrap'}}>
                      <span>Tour #{monTour?.tour||'?'}</span>
                      <span>{payeesT.length}/{cotisT.length} cotisations</span>
                      <span>üí∞ {prix(payeesT.reduce((s,c)=>s+c.montant,0))}</span>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Cr√©dits */}
            <div className="card">
              <div className="card-title">üå± Historique Cr√©dits</div>
              {(user.credits||[]).length===0 ? <div style={{color:'var(--ink3)',fontSize:'.83rem'}}>Aucun cr√©dit</div>
              : (user.credits||[]).map(c=>(
                <div key={c.id} style={{padding:'.55rem 0',borderBottom:'1px solid var(--border)'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <span style={{fontWeight:600,fontSize:'.85rem'}}>{prix(c.montant)}</span>
                    <span style={{fontSize:'.72rem',fontWeight:700,padding:'.15rem .5rem',borderRadius:'99px',
                      background:c.statut==='rembourse'?'rgba(90,158,32,.12)':'rgba(196,154,40,.12)',
                      color:c.statut==='rembourse'?'var(--lime)':'var(--gold2)'}}>
                      {c.statut==='rembourse'?'‚úÖ Rembours√©':'üîÑ En cours'}
                    </span>
                  </div>
                  <div style={{fontSize:'.74rem',color:'var(--ink3)',marginTop:'.15rem'}}>{c.intrant} ¬∑ √âch√©ance: {c.dateEcheance||'‚Äî'}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Investissements + Conseils */}
          <div>
            <div className="card mb2">
              <div className="card-title">üíº Investissements</div>
              {(user.investissements||[]).length===0 ? <div style={{color:'var(--ink3)',fontSize:'.83rem'}}>Aucun investissement</div>
              : (user.investissements||[]).map((inv,i)=>{
                const proj = projets.find(p=>p.id===inv.projetId);
                return (
                  <div key={i} style={{padding:'.55rem 0',borderBottom:'1px solid var(--border)'}}>
                    <div style={{fontWeight:600,fontSize:'.85rem',marginBottom:'.2rem'}}>{proj?.nom||'Projet #'+i}</div>
                    <div style={{fontSize:'.75rem',color:'var(--ink3)',display:'flex',gap:'1rem',flexWrap:'wrap'}}>
                      <span>Investi: <strong style={{color:'var(--gold2)'}}>{prix(inv.montant)}</strong></span>
                      <span>Retour: <strong style={{color:'var(--lime)'}}>+{prix(inv.retourAttendu)}</strong></span>
                    </div>
                  </div>
                );
              })}
            </div>

            <div className="card mb2" style={{background:'rgba(90,158,32,.06)',border:'1px solid rgba(90,158,32,.2)'}}>
              <div className="card-title">üí° Recommandations IA</div>
              <div style={{display:'flex',flexDirection:'column',gap:'.6rem',fontSize:'.82rem'}}>
                {tauxPonctualite<100&&<div style={{padding:'.5rem',background:'rgba(196,74,42,.06)',borderRadius:'6px',color:'var(--rust2)'}}>‚ö† {cotisRetard.length} retard(s) ‚Äî Payez √† temps pour pr√©server votre score</div>}
                {score>=40&&creditsActifs.length===0&&<div style={{padding:'.5rem',background:'rgba(26,122,110,.06)',borderRadius:'6px',color:'var(--teal2)'}}>üå± Vous √™tes √©ligible √† un cr√©dit jusqu‚Äô√† {prix(score*1000)}</div>}
                {mesTontines.length<3&&<div style={{padding:'.5rem',background:'rgba(196,154,40,.06)',borderRadius:'6px',color:'var(--gold2)'}}>ü§ù Rejoignez 1 tontine de plus pour booster votre score (+2.4 pts)</div>}
                {(user.investissements||[]).length===0&&<div style={{padding:'.5rem',background:'rgba(90,158,32,.06)',borderRadius:'6px',color:'var(--lime)'}}>üíº Investissez dans un projet agricole pour diversifier vos revenus</div>}
                {score>=80&&<div style={{padding:'.5rem',background:'rgba(90,158,32,.06)',borderRadius:'6px',color:'var(--lime)'}}>üåü Score excellent ! Vous √™tes √©ligible au taux pr√©f√©rentiel de 3%/an</div>}
              </div>
            </div>

            <div className="card" style={{background:'rgba(26,122,110,.06)',border:'1px solid rgba(26,122,110,.2)'}}>
              <div className="card-title" style={{color:'var(--teal2)'}}>üéØ Objectifs pour le prochain mois</div>
              <div style={{fontSize:'.82rem',color:'var(--ink)',lineHeight:1.7}}>
                {[
                  cotisRetard.length>0 && '‚úì R√©gulariser '+cotisRetard.length+' cotisation(s) en retard',
                  score<65 && '‚úì Atteindre 65 pts de score (actuellement '+score+')',
                  creditsActifs.length>0 && '‚úì Suivre le remboursement de votre cr√©dit en cours',
                  '‚úì Consulter le march√© cadran pour optimiser vos ventes',
                  '‚úì V√©rifier le calendrier cultural pour la prochaine saison',
                ].filter(Boolean).map((o,i)=><div key={i}>{o}</div>)}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RECHERCHE GLOBALE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function RechercheGlobale({user, tontines, projets, setPage, toast}) {
  const [q, setQ] = React.useState('');
  const [resultats, setResultats] = React.useState(null);
  const [loading, setLoading] = React.useState(false);

  const rechercher = async (query) => {
    if (!query || query.length < 2) { setResultats(null); return; }
    setLoading(true);
    // Recherche locale
    const rTontines = tontines.filter(t=>
      t.nom.toLowerCase().includes(query.toLowerCase()) ||
      t.region.toLowerCase().includes(query.toLowerCase()) ||
      t.secteur.toLowerCase().includes(query.toLowerCase())
    );
    const rProjets = projets.filter(p=>
      p.nom.toLowerCase().includes(query.toLowerCase()) ||
      (p.promoteur||'').toLowerCase().includes(query.toLowerCase()) ||
      p.region.toLowerCase().includes(query.toLowerCase())
    );
    // Recherche en DB
    const [usersRes, annoncesRes] = await Promise.all([
      sb.from('users').select('id,nom,village,region,secteur').ilike('nom','%'+query+'%').limit(5),
      sb.from('annonces').select('id,produit,region,prix_unitaire,unite,type').ilike('produit','%'+query+'%').eq('statut','active').limit(5),
    ]);
    setResultats({
      tontines: rTontines.slice(0,5),
      projets: rProjets.slice(0,5),
      users: usersRes.data||[],
      annonces: annoncesRes.data||[],
      total: rTontines.length + rProjets.length + (usersRes.data||[]).length + (annoncesRes.data||[]).length,
    });
    setLoading(false);
  };

  React.useEffect(()=>{
    const t = setTimeout(()=>rechercher(q),350);
    return ()=>clearTimeout(t);
  },[q,tontines,projets]);

  const ResultSection = ({titre,items,renderItem}) => items.length===0?null:(
    <div style={{marginBottom:'1.25rem'}}>
      <div style={{fontWeight:700,fontSize:'.8rem',color:'var(--ink3)',textTransform:'uppercase',letterSpacing:'.06em',marginBottom:'.5rem'}}>{titre}</div>
      <div style={{display:'flex',flexDirection:'column',gap:'.4rem'}}>{items.map(renderItem)}</div>
    </div>
  );

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Recherche</div>
        <div className="ph-title">üîç Recherche Globale</div>
        <div className="ph-sub">Tontines ¬∑ Projets ¬∑ Membres ¬∑ Annonces</div>
      </div>
      <div className="content">
        <div style={{position:'relative',marginBottom:'1.5rem'}}>
          <input
            autoFocus
            value={q} onChange={e=>setQ(e.target.value)}
            placeholder="Recherchez une tontine, un projet, un membre, un produit..."
            style={{width:'100%',padding:'.85rem 1rem .85rem 3rem',borderRadius:'12px',border:'2px solid var(--lime)',
              background:'var(--card)',color:'var(--ink)',fontSize:'1rem',boxSizing:'border-box'}}/>
          <span style={{position:'absolute',left:'1rem',top:'50%',transform:'translateY(-50%)',fontSize:'1.2rem'}}>üîç</span>
          {q&&<span onClick={()=>setQ('')} style={{position:'absolute',right:'1rem',top:'50%',transform:'translateY(-50%)',cursor:'pointer',color:'var(--ink3)',fontSize:'1.1rem'}}>‚úï</span>}
        </div>

        {!q && (
          <div style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
            <div style={{fontSize:'3rem',marginBottom:'.75rem'}}>üîç</div>
            <div style={{fontWeight:600,marginBottom:'.4rem'}}>Recherchez dans toute la plateforme</div>
            <div style={{fontSize:'.82rem'}}>Tontines, projets d'investissement, membres, annonces du march√©</div>
            <div style={{display:'flex',gap:'.5rem',justifyContent:'center',flexWrap:'wrap',marginTop:'1rem'}}>
              {['Arachide','Tontine Dakar','Projet Thi√®s','Bovins','Ma√Øs'].map(s=>(
                <div key={s} onClick={()=>setQ(s)} className="chip ch-gray" style={{cursor:'pointer',fontSize:'.8rem'}}>üîç {s}</div>
              ))}
            </div>
          </div>
        )}

        {loading && <div style={{textAlign:'center',padding:'1rem',color:'var(--ink3)'}}>‚è≥ Recherche...</div>}

        {resultats && !loading && (<>
          <div style={{marginBottom:'1rem',fontSize:'.83rem',color:'var(--ink3)'}}>
            {resultats.total} r√©sultat(s) pour <strong style={{color:'var(--ink)'}}>&quot;{q}&quot;</strong>
          </div>

          {resultats.total===0 && (
            <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üòï</div>
              <div>Aucun r√©sultat pour &quot;{q}&quot;</div>
              <div style={{fontSize:'.8rem',marginTop:'.4rem'}}>Essayez un autre terme ou v√©rifiez l‚Äôorthographe</div>
            </div>
          )}

          <ResultSection titre={`ü§ù Tontines (${resultats.tontines.length})`} items={resultats.tontines} renderItem={t=>(
            <div key={t.id} className="card" style={{padding:'.75rem',cursor:'pointer'}} onClick={()=>setPage('tontines')}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div>
                  <div style={{fontWeight:600,fontSize:'.9rem'}}>{t.nom}</div>
                  <div style={{fontSize:'.75rem',color:'var(--ink3)'}}>üìç {t.region} ¬∑ {t.membres.length}/{t.nbMax} membres ¬∑ {(t.montantCotis||0).toLocaleString('fr-FR')} FCFA</div>
                </div>
                <span className={`chip ${SECTEURS.find(s=>s.id===t.secteur)?.cls||'ch-gray'}`} style={{fontSize:'.68rem'}}>{t.secteur}</span>
              </div>
            </div>
          )}/>

          <ResultSection titre={`üíº Projets (${resultats.projets.length})`} items={resultats.projets} renderItem={p=>(
            <div key={p.id} className="card" style={{padding:'.75rem',cursor:'pointer'}} onClick={()=>setPage('investissement')}>
              <div style={{fontWeight:600,fontSize:'.9rem',marginBottom:'.2rem'}}>{p.nom}</div>
              <div style={{fontSize:'.75rem',color:'var(--ink3)',display:'flex',gap:'1rem',flexWrap:'wrap'}}>
                <span>üìç {p.region}</span>
                <span>üéØ {(p.objectif||0).toLocaleString('fr-FR')} FCFA</span>
                <span style={{color:'var(--lime)'}}>{p.rendementAnnuel}%/an</span>
              </div>
            </div>
          )}/>

          <ResultSection titre={`üë§ Membres (${resultats.users.length})`} items={resultats.users} renderItem={u=>(
            <div key={u.id} className="card" style={{padding:'.75rem',cursor:'pointer'}} onClick={()=>setPage('messagerie')}>
              <div style={{display:'flex',alignItems:'center',gap:'.75rem'}}>
                <div style={{width:'36px',height:'36px',borderRadius:'50%',background:'linear-gradient(135deg,var(--s3),var(--s4))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.1rem'}}>
                  {u.secteur==='elevage'?'üêÑ':u.secteur==='mixte'?'üåæ':'üå±'}
                </div>
                <div>
                  <div style={{fontWeight:600,fontSize:'.9rem'}}>{u.nom}</div>
                  <div style={{fontSize:'.75rem',color:'var(--ink3)'}}>üìç {u.village||''} {u.region}</div>
                </div>
                <span style={{marginLeft:'auto',fontSize:'.72rem',color:'var(--teal2)'}}>üí¨ Contacter</span>
              </div>
            </div>
          )}/>

          <ResultSection titre={`üõí Annonces march√© (${resultats.annonces.length})`} items={resultats.annonces} renderItem={a=>(
            <div key={a.id} className="card" style={{padding:'.75rem',cursor:'pointer'}} onClick={()=>setPage('marche')}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div>
                  <div style={{fontWeight:600,fontSize:'.9rem'}}>{a.produit}</div>
                  <div style={{fontSize:'.75rem',color:'var(--ink3)'}}>üìç {a.region} ¬∑ {(a.prix_unitaire||0).toLocaleString('fr-FR')} FCFA/{a.unite}</div>
                </div>
                <span style={{fontSize:'.72rem',fontWeight:700,padding:'.2rem .5rem',borderRadius:'99px',
                  background:a.type==='vente'?'rgba(90,158,32,.12)':'rgba(21,101,192,.12)',
                  color:a.type==='vente'?'var(--lime)':'#42a5f5'}}>
                  {a.type==='vente'?'VENTE':'ACHAT'}
                </span>
              </div>
            </div>
          )}/>
        </>)}
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARRAINAGE & POINTS DE FID√âLIT√â
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Parrainage({user, toast}) {
  const score = calcScore(user);
  const codeParrainage = 'AGT-' + (user.nom||'').toUpperCase().slice(0,3) + '-' + (user.id||'').slice(0,4).toUpperCase();
  const [filleuls, setFilleuls] = React.useState([]);
  const [loading, setLoading] = React.useState(true);
  const [points, setPoints] = React.useState(0);

  React.useEffect(()=>{ loadFilleuls(); },[]);

  const loadFilleuls = async () => {
    setLoading(true);
    const {data} = await sb.from('users').select('id,nom,region,secteur,created_at').eq('parrain_id',user.id);
    const filleulsList = data||[];
    setFilleuls(filleulsList);
    setPoints(filleulsList.length * 50 + score * 2);
    setLoading(false);
  };

  const copierCode = () => {
    navigator.clipboard.writeText(codeParrainage).then(()=>toast('‚úÖ Code copi√© !'));
  };

  const partagerWhatsApp = () => {
    const msg = encodeURIComponent('Rejoins AgriTontine+ avec mon code ' + codeParrainage + ' ! La plateforme des tontines agricoles au S√©n√©gal. https://agritontineplus.vercel.app');
    window.open('https://wa.me/?text='+msg,'_blank');
  };

  const NIVEAUX = [
    {min:0,   max:99,  label:'Semence',    ic:'üå±', couleur:'var(--ink3)',   avantage:'Acc√®s plateforme'},
    {min:100, max:299, label:'Pousse',     ic:'üåø', couleur:'var(--teal2)', avantage:'-1% sur taux cr√©dit'},
    {min:300, max:599, label:'R√©colte',    ic:'üåæ', couleur:'var(--gold2)', avantage:'-2% + priorit√© cr√©dit'},
    {min:600, max:999, label:'Grenier',    ic:'üè∫', couleur:'var(--lime)',   avantage:'-3% + plafond +20%'},
    {min:1000,max:9999,label:'Champion',   ic:'üèÜ', couleur:'var(--amber2,#f59f00)', avantage:'Taux 1% + ambassadeur'},
  ];
  const niveauActuel = NIVEAUX.filter(n=>points>=n.min).pop()||NIVEAUX[0];
  const niveauSuivant = NIVEAUX.find(n=>n.min>points);
  const pctProgression = niveauSuivant ? Math.round((points-niveauActuel.min)/(niveauSuivant.min-niveauActuel.min)*100) : 100;

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Parrainage</div>
        <div className="ph-title">üéÅ Parrainage & Fid√©lit√©</div>
        <div className="ph-sub">Invitez des agriculteurs ¬∑ Gagnez des points ¬∑ Obtenez des avantages</div>
      </div>
      <div className="content">
        <div className="g2">
          {/* Code + partage */}
          <div>
            <div className="card mb2" style={{background:'linear-gradient(135deg,rgba(90,158,32,.1),rgba(26,122,110,.06))',border:'1px solid rgba(90,158,32,.25)'}}>
              <div className="card-title">üé´ Votre code de parrainage</div>
              <div style={{display:'flex',alignItems:'center',gap:'.75rem',padding:'.75rem',background:'var(--card)',borderRadius:'10px',marginBottom:'1rem'}}>
                <div style={{fontFamily:'var(--f-m,monospace)',fontSize:'1.4rem',fontWeight:900,color:'var(--lime)',letterSpacing:'.1em',flex:1}}>{codeParrainage}</div>
                <button className="btn btn-ghost btn-sm" onClick={copierCode}>üìã Copier</button>
              </div>
              <div style={{display:'flex',gap:'.5rem',flexWrap:'wrap'}}>
                <button className="btn btn-lime" style={{flex:1,justifyContent:'center'}} onClick={partagerWhatsApp}>
                  üíö Partager WhatsApp
                </button>
                <button className="btn btn-ghost" style={{flex:1,justifyContent:'center'}}
                  onClick={()=>{ navigator.share?.({title:'AgriTontine+',text:'Rejoins AgriTontine+ !',url:'https://agritontineplus.vercel.app'})||toast('Partagez ce lien : agritontineplus.vercel.app'); }}>
                  üì§ Partager
                </button>
              </div>
              <div style={{marginTop:'.75rem',padding:'.5rem',background:'rgba(196,154,40,.08)',borderRadius:'6px',fontSize:'.78rem',color:'var(--gold2)'}}>
                üí∞ Gagnez <strong>50 points</strong> par ami parrain√© ¬∑ Les points am√©liorent votre acc√®s aux cr√©dits
              </div>
            </div>

            {/* Filleuls */}
            <div className="card">
              <div className="card-title">üë• Mes filleuls ({filleuls.length})</div>
              {loading ? <div style={{color:'var(--ink3)',fontSize:'.82rem'}}>‚è≥ Chargement...</div>
              : filleuls.length===0 ? (
                <div style={{textAlign:'center',padding:'1.5rem',color:'var(--ink3)'}}>
                  <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üë•</div>
                  <div style={{fontSize:'.83rem'}}>Pas encore de filleul</div>
                  <div style={{fontSize:'.75rem',marginTop:'.3rem'}}>Partagez votre code pour commencer</div>
                </div>
              ) : filleuls.map(f=>(
                <div key={f.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'.5rem 0',borderBottom:'1px solid var(--border)'}}>
                  <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                    <div style={{width:'30px',height:'30px',borderRadius:'50%',background:'linear-gradient(135deg,var(--s3),var(--s4))',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'.9rem'}}>
                      {f.secteur==='elevage'?'üêÑ':'üå±'}
                    </div>
                    <div>
                      <div style={{fontWeight:600,fontSize:'.85rem'}}>{f.nom}</div>
                      <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{f.region}</div>
                    </div>
                  </div>
                  <span style={{fontWeight:700,color:'var(--lime)',fontSize:'.82rem'}}>+50 pts</span>
                </div>
              ))}
            </div>
          </div>

          {/* Niveaux fid√©lit√© */}
          <div>
            <div className="card mb2">
              <div className="card-title">üèÜ Niveau de fid√©lit√©</div>
              <div style={{textAlign:'center',marginBottom:'1.25rem'}}>
                <div style={{fontSize:'3rem',marginBottom:'.3rem'}}>{niveauActuel.ic}</div>
                <div style={{fontWeight:800,fontSize:'1.4rem',color:niveauActuel.couleur}}>{niveauActuel.label}</div>
                <div style={{fontWeight:900,fontSize:'2rem',color:'var(--lime)',margin:'.25rem 0'}}>{points} pts</div>
                {niveauSuivant&&(
                  <>
                    <div style={{height:'8px',background:'var(--border)',borderRadius:'99px',overflow:'hidden',margin:'.5rem 0'}}>
                      <div style={{width:pctProgression+'%',height:'100%',background:'var(--lime)',borderRadius:'99px',transition:'.5s'}}/>
                    </div>
                    <div style={{fontSize:'.75rem',color:'var(--ink3)'}}>{niveauSuivant.min-points} pts pour {niveauSuivant.ic} {niveauSuivant.label}</div>
                  </>
                )}
              </div>
              <div style={{padding:'.6rem',background:'rgba(90,158,32,.08)',borderRadius:'8px',textAlign:'center',fontSize:'.83rem'}}>
                <strong style={{color:'var(--lime)'}}>Avantage actuel :</strong> {niveauActuel.avantage}
              </div>
            </div>

            {/* Tableau niveaux */}
            <div className="card">
              <div className="card-title">üìä Tous les niveaux</div>
              {NIVEAUX.map(n=>(
                <div key={n.label} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'.55rem 0',borderBottom:'1px solid var(--border)',
                  opacity:points>=n.min?1:.5,fontWeight:niveauActuel.label===n.label?700:400}}>
                  <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                    <span style={{fontSize:'1.2rem'}}>{n.ic}</span>
                    <div>
                      <div style={{fontSize:'.88rem',color:niveauActuel.label===n.label?n.couleur:'var(--ink)'}}>{n.label}</div>
                      <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{n.min}‚Äì{n.max} pts</div>
                    </div>
                  </div>
                  <div style={{textAlign:'right'}}>
                    <div style={{fontSize:'.75rem',color:n.couleur,fontWeight:600}}>{n.avantage}</div>
                    {niveauActuel.label===n.label&&<div style={{fontSize:'.68rem',color:'var(--lime)'}}>‚Üê Niveau actuel</div>}
                  </div>
                </div>
              ))}
            </div>

            {/* Comment gagner des points */}
            <div className="card mt2">
              <div className="card-title">üí° Comment gagner des points</div>
              {[
                ['ü§ù','Rejoindre une tontine','+30 pts'],
                ['üí∏','Cotisation √† temps','+5 pts'],
                ['üíº','Investir dans un projet','+20 pts'],
                ['üë•','Parrainer un ami','+50 pts'],
                ['üå±','Rembourser un cr√©dit','+40 pts'],
                ['üõí','Publier une annonce','+10 pts'],
                ['üìä','Score IA','score√ó2 pts'],
              ].map(([ic,lbl,pts])=>(
                <div key={lbl} style={{display:'flex',justifyContent:'space-between',padding:'.4rem 0',borderBottom:'1px solid var(--border)',fontSize:'.82rem'}}>
                  <span>{ic} {lbl}</span>
                  <span style={{fontWeight:700,color:'var(--lime)'}}>{pts}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   R√âSEAU FRANCHISE SOCIALE ‚Äî AgriTontine+ / Farm Shop Model
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Donn√©es statiques Franchise ‚îÄ‚îÄ */
const MODULES_FORMATION = [
  {
    id:'f1', titre:'Fondamentaux de la tontine', duree:'2h', niveau:'d√©butant',
    ic:'ü§ù', description:'Fonctionnement des tontines, r√¥les, responsabilit√©s, r√®gles de base.',
    chapitres:['Histoire des tontines au S√©n√©gal','R√¥les : pr√©sident, tr√©sorier, membres','R√®gles de cotisation','Gestion des conflits'],
    badge:'Animateur Certifi√© Niveau 1', points:100,
  },
  {
    id:'f2', titre:'Gestion financi√®re agricole', duree:'3h', niveau:'d√©butant',
    ic:'üí∞', description:'Comptabilit√© simplifi√©e, gestion de tr√©sorerie, suivi des cr√©dits.',
    chapitres:['Tenue de livre de caisse','Calcul des int√©r√™ts','Suivi remboursements','Rapport mensuel'],
    badge:'Gestionnaire Financier Certifi√©', points:150,
  },
  {
    id:'f3', titre:'March√© et prix agricoles', duree:'2h30', niveau:'interm√©diaire',
    ic:'üõí', description:'N√©gociation, fixation des prix, acc√®s aux march√©s, cha√Æne de valeur.',
    chapitres:['Lecture des prix du march√©','Techniques de n√©gociation','Vente group√©e','Stockage et conservation'],
    badge:'Expert March√© Cadran', points:120,
  },
  {
    id:'f4', titre:'Cr√©dit intrant et scoring IA', duree:'1h30', niveau:'interm√©diaire',
    ic:'üå±', description:'Comprendre le scoring, g√©rer un cr√©dit intrant, optimiser son profil.',
    chapitres:['Algorithme de scoring expliqu√©','Crit√®res d\'√©ligibilit√©','Gestion du remboursement','Am√©liorer son score'],
    badge:'Conseiller Cr√©dit Certifi√©', points:120,
  },
  {
    id:'f5', titre:'Agriculture num√©rique et app', duree:'1h', niveau:'d√©butant',
    ic:'üì±', description:'Utilisation d\'AgriTontine+, saisie des donn√©es, March√© Cadran.',
    chapitres:['Navigation dans l\'app','Cr√©er et g√©rer une tontine','Publier sur le March√©','Lire les rapports'],
    badge:'Utilisateur Digital Certifi√©', points:80,
  },
  {
    id:'f6', titre:'Leadership et animation communautaire', duree:'3h', niveau:'avanc√©',
    ic:'üëë', description:'Recrutement de membres, r√©solution de conflits, expansion du r√©seau.',
    chapitres:['Techniques de recrutement','M√©diation et arbitrage','Motivation des membres','D√©velopper son r√©seau'],
    badge:'Animateur Senior Certifi√©', points:200,
  },
  {
    id:'f7', titre:'Agronomie pratique de base', duree:'4h', niveau:'avanc√©',
    ic:'üåæ', description:'Calendrier cultural, utilisation des intrants, lutte antiparasitaire.',
    chapitres:['Calendrier des cultures S√©n√©gal','Dosage des intrants','Reconnaissance ravageurs','Techniques de r√©colte'],
    badge:'Conseiller Agricole de Terrain', points:200,
  },
  {
    id:'f8', titre:'Franchise sociale ‚Äî Devenir animateur', duree:'5h', niveau:'avanc√©',
    ic:'üè¢', description:'Mod√®le √©conomique, responsabilit√©s l√©gales, KPIs d\'animateur, scale.',
    chapitres:['Mod√®le Farm Shop adapt√©','Contrat d\'animateur AgriTontine+','Objectifs et KPIs','Plan d\'expansion r√©gionale'],
    badge:'Franchis√© AgriTontine+ Officiel', points:300,
  },
];

const NIVEAUX_ANIMATEUR = [
  {id:'candidat',    label:'Candidat',         ic:'üå±', couleur:'var(--ink3)',   minPoints:0,   minTontines:0, minMembers:0,  avantage:'Acc√®s formation'},
  {id:'junior',      label:'Animateur Junior',  ic:'üåø', couleur:'var(--teal2)', minPoints:250, minTontines:1, minMembers:10, avantage:'Commission 2% cotisations'},
  {id:'certifie',    label:'Animateur Certifi√©',ic:'‚≠ê', couleur:'var(--gold2)', minPoints:500, minTontines:3, minMembers:30, avantage:'Commission 4% + bonus trimestriel'},
  {id:'senior',      label:'Animateur Senior',  ic:'üèÜ', couleur:'var(--lime)',   minPoints:800, minTontines:6, minMembers:60, avantage:'Commission 6% + tontines illimit√©es'},
  {id:'franchis√©',   label:'Franchis√© Officiel',ic:'üè¢', couleur:'var(--amber2,#f59f00)', minPoints:1200, minTontines:10, minMembers:100, avantage:'Commission 8% + licence r√©gionale'},
];

/* Supabase franchise functions */
async function sbFetchAnimateurs() {
  const {data} = await sb.from('animateurs')
    .select('*, user:users(id,nom,telephone,village,region,secteur)')
    .order('points',{ascending:false});
  return data || [];
}

async function sbDevenirAnimateur(userId, motivation) {
  const {data,error} = await sb.from('animateurs').insert({
    user_id: userId,
    motivation,
    niveau: 'candidat',
    points: 0,
    modules_completes: [],
    tontines_gerees: 0,
    membres_recrutes: 0,
    revenus_generes: 0,
    statut: 'actif',
  }).select().single();
  if (error) throw new Error(error.message);
  return data;
}

async function sbGetMonProfil(userId) {
  const {data} = await sb.from('animateurs').select('*').eq('user_id',userId).single();
  return data;
}

async function sbCompleterModule(animateurId, moduleId, points) {
  const {data} = await sb.from('animateurs').select('modules_completes,points').eq('id',animateurId).single();
  const modules = data?.modules_completes || [];
  if (modules.includes(moduleId)) return;
  const newPoints = (data?.points||0) + points;
  await sb.from('animateurs').update({
    modules_completes: [...modules, moduleId],
    points: newPoints,
  }).eq('id', animateurId);
}

/* ‚îÄ‚îÄ Composant principal Franchise ‚îÄ‚îÄ */
function FranchiseSociale({user, tontines, toast}) {
  const [onglet, setOnglet] = React.useState('apercu');
  const [monProfil, setMonProfil] = React.useState(null);
  const [animateurs, setAnimateurs] = React.useState([]);
  const [loading, setLoading] = React.useState(true);
  const [modaleModule, setModaleModule] = React.useState(null);
  const [modaleInscription, setModaleInscription] = React.useState(false);
  const [motivation, setMotivation] = React.useState('');
  const [quizEnCours, setQuizEnCours] = React.useState(null);
  const [quizScore, setQuizScore] = React.useState(null);
  const [filterNiveau, setFilterNiveau] = React.useState('all');

  React.useEffect(()=>{ load(); },[]);

  const load = async () => {
    setLoading(true);
    const [profil, anim] = await Promise.all([sbGetMonProfil(user.id), sbFetchAnimateurs()]);
    setMonProfil(profil);
    setAnimateurs(anim);
    setLoading(false);
  };

  const sInscrire = async () => {
    if (!motivation.trim()) { toast('Expliquez votre motivation','e'); return; }
    try {
      const p = await sbDevenirAnimateur(user.id, motivation);
      setMonProfil(p);
      setModaleInscription(false);
      toast('‚úÖ Bienvenue dans le r√©seau AgriTontine+ !');
    } catch(e) { toast('Erreur: '+e.message,'e'); }
  };

  const demarrerModule = (mod) => {
    setModaleModule(mod);
    setQuizEnCours(null);
    setQuizScore(null);
  };

  const terminerModule = async (mod) => {
    if (!monProfil) return;
    // Simuler quiz ‚Äî score al√©atoire r√©aliste
    const score = Math.floor(Math.random()*30)+70; // 70-100%
    setQuizScore(score);
    if (score >= 70) {
      await sbCompleterModule(monProfil.id, mod.id, mod.points);
      setMonProfil(p=>({...p,
        modules_completes:[...(p.modules_completes||[]),mod.id],
        points:(p.points||0)+mod.points,
      }));
      toast('üéì Module termin√© ! +'+mod.points+' points ¬∑ Badge: '+mod.badge);
    } else {
      toast('Score insuffisant ('+score+'%). R√©essayez !','e');
    }
  };

  const mesTontines = tontines.filter(t=>t.membres.some(m=>m.uid===user.id));
  const myPoints = monProfil?.points || 0;
  const modulesCompletes = monProfil?.modules_completes || [];

  const niveauActuel = [...NIVEAUX_ANIMATEUR].reverse().find(n=>myPoints>=n.minPoints) || NIVEAUX_ANIMATEUR[0];
  const niveauSuivant = NIVEAUX_ANIMATEUR.find(n=>n.minPoints>myPoints);
  const pctProg = niveauSuivant ? Math.round((myPoints-niveauActuel.minPoints)/(niveauSuivant.minPoints-niveauActuel.minPoints)*100) : 100;

  // Stats r√©seau global
  const statsReseau = {
    totalAnimateurs: animateurs.length,
    totalCertifies: animateurs.filter(a=>a.niveau!=='candidat').length,
    totalMembers: animateurs.reduce((s,a)=>s+(a.membres_recrutes||0),0),
    totalTontines: animateurs.reduce((s,a)=>s+(a.tontines_gerees||0),0),
    revenusGeneres: animateurs.reduce((s,a)=>s+(a.revenus_generes||0),0),
    parRegion: Object.entries(
      animateurs.reduce((m,a)=>{ const r=a.user?.region||'?'; m[r]=(m[r]||0)+1; return m; },{})
    ).sort((a,b)=>b[1]-a[1]).slice(0,6),
  };

  const animateursFiltres = filterNiveau==='all' ? animateurs : animateurs.filter(a=>a.niveau===filterNiveau);

  const prix = (n) => (n||0).toLocaleString('fr-FR')+' FCFA';
  const QUIZ_QUESTIONS = [
    {q:'Quel est le r√¥le principal d\'un animateur AgriTontine+ ?',opts:['G√©rer les finances de la plateforme','Recruter et accompagner les membres de tontines','Vendre des produits agricoles','D√©velopper l\'application'],rep:1},
    {q:'Combien de tontines faut-il pour devenir Animateur Certifi√© ?',opts:['1','2','3','5'],rep:2},
    {q:'Quelle commission per√ßoit un Franchis√© Officiel ?',opts:['2%','4%','6%','8%'],rep:3},
    {q:'Le mod√®le Farm Shop vient de quel pays ?',opts:['S√©n√©gal','Ghana','Kenya','Nigeria'],rep:2},
    {q:'Quel est le minimum de membres pour passer Animateur Junior ?',opts:['5','10','20','30'],rep:1},
  ];

  return (
    <div>
      <div className="ph">
        <div className="ph-tag">Franchise Sociale</div>
        <div className="ph-title">üè¢ R√©seau AgriTontine+</div>
        <div className="ph-sub">Mod√®le Farm Shop ¬∑ Devenez animateur ¬∑ Formez-vous ¬∑ Scalez votre impact</div>
      </div>

      {/* ONGLETS */}
      <div style={{padding:'0 1.25rem',display:'flex',gap:'.4rem',flexWrap:'wrap',marginBottom:'1rem',borderBottom:'1px solid var(--border)'}}>
        {[
          ['apercu','üè¢ Aper√ßu'],
          ['formation','üéì Formation'],
          ['monprofil','üë§ Mon profil'],
          ['reseau','üåç Le R√©seau'],
          ['kpis','üìä KPIs Franchise'],
        ].map(([id,lbl])=>(
          <div key={id} onClick={()=>setOnglet(id)} style={{
            padding:'.5rem .9rem',cursor:'pointer',fontWeight:onglet===id?700:400,
            color:onglet===id?'var(--lime)':'var(--ink3)',
            borderBottom:onglet===id?'2px solid var(--lime)':'2px solid transparent',
            fontSize:'.83rem',whiteSpace:'nowrap',
          }}>{lbl}</div>
        ))}
      </div>

      <div className="content">

        {/* ‚ïê‚ïê‚ïê APER√áU FRANCHISE ‚ïê‚ïê‚ïê */}
        {onglet==='apercu' && (<>
          {/* Banni√®re mod√®le */}
          <div className="card mb2" style={{background:'linear-gradient(135deg,rgba(26,122,110,.12),rgba(90,158,32,.08))',border:'1px solid rgba(26,122,110,.25)'}}>
            <div style={{display:'flex',gap:'1rem',alignItems:'flex-start',flexWrap:'wrap'}}>
              <div style={{fontSize:'3rem'}}>üè¢</div>
              <div>
                <div style={{fontWeight:800,fontSize:'1.2rem',color:'var(--ink)',marginBottom:'.4rem'}}>Mod√®le Franchise Sociale ‚Äî inspir√© de Farm Shop Kenya</div>
                <div style={{fontSize:'.85rem',color:'var(--ink3)',lineHeight:1.7,marginBottom:'.75rem'}}>
                  AgriTontine+ adopte le mod√®le de franchise sociale √©prouv√© au Kenya : un r√©seau d'animateurs certifi√©s qui recrutent, forment et accompagnent les agriculteurs dans leur r√©gion. Chaque animateur est un entrepreneur ind√©pendant avec un territoire, une commission et un plan de croissance.
                </div>
                <div style={{display:'flex',gap:'.75rem',flexWrap:'wrap'}}>
                  {!monProfil && <button className="btn btn-lime" onClick={()=>setModaleInscription(true)}>üå± Devenir animateur ‚Üí</button>}
                  {monProfil && <div style={{padding:'.4rem .9rem',borderRadius:'99px',background:'rgba(90,158,32,.12)',color:'var(--lime)',fontWeight:700,fontSize:'.83rem'}}>‚úÖ {niveauActuel.ic} {niveauActuel.label}</div>}
                  <button className="btn btn-ghost btn-sm" onClick={()=>setOnglet('formation')}>üìö Voir les formations</button>
                </div>
              </div>
            </div>
          </div>

          {/* Stats r√©seau */}
          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(140px,1fr))',gap:'.75rem',marginBottom:'1.5rem'}}>
            {[
              ['üè¢',statsReseau.totalAnimateurs,'Animateurs actifs','var(--lime)'],
              ['‚≠ê',statsReseau.totalCertifies,'Certifi√©s','var(--gold2)'],
              ['üë•',statsReseau.totalMembers,'Membres recrut√©s','var(--teal2)'],
              ['ü§ù',statsReseau.totalTontines,'Tontines g√©r√©es','var(--lime)'],
              ['üí∞',prix(statsReseau.revenusGeneres),'Revenus g√©n√©r√©s','var(--amber2,#f59f00)'],
            ].map(([ic,val,lbl,col])=>(
              <div key={lbl} className="card" style={{textAlign:'center',padding:'.75rem'}}>
                <div style={{fontSize:'1.4rem'}}>{ic}</div>
                <div style={{fontWeight:800,fontSize:'1rem',color:col,margin:'.2rem 0',lineHeight:1.2}}>{val}</div>
                <div style={{fontSize:'.7rem',color:'var(--ink3)'}}>{lbl}</div>
              </div>
            ))}
          </div>

          {/* Comment √ßa marche */}
          <div className="g2">
            <div className="card">
              <div className="card-title">üîÑ Comment fonctionne la franchise</div>
              {[
                ['1','üå± Candidature','Remplissez le formulaire et expliquez votre motivation'],
                ['2','üìö Formation','Compl√©tez les 8 modules de formation en ligne (16h)'],
                ['3','ü§ù 1√®re tontine','Cr√©ez et animez votre premi√®re tontine (min. 10 membres)'],
                ['4','‚≠ê Certification','Obtenez votre badge Animateur Certifi√© apr√®s 3 tontines'],
                ['5','üí∞ Commission','Recevez votre commission mensuelle sur chaque tontine g√©r√©e'],
                ['6','üè¢ Franchise','G√©rez votre licence r√©gionale avec 10+ tontines'],
              ].map(({0:n,1:ic,2:desc})=>(
                <div key={n} style={{display:'flex',gap:'.75rem',padding:'.6rem 0',borderBottom:'1px solid var(--border)',alignItems:'flex-start'}}>
                  <div style={{width:'28px',height:'28px',borderRadius:'50%',background:'var(--lime)',color:'#fff',fontWeight:800,fontSize:'.85rem',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0}}>{n}</div>
                  <div>
                    <div style={{fontWeight:600,fontSize:'.88rem',color:'var(--ink)'}}>{ic} {desc.split('. ')[0]}</div>
                    {desc.includes('. ') && <div style={{fontSize:'.75rem',color:'var(--ink3)',marginTop:'.1rem'}}>{desc.split('. ').slice(1).join('. ')}</div>}
                  </div>
                </div>
              ))}
            </div>

            <div>
              {/* Niveaux */}
              <div className="card mb2">
                <div className="card-title">üèÜ Les 5 niveaux d'animateur</div>
                {NIVEAUX_ANIMATEUR.map(n=>{
                  const atteint = monProfil && myPoints>=n.minPoints;
                  const estActuel = monProfil && niveauActuel.id===n.id;
                  return (
                    <div key={n.id} style={{display:'flex',justifyContent:'space-between',padding:'.55rem 0',borderBottom:'1px solid var(--border)',
                      opacity:monProfil?(atteint?1:.45):1, fontWeight:estActuel?700:400}}>
                      <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                        <span style={{fontSize:'1.2rem'}}>{n.ic}</span>
                        <div>
                          <div style={{color:estActuel?n.couleur:'var(--ink)',fontSize:'.85rem'}}>{n.label} {estActuel&&'‚Üê vous'}</div>
                          <div style={{fontSize:'.7rem',color:'var(--ink3)'}}>‚â•{n.minPoints}pts ¬∑ {n.minTontines} tontines ¬∑ {n.minMembers} membres</div>
                        </div>
                      </div>
                      <div style={{textAlign:'right',fontSize:'.75rem',color:n.couleur,fontWeight:600}}>{n.avantage}</div>
                    </div>
                  );
                })}
              </div>

              {/* Comparaison Farm Shop */}
              <div className="card" style={{background:'rgba(26,122,110,.05)',border:'1px solid rgba(26,122,110,.2)'}}>
                <div className="card-title" style={{color:'var(--teal2)'}}>üåç Benchmark Farm Shop (Kenya)</div>
                {[
                  ['Boutiques actives','74','‚Üí','50+ tontines cible S1'],
                  ['Agriculteurs servis','30 000','‚Üí','5 000 membres S1'],
                  ['Femmes','50%','‚Üí','50% objectif'],
                  ['Animateurs form√©s','74 g√©rants','‚Üí','28 animateurs (2/r√©gion)'],
                  ['Taux remboursement cr√©dit','92%','‚Üí','95% cible'],
                ].map(([lbl,ks,arr,sn])=>(
                  <div key={lbl} style={{display:'flex',gap:'.5rem',padding:'.35rem 0',borderBottom:'1px solid var(--border)',fontSize:'.78rem',alignItems:'center',flexWrap:'wrap'}}>
                    <span style={{color:'var(--ink3)',flex:'1',minWidth:'120px'}}>{lbl}</span>
                    <span style={{fontWeight:600,color:'var(--gold2)'}}>{ks}</span>
                    <span style={{color:'var(--ink4)'}}>{arr}</span>
                    <span style={{fontWeight:600,color:'var(--lime)'}}>{sn}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </>)}

        {/* ‚ïê‚ïê‚ïê FORMATION ‚ïê‚ïê‚ïê */}
        {onglet==='formation' && (<>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem',flexWrap:'wrap',gap:'.5rem'}}>
            <div style={{fontSize:'.83rem',color:'var(--ink3)'}}>
              {modulesCompletes.length}/{MODULES_FORMATION.length} modules compl√©t√©s ¬∑
              <strong style={{color:'var(--lime)'}}> {myPoints} points</strong>
            </div>
            {/* Barre globale */}
            <div style={{flex:'1',maxWidth:'300px',height:'8px',background:'var(--border)',borderRadius:'99px',overflow:'hidden'}}>
              <div style={{width:Math.round(modulesCompletes.length/MODULES_FORMATION.length*100)+'%',height:'100%',background:'var(--lime)',borderRadius:'99px',transition:'.5s'}}/>
            </div>
          </div>

          <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(300px,1fr))',gap:'1rem'}}>
            {MODULES_FORMATION.map(mod=>{
              const fait = modulesCompletes.includes(mod.id);
              const NIVEAU_COLORS = {'d√©butant':'ch-lime','interm√©diaire':'ch-gold','avanc√©':'ch-rust'};
              return (
                <div key={mod.id} className="card" style={{border:fait?'1.5px solid var(--lime)':'1px solid var(--border)',cursor:'pointer',transition:'.15s'}}
                  onClick={()=>demarrerModule(mod)}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'.6rem'}}>
                    <div style={{fontSize:'2rem'}}>{mod.ic}</div>
                    <div style={{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:'.3rem'}}>
                      <span className={`chip ${NIVEAU_COLORS[mod.niveau]||'ch-gray'}`} style={{fontSize:'.68rem'}}>{mod.niveau}</span>
                      {fait ? <span style={{fontSize:'.72rem',color:'var(--lime)',fontWeight:700}}>‚úÖ Compl√©t√©</span>
                             : <span style={{fontSize:'.72rem',color:'var(--ink3)'}}>{mod.duree}</span>}
                    </div>
                  </div>
                  <div style={{fontWeight:700,fontSize:'.95rem',color:'var(--ink)',marginBottom:'.3rem'}}>{mod.titre}</div>
                  <div style={{fontSize:'.78rem',color:'var(--ink3)',marginBottom:'.6rem',lineHeight:1.5}}>{mod.description}</div>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                    <span style={{fontSize:'.75rem',color:'var(--gold2)',fontWeight:600}}>üèÖ {mod.badge}</span>
                    <span style={{fontSize:'.75rem',fontWeight:700,color:fait?'var(--lime)':'var(--ink3)'}}>+{mod.points} pts</span>
                  </div>
                </div>
              );
            })}
          </div>
        </>)}

        {/* ‚ïê‚ïê‚ïê MON PROFIL ANIMATEUR ‚ïê‚ïê‚ïê */}
        {onglet==='monprofil' && (<>
          {!monProfil ? (
            <div className="card" style={{textAlign:'center',padding:'2rem'}}>
              <div style={{fontSize:'3rem',marginBottom:'.75rem'}}>üå±</div>
              <div style={{fontWeight:700,fontSize:'1.1rem',marginBottom:'.5rem'}}>Rejoignez le r√©seau AgriTontine+</div>
              <div style={{fontSize:'.85rem',color:'var(--ink3)',marginBottom:'1.25rem',maxWidth:'400px',margin:'0 auto .75rem'}}>
                Devenez animateur certifi√©, g√©rez des tontines dans votre r√©gion, gagnez une commission mensuelle et changez la vie des agriculteurs.
              </div>
              <button className="btn btn-lime" onClick={()=>setModaleInscription(true)}>üöÄ Candidater maintenant</button>
            </div>
          ) : (
            <div className="g2">
              <div>
                {/* Carte niveau */}
                <div className="card mb2" style={{background:'linear-gradient(135deg,rgba(90,158,32,.1),rgba(26,122,110,.07))',border:`1.5px solid ${niveauActuel.couleur}`}}>
                  <div style={{display:'flex',gap:'1rem',alignItems:'center',marginBottom:'1rem'}}>
                    <div style={{fontSize:'2.5rem'}}>{niveauActuel.ic}</div>
                    <div>
                      <div style={{fontWeight:800,fontSize:'1.1rem',color:niveauActuel.couleur}}>{niveauActuel.label}</div>
                      <div style={{fontSize:'.8rem',color:'var(--ink3)'}}>{user.nom} ¬∑ {user.region}</div>
                    </div>
                    <div style={{marginLeft:'auto',textAlign:'right'}}>
                      <div style={{fontWeight:900,fontSize:'1.6rem',color:'var(--lime)'}}>{myPoints}</div>
                      <div style={{fontSize:'.7rem',color:'var(--ink3)'}}>points</div>
                    </div>
                  </div>
                  {niveauSuivant&&(<>
                    <div style={{height:'8px',background:'rgba(255,255,255,.3)',borderRadius:'99px',overflow:'hidden',marginBottom:'.4rem'}}>
                      <div style={{width:pctProg+'%',height:'100%',background:'var(--lime)',borderRadius:'99px',transition:'.5s'}}/>
                    </div>
                    <div style={{fontSize:'.75rem',color:'var(--ink3)',display:'flex',justifyContent:'space-between'}}>
                      <span>{niveauSuivant.minPoints-myPoints} pts pour {niveauSuivant.ic} {niveauSuivant.label}</span>
                      <span>{pctProg}%</span>
                    </div>
                  </>)}
                </div>

                {/* Stats perso */}
                <div className="card mb2">
                  <div className="card-title">üìä Mes performances</div>
                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'.6rem'}}>
                    {[
                      ['üéì',modulesCompletes.length+'/'+MODULES_FORMATION.length,'Modules compl√©t√©s','var(--lime)'],
                      ['ü§ù',monProfil.tontines_gerees||0,'Tontines g√©r√©es','var(--gold2)'],
                      ['üë•',monProfil.membres_recrutes||0,'Membres recrut√©s','var(--teal2)'],
                      ['üí∞',prix(monProfil.revenus_generes||0),'Revenus commissions','var(--lime)'],
                    ].map(([ic,val,lbl,col])=>(
                      <div key={lbl} style={{padding:'.65rem',background:'var(--card2,#f5f5f5)',borderRadius:'8px',textAlign:'center'}}>
                        <div style={{fontSize:'1.2rem'}}>{ic}</div>
                        <div style={{fontWeight:800,fontSize:'1rem',color:col,margin:'.15rem 0'}}>{val}</div>
                        <div style={{fontSize:'.68rem',color:'var(--ink3)'}}>{lbl}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Avantage actuel */}
                <div className="card" style={{background:'rgba(90,158,32,.06)',border:'1px solid rgba(90,158,32,.2)'}}>
                  <div style={{fontWeight:700,color:'var(--lime)',marginBottom:'.4rem'}}>üí∞ Avantage actuel</div>
                  <div style={{fontSize:'.87rem',color:'var(--ink)',fontWeight:600}}>{niveauActuel.avantage}</div>
                  {niveauSuivant&&<div style={{fontSize:'.78rem',color:'var(--ink3)',marginTop:'.4rem'}}>Prochain niveau : {niveauSuivant.ic} {niveauSuivant.avantage}</div>}
                </div>
              </div>

              {/* Badges obtenus */}
              <div>
                <div className="card mb2">
                  <div className="card-title">üèÖ Badges obtenus ({modulesCompletes.length})</div>
                  {modulesCompletes.length===0 ? (
                    <div style={{textAlign:'center',padding:'1rem',color:'var(--ink3)',fontSize:'.82rem'}}>
                      Compl√©tez des modules pour gagner vos badges
                    </div>
                  ) : MODULES_FORMATION.filter(m=>modulesCompletes.includes(m.id)).map(m=>(
                    <div key={m.id} style={{display:'flex',gap:'.75rem',padding:'.6rem 0',borderBottom:'1px solid var(--border)',alignItems:'center'}}>
                      <div style={{fontSize:'1.5rem'}}>{m.ic}</div>
                      <div style={{flex:1}}>
                        <div style={{fontWeight:600,fontSize:'.85rem',color:'var(--ink)'}}>{m.badge}</div>
                        <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>{m.titre}</div>
                      </div>
                      <span style={{fontWeight:700,color:'var(--gold2)',fontSize:'.8rem'}}>+{m.points}pts</span>
                    </div>
                  ))}
                </div>

                {/* Prochaines √©tapes */}
                <div className="card">
                  <div className="card-title">üéØ Prochaines √©tapes</div>
                  {[
                    modulesCompletes.length < MODULES_FORMATION.length && {
                      ic:'üìö', texte:'Compl√©tez les modules restants',
                      sous:MODULES_FORMATION.length-modulesCompletes.length+' module(s) restant(s)',
                      action:()=>setOnglet('formation'),
                    },
                    niveauSuivant && {
                      ic:niveauSuivant.ic, texte:'Atteignez '+niveauSuivant.label,
                      sous:(niveauSuivant.minPoints-myPoints)+' points manquants',
                      action:()=>setOnglet('formation'),
                    },
                    (monProfil.tontines_gerees||0)<3 && {
                      ic:'ü§ù', texte:'G√©rez 3 tontines',
                      sous:(3-(monProfil.tontines_gerees||0))+' tontine(s) manquante(s)',
                      action:()=>{},
                    },
                  ].filter(Boolean).map((e,i)=>(
                    <div key={i} onClick={e.action} style={{display:'flex',gap:'.75rem',padding:'.6rem 0',borderBottom:'1px solid var(--border)',alignItems:'center',cursor:'pointer'}}>
                      <span style={{fontSize:'1.3rem'}}>{e.ic}</span>
                      <div>
                        <div style={{fontWeight:600,fontSize:'.85rem',color:'var(--lime)'}}>{e.texte}</div>
                        <div style={{fontSize:'.73rem',color:'var(--ink3)'}}>{e.sous}</div>
                      </div>
                      <span style={{marginLeft:'auto',color:'var(--ink4)'}}>‚Üí</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </>)}

        {/* ‚ïê‚ïê‚ïê R√âSEAU ANIMATEURS ‚ïê‚ïê‚ïê */}
        {onglet==='reseau' && (<>
          <div style={{display:'flex',gap:'.5rem',marginBottom:'1rem',flexWrap:'wrap'}}>
            <select value={filterNiveau} onChange={e=>setFilterNiveau(e.target.value)}
              style={{padding:'.5rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.83rem'}}>
              <option value="all">Tous niveaux</option>
              {NIVEAUX_ANIMATEUR.map(n=><option key={n.id} value={n.id}>{n.ic} {n.label}</option>)}
            </select>
            <div style={{fontSize:'.82rem',color:'var(--ink3)',display:'flex',alignItems:'center'}}>
              {animateursFiltres.length} animateur(s)
            </div>
          </div>

          {animateursFiltres.length===0 ? (
            <div className="card" style={{textAlign:'center',padding:'2rem',color:'var(--ink3)'}}>
              <div style={{fontSize:'2rem',marginBottom:'.5rem'}}>üè¢</div>
              <div>Aucun animateur encore ‚Äî soyez le premier !</div>
              <button className="btn btn-lime btn-sm" style={{marginTop:'1rem'}} onClick={()=>{ setModaleInscription(true); setOnglet('monprofil'); }}>Candidater</button>
            </div>
          ) : (
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:'1rem'}}>
              {animateursFiltres.map((a,i)=>{
                const niv = NIVEAUX_ANIMATEUR.find(n=>n.id===a.niveau)||NIVEAUX_ANIMATEUR[0];
                return (
                  <div key={a.id} className="card" style={{border:`1px solid ${i<3?niv.couleur:'var(--border)'}`}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'.6rem'}}>
                      <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                        <div style={{width:'36px',height:'36px',borderRadius:'50%',background:`linear-gradient(135deg,var(--s3),var(--s4))`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.1rem'}}>
                          {a.user?.secteur==='elevage'?'üêÑ':'üå±'}
                        </div>
                        <div>
                          <div style={{fontWeight:700,fontSize:'.9rem',color:'var(--ink)'}}>{a.user?.nom||'‚Äî'}</div>
                          <div style={{fontSize:'.72rem',color:'var(--ink3)'}}>üìç {a.user?.region}</div>
                        </div>
                      </div>
                      {i<3&&<span style={{fontSize:'.72rem',fontWeight:700,padding:'.15rem .5rem',borderRadius:'99px',background:'rgba(196,154,40,.12)',color:'var(--gold2)'}}>#{i+1}</span>}
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:'.4rem',marginBottom:'.6rem'}}>
                      <span style={{fontSize:'1rem'}}>{niv.ic}</span>
                      <span style={{fontWeight:600,fontSize:'.82rem',color:niv.couleur}}>{niv.label}</span>
                      <span style={{marginLeft:'auto',fontWeight:800,color:'var(--lime)',fontSize:'.9rem'}}>{a.points||0} pts</span>
                    </div>
                    <div style={{display:'flex',gap:'1rem',fontSize:'.75rem',color:'var(--ink3)'}}>
                      <span>ü§ù {a.tontines_gerees||0} tontines</span>
                      <span>üë• {a.membres_recrutes||0} membres</span>
                      <span>üéì {(a.modules_completes||[]).length} modules</span>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </>)}

        {/* ‚ïê‚ïê‚ïê KPIs FRANCHISE ‚ïê‚ïê‚ïê */}
        {onglet==='kpis' && (<>
          <div className="card mb2" style={{background:'linear-gradient(135deg,rgba(26,122,110,.08),rgba(90,158,32,.05))'}}>
            <div className="card-title">üìä Tableau de bord Franchise ‚Äî Vision nationale</div>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(180px,1fr))',gap:'1rem'}}>
              {[
                ['üéØ','Objectif S1 2026','50 animateurs certifi√©s'],
                ['üìç','Couverture','14 r√©gions S√©n√©gal'],
                ['üí∞','Mod√®le revenus','Commission 2‚Äì8% cotisations'],
                ['üåç','Benchmark','Farm Shop Kenya ‚Äî 92% viabilit√©'],
              ].map(([ic,titre,val])=>(
                <div key={titre} style={{padding:'.75rem',background:'rgba(255,255,255,.5)',borderRadius:'10px'}}>
                  <div style={{fontSize:'1.4rem',marginBottom:'.3rem'}}>{ic}</div>
                  <div style={{fontWeight:700,fontSize:'.85rem',color:'var(--ink)',marginBottom:'.2rem'}}>{titre}</div>
                  <div style={{fontSize:'.78rem',color:'var(--ink3)'}}>{val}</div>
                </div>
              ))}
            </div>
          </div>

          {/* KPIs cl√©s */}
          <div className="g2">
            <div>
              <div className="card mb2">
                <div className="card-title">üìà KPIs de performance animateur</div>
                {[
                  ['Taux de r√©tention membres','‚â•85%','Membres restant actifs apr√®s 3 mois'],
                  ['Taux de ponctualit√© cotisations','‚â•90%','Cotisations pay√©es √† temps'],
                  ['Taux de remboursement cr√©dit','‚â•92%','Cr√©dits rembours√©s vs octroy√©s'],
                  ['NPS membres','‚â•8/10','Satisfaction des membres'],
                  ['Croissance mensuelle','‚â•10%','Nouveaux membres/mois'],
                  ['Modules compl√©t√©s','‚â•6/8','Formation animateur'],
                ].map(([kpi,cible,desc])=>(
                  <div key={kpi} style={{padding:'.6rem 0',borderBottom:'1px solid var(--border)'}}>
                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:'.15rem'}}>
                      <span style={{fontWeight:600,fontSize:'.85rem',color:'var(--ink)'}}>{kpi}</span>
                      <span style={{fontWeight:700,color:'var(--lime)',fontSize:'.85rem'}}>{cible}</span>
                    </div>
                    <div style={{fontSize:'.73rem',color:'var(--ink3)'}}>{desc}</div>
                  </div>
                ))}
              </div>
            </div>

            <div>
              <div className="card mb2">
                <div className="card-title">üó∫ Couverture par r√©gion</div>
                {statsReseau.parRegion.length===0 ? (
                  <div style={{color:'var(--ink3)',fontSize:'.82rem',padding:'.5rem 0'}}>Aucun animateur encore inscrit</div>
                ) : statsReseau.parRegion.map(([region,nb])=>(
                  <div key={region} style={{display:'flex',justifyContent:'space-between',padding:'.4rem 0',borderBottom:'1px solid var(--border)',fontSize:'.83rem'}}>
                    <span style={{color:'var(--ink)'}}>{region}</span>
                    <div style={{display:'flex',gap:'.5rem',alignItems:'center'}}>
                      <div style={{width:'60px',height:'6px',background:'var(--border)',borderRadius:'99px',overflow:'hidden'}}>
                        <div style={{width:Math.min(100,nb*20)+'%',height:'100%',background:'var(--lime)',borderRadius:'99px'}}/>
                      </div>
                      <span style={{fontWeight:600,color:'var(--lime)',minWidth:'20px'}}>{nb}</span>
                    </div>
                  </div>
                ))}
                <div style={{marginTop:'.75rem',padding:'.5rem',background:'rgba(196,74,42,.06)',borderRadius:'6px',fontSize:'.75rem',color:'var(--rust2)'}}>
                  ‚ö† R√©gions sans animateur : {14-statsReseau.parRegion.length} ‚Äî Priorit√© de recrutement
                </div>
              </div>

              <div className="card">
                <div className="card-title">üí° Strat√©gie de d√©ploiement</div>
                <div style={{fontSize:'.82rem',color:'var(--ink)',lineHeight:1.7}}>
                  {[
                    {phase:'Phase 1 (T1 2026)',obj:'2 animateurs/r√©gion ¬∑ 28 total',ic:'üå±'},
                    {phase:'Phase 2 (T2 2026)',obj:'5 animateurs/r√©gion ¬∑ 70 total',ic:'üåø'},
                    {phase:'Phase 3 (S2 2026)',obj:'Franchise autonome ¬∑ 150 animateurs',ic:'üåæ'},
                    {phase:'Vision 2027',obj:'500 animateurs ¬∑ 50 000 membres',ic:'üèÜ'},
                  ].map(p=>(
                    <div key={p.phase} style={{padding:'.45rem 0',borderBottom:'1px solid var(--border)',display:'flex',gap:'.5rem'}}>
                      <span>{p.ic}</span>
                      <div>
                        <div style={{fontWeight:600,color:'var(--ink)'}}>{p.phase}</div>
                        <div style={{fontSize:'.75rem',color:'var(--ink3)'}}>{p.obj}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </>)}
      </div>

      {/* ‚ïê‚ïê‚ïê MODAL INSCRIPTION ANIMATEUR ‚ïê‚ïê‚ïê */}
      {modaleInscription && (
        <div className="modal-overlay" onClick={()=>setModaleInscription(false)}>
          <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'480px'}}>
            <div className="modal-title">üå± Devenir Animateur AgriTontine+</div>
            <div style={{padding:'.75rem',background:'rgba(90,158,32,.06)',borderRadius:'8px',marginBottom:'1rem',fontSize:'.83rem',color:'var(--ink3)',lineHeight:1.6}}>
              En tant qu'animateur, vous recrutez des agriculteurs, g√©rez des tontines dans votre r√©gion et recevez une commission sur chaque cotisation. Commencez par compl√©ter la formation en ligne.
            </div>
            <div className="fg">
              <label>Votre motivation (obligatoire)</label>
              <textarea value={motivation} onChange={e=>setMotivation(e.target.value)}
                placeholder="Pourquoi voulez-vous devenir animateur AgriTontine+ ? Quelle est votre exp√©rience avec les tontines ou l'agriculture ?"
                rows={4} style={{width:'100%',padding:'.6rem .75rem',borderRadius:'8px',border:'1px solid var(--border)',background:'var(--card)',color:'var(--ink)',fontSize:'.85rem',resize:'vertical',boxSizing:'border-box'}}/>
            </div>
            <div className="fg">
              <label>R√©gion d'intervention</label>
              <input value={user.region} disabled style={{opacity:.7}}/>
            </div>
            <div className="frow-btns">
              <button className="btn btn-ghost" onClick={()=>setModaleInscription(false)}>Annuler</button>
              <button className="btn btn-lime" onClick={sInscrire}>Envoyer ma candidature ‚Üí</button>
            </div>
          </div>
        </div>
      )}

      {/* ‚ïê‚ïê‚ïê MODAL MODULE FORMATION ‚ïê‚ïê‚ïê */}
      {modaleModule && (
        <div className="modal-overlay" onClick={()=>{ setModaleModule(null); setQuizScore(null); setQuizEnCours(null); }}>
          <div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:'540px'}}>
            {quizScore !== null ? (
              /* R√©sultat quiz */
              <div style={{textAlign:'center',padding:'1rem'}}>
                <div style={{fontSize:'3rem',marginBottom:'.5rem'}}>{quizScore>=70?'üéì':'üòï'}</div>
                <div style={{fontWeight:800,fontSize:'1.2rem',color:quizScore>=70?'var(--lime)':'var(--rust2)',marginBottom:'.5rem'}}>
                  {quizScore>=70?'Module valid√© !':'Score insuffisant'}
                </div>
                <div style={{fontSize:'1.4rem',fontWeight:900,color:'var(--ink)',marginBottom:'.25rem'}}>{quizScore}%</div>
                <div style={{fontSize:'.82rem',color:'var(--ink3)',marginBottom:'1rem'}}>{quizScore>=70?'F√©licitations ! Badge ¬´'+modaleModule.badge+'¬ª obtenu.':'Minimum requis : 70%. R√©visez et r√©essayez.'}</div>
                {quizScore>=70&&<div style={{padding:'.6rem',background:'rgba(90,158,32,.08)',borderRadius:'8px',fontSize:'.83rem',color:'var(--lime)',marginBottom:'1rem'}}>+{modaleModule.points} points ajout√©s √† votre profil !</div>}
                <button className="btn btn-lime w100" onClick={()=>{ setModaleModule(null); setQuizScore(null); }}>
                  {quizScore>=70?'Continuer la formation ‚Üí':'Fermer'}
                </button>
              </div>
            ) : quizEnCours ? (
              /* Quiz */
              <div>
                <div className="modal-title">üìù Quiz ‚Äî {modaleModule.titre}</div>
                <div style={{fontSize:'.8rem',color:'var(--ink3)',marginBottom:'1rem'}}>5 questions ¬∑ Minimum 70% pour valider</div>
                {QUIZ_QUESTIONS.map((q,qi)=>(
                  <div key={qi} style={{marginBottom:'1rem',padding:'.75rem',background:'var(--card2,#f5f5f5)',borderRadius:'8px'}}>
                    <div style={{fontWeight:600,fontSize:'.85rem',marginBottom:'.5rem'}}>{qi+1}. {q.q}</div>
                    <div style={{display:'flex',flexDirection:'column',gap:'.3rem'}}>
                      {q.opts.map((opt,oi)=>(
                        <div key={oi} style={{padding:'.35rem .6rem',borderRadius:'6px',fontSize:'.82rem',
                          background:oi===q.rep?'rgba(90,158,32,.1)':'transparent',
                          color:oi===q.rep?'var(--lime)':'var(--ink3)',
                          border:oi===q.rep?'1px solid rgba(90,158,32,.3)':'1px solid transparent'}}>
                          {String.fromCharCode(65+oi)}. {opt}
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
                <div className="frow-btns">
                  <button className="btn btn-ghost" onClick={()=>setQuizEnCours(false)}>Retour</button>
                  <button className="btn btn-lime" onClick={()=>terminerModule(modaleModule)}>Soumettre le quiz</button>
                </div>
              </div>
            ) : (
              /* Contenu module */
              <div>
                <div style={{display:'flex',gap:'1rem',alignItems:'center',marginBottom:'1rem'}}>
                  <div style={{fontSize:'2.5rem'}}>{modaleModule.ic}</div>
                  <div>
                    <div className="modal-title" style={{marginBottom:'.2rem'}}>{modaleModule.titre}</div>
                    <div style={{fontSize:'.78rem',color:'var(--ink3)'}}>‚è± {modaleModule.duree} ¬∑ üèÖ {modaleModule.badge}</div>
                  </div>
                </div>
                <div style={{fontSize:'.85rem',color:'var(--ink3)',marginBottom:'1rem',lineHeight:1.6}}>{modaleModule.description}</div>
                <div style={{marginBottom:'1.25rem'}}>
                  <div style={{fontWeight:600,fontSize:'.85rem',marginBottom:'.5rem'}}>üìã Au programme :</div>
                  {modaleModule.chapitres.map((ch,i)=>(
                    <div key={i} style={{display:'flex',gap:'.5rem',padding:'.35rem 0',borderBottom:'1px solid var(--border)',fontSize:'.83rem',color:'var(--ink)'}}>
                      <span style={{color:'var(--lime)',fontWeight:600}}>{i+1}.</span> {ch}
                    </div>
                  ))}
                </div>
                <div style={{padding:'.6rem',background:'rgba(196,154,40,.08)',borderRadius:'8px',fontSize:'.78rem',color:'var(--gold2)',marginBottom:'1rem'}}>
                  ‚è± Ce module dure {modaleModule.duree} ¬∑ +{modaleModule.points} points apr√®s validation du quiz
                </div>
                <div className="frow-btns">
                  <button className="btn btn-ghost" onClick={()=>setModaleModule(null)}>Fermer</button>
                  {modulesCompletes.includes(modaleModule.id)
                    ? <button className="btn btn-ghost" style={{color:'var(--lime)',borderColor:'var(--lime)'}} disabled>‚úÖ D√©j√† compl√©t√©</button>
                    : <button className="btn btn-lime" onClick={()=>setQuizEnCours(true)}>Commencer le quiz ‚Üí</button>
                  }
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
function Login({onLogin}){
  const [step,setStep]=useState('phone'); // phone | otp | profile
  const [tab,setTab]=useState('paysan');
  const [tel,setTel]=useState('');
  const [otp,setOtp]=useState(['','','','','','']);
  const [otpSent,setOtpSent]=useState(false);
  const [otpReal,setOtpReal]=useState('');
  const [f,setF]=useState({nom:'',tel:'',village:'',region:'Dakar',secteur:'agriculture',role:'paysan'});
  const [err,setErr]=useState('');
  const [loading,setLoading]=useState(false);
  const [countdown,setCountdown]=useState(0);
  const otpRefs=[useRef(),useRef(),useRef(),useRef(),useRef(),useRef()];

  // Countdown pour renvoyer OTP
  React.useEffect(()=>{
    if(countdown>0){ const t=setTimeout(()=>setCountdown(c=>c-1),1000); return ()=>clearTimeout(t); }
  },[countdown]);

  const sendOTP = async()=>{
    if(!tel.match(/^\+221(70|75|76|77|78)\d{7}$/)){setErr('Num√©ro S√©n√©gal invalide');return;}
    setLoading(true);setErr('');
    // G√©n√©rer OTP 6 chiffres (en prod: Twilio/AfricasTalking)
    const code = String(Math.floor(100000+Math.random()*900000));
    setOtpReal(code);
    // Simulation envoi SMS (en prod: appel API)
    await new Promise(r=>setTimeout(r,800));
    setOtpSent(true);
    setStep('otp');
    setCountdown(60);
    setLoading(false);
    // En d√©mo: afficher le code dans la console
    console.log('üîê OTP Demo Code:', code);
  };

  const handleOtpInput=(i,val)=>{
    if(!/^\d*$/.test(val))return;
    const n=[...otp];n[i]=val.slice(-1);setOtp(n);
    if(val&&i<5)otpRefs[i+1].current?.focus();
    if(!val&&i>0)otpRefs[i-1].current?.focus();
  };

  const verifyOTP = async()=>{
    const code=otp.join('');
    if(code.length!==6){setErr('Entrez les 6 chiffres');return;}
    setLoading(true);setErr('');
    await new Promise(r=>setTimeout(r,600));
    if(code===otpReal||code==='123456'){
      // Check if user exists
      const {data}=await sb.from('users').select('*').eq('telephone',tel).single();
      if(data){ const extra=await loadUserData(data.id); onLogin(dbUser(data,extra)); }
      else{ setF(p=>({...p,tel})); setStep('profile'); }
    } else { setErr('Code incorrect'); setOtp(['','','','','','']); otpRefs[0].current?.focus(); }
    setLoading(false);
  };

  const loginDemo = async (secteur) => {
    setLoading(true); setErr('');
    try {
      // Chercher un user d√©mo existant en DB
      const { data } = await sb.from('users').select('*').eq('secteur',secteur).limit(1);
      let u = data && data.length > 0 ? data[0] : null;
      if (!u) {
        // Cr√©er un user d√©mo si la DB est vide
        const demoNames = {agriculture:'Baye S√®ne',elevage:'Ousmane Diallo',mixte:'Mariama Diallo',admin:'Mariama Diallo'};
        const demoVilles = {agriculture:'Touba Toul',elevage:'Lingu√®re',mixte:'Bambey',admin:'Bambey'};
        const demoRegions = {agriculture:'Diourbel',elevage:'Louga',mixte:'Diourbel',admin:'Diourbel'};
        const { data: nu, error } = await sb.from('users').insert({
          clerk_id: 'demo_'+secteur+'_'+Date.now(),
          nom: demoNames[secteur]||'Demo User',
          telephone: '+22177'+Math.floor(Math.random()*9000000+1000000),
          village: demoVilles[secteur]||'Dakar',
          region: demoRegions[secteur]||'Dakar',
          secteur: secteur==='admin'?'mixte':secteur,
          role: secteur==='admin'?'admin':'paysan',
        }).select().single();
        if (error) { setErr('Erreur: '+error.message); setLoading(false); return; }
        u = nu;
      }
      const extra = await loadUserData(u.id);
      onLogin(dbUser(u, extra));
    } catch(e) { setErr(e.message); }
    setLoading(false);
  };

  const submit = async (e) => {
    if(e && e.preventDefault) e.preventDefault();
    if (!f.nom||!f.village) { setErr('Tous les champs sont requis'); return; }
    setLoading(true); setErr('');
    const phoneToUse = tel || f.tel;
    try {
      // Chercher si le num√©ro existe d√©j√†
      const { data:existing } = await sb.from('users').select('*').eq('telephone',phoneToUse).single();
      let u;
      if (existing) {
        u = existing;
      } else {
        const { data:nu, error } = await sb.from('users').insert({
          clerk_id: 'phone_'+(phoneToUse||'').replace('+',''),
          nom: f.nom, telephone: phoneToUse,
          village: f.village, region: f.region,
          secteur: f.secteur, role: tab==='admin'?'admin':'paysan',
        }).select().single();
        if (error) { setErr('Erreur inscription: '+error.message); setLoading(false); return; }
        u = nu;
      }
      const extra = await loadUserData(u.id);
      onLogin(dbUser(u, extra));
    } catch(e) { setErr(e.message); }
    setLoading(false);
  };

  return(
    <div className="lbg">
      {/* Animated background grid */}
      <div className="lbg-grid"/>
      <div className="lbg-glow1"/><div className="lbg-glow2"/>

      <div className="lcard">
        {/* Logo */}
        <div className="llogo">
          <div className="llogo-icon">üåæ</div>
          <div>
            <div className="llogo-name">AgriTontine<span>+</span></div>
            <div className="llogo-sub">La fintech agricole du S√©n√©gal</div>
          </div>
        </div>

        {/* Badges */}
        <div className="lbadges">
          <span className="lbadge lbadge-green">üîí S√©curis√© OTP</span>
          <span className="lbadge lbadge-blue">üåç 14 r√©gions</span>
          <span className="lbadge lbadge-teal">‚ö° Temps r√©el</span>
        </div>

        {/* STEP 1 ‚Äî PHONE */}
        {step==='phone' && (
          <div className="lstep">
            <div className="lstep-title">Connexion s√©curis√©e</div>
            <div className="lstep-sub">Entrez votre num√©ro Wave/Orange/Free ¬∑ Un code SMS vous sera envoy√©</div>
            <div className="lphone-wrap">
              <div className="lphone-flag">üá∏üá≥ +221</div>
              <input className="lphone-input" type="tel" placeholder="77 123 45 67"
                value={tel.replace('+221','')} maxLength={9}
                onChange={e=>{setErr('');setTel('+221'+e.target.value.replace(/\D/g,'').slice(0,9));}}
                onKeyDown={e=>{if(e.key==='Enter')sendOTP();}}
                disabled={loading}/>
            </div>
            {err&&<div className="lerr">‚ö† {err}</div>}
            <button className="lbtn-primary" onClick={sendOTP} disabled={loading}>
              {loading?<span className="lspinner"/>:null}
              {loading?'Envoi en cours...':'Recevoir le code SMS ‚Üí'}
            </button>
            <div className="ldivider"><span>ou</span></div>
            <div className="ldemo-title">Acc√®s d√©mo instantan√©</div>
            <div className="ldemo-grid">
              <button className="ldemo-btn" onClick={()=>loginDemo('agriculture')} disabled={loading}>
                <span className="ldemo-ic">üë®‚Äçüåæ</span><span>Paysan</span>
              </button>
              <button className="ldemo-btn" onClick={()=>loginDemo('elevage')} disabled={loading}>
                <span className="ldemo-ic">üêÑ</span><span>√âleveur</span>
              </button>
              <button className="ldemo-btn ldemo-btn-admin" onClick={()=>loginDemo('admin')} disabled={loading}>
                <span className="ldemo-ic">üëë</span><span>Admin</span>
              </button>
            </div>
          </div>
        )}

        {/* STEP 2 ‚Äî OTP */}
        {step==='otp' && (
          <div className="lstep">
            <button className="lback" onClick={()=>{setStep('phone');setErr('');setOtp(['','','','','','']);}}>‚Üê Retour</button>
            <div className="lstep-title">V√©rification</div>
            <div className="lstep-sub">Code envoy√© au <strong>{tel}</strong><br/>V√©rifiez vos SMS ¬∑ Code valable 10 minutes</div>
            <div className="lotp-wrap">
              {otp.map((digit,i)=>(
                <input key={i} ref={otpRefs[i]} className="lotp-box" type="tel" maxLength={1}
                  value={digit}
                  onChange={e=>handleOtpInput(i,e.target.value)}
                  onKeyDown={e=>{if(e.key==='Backspace'&&!digit&&i>0)otpRefs[i-1].current?.focus();}}
                  disabled={loading}/>
              ))}
            </div>
            <div className="lotp-hint">üí° En d√©mo, code = <strong className="t-lime">123456</strong> ou v√©rifiez la console</div>
            {err&&<div className="lerr">‚ö† {err}</div>}
            <button className="lbtn-primary" onClick={verifyOTP} disabled={loading||otp.join('').length!==6}>
              {loading?<span className="lspinner"/>:null}
              {loading?'V√©rification...':'Confirmer le code'}
            </button>
            {countdown>0
              ? <div className="lotp-countdown">Renvoyer dans {countdown}s</div>
              : <button className="lbtn-ghost" onClick={()=>{setStep('phone');setOtp(['','','','','','']);}}>üì≤ Renvoyer le code</button>
            }
          </div>
        )}

        {/* STEP 3 ‚Äî PROFILE */}
        {step==='profile' && (
          <div className="lstep">
            <div className="lstep-title">Cr√©er votre profil</div>
            <div className="lstep-sub">Premi√®re connexion ‚Äî compl√©tez votre profil agriculteur</div>
            <div className="fg"><label>Nom complet</label>
              <input value={f.nom} onChange={e=>setF({...f,nom:e.target.value})} placeholder="Ex: Baye S√®ne"/>
            </div>
            <div className="fr">
              <div className="fg"><label>Village / Ville</label>
                <input value={f.village} onChange={e=>setF({...f,village:e.target.value})} placeholder="Ex: Lingu√®re"/>
              </div>
              <div className="fg"><label>R√©gion</label>
                <select value={f.region} onChange={e=>setF({...f,region:e.target.value})}>
                  {REGIONS.map(r=><option key={r}>{r}</option>)}
                </select>
              </div>
            </div>
            <div className="fg"><label>Secteur d'activit√©</label>
              <div className="lsecteur-grid">
                {SECTEURS.map(s=>(
                  <div key={s.id} className={`lsecteur-btn ${f.secteur===s.id?'sel':''}`}
                    onClick={()=>setF(p=>({...p,secteur:s.id}))}>
                    <span style={{fontSize:'1.3rem'}}>{s.ic}</span>
                    <span style={{fontSize:'.78rem',fontWeight:600}}>{s.label}</span>
                  </div>
                ))}
              </div>
            </div>
            {err&&<div className="lerr">‚ö† {err}</div>}
            <button className="lbtn-primary" onClick={submit} disabled={loading||!f.nom||!f.village}>
              {loading?<span className="lspinner"/>:null}
              {loading?'Cr√©ation...':'Acc√©der √† la plateforme ‚Üí'}
            </button>
          </div>
        )}

        <div className="lfooter">
          üîê Connexion chiffr√©e ¬∑ Donn√©es h√©berg√©es au S√©n√©gal ¬∑ AgriTontine+ v8.0
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP ROOT ‚Äî avec Supabase + Realtime
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function App(){
  // ‚îÄ‚îÄ TOUS LES HOOKS EN PREMIER ‚Äî jamais apr√®s un return conditionnel ‚îÄ‚îÄ
  const [user,setUser]         = useState(null);
  const [page,setPage]         = useState('dashboard');
  const [tontines,setTontines] = useState([]);
  const [projets,setProjets]   = useState([]);
  const [appLoading,setAppLoading] = useState(false);
  const {toasts,add:toast}     = useToast();

  // Chargement initial apr√®s login
  useEffect(()=>{
    if (!user) { setTontines([]); setProjets([]); return; }
    setAppLoading(true);
    Promise.all([sbFetchTontines(), sbFetchProjets()]).then(([t,p])=>{
      setTontines(t);
      setProjets(p);
      setAppLoading(false);
    });
  },[user && user.id]);

  // Realtime : cotisations
  useEffect(()=>{
    if (!user) return;
    const ch = sb.channel('rt_cotis_'+user.id)
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'cotisations'},
        async (payload)=>{
          if (payload.new.user_id === user.id) {
            const extra = await loadUserData(user.id);
            setUser(u=>({...u,...extra}));
          } else {
            toast('üí∏ Nouvelle cotisation dans votre tontine !','i');
            sbFetchTontines().then(t=>setTontines(t));
          }
        })
      .subscribe();
    return ()=>sb.removeChannel(ch);
  },[user && user.id]);

  // Realtime : projets
  useEffect(()=>{
    if (!user) return;
    const ch = sb.channel('rt_projets_'+user.id)
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'projets'},
        (payload)=>setProjets(prev=>prev.map(p=>p.id===payload.new.id?dbProjet(payload.new):p)))
      .subscribe();
    return ()=>sb.removeChannel(ch);
  },[user && user.id]);

  // Wrapper setTontines ‚Üí Supabase
  const setTontinesWrapper = useCallback(async (updaterOrFn)=>{
    if (typeof updaterOrFn !== 'function') { setTontines(updaterOrFn); return; }
    setTontines(prev=>{
      const next = updaterOrFn(prev);
      const added = next.find(t=>!prev.find(p=>p.id===t.id));
      if (added) {
        // Cr√©er tontine en DB
        sbCreerTontine(user,{
          nom:added.nom, secteur:added.secteur, region:added.region,
          montant:added.montantCotis, frequence:added.frequence,
          nbMax:added.nbMax, desc:added.description,
        }).then(()=>Promise.all([sbFetchTontines(),loadUserData(user.id)])).then(([t,extra])=>{
          setTontines(t);
          setUser(u=>({...u,...extra}));
          toast('Tontine "'+added.nom+'" cr√©√©e !');
        }).catch(e=>toast('Erreur: '+e.message,'e'));
        return prev; // ne pas muter l'√©tat local avant la r√©ponse DB
      }
      // Rejoindre une tontine
      const changed = next.find((t,i)=>t.membres.length > (prev[i]?.membres.length||0));
      if (changed) {
        const origTontine = prev.find(t=>t.id===changed.id);
        if (origTontine) {
          sbRejoindre(user.id, origTontine)
            .then(()=>Promise.all([sbFetchTontines(),loadUserData(user.id)]))
            .then(([t,extra])=>{
              setTontines(t);
              setUser(u=>({...u,...extra}));
              toast('Vous avez rejoint "'+changed.nom+'" !');
            }).catch(e=>toast(e.message,'e'));
        }
        return prev;
      }
      return next;
    });
  },[user, tontines]);

  // Wrapper setUser ‚Üí Supabase
  const setUserWrapper = useCallback(async (updaterOrObj)=>{
    if (typeof updaterOrObj !== 'function') {
      // Mise √† jour profil
      sbUpdateProfil(user.id, updaterOrObj)
        .then(()=>setUser(u=>({...u,...updaterOrObj})))
        .catch(e=>toast('Erreur profil: '+e.message,'e'));
      return;
    }
    const next = updaterOrObj(user);

    // Nouvelle cotisation ?
    if ((next.cotisations||[]).length > (user.cotisations||[]).length) {
      const nc = next.cotisations.find(c=>!(user.cotisations||[]).find(pc=>pc.id===c.id));
      if (nc) {
        const tontine = tontines.find(t=>t.id===nc.tontineId);
        if (!tontine) return;
        sbPayerCotis(user.id, tontine)
          .then(()=>loadUserData(user.id))
          .then(extra=>{ setUser(u=>({...u,...extra})); toast('Cotisation de '+tontine.montantCotis.toLocaleString('fr-FR')+' FCFA enregistr√©e !'); })
          .catch(e=>toast('Erreur cotisation: '+e.message,'e'));
        return;
      }
    }
    // Nouveau cr√©dit ?
    if ((next.credits||[]).length > (user.credits||[]).length) {
      const nc = next.credits.find(c=>!(user.credits||[]).find(pc=>pc.id===c.id));
      if (nc) {
        const score = calcScore(user);
        sbDemanderCredit(user.id,{montant:String(nc.montant),intrant:nc.intrant,partenaire:nc.partenaire},score)
          .then(()=>loadUserData(user.id))
          .then(extra=>{ setUser(u=>({...u,...extra})); toast('‚úì Cr√©dit '+nc.montant.toLocaleString('fr-FR')+' FCFA approuv√© !'); })
          .catch(e=>toast('Erreur cr√©dit: '+e.message,'e'));
        return;
      }
    }
    // Remboursement ?
    const remb = (next.credits||[]).find(c=>c.statut==='rembourse'&&(user.credits||[]).find(pc=>pc.id===c.id&&pc.statut!=='rembourse'));
    if (remb) {
      sbRembourser(remb.id)
        .then(()=>loadUserData(user.id))
        .then(extra=>{ setUser(u=>({...u,...extra})); toast('‚úì Cr√©dit rembours√© !'); })
        .catch(e=>toast('Erreur: '+e.message,'e'));
      return;
    }
    // Nouvel investissement ?
    if ((next.investissements||[]).length > (user.investissements||[]).length) {
      const ni = next.investissements.find(i=>!(user.investissements||[]).find(pi=>pi.projetId===i.projetId&&pi.date===i.date));
      if (ni) {
        const projet = projets.find(p=>p.id===ni.projetId);
        if (!projet) return;
        sbInvestir(user.id,projet,ni.montant)
          .then(()=>Promise.all([loadUserData(user.id),sbFetchProjets()]))
          .then(([extra,p])=>{ setUser(u=>({...u,...extra})); setProjets(p); toast('‚úì Investissement de '+ni.montant.toLocaleString('fr-FR')+' FCFA confirm√© !'); })
          .catch(e=>toast('Erreur investissement: '+e.message,'e'));
        return;
      }
    }
    setUser(next);
  },[user, tontines, projets]);

  // Wrapper setProjets ‚Üí Supabase
  const setProjetsWrapper = useCallback(async (updaterOrFn)=>{
    if (typeof updaterOrFn !== 'function') { setProjets(updaterOrFn); return; }
    const next = updaterOrFn(projets);
    const added = next.find(p=>!projets.find(pp=>pp.id===p.id));
    if (added) {
      sbCreerProjet(user.id,{
        nom:added.nom, promoteur:added.promoteur||user.nom, region:added.region,
        secteur:added.secteur, desc:added.description,
        objectif:String(added.objectif), rendement:String(added.rendementAnnuel),
        duree:String(added.dureeMois), risque:added.risque,
      })
      .then(()=>sbFetchProjets())
      .then(p=>{ setProjets(p); toast('Projet "'+added.nom+'" publi√© !'); })
      .catch(e=>toast('Erreur projet: '+e.message,'e'));
    }
  },[projets, user]);

  // ‚îÄ‚îÄ RETOURS CONDITIONNELS ‚Äî apr√®s tous les hooks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (!user) return (
    <>
      <Login onLogin={u=>{setUser(u);setPage('dashboard');}}/>
      <Toasts toasts={toasts}/>
    </>
  );

  if (appLoading) return (
    <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'var(--bg)',flexDirection:'column',gap:'1rem'}}>
      <div style={{fontFamily:'var(--f-d)',fontSize:'2.5rem',color:'var(--lime)'}}>AgriTontine+</div>
      <div style={{color:'var(--ink3)',fontSize:'.9rem'}}>‚è≥ Chargement depuis Supabase...</div>
    </div>
  );

  const score = calcScore(user);
  const isAdm = tontines.some(t=>t.admin===user.id)||user.role==='admin';
  const openInvests = projets.filter(p=>p.statut==='ouvert').length;
  const getSectorAv = ()=>{ const s=SECTEURS.find(x=>x.id===user.secteur); return s?s.ic:'üåæ'; };

  const nav=[
    {id:'dashboard',ic:'üè†',label:'Tableau de bord'},
    {id:'tontines',ic:'ü§ù',label:'Tontines'},
    {id:'cotisations',ic:'üí∏',label:'Cotisations'},
    {id:'credits',ic:'üå±',label:'Cr√©dits intrants',dot:score<40?'!':null,dotCls:'dot-gold'},
    {id:'investissement',ic:'üíº',label:'Investissement',dot:openInvests>0?openInvests:null,dotCls:'dot-green'},
    ...(isAdm?[{id:'admin',ic:'üëë',label:'Administration'}]:[]),
    {id:'marche',ic:'üõí',label:'March√© Cadran'},
    {id:'outils',ic:'üåæ',label:'Outils Agricoles'},
    {id:'annuaire',ic:'üë®‚Äç‚öïÔ∏è',label:'Annuaire Experts'},
    {id:'messagerie',ic:'üí¨',label:'Messagerie'},
    {id:'carte',ic:'üó∫',label:'Carte Tontines'},
    {id:'adminnational',ic:'üìä',label:'Admin National'},
    {id:'notifications',ic:'üîî',label:'Notifications',dot:null,dotCls:'dot-red'},
    {id:'simulateur',ic:'üßÆ',label:'Simulateur Cr√©dit'},
    {id:'parametres',ic:'‚öôÔ∏è',label:'Param√®tres'},
    {id:'rapport',ic:'üìÑ',label:'Rapport Mensuel'},
    {id:'recherche',ic:'üîç',label:'Recherche'},
    {id:'parrainage',ic:'üéÅ',label:'Parrainage'},
    {id:'franchise',ic:'üè¢',label:'R√©seau Franchise'},
    {id:'profil',ic:'üë§',label:'Mon profil'},
  ];

  const pages={
    dashboard:<Dashboard user={user} tontines={tontines} projets={projets} toast={toast}/>,
    tontines:<Tontines user={user} tontines={tontines} setTontines={setTontinesWrapper} toast={toast}/>,
    cotisations:<Cotisations user={user} setUser={setUserWrapper} tontines={tontines} toast={toast}/>,
    credits:<Credits user={user} setUser={setUserWrapper} toast={toast}/>,
    investissement:<Investissement user={user} setUser={setUserWrapper} projets={projets} setProjets={setProjetsWrapper} toast={toast}/>,
    admin:<Admin user={user} tontines={tontines} setTontines={setTontinesWrapper} toast={toast}/>,
    marche:<Marche user={user} toast={toast}/>,
    outils:<OutilsAgricoles user={user} toast={toast}/>,
    annuaire:<Annuaire user={user} toast={toast}/>,
    messagerie:<Messagerie user={user} toast={toast}/>,
    carte:<CarteRegions user={user} tontines={tontines} toast={toast}/>,
    adminnational:<AdminNational user={user} tontines={tontines} projets={projets} toast={toast}/>,
    notifications:<Notifications user={user} toast={toast}/>,
    simulateur:<SimulateurCredit user={user} tontines={tontines} toast={toast}/>,
    parametres:<Parametres user={user} setUser={setUserWrapper} toast={toast}/>,
    rapport:<RapportMensuel user={user} tontines={tontines} projets={projets} toast={toast}/>,
    recherche:<RechercheGlobale user={user} tontines={tontines} projets={projets} setPage={setPage} toast={toast}/>,
    parrainage:<Parrainage user={user} toast={toast}/>,
    franchise:<FranchiseSociale user={user} tontines={tontines} toast={toast}/>,
    profil:<Profil user={user} setUser={setUserWrapper} toast={toast}/>,
  };

  const scoreColor=score>=65?'var(--lime)':score>=40?'var(--gold2)':'var(--rust2)';

  const [sidebarOpen, setSidebarOpen] = React.useState(false);
  const BOT_NAV = [
    {id:'dashboard',ic:'üè†',label:'Accueil'},
    {id:'tontines',ic:'ü§ù',label:'Tontines'},
    {id:'marche',ic:'üõí',label:'March√©'},
    {id:'messagerie',ic:'üí¨',label:'Messages'},
    {id:'profil',ic:'üë§',label:'Profil'},
  ];

  return(
    <div className="app" onClick={e=>{if(sidebarOpen&&!e.target.closest('.sidebar'))setSidebarOpen(false)}}>
    {/* PWA Install Button */}
    <button id="pwa-install-btn" onClick={()=>window.installPWA&&window.installPWA()}>
      üì≤ Installer l'app
    </button>
    {/* Mobile Header */}
    <div className="mobile-header">
      <div className="mobile-menu-btn" onClick={()=>setSidebarOpen(s=>!s)}>‚ò∞</div>
      <div className="mobile-logo">AgriTontine<span>+</span></div>
      <div style={{width:38}}/>
    </div>
      <div className={`sidebar ${sidebarOpen?'open':''}`}>
        <div className="sb-brand">
          <div className="sb-logo">AgriTontine<b>+</b></div>
          <div className="sb-tagline">Agri ¬∑ √âlevage ¬∑ Investissement</div>
          <div className="sb-flag">üá∏üá≥ S√©n√©gal ¬∑ 14 r√©gions</div>
          <div className="sb-flag" style={{marginTop:'.25rem',background:'rgba(26,158,142,.12)',color:'var(--teal2)',borderColor:'rgba(26,158,142,.25)'}}>üóÑ Supabase Live</div>
        </div>
        <div className="sb-user">
          <div className="fcc gap2 mb1">
            <div className="sb-av" style={{background:'linear-gradient(135deg,var(--s3),var(--s4))'}}>{getSectorAv()}</div>
            <div>
              <div className="sb-uname">{user.nom}</div>
              <div className="sb-usub">üìç {user.village} ¬∑ {user.region}</div>
            </div>
          </div>
          <div className="sb-score-row">
            <div className="sb-score-track"><div className="sb-score-fill" style={{width:score+'%',background:scoreColor}}/></div>
            <div className="sb-score-num" style={{color:scoreColor}}>{score}/100</div>
          </div>
          <div className="fcc gap1 mt1"><SectorBadge secteur={user.secteur}/></div>
        </div>
        <div className="sb-nav">
          <div className="sb-sec">Navigation</div>
          {nav.map(item=>(
            <div key={item.id} className={`sb-item ${page===item.id?'on':''}`} onClick={()=>setPage(item.id)}>
              <span className="sb-ic">{item.ic}</span>{item.label}
              {item.dot&&<span className={`sb-dot ${item.dotCls||'dot-red'}`}>{item.dot}</span>}
            </div>
          ))}
        </div>
        <div className="sb-foot">
          <div className="sb-logout" onClick={()=>{setUser(null);setPage('dashboard');}}>
            <span>üö™</span> D√©connexion
          </div>
          <div className="sb-version">
            üóÑ Supabase ¬∑ ‚òÅÔ∏è Vercel<br/>
            <span style={{color:'var(--lime)'}}>v2.1 ¬∑ Donn√©es persistantes</span>
          </div>
        </div>
      </div>
      <div className="main">{pages[page]||pages.dashboard}</div>
      <Toasts toasts={toasts}/>
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>

<script>
// ‚îÄ‚îÄ PWA Service Worker ‚îÄ‚îÄ
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    const swCode = `
      const CACHE='agritontine-v8';
      const ASSETS=['/'];
      self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))));
      self.addEventListener('fetch',e=>e.respondWith(
        fetch(e.request).catch(()=>caches.match(e.request))
      ));
    `;
    const blob = new Blob([swCode],{type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).catch(()=>{});
  });
}

// ‚îÄ‚îÄ PWA Install Prompt ‚îÄ‚îÄ
let deferredPrompt;
window.addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('pwa-install-btn');
  if(btn) btn.style.display='flex';
});
window.addEventListener('appinstalled',()=>{
  const btn = document.getElementById('pwa-install-btn');
  if(btn) btn.style.display='none';
});
function installPWA(){
  if(deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(()=>{ deferredPrompt=null; });
  }
}
</script>
</body>
</html>
